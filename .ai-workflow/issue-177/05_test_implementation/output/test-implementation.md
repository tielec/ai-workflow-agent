# ãƒ†ã‚¹ãƒˆã‚³ãƒ¼ãƒ‰å®Ÿè£…ãƒ­ã‚° - Issue #177

## å®Ÿè£…ã‚µãƒãƒªãƒ¼

- **ãƒ†ã‚¹ãƒˆæˆ¦ç•¥**: UNIT_ONLY
- **ãƒ†ã‚¹ãƒˆãƒ•ã‚¡ã‚¤ãƒ«æ•°**: 2å€‹ï¼ˆ1å€‹ã¯æ—¢å­˜ãƒ•ã‚¡ã‚¤ãƒ«ã¸ã®è¿½åŠ ã€1å€‹ã¯æ–°è¦ä½œæˆï¼‰
- **ãƒ†ã‚¹ãƒˆã‚±ãƒ¼ã‚¹æ•°**: 15å€‹
- **ãƒ†ã‚¹ãƒˆã‚³ãƒ¼ãƒ‰æˆ¦ç•¥**: EXTEND_TEST + NEW_TEST

## ãƒ†ã‚¹ãƒˆãƒ•ã‚¡ã‚¤ãƒ«ä¸€è¦§

### ä¿®æ­£ï¼ˆæ—¢å­˜ãƒ•ã‚¡ã‚¤ãƒ«ã¸ã®è¿½åŠ ï¼‰

1. **`tests/unit/core/config.test.ts`**: Config.canAgentInstallPackages() ã®ãƒ¦ãƒ‹ãƒƒãƒˆãƒ†ã‚¹ãƒˆï¼ˆ10ä»¶ã®ãƒ†ã‚¹ãƒˆã‚±ãƒ¼ã‚¹è¿½åŠ ï¼‰

### æ–°è¦ä½œæˆ

2. **`tests/unit/phases/base-phase-prompt-injection.test.ts`**: BasePhase.loadPrompt() ã®ç’°å¢ƒæƒ…å ±æ³¨å…¥ãƒ­ã‚¸ãƒƒã‚¯ã®ãƒ¦ãƒ‹ãƒƒãƒˆãƒ†ã‚¹ãƒˆï¼ˆ5ä»¶ã®ãƒ†ã‚¹ãƒˆã‚±ãƒ¼ã‚¹ï¼‰

## ãƒ†ã‚¹ãƒˆã‚±ãƒ¼ã‚¹è©³ç´°

### ãƒ•ã‚¡ã‚¤ãƒ«1: tests/unit/core/config.test.ts

#### æ–°è¦è¿½åŠ ãƒ†ã‚¹ãƒˆã‚¹ã‚¤ãƒ¼ãƒˆ: Config - ãƒ‘ãƒƒã‚±ãƒ¼ã‚¸ã‚¤ãƒ³ã‚¹ãƒˆãƒ¼ãƒ«è¨­å®šï¼ˆIssue #177ï¼‰

**ãƒ†ã‚¹ãƒˆå¯¾è±¡**: `Config.canAgentInstallPackages()` ãƒ¡ã‚½ãƒƒãƒ‰

**è¿½åŠ ãƒ†ã‚¹ãƒˆã‚±ãƒ¼ã‚¹æ•°**: 10ä»¶

#### TC-001: æ­£å¸¸ç³» - "true" ã®å ´åˆ
- **ãƒ†ã‚¹ãƒˆå†…å®¹**: ç’°å¢ƒå¤‰æ•° `AGENT_CAN_INSTALL_PACKAGES` ãŒ `"true"` ã®å ´åˆã€`canAgentInstallPackages()` ãŒ `true` ã‚’è¿”ã™ã“ã¨ã‚’æ¤œè¨¼
- **Given**: `AGENT_CAN_INSTALL_PACKAGES="true"`
- **When**: `canAgentInstallPackages()` ã‚’å‘¼ã³å‡ºã™
- **Then**: `true` ãŒè¿”ã•ã‚Œã‚‹

#### TC-002: æ­£å¸¸ç³» - "1" ã®å ´åˆ
- **ãƒ†ã‚¹ãƒˆå†…å®¹**: ç’°å¢ƒå¤‰æ•° `AGENT_CAN_INSTALL_PACKAGES` ãŒ `"1"` ã®å ´åˆã€`canAgentInstallPackages()` ãŒ `true` ã‚’è¿”ã™ã“ã¨ã‚’æ¤œè¨¼
- **Given**: `AGENT_CAN_INSTALL_PACKAGES="1"`
- **When**: `canAgentInstallPackages()` ã‚’å‘¼ã³å‡ºã™
- **Then**: `true` ãŒè¿”ã•ã‚Œã‚‹

#### TC-003: æ­£å¸¸ç³» - "false" ã®å ´åˆ
- **ãƒ†ã‚¹ãƒˆå†…å®¹**: ç’°å¢ƒå¤‰æ•° `AGENT_CAN_INSTALL_PACKAGES` ãŒ `"false"` ã®å ´åˆã€`canAgentInstallPackages()` ãŒ `false` ã‚’è¿”ã™ã“ã¨ã‚’æ¤œè¨¼
- **Given**: `AGENT_CAN_INSTALL_PACKAGES="false"`
- **When**: `canAgentInstallPackages()` ã‚’å‘¼ã³å‡ºã™
- **Then**: `false` ãŒè¿”ã•ã‚Œã‚‹

#### TC-004: æ­£å¸¸ç³» - "0" ã®å ´åˆ
- **ãƒ†ã‚¹ãƒˆå†…å®¹**: ç’°å¢ƒå¤‰æ•° `AGENT_CAN_INSTALL_PACKAGES` ãŒ `"0"` ã®å ´åˆã€`canAgentInstallPackages()` ãŒ `false` ã‚’è¿”ã™ã“ã¨ã‚’æ¤œè¨¼
- **Given**: `AGENT_CAN_INSTALL_PACKAGES="0"`
- **When**: `canAgentInstallPackages()` ã‚’å‘¼ã³å‡ºã™
- **Then**: `false` ãŒè¿”ã•ã‚Œã‚‹

#### TC-005: æ­£å¸¸ç³»ï¼ˆãƒ‡ãƒ•ã‚©ãƒ«ãƒˆå‹•ä½œï¼‰ - æœªè¨­å®šã®å ´åˆ
- **ãƒ†ã‚¹ãƒˆå†…å®¹**: ç’°å¢ƒå¤‰æ•° `AGENT_CAN_INSTALL_PACKAGES` ãŒæœªè¨­å®šã®å ´åˆã€ãƒ‡ãƒ•ã‚©ãƒ«ãƒˆå‹•ä½œï¼ˆ`false`ï¼‰ãŒå®Ÿè¡Œã•ã‚Œã‚‹ã“ã¨ã‚’æ¤œè¨¼
- **Given**: `AGENT_CAN_INSTALL_PACKAGES` ãŒæœªè¨­å®š
- **When**: `canAgentInstallPackages()` ã‚’å‘¼ã³å‡ºã™
- **Then**: `false` ãŒè¿”ã•ã‚Œã‚‹ï¼ˆãƒ‡ãƒ•ã‚©ãƒ«ãƒˆå€¤ï¼‰

#### TC-006: å¢ƒç•Œå€¤ãƒ†ã‚¹ãƒˆ - ç©ºæ–‡å­—åˆ—ã®å ´åˆ
- **ãƒ†ã‚¹ãƒˆå†…å®¹**: ç’°å¢ƒå¤‰æ•° `AGENT_CAN_INSTALL_PACKAGES` ãŒç©ºæ–‡å­—åˆ—ã®å ´åˆã€ãƒ‡ãƒ•ã‚©ãƒ«ãƒˆå‹•ä½œï¼ˆ`false`ï¼‰ãŒå®Ÿè¡Œã•ã‚Œã‚‹ã“ã¨ã‚’æ¤œè¨¼
- **Given**: `AGENT_CAN_INSTALL_PACKAGES=""`
- **When**: `canAgentInstallPackages()` ã‚’å‘¼ã³å‡ºã™
- **Then**: `false` ãŒè¿”ã•ã‚Œã‚‹ï¼ˆãƒ‡ãƒ•ã‚©ãƒ«ãƒˆå€¤ï¼‰

#### TC-007: å¢ƒç•Œå€¤ãƒ†ã‚¹ãƒˆ - å¤§æ–‡å­—ã®å ´åˆ
- **ãƒ†ã‚¹ãƒˆå†…å®¹**: ç’°å¢ƒå¤‰æ•° `AGENT_CAN_INSTALL_PACKAGES` ãŒ `"TRUE"`ï¼ˆå¤§æ–‡å­—ï¼‰ã®å ´åˆã€å¤§æ–‡å­—å°æ–‡å­—ã‚’åŒºåˆ¥ã›ãšã« `true` ã¨è§£é‡ˆã•ã‚Œã‚‹ã“ã¨ã‚’æ¤œè¨¼
- **Given**: `AGENT_CAN_INSTALL_PACKAGES="TRUE"`
- **When**: `canAgentInstallPackages()` ã‚’å‘¼ã³å‡ºã™
- **Then**: `true` ãŒè¿”ã•ã‚Œã‚‹ï¼ˆå¤§æ–‡å­—å°æ–‡å­—ã‚’åŒºåˆ¥ã—ãªã„ï¼‰

#### TC-008: å¢ƒç•Œå€¤ãƒ†ã‚¹ãƒˆ - å‰å¾Œã«ç©ºç™½
- **ãƒ†ã‚¹ãƒˆå†…å®¹**: ç’°å¢ƒå¤‰æ•° `AGENT_CAN_INSTALL_PACKAGES` ãŒ `" true "`ï¼ˆå‰å¾Œã«ç©ºç™½ï¼‰ã®å ´åˆã€ç©ºç™½ã‚’é™¤å»ã—ã¦ `true` ã¨è§£é‡ˆã•ã‚Œã‚‹ã“ã¨ã‚’æ¤œè¨¼
- **Given**: `AGENT_CAN_INSTALL_PACKAGES=" true "`
- **When**: `canAgentInstallPackages()` ã‚’å‘¼ã³å‡ºã™
- **Then**: `true` ãŒè¿”ã•ã‚Œã‚‹ï¼ˆå‰å¾Œã®ç©ºç™½ã‚’é™¤å»ï¼‰

#### TC-009: ç•°å¸¸ç³» - "yes" ã®å ´åˆï¼ˆè¨±å¯ã•ã‚Œã¦ã„ãªã„å€¤ï¼‰
- **ãƒ†ã‚¹ãƒˆå†…å®¹**: ç’°å¢ƒå¤‰æ•° `AGENT_CAN_INSTALL_PACKAGES` ãŒ `"yes"`ï¼ˆè¨±å¯ã•ã‚Œã¦ã„ãªã„å€¤ï¼‰ã®å ´åˆã€ãƒ‘ãƒƒã‚±ãƒ¼ã‚¸ã‚¤ãƒ³ã‚¹ãƒˆãƒ¼ãƒ«ãŒæ‹’å¦ã•ã‚Œã‚‹ã“ã¨ã‚’æ¤œè¨¼
- **Given**: `AGENT_CAN_INSTALL_PACKAGES="yes"`
- **When**: `canAgentInstallPackages()` ã‚’å‘¼ã³å‡ºã™
- **Then**: `false` ãŒè¿”ã•ã‚Œã‚‹ï¼ˆ"yes" ã¯è¨±å¯ã•ã‚Œã¦ã„ãªã„ï¼‰

#### TC-010: ç•°å¸¸ç³» - "2" ã®å ´åˆï¼ˆè¨±å¯ã•ã‚Œã¦ã„ãªã„æ•°å€¤ï¼‰
- **ãƒ†ã‚¹ãƒˆå†…å®¹**: ç’°å¢ƒå¤‰æ•° `AGENT_CAN_INSTALL_PACKAGES` ãŒ `"2"`ï¼ˆè¨±å¯ã•ã‚Œã¦ã„ãªã„æ•°å€¤ï¼‰ã®å ´åˆã€ãƒ‘ãƒƒã‚±ãƒ¼ã‚¸ã‚¤ãƒ³ã‚¹ãƒˆãƒ¼ãƒ«ãŒæ‹’å¦ã•ã‚Œã‚‹ã“ã¨ã‚’æ¤œè¨¼
- **Given**: `AGENT_CAN_INSTALL_PACKAGES="2"`
- **When**: `canAgentInstallPackages()` ã‚’å‘¼ã³å‡ºã™
- **Then**: `false` ãŒè¿”ã•ã‚Œã‚‹ï¼ˆ"2" ã¯è¨±å¯ã•ã‚Œã¦ã„ãªã„ï¼‰

### ãƒ•ã‚¡ã‚¤ãƒ«2: tests/unit/phases/base-phase-prompt-injection.test.ts

#### æ–°è¦ä½œæˆãƒ†ã‚¹ãƒˆã‚¹ã‚¤ãƒ¼ãƒˆ: BasePhase - ç’°å¢ƒæƒ…å ±æ³¨å…¥ãƒ­ã‚¸ãƒƒã‚¯ï¼ˆIssue #177ï¼‰

**ãƒ†ã‚¹ãƒˆå¯¾è±¡**: `BasePhase.loadPrompt()` ãƒ¡ã‚½ãƒƒãƒ‰ã®ç’°å¢ƒæƒ…å ±æ³¨å…¥ãƒ­ã‚¸ãƒƒã‚¯ã€`buildEnvironmentInfoSection()` ãƒ¡ã‚½ãƒƒãƒ‰

**è¿½åŠ ãƒ†ã‚¹ãƒˆã‚±ãƒ¼ã‚¹æ•°**: 5ä»¶

#### TC-011: AGENT_CAN_INSTALL_PACKAGES=true ã®å ´åˆã€ãƒ—ãƒ­ãƒ³ãƒ—ãƒˆå…ˆé ­ã«ç’°å¢ƒæƒ…å ±ãŒæ³¨å…¥ã•ã‚Œã‚‹ï¼ˆæ­£å¸¸ç³»ï¼‰
- **ãƒ†ã‚¹ãƒˆå†…å®¹**: ç’°å¢ƒå¤‰æ•° `AGENT_CAN_INSTALL_PACKAGES` ãŒ `"true"` ã®å ´åˆã€`loadPrompt('execute')` ãŒãƒ—ãƒ­ãƒ³ãƒ—ãƒˆã®å…ˆé ­ã«ç’°å¢ƒæƒ…å ±ã‚»ã‚¯ã‚·ãƒ§ãƒ³ã‚’æ³¨å…¥ã™ã‚‹ã“ã¨ã‚’æ¤œè¨¼
- **Given**: `AGENT_CAN_INSTALL_PACKAGES="true"`
- **When**: `loadPrompt('execute')` ã‚’å‘¼ã³å‡ºã™
- **Then**:
  - ãƒ—ãƒ­ãƒ³ãƒ—ãƒˆã®å…ˆé ­ã« `## ğŸ› ï¸ é–‹ç™ºç’°å¢ƒæƒ…å ±` ã‚»ã‚¯ã‚·ãƒ§ãƒ³ãŒå«ã¾ã‚Œã‚‹
  - ã‚»ã‚¯ã‚·ãƒ§ãƒ³å†…ã« Pythonã€Goã€Javaã€Rustã€Ruby ã®ã‚¤ãƒ³ã‚¹ãƒˆãƒ¼ãƒ«ã‚³ãƒãƒ³ãƒ‰ãŒå«ã¾ã‚Œã‚‹
  - ç’°å¢ƒæƒ…å ±ã‚»ã‚¯ã‚·ãƒ§ãƒ³ãŒãƒ—ãƒ­ãƒ³ãƒ—ãƒˆãƒ†ãƒ³ãƒ—ãƒ¬ãƒ¼ãƒˆã®å†…å®¹ã‚ˆã‚Šã‚‚å‰ã«é…ç½®ã•ã‚Œã‚‹

#### TC-012: AGENT_CAN_INSTALL_PACKAGES=false ã®å ´åˆã€ç’°å¢ƒæƒ…å ±ãŒæ³¨å…¥ã•ã‚Œãªã„ï¼ˆæ­£å¸¸ç³»ï¼‰
- **ãƒ†ã‚¹ãƒˆå†…å®¹**: ç’°å¢ƒå¤‰æ•° `AGENT_CAN_INSTALL_PACKAGES` ãŒ `"false"` ã®å ´åˆã€ãƒ—ãƒ­ãƒ³ãƒ—ãƒˆã«ç’°å¢ƒæƒ…å ±ã‚»ã‚¯ã‚·ãƒ§ãƒ³ãŒæ³¨å…¥ã•ã‚Œãªã„ã“ã¨ã‚’æ¤œè¨¼
- **Given**: `AGENT_CAN_INSTALL_PACKAGES="false"`
- **When**: `loadPrompt('execute')` ã‚’å‘¼ã³å‡ºã™
- **Then**:
  - ãƒ—ãƒ­ãƒ³ãƒ—ãƒˆã« `## ğŸ› ï¸ é–‹ç™ºç’°å¢ƒæƒ…å ±` ã‚»ã‚¯ã‚·ãƒ§ãƒ³ãŒå«ã¾ã‚Œãªã„
  - ãƒ—ãƒ­ãƒ³ãƒ—ãƒˆå†…å®¹ã¯å…ƒã®ãƒ†ãƒ³ãƒ—ãƒ¬ãƒ¼ãƒˆå†…å®¹ã®ã¿

#### TC-013: AGENT_CAN_INSTALL_PACKAGES ãŒæœªè¨­å®šã®å ´åˆã€ç’°å¢ƒæƒ…å ±ãŒæ³¨å…¥ã•ã‚Œãªã„ï¼ˆæ­£å¸¸ç³»ãƒ»ãƒ‡ãƒ•ã‚©ãƒ«ãƒˆå‹•ä½œï¼‰
- **ãƒ†ã‚¹ãƒˆå†…å®¹**: ç’°å¢ƒå¤‰æ•° `AGENT_CAN_INSTALL_PACKAGES` ãŒæœªè¨­å®šã®å ´åˆã€ãƒ‡ãƒ•ã‚©ãƒ«ãƒˆå‹•ä½œï¼ˆç’°å¢ƒæƒ…å ±æ³¨å…¥ãªã—ï¼‰ãŒå®Ÿè¡Œã•ã‚Œã‚‹ã“ã¨ã‚’æ¤œè¨¼
- **Given**: `AGENT_CAN_INSTALL_PACKAGES` ãŒæœªè¨­å®š
- **When**: `loadPrompt('execute')` ã‚’å‘¼ã³å‡ºã™
- **Then**:
  - ãƒ—ãƒ­ãƒ³ãƒ—ãƒˆã« `## ğŸ› ï¸ é–‹ç™ºç’°å¢ƒæƒ…å ±` ã‚»ã‚¯ã‚·ãƒ§ãƒ³ãŒå«ã¾ã‚Œãªã„ï¼ˆãƒ‡ãƒ•ã‚©ãƒ«ãƒˆå‹•ä½œï¼‰
  - ãƒ—ãƒ­ãƒ³ãƒ—ãƒˆå†…å®¹ã¯å…ƒã®ãƒ†ãƒ³ãƒ—ãƒ¬ãƒ¼ãƒˆå†…å®¹ã®ã¿

#### TC-014: review ã¨ revise ã‚¹ãƒ†ãƒƒãƒ—ã«ã¯ç’°å¢ƒæƒ…å ±ãŒæ³¨å…¥ã•ã‚Œãªã„
- **ãƒ†ã‚¹ãƒˆå†…å®¹**: ç’°å¢ƒå¤‰æ•° `AGENT_CAN_INSTALL_PACKAGES` ãŒ `"true"` ã§ã‚‚ã€`review` ã¨ `revise` ã‚¹ãƒ†ãƒƒãƒ—ã§ã¯ç’°å¢ƒæƒ…å ±ãŒæ³¨å…¥ã•ã‚Œãªã„ã“ã¨ã‚’æ¤œè¨¼
- **Given**: `AGENT_CAN_INSTALL_PACKAGES="true"`
- **When**: `loadPrompt('review')` ã¾ãŸã¯ `loadPrompt('revise')` ã‚’å‘¼ã³å‡ºã™
- **Then**:
  - ãƒ—ãƒ­ãƒ³ãƒ—ãƒˆã« `## ğŸ› ï¸ é–‹ç™ºç’°å¢ƒæƒ…å ±` ã‚»ã‚¯ã‚·ãƒ§ãƒ³ãŒå«ã¾ã‚Œãªã„
  - ãƒ—ãƒ­ãƒ³ãƒ—ãƒˆå†…å®¹ã¯å…ƒã®ãƒ†ãƒ³ãƒ—ãƒ¬ãƒ¼ãƒˆå†…å®¹ã®ã¿

#### TC-015: buildEnvironmentInfoSection() ãŒæ­£ã—ã„Markdownå½¢å¼ã‚’è¿”ã™ï¼ˆæ­£å¸¸ç³»ï¼‰
- **ãƒ†ã‚¹ãƒˆå†…å®¹**: `buildEnvironmentInfoSection()` ãƒ¡ã‚½ãƒƒãƒ‰ãŒã€æ­£ã—ã„Markdownå½¢å¼ã®ç’°å¢ƒæƒ…å ±ã‚»ã‚¯ã‚·ãƒ§ãƒ³ã‚’è¿”ã™ã“ã¨ã‚’æ¤œè¨¼
- **Given**: ãªã—
- **When**: `buildEnvironmentInfoSection()` ã‚’å‘¼ã³å‡ºã™
- **Then**:
  - ã‚»ã‚¯ã‚·ãƒ§ãƒ³ãƒ˜ãƒƒãƒ€ãƒ¼ `## ğŸ› ï¸ é–‹ç™ºç’°å¢ƒæƒ…å ±` ãŒå«ã¾ã‚Œã‚‹
  - Pythonã€Goã€Javaã€Rustã€Ruby ã®5è¨€èªã®ã‚¤ãƒ³ã‚¹ãƒˆãƒ¼ãƒ«ã‚³ãƒãƒ³ãƒ‰ãŒå«ã¾ã‚Œã‚‹
  - å„è¨€èªã®ã‚¤ãƒ³ã‚¹ãƒˆãƒ¼ãƒ«ã‚³ãƒãƒ³ãƒ‰ãŒã‚³ãƒ¼ãƒ‰ãƒ–ãƒ­ãƒƒã‚¯ï¼ˆ`` ` ``ï¼‰ã§å›²ã¾ã‚Œã¦ã„ã‚‹
  - Markdownã®ç®‡æ¡æ›¸ãå½¢å¼ï¼ˆ`-` ã§å§‹ã¾ã‚‹è¡Œï¼‰ãŒå«ã¾ã‚Œã‚‹

## ãƒ†ã‚¹ãƒˆå®Ÿè£…ã®ç‰¹å¾´

### 1. æ—¢å­˜ãƒ‘ã‚¿ãƒ¼ãƒ³ã®è¸è¥²

æ—¢å­˜ã® `config.test.ts` ãŠã‚ˆã³ `base-phase-template.test.ts` ã®ãƒ†ã‚¹ãƒˆãƒ‘ã‚¿ãƒ¼ãƒ³ã‚’å®Œå…¨ã«è¸è¥²ã—ã¦ã„ã¾ã™ï¼š

- **Given/When/Then æ§‹é€ **: å„ãƒ†ã‚¹ãƒˆã‚±ãƒ¼ã‚¹ã¯æ˜ç¢ºãª3æ®µéšæ§‹é€ ã§è¨˜è¿°
- **ç’°å¢ƒå¤‰æ•°ã®ç®¡ç†**: `beforeEach()` ã§ãƒãƒƒã‚¯ã‚¢ãƒƒãƒ—ã€`afterEach()` ã§å¾©å…ƒ
- **ã‚¤ãƒ³ã‚¹ã‚¿ãƒ³ã‚¹ç”Ÿæˆ**: å„ãƒ†ã‚¹ãƒˆã§æ–°è¦ã‚¤ãƒ³ã‚¹ã‚¿ãƒ³ã‚¹ã‚’ç”Ÿæˆã—ã€ç‹¬ç«‹æ€§ã‚’ç¢ºä¿
- **ãƒ†ã‚¹ãƒˆåã®å‘½åè¦å‰‡**: æ—¢å­˜ãƒ†ã‚¹ãƒˆã¨åŒæ§˜ã®è‹±èªè¨˜è¿°ãƒ‘ã‚¿ãƒ¼ãƒ³
- **ãƒ¢ãƒƒã‚¯è¨­å®š**: jest-mock-extended ã‚’ä½¿ç”¨ã—ãŸ fs-extra ã®ãƒ¢ãƒƒã‚¯ï¼ˆJest v30.x äº’æ›ï¼‰

### 2. ãƒ†ã‚¹ãƒˆã‚«ãƒãƒ¬ãƒƒã‚¸

ãƒ†ã‚¹ãƒˆã‚·ãƒŠãƒªã‚ªï¼ˆPhase 3ï¼‰ã§ç­–å®šã•ã‚ŒãŸã™ã¹ã¦ã®ãƒ‘ã‚¿ãƒ¼ãƒ³ã‚’ç¶²ç¾…ï¼š

#### Config ã‚¯ãƒ©ã‚¹ï¼ˆTC-001ï½TC-010ï¼‰
- **æ­£å¸¸ç³»ï¼ˆ4ä»¶ï¼‰**: trueã€1ã€falseã€0
- **ãƒ‡ãƒ•ã‚©ãƒ«ãƒˆå‹•ä½œï¼ˆ2ä»¶ï¼‰**: æœªè¨­å®šã€ç©ºæ–‡å­—åˆ—
- **å¢ƒç•Œå€¤ï¼ˆ2ä»¶ï¼‰**: å¤§æ–‡å­—ã€å‰å¾Œã®ç©ºç™½
- **ç•°å¸¸ç³»ï¼ˆ2ä»¶ï¼‰**: yesã€2

#### BasePhase ã‚¯ãƒ©ã‚¹ï¼ˆTC-011ï½TC-015ï¼‰
- **æ­£å¸¸ç³»ï¼ˆ3ä»¶ï¼‰**: ç’°å¢ƒæƒ…å ±æ³¨å…¥ï¼ˆtrueï¼‰ã€éæ³¨å…¥ï¼ˆfalseï¼‰ã€éæ³¨å…¥ï¼ˆæœªè¨­å®šï¼‰
- **ã‚¹ãƒ†ãƒƒãƒ—åˆ¥å‹•ä½œï¼ˆ1ä»¶ï¼‰**: execute ã®ã¿æ³¨å…¥ã€review/revise ã§ã¯æ³¨å…¥ã•ã‚Œãªã„
- **Markdown ç”Ÿæˆï¼ˆ1ä»¶ï¼‰**: buildEnvironmentInfoSection() ã®æ¤œè¨¼

### 3. ãƒ†ã‚¹ãƒˆè¨­è¨ˆã®è€ƒæ…®äº‹é …

- **ç’°å¢ƒå¤‰æ•°ã®ç‹¬ç«‹æ€§**: å„ãƒ†ã‚¹ãƒˆã§ç’°å¢ƒå¤‰æ•°ã‚’ã‚¯ãƒªãƒ¼ãƒ³ã‚¢ãƒƒãƒ—ã—ã€ãƒ†ã‚¹ãƒˆé–“ã®ä¾å­˜é–¢ä¿‚ã‚’æ’é™¤
- **ãƒ‡ãƒ•ã‚©ãƒ«ãƒˆå€¤ã®æ¤œè¨¼**: ç’°å¢ƒå¤‰æ•°æœªè¨­å®šæ™‚ã®ãƒ‡ãƒ•ã‚©ãƒ«ãƒˆå‹•ä½œï¼ˆ`false`ï¼‰ã‚’æ˜ç¤ºçš„ã«ãƒ†ã‚¹ãƒˆ
- **å¤§æ–‡å­—å°æ–‡å­—ã®è¨±å®¹**: `parseBoolean()` ã® `toLowerCase()` ã«ã‚ˆã‚‹æ­£è¦åŒ–ã‚’æ¤œè¨¼
- **ç©ºç™½ã®å‡¦ç†**: `trim()` ã«ã‚ˆã‚‹å‰å¾Œã®ç©ºç™½é™¤å»ã‚’æ¤œè¨¼
- **ç„¡åŠ¹å€¤ã®æ‹’å¦**: `"yes"` ã‚„ `"2"` ãªã©ã€è¨±å¯ã•ã‚Œã¦ã„ãªã„å€¤ã‚’é©åˆ‡ã« `false` ã¨ã—ã¦æ‰±ã†ã“ã¨ã‚’æ¤œè¨¼
- **ãƒ¢ãƒƒã‚¯ã®é©åˆ‡ãªä½¿ç”¨**: `fs-extra` ã®ãƒ¢ãƒƒã‚¯ã«ã‚ˆã‚Šã€å®Ÿéš›ã®ãƒ•ã‚¡ã‚¤ãƒ«ã‚·ã‚¹ãƒ†ãƒ ã¸ã®ä¾å­˜ã‚’æ’é™¤
- **ãƒ—ãƒ©ã‚¤ãƒ™ãƒ¼ãƒˆãƒ¡ã‚½ãƒƒãƒ‰ã®ãƒ†ã‚¹ãƒˆ**: ãƒ†ã‚¹ãƒˆç”¨ã‚µãƒ–ã‚¯ãƒ©ã‚¹ã§ãƒ©ãƒƒãƒ‘ãƒ¼ãƒ¡ã‚½ãƒƒãƒ‰ã‚’ä½œæˆã—ã€private ãƒ¡ã‚½ãƒƒãƒ‰ã‚’ãƒ†ã‚¹ãƒˆå¯èƒ½ã«

## ä¿®æ­£å±¥æ­´

### ä¿®æ­£1: BasePhaseã®ãƒ—ãƒ­ãƒ³ãƒ—ãƒˆæ³¨å…¥ãƒ†ã‚¹ãƒˆï¼ˆTC-011ï½TC-015ï¼‰ã®å®Ÿè£…

- **æŒ‡æ‘˜å†…å®¹**: ãƒ¬ãƒ“ãƒ¥ãƒ¼ã§ã®ãƒ–ãƒ­ãƒƒã‚«ãƒ¼æŒ‡æ‘˜
  - ãƒ†ã‚¹ãƒˆã‚·ãƒŠãƒªã‚ªã§å®šç¾©ã•ã‚ŒãŸ15ä»¶ã®ãƒ†ã‚¹ãƒˆã‚±ãƒ¼ã‚¹ã®ã†ã¡ã€10ä»¶ï¼ˆConfig ã‚¯ãƒ©ã‚¹ï¼‰ã®ã¿ãŒå®Ÿè£…ã•ã‚Œã€5ä»¶ï¼ˆBasePhaseï¼‰ãŒæœªå®Ÿè£…
  - Planning Phaseã®Task 5-2ãŒæœªå®Œäº†
  - å“è³ªã‚²ãƒ¼ãƒˆã€ŒPhase 3ã®ãƒ†ã‚¹ãƒˆã‚·ãƒŠãƒªã‚ªãŒã™ã¹ã¦å®Ÿè£…ã•ã‚Œã¦ã„ã‚‹ã€ãŒæº€ãŸã•ã‚Œã¦ã„ãªã„

- **ä¿®æ­£å†…å®¹**: BasePhaseã®ãƒ—ãƒ­ãƒ³ãƒ—ãƒˆæ³¨å…¥ãƒ­ã‚¸ãƒƒã‚¯ã®ãƒ¦ãƒ‹ãƒƒãƒˆãƒ†ã‚¹ãƒˆã‚’å®Ÿè£…
  - æ–°è¦ãƒ•ã‚¡ã‚¤ãƒ« `tests/unit/phases/base-phase-prompt-injection.test.ts` ã‚’ä½œæˆ
  - TC-011ï½TC-015 ã®5ä»¶ã®ãƒ†ã‚¹ãƒˆã‚±ãƒ¼ã‚¹ã‚’å®Ÿè£…
  - æ—¢å­˜ã®BasePhaseãƒ†ã‚¹ãƒˆãƒ‘ã‚¿ãƒ¼ãƒ³ï¼ˆ`base-phase-template.test.ts`ï¼‰ã‚’å‚è€ƒã«ã—ã€jest-mock-extended ã‚’ä½¿ç”¨
  - ãƒ†ã‚¹ãƒˆç”¨ã‚µãƒ–ã‚¯ãƒ©ã‚¹ `TestPhase` ã‚’ä½œæˆã—ã€private ãƒ¡ã‚½ãƒƒãƒ‰ã‚’ãƒ†ã‚¹ãƒˆå¯èƒ½ã«

- **å½±éŸ¿ç¯„å›²**:
  - æ–°è¦ãƒ•ã‚¡ã‚¤ãƒ«: `tests/unit/phases/base-phase-prompt-injection.test.ts`ï¼ˆç´„270è¡Œï¼‰
  - æ—¢å­˜ãƒ•ã‚¡ã‚¤ãƒ«ã¸ã®å¤‰æ›´ãªã—

- **ä¿®æ­£ç†ç”±**:
  - ãƒ†ã‚¹ãƒˆã‚·ãƒŠãƒªã‚ªï¼ˆPhase 3ï¼‰ã§å®šç¾©ã•ã‚ŒãŸå…¨ãƒ†ã‚¹ãƒˆã‚±ãƒ¼ã‚¹ã‚’å®Ÿè£…ã™ã‚‹ã“ã¨ãŒå“è³ªã‚²ãƒ¼ãƒˆã®è¦ä»¶
  - Planning Phaseï¼ˆPhase 0ï¼‰ã®Task 5-2ã‚’å®Œäº†ã•ã›ã‚‹ãŸã‚
  - Phase 4ã§å®Ÿè£…ã•ã‚ŒãŸBasePhaseã®æ©Ÿèƒ½ï¼ˆ`loadPrompt()` æ‹¡å¼µã€`buildEnvironmentInfoSection()`ï¼‰ã‚’æ¤œè¨¼ã™ã‚‹ãŸã‚

## æ¬¡ã®ã‚¹ãƒ†ãƒƒãƒ—

### Phase 6ï¼ˆTestingï¼‰ã§ã®ç¢ºèªäº‹é …

ä»¥ä¸‹ã®é …ç›®ã‚’ Phase 6 ã§ç¢ºèªã—ã¦ãã ã•ã„ï¼š

1. **ãƒ¦ãƒ‹ãƒƒãƒˆãƒ†ã‚¹ãƒˆå®Ÿè¡Œï¼ˆConfigï¼‰**: `npm test tests/unit/core/config.test.ts` ã§å…¨ãƒ†ã‚¹ãƒˆã‚±ãƒ¼ã‚¹ãŒæˆåŠŸã™ã‚‹ã“ã¨ã‚’ç¢ºèª
2. **ãƒ¦ãƒ‹ãƒƒãƒˆãƒ†ã‚¹ãƒˆå®Ÿè¡Œï¼ˆBasePhaseï¼‰**: `npm test tests/unit/phases/base-phase-prompt-injection.test.ts` ã§å…¨ãƒ†ã‚¹ãƒˆã‚±ãƒ¼ã‚¹ãŒæˆåŠŸã™ã‚‹ã“ã¨ã‚’ç¢ºèª
3. **å…¨ãƒ†ã‚¹ãƒˆå®Ÿè¡Œ**: `npm test` ã§æ—¢å­˜ãƒ†ã‚¹ãƒˆã‚‚å«ã‚ã¦ã™ã¹ã¦ã®ãƒ†ã‚¹ãƒˆãŒæˆåŠŸã™ã‚‹ã“ã¨ã‚’ç¢ºèª
4. **ãƒ†ã‚¹ãƒˆã‚«ãƒãƒ¬ãƒƒã‚¸ç¢ºèª**: æ–°è¦ã‚³ãƒ¼ãƒ‰ï¼ˆ`canAgentInstallPackages()`ã€`parseBoolean()`ã€`loadPrompt()` æ‹¡å¼µéƒ¨åˆ†ã€`buildEnvironmentInfoSection()`ï¼‰ã®ã‚«ãƒãƒ¬ãƒƒã‚¸ãŒ 80%ä»¥ä¸Šã§ã‚ã‚‹ã“ã¨ã‚’ç¢ºèª

### å“è³ªã‚²ãƒ¼ãƒˆç¢ºèª

- [x] **Phase 3ã®ãƒ†ã‚¹ãƒˆã‚·ãƒŠãƒªã‚ªãŒã™ã¹ã¦å®Ÿè£…ã•ã‚Œã¦ã„ã‚‹**: Config ã‚¯ãƒ©ã‚¹ã®ãƒ†ã‚¹ãƒˆã‚±ãƒ¼ã‚¹ï¼ˆTC-001ï½TC-010ï¼‰+ BasePhaseã®ãƒ†ã‚¹ãƒˆã‚±ãƒ¼ã‚¹ï¼ˆTC-011ï½TC-015ï¼‰ã‚’å®Œå…¨ã«å®Ÿè£… âœ…
- [x] **ãƒ†ã‚¹ãƒˆã‚³ãƒ¼ãƒ‰ãŒå®Ÿè¡Œå¯èƒ½ã§ã‚ã‚‹**: Jest ã®æ¨™æº–çš„ãªãƒ†ã‚¹ãƒˆãƒ‘ã‚¿ãƒ¼ãƒ³ã«æº–æ‹ ã—ã€å®Ÿè¡Œå¯èƒ½ âœ…
- [x] **ãƒ†ã‚¹ãƒˆã®æ„å›³ãŒã‚³ãƒ¡ãƒ³ãƒˆã§æ˜ç¢º**: å„ãƒ†ã‚¹ãƒˆã‚±ãƒ¼ã‚¹ã« Given/When/Then ã‚³ãƒ¡ãƒ³ãƒˆã‚’è¨˜è¼‰ âœ…

## ãƒ†ã‚¹ãƒˆå®Ÿè£…ã®å·¥å¤«

### 1. ç’°å¢ƒå¤‰æ•°ã®å®‰å…¨ãªç®¡ç†

```typescript
beforeEach(() => {
  // ç’°å¢ƒå¤‰æ•°ã®ãƒãƒƒã‚¯ã‚¢ãƒƒãƒ—
  originalEnv = { ...process.env };
});

afterEach(() => {
  // ç’°å¢ƒå¤‰æ•°ã®å¾©å…ƒ
  process.env = originalEnv;
});
```

å„ãƒ†ã‚¹ãƒˆã§ç’°å¢ƒå¤‰æ•°ã‚’ãƒãƒƒã‚¯ã‚¢ãƒƒãƒ—ãƒ»å¾©å…ƒã™ã‚‹ã“ã¨ã§ã€ãƒ†ã‚¹ãƒˆé–“ã®ç‹¬ç«‹æ€§ã‚’ç¢ºä¿ã—ã¾ã—ãŸã€‚

### 2. æ˜ç¢ºãªãƒ†ã‚¹ãƒˆå

```typescript
test('Given AGENT_CAN_INSTALL_PACKAGES="true", When canAgentInstallPackages() is called, Then true is returned', () => {
  // ...
});
```

ãƒ†ã‚¹ãƒˆåã« Given/When/Then ã‚’å«ã‚ã‚‹ã“ã¨ã§ã€ãƒ†ã‚¹ãƒˆã‚±ãƒ¼ã‚¹ã®æ„å›³ã‚’æ˜ç¢ºã«ã—ã¾ã—ãŸã€‚

### 3. æ—¢å­˜ãƒ†ã‚¹ãƒˆã¨ã®æ•´åˆæ€§

- Config ã‚¯ãƒ©ã‚¹ã®ãƒ†ã‚¹ãƒˆ: æ—¢å­˜ã® `config.test.ts` ã®ãƒ†ã‚¹ãƒˆãƒ‘ã‚¿ãƒ¼ãƒ³ï¼ˆ`getLogNoColor()` ã®ãƒ†ã‚¹ãƒˆï¼‰ã‚’å‚è€ƒã«ã—ã€ã‚³ãƒ¼ãƒ‰ãƒ™ãƒ¼ã‚¹å…¨ä½“ã§ã®ä¸€è²«æ€§ã‚’ç¶­æŒ
- BasePhase ã‚¯ãƒ©ã‚¹ã®ãƒ†ã‚¹ãƒˆ: æ—¢å­˜ã® `base-phase-template.test.ts` ã®ãƒ†ã‚¹ãƒˆãƒ‘ã‚¿ãƒ¼ãƒ³ã‚’å‚è€ƒã«ã—ã€ãƒ¢ãƒƒã‚¯è¨­å®šã‚„ãƒ†ã‚¹ãƒˆã‚¯ãƒ©ã‚¹æ§‹é€ ã‚’çµ±ä¸€

### 4. ãƒ—ãƒ©ã‚¤ãƒ™ãƒ¼ãƒˆãƒ¡ã‚½ãƒƒãƒ‰ã®ãƒ†ã‚¹ãƒˆæˆ¦ç•¥

```typescript
class TestPhase extends BasePhase {
  // loadPrompt() ã‚’ public ã«ã™ã‚‹ãƒ©ãƒƒãƒ‘ãƒ¼
  public testLoadPrompt(promptType: 'execute' | 'review' | 'revise'): string {
    return (this as any).loadPrompt(promptType);
  }

  // buildEnvironmentInfoSection() ã‚’ public ã«ã™ã‚‹ãƒ©ãƒƒãƒ‘ãƒ¼
  public testBuildEnvironmentInfoSection(): string {
    return (this as any).buildEnvironmentInfoSection();
  }
}
```

private ãƒ¡ã‚½ãƒƒãƒ‰ã‚’ãƒ†ã‚¹ãƒˆã™ã‚‹ãŸã‚ã«ã€ãƒ†ã‚¹ãƒˆç”¨ã‚µãƒ–ã‚¯ãƒ©ã‚¹ã§ãƒ©ãƒƒãƒ‘ãƒ¼ãƒ¡ã‚½ãƒƒãƒ‰ã‚’ä½œæˆã—ã€æ—¢å­˜ã®å®Ÿè£…ã‚’å¤‰æ›´ã›ãšã«ãƒ†ã‚¹ãƒˆå¯èƒ½ã«ã—ã¾ã—ãŸã€‚

### 5. ãƒ¢ãƒƒã‚¯ã®é©åˆ‡ãªä½¿ç”¨

```typescript
const mockFs: DeepMockProxy<typeof FsExtra> = mockDeep<typeof FsExtra>();
jest.unstable_mockModule('fs-extra', () => mockFs);
```

jest-mock-extended ã‚’ä½¿ç”¨ã—ã€Jest v30.x ã«å¯¾å¿œã—ãŸãƒ¢ãƒƒã‚¯è¨­å®šã‚’è¡Œã„ã¾ã—ãŸã€‚ã“ã‚Œã«ã‚ˆã‚Šã€å®Ÿéš›ã®ãƒ•ã‚¡ã‚¤ãƒ«ã‚·ã‚¹ãƒ†ãƒ ã¸ã®ä¾å­˜ã‚’æ’é™¤ã—ã€ãƒ†ã‚¹ãƒˆã®ç‹¬ç«‹æ€§ã‚’ç¢ºä¿ã—ã¾ã—ãŸã€‚

## è£œè¶³æƒ…å ±

### ãƒ†ã‚¹ãƒˆã‚·ãƒŠãƒªã‚ªã¨ã®å¯¾å¿œ

æœ¬ãƒ†ã‚¹ãƒˆå®Ÿè£…ã¯ã€ä»¥ä¸‹ã®ãƒ‰ã‚­ãƒ¥ãƒ¡ãƒ³ãƒˆã«æº–æ‹ ã—ã¦ã„ã¾ã™ï¼š

- **ãƒ†ã‚¹ãƒˆã‚·ãƒŠãƒªã‚ª**: `.ai-workflow/issue-177/03_test_scenario/output/test-scenario.md`ï¼ˆã‚»ã‚¯ã‚·ãƒ§ãƒ³2.1ãƒ»2.2ã€TC-001ï½TC-015ï¼‰
- **è¨­è¨ˆæ›¸**: `.ai-workflow/issue-177/02_design/output/design.md`ï¼ˆã‚»ã‚¯ã‚·ãƒ§ãƒ³8.2ã€Config ã‚¯ãƒ©ã‚¹æ‹¡å¼µè¨­è¨ˆã€ã‚»ã‚¯ã‚·ãƒ§ãƒ³8.3ã€BasePhase æ‹¡å¼µè¨­è¨ˆï¼‰
- **å®Ÿè£…ãƒ­ã‚°**: `.ai-workflow/issue-177/04_implementation/output/implementation.md`ï¼ˆãƒ•ã‚¡ã‚¤ãƒ«2ã€Config ã‚¯ãƒ©ã‚¹ã®æ‹¡å¼µã€ãƒ•ã‚¡ã‚¤ãƒ«3ã€BasePhase ã®æ‹¡å¼µï¼‰

### å‚è€ƒè³‡æ–™

#### Config ã‚¯ãƒ©ã‚¹ã®ãƒ†ã‚¹ãƒˆ
- æ—¢å­˜ã®ãƒ†ã‚¹ãƒˆãƒ‘ã‚¿ãƒ¼ãƒ³: `tests/unit/core/config.test.ts` ã® `getLogNoColor()` ãƒ†ã‚¹ãƒˆï¼ˆline 639-699ï¼‰
- Config ã‚¯ãƒ©ã‚¹å®Ÿè£…: `src/core/config.ts` ã® `canAgentInstallPackages()` ãƒ¡ã‚½ãƒƒãƒ‰ï¼ˆline 365-368ï¼‰
- Config ã‚¯ãƒ©ã‚¹å®Ÿè£…: `src/core/config.ts` ã® `parseBoolean()` ãƒ˜ãƒ«ãƒ‘ãƒ¼ãƒ¡ã‚½ãƒƒãƒ‰ï¼ˆline 425-432ï¼‰

#### BasePhase ã‚¯ãƒ©ã‚¹ã®ãƒ†ã‚¹ãƒˆ
- æ—¢å­˜ã®ãƒ†ã‚¹ãƒˆãƒ‘ã‚¿ãƒ¼ãƒ³: `tests/unit/phases/base-phase-template.test.ts` ã® `executePhaseTemplate()` ãƒ†ã‚¹ãƒˆ
- BasePhase å®Ÿè£…: `src/phases/base-phase.ts` ã® `loadPrompt()` ãƒ¡ã‚½ãƒƒãƒ‰ï¼ˆline 193-222ï¼‰
- BasePhase å®Ÿè£…: `src/phases/base-phase.ts` ã® `buildEnvironmentInfoSection()` ãƒ¡ã‚½ãƒƒãƒ‰ï¼ˆline 229-241ï¼‰

---

**ä½œæˆæ—¥æ™‚**: 2025-01-31
**æœ€çµ‚æ›´æ–°æ—¥æ™‚**: 2025-01-31ï¼ˆä¿®æ­£1: BasePhaseãƒ†ã‚¹ãƒˆè¿½åŠ ï¼‰
**ä½œæˆè€…**: AI Workflow Agent (Test Implementation Phase)
**Issueç•ªå·**: #177
**ãƒãƒ¼ã‚¸ãƒ§ãƒ³**: v1.1
