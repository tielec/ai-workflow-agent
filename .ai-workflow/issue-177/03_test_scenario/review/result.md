テストシナリオのレビューを開始します。まず、Planning Documentを読み込んで、Phase 3のチェックリストを確認します。
Planning.mdを確認しました。Phase 3のチェックリストは以下の通りです：

```markdown
### Phase 3: テストシナリオ

- [ ] Task 3-1: Config ユニットテストシナリオ策定 (0.5h)
  - `canAgentInstallPackages()` のテストケース網羅
  - 環境変数パターン（true、1、false、0、未設定、空文字列、その他）
  - 境界値テスト（大文字小文字混在、空白前後）

- [ ] Task 3-2: BasePhase プロンプト注入テストシナリオ策定 (0.5h)
  - 環境情報注入のテストケース（注入あり/なし）
  - Markdownフォーマット検証
  - 既存プロンプトとの互換性確認
```

それでは、テストシナリオ（test-scenario.md）の内容とPlanning.mdのチェックリストを照合し、レビューを実施します。

## 品質ゲート評価

**⚠️ 重要: 各項目に対して明示的にPASS/FAILを判定してください。1つでもFAILがあれば最終判定は自動的にFAILです。**

- [x] **Phase 2の戦略に沿ったテストシナリオである**: **PASS** - UNIT_ONLY戦略に完全準拠。ユニットテストシナリオのみが記載されており、Integration/BDDシナリオは含まれていません。
- [x] **主要な正常系がカバーされている**: **PASS** - Config.canAgentInstallPackages()の正常系（TC-001～TC-005）、BasePhase.loadPrompt()の正常系（TC-011～TC-014）が網羅的にカバーされています。
- [x] **主要な異常系がカバーされている**: **PASS** - 環境変数の不正値（TC-009, TC-010）、境界値テスト（TC-006～TC-008）が適切にカバーされています。
- [x] **期待結果が明確である**: **PASS** - すべてのテストケースに「期待結果」セクションと「検証項目」が具体的に記載されており、実装可能な形式で定義されています。

**品質ゲート総合判定: PASS**

すべての品質ゲート項目がPASSであり、次フェーズ（実装）に進むことができます。

## Planning.mdとの照合結果

テストシナリオ（test-scenario.md）をPlanning.mdのPhase 3チェックリストと照合しました：

### Task 3-1: Config ユニットテストシナリオ策定
- ✅ `canAgentInstallPackages()` のテストケース網羅（TC-001～TC-010の10件）
- ✅ 環境変数パターン（true、1、false、0、未設定、空文字列、その他）すべてカバー
- ✅ 境界値テスト（大文字小文字混在: TC-007、空白前後: TC-008）

### Task 3-2: BasePhase プロンプト注入テストシナリオ策定
- ✅ 環境情報注入のテストケース（注入あり: TC-011、注入なし: TC-012, TC-013）
- ✅ Markdownフォーマット検証（TC-015）
- ✅ 既存プロンプトとの互換性確認（テンプレート変数置換: TC-014）

**すべてのタスクが完了**しています。Planning.mdを更新します。
Planning.mdの更新が完了しました。それでは、詳細レビューを実施します。

---

## 詳細レビュー

### 1. テスト戦略との整合性

**良好な点**:
- UNIT_ONLY戦略に完全準拠しており、ユニットテストシナリオのみが記載されている
- セクション2「Unitテストシナリオ」として明確に分類されており、構造が明瞭
- テストスイートが適切に分割されている（Config.canAgentInstallPackages、BasePhase.loadPrompt、BasePhase.buildEnvironmentInfoSection）
- 既存のテストパターン（Given/When/Then）を踏襲しており、一貫性がある
- テストファイル配置も既存パターン（tests/unit/core/config.test.ts）に従っている

**懸念点**:
- なし（テスト戦略との整合性は完璧）

### 2. 正常系のカバレッジ

**良好な点**:
- Config.canAgentInstallPackages()の正常系が網羅的（TC-001～TC-005）
  - true/1の場合のtrueパターン（TC-001, TC-002）
  - false/0/未設定の場合のfalseパターン（TC-003, TC-004, TC-005）
- BasePhase.loadPrompt()の正常系が十分（TC-011～TC-014）
  - 環境情報注入あり（TC-011）
  - 環境情報注入なし（TC-012, TC-013）
  - テンプレート変数との統合（TC-014）
- クリティカルパス（Config → BasePhase → プロンプト生成）がすべてカバーされている
- デフォルト動作（環境変数未設定時のfalse）が明示的にテストされている（TC-005, TC-013）

**懸念点**:
- なし（主要な正常系は十分カバーされている）

### 3. 異常系のカバレッジ

**良好な点**:
- 境界値テストが充実している
  - 大文字小文字混在（TC-007: "TRUE"）
  - 前後の空白（TC-008: " true "）
  - 空文字列（TC-006）
- 不正な値の処理が適切にテストされている
  - 許可されていない文字列値（TC-009: "yes"）
  - 許可されていない数値（TC-010: "2"）
- 合計10件の環境変数パターンが網羅されており、Phase 2設計書の見積もり（約10件）と一致

**改善の余地**:
- 以下のエッジケースは追加を検討してもよいが、実装フェーズで補完可能なため必須ではない：
  - 特殊文字を含む値（例: "true\n"、"1;rm -rf /"等）
  - 非常に長い文字列値
  - ただし、これらは「80点で十分」の原則に基づき、スコープ外と判断するのが妥当

### 4. 期待結果の明確性

**良好な点**:
- すべてのテストケースに「期待結果」セクションが明記されている
- 検証項目が具体的（`expect(result).toBe(true)` 等）
- 実装例（TypeScriptコード）が各テストケースに含まれており、実装時の曖昧さがない
- Given/When/Thenパターンが一貫して使用されており、可読性が高い
- 前提条件が明確（環境変数の設定状態、テスト開始時の状態）

**懸念点**:
- なし（期待結果の記述は非常に明確）

### 5. 要件との対応

**良好な点**:
- 要件定義書（requirements.md）の受け入れ基準との対応が明確
  - AC-5（Config クラスの動作確認）: TC-001～TC-010でカバー
  - AC-6（プロンプト注入の動作確認）: TC-011～TC-015でカバー
- セクション6.2「テストカバレッジマトリクス」で要件との対応関係が明示されている
- 機能要件（FR-4: Config拡張、FR-5: プロンプト注入）がすべてテスト対象に含まれている
- 非機能要件（NFR-4: 後方互換性）もテストケースに反映されている（TC-005, TC-013）

**改善の余地**:
- なし（要件との対応は完璧）

### 6. 実行可能性

**良好な点**:
- テストデータが具体的に定義されている（各テストケースの「テストデータ」セクション）
- テスト環境要件が明記されている（セクション4: Node.js 20.x、Jest等）
- モック/スタブの必要性が明確に記載されている（セクション4.3）
  - プロンプトテンプレートファイルのモック化
  - WorkflowContextのモック
- テスト実行方法が具体的（セクション5: `npm test`、カバレッジ目標80%以上）
- テストスイート名、テストファイル名が明記されており、実装時の迷いがない

**懸念点**:
- なし（実行可能性は非常に高い）

## ブロッカー（BLOCKER）

**次フェーズに進めない重大な問題**

なし

## 改善提案（SUGGESTION）

**次フェーズに進めるが、改善が望ましい事項**

1. **TC-015（buildEnvironmentInfoSection）の扱いについて**
   - 現状: TC-015は`buildEnvironmentInfoSection()`がprivateメソッドであるため、直接テストせずにloadPrompt()経由でテストすることを推奨している
   - 提案: この方針は正しいが、テストシナリオ内で「TC-015は参考であり、実際にはTC-011～TC-014で十分カバーされる」ことを明示してもよい
   - 効果: 実装フェーズでの混乱を防ぎ、優先度を明確化できる

2. **テストカバレッジ目標の具体的な測定方法**
   - 現状: セクション5.3で「新規コードのカバレッジ80%以上」と記載されているが、測定方法は`npm run test:coverage`のみ
   - 提案: カバレッジレポートのどの指標（Statement/Branch/Function/Line）を重視するか明記してもよい
   - 効果: Phase 6（テスト実行）での判定基準が明確になる

3. **環境情報セクションの言語リストの拡張性**
   - 現状: Python、Go、Java、Rust、Rubyの5言語が固定されている
   - 提案: 将来的に言語リストを環境変数から読み込む等の拡張可能性について、テストシナリオに言及してもよい（ただしスコープ外として明記）
   - 効果: 設計の拡張性が明確になるが、現時点では不要

## 総合評価

テストシナリオは非常に高品質であり、次フェーズ（実装）に進むための要件を完全に満たしています。

**主な強み**:
- UNIT_ONLY戦略に完全準拠しており、テスト戦略との整合性が完璧
- 15件のテストケースが網羅的に定義されており、正常系・異常系・境界値がすべてカバーされている
- Given/When/Thenパターンが一貫して使用され、実装例も含まれているため、実装時の曖昧さがゼロ
- 要件定義書の受け入れ基準と完全に対応しており、トレーサビリティが高い
- テストカバレッジマトリクス（セクション6.2）により、機能要件とテストケースの対応が可視化されている
- Planning Documentとの整合性が完璧（見積もり「約10件」に対して15件のテストケースを提供）
- テスト環境要件、モック/スタブ、実行方法が具体的に記載されており、実行可能性が非常に高い

**主な改善提案**:
- TC-015の優先度を明示（ただし現状でも十分明確）
- カバレッジ測定の具体的な指標を明記（ただし実装フェーズで決定可能）
- 将来の拡張性についての言及（ただしスコープ外として適切に分離されている）

**総括コメント**:

本テストシナリオは、「80点で十分」の原則に基づいても、実際には**95点レベル**の品質に達しています。すべての品質ゲートを満たし、Planning Documentのすべてのタスクが完了しており、要件定義書の受け入れ基準と完全に対応しています。改善提案はすべて「nice-to-have」レベルであり、現状のまま実装フェーズに進んで全く問題ありません。

特に評価すべき点は、各テストケースに実装例（TypeScriptコード）が含まれていることです。これにより、実装フェーズでの解釈の相違や手戻りのリスクが最小化されています。また、テストカバレッジマトリクスにより、要件とテストケースの対応関係が明確であり、レビュー時および実装後の検証が容易になっています。

自信を持って次フェーズ（実装）に進むことを推奨します。

---
**判定: PASS_WITH_SUGGESTIONS**
Planning.mdの更新が完了しました。それでは、詳細レビューを実施します。

---

## 詳細レビュー

### 1. テスト戦略との整合性

**良好な点**:
- UNIT_ONLY戦略に完全準拠しており、ユニットテストシナリオのみが記載されている
- セクション2「Unitテストシナリオ」として明確に分類されており、構造が明瞭
- テストスイートが適切に分割されている（Config.canAgentInstallPackages、BasePhase.loadPrompt、BasePhase.buildEnvironmentInfoSection）
- 既存のテストパターン（Given/When/Then）を踏襲しており、一貫性がある
- テストファイル配置も既存パターン（tests/unit/core/config.test.ts）に従っている

**懸念点**:
- なし（テスト戦略との整合性は完璧）

### 2. 正常系のカバレッジ

**良好な点**:
- Config.canAgentInstallPackages()の正常系が網羅的（TC-001～TC-005）
  - true/1の場合のtrueパターン（TC-001, TC-002）
  - false/0/未設定の場合のfalseパターン（TC-003, TC-004, TC-005）
- BasePhase.loadPrompt()の正常系が十分（TC-011～TC-014）
  - 環境情報注入あり（TC-011）
  - 環境情報注入なし（TC-012, TC-013）
  - テンプレート変数との統合（TC-014）
- クリティカルパス（Config → BasePhase → プロンプト生成）がすべてカバーされている
- デフォルト動作（環境変数未設定時のfalse）が明示的にテストされている（TC-005, TC-013）

**懸念点**:
- なし（主要な正常系は十分カバーされている）

### 3. 異常系のカバレッジ

**良好な点**:
- 境界値テストが充実している
  - 大文字小文字混在（TC-007: "TRUE"）
  - 前後の空白（TC-008: " true "）
  - 空文字列（TC-006）
- 不正な値の処理が適切にテストされている
  - 許可されていない文字列値（TC-009: "yes"）
  - 許可されていない数値（TC-010: "2"）
- 合計10件の環境変数パターンが網羅されており、Phase 2設計書の見積もり（約10件）と一致

**改善の余地**:
- 以下のエッジケースは追加を検討してもよいが、実装フェーズで補完可能なため必須ではない：
  - 特殊文字を含む値（例: "true\n"、"1;rm -rf /"等）
  - 非常に長い文字列値
  - ただし、これらは「80点で十分」の原則に基づき、スコープ外と判断するのが妥当

### 4. 期待結果の明確性

**良好な点**:
- すべてのテストケースに「期待結果」セクションが明記されている
- 検証項目が具体的（`expect(result).toBe(true)` 等）
- 実装例（TypeScriptコード）が各テストケースに含まれており、実装時の曖昧さがない
- Given/When/Thenパターンが一貫して使用されており、可読性が高い
- 前提条件が明確（環境変数の設定状態、テスト開始時の状態）

**懸念点**:
- なし（期待結果の記述は非常に明確）

### 5. 要件との対応

**良好な点**:
- 要件定義書（requirements.md）の受け入れ基準との対応が明確
  - AC-5（Config クラスの動作確認）: TC-001～TC-010でカバー
  - AC-6（プロンプト注入の動作確認）: TC-011～TC-015でカバー
- セクション6.2「テストカバレッジマトリクス」で要件との対応関係が明示されている
- 機能要件（FR-4: Config拡張、FR-5: プロンプト注入）がすべてテスト対象に含まれている
- 非機能要件（NFR-4: 後方互換性）もテストケースに反映されている（TC-005, TC-013）

**改善の余地**:
- なし（要件との対応は完璧）

### 6. 実行可能性

**良好な点**:
- テストデータが具体的に定義されている（各テストケースの「テストデータ」セクション）
- テスト環境要件が明記されている（セクション4: Node.js 20.x、Jest等）
- モック/スタブの必要性が明確に記載されている（セクション4.3）
  - プロンプトテンプレートファイルのモック化
  - WorkflowContextのモック
- テスト実行方法が具体的（セクション5: `npm test`、カバレッジ目標80%以上）
- テストスイート名、テストファイル名が明記されており、実装時の迷いがない

**懸念点**:
- なし（実行可能性は非常に高い）

## ブロッカー（BLOCKER）

**次フェーズに進めない重大な問題**

なし

## 改善提案（SUGGESTION）

**次フェーズに進めるが、改善が望ましい事項**

1. **TC-015（buildEnvironmentInfoSection）の扱いについて**
   - 現状: TC-015は`buildEnvironmentInfoSection()`がprivateメソッドであるため、直接テストせずにloadPrompt()経由でテストすることを推奨している
   - 提案: この方針は正しいが、テストシナリオ内で「TC-015は参考であり、実際にはTC-011～TC-014で十分カバーされる」ことを明示してもよい
   - 効果: 実装フェーズでの混乱を防ぎ、優先度を明確化できる

2. **テストカバレッジ目標の具体的な測定方法**
   - 現状: セクション5.3で「新規コードのカバレッジ80%以上」と記載されているが、測定方法は`npm run test:coverage`のみ
   - 提案: カバレッジレポートのどの指標（Statement/Branch/Function/Line）を重視するか明記してもよい
   - 効果: Phase 6（テスト実行）での判定基準が明確になる

3. **環境情報セクションの言語リストの拡張性**
   - 現状: Python、Go、Java、Rust、Rubyの5言語が固定されている
   - 提案: 将来的に言語リストを環境変数から読み込む等の拡張可能性について、テストシナリオに言及してもよい（ただしスコープ外として明記）
   - 効果: 設計の拡張性が明確になるが、現時点では不要

## 総合評価

テストシナリオは非常に高品質であり、次フェーズ（実装）に進むための要件を完全に満たしています。

**主な強み**:
- UNIT_ONLY戦略に完全準拠しており、テスト戦略との整合性が完璧
- 15件のテストケースが網羅的に定義されており、正常系・異常系・境界値がすべてカバーされている
- Given/When/Thenパターンが一貫して使用され、実装例も含まれているため、実装時の曖昧さがゼロ
- 要件定義書の受け入れ基準と完全に対応しており、トレーサビリティが高い
- テストカバレッジマトリクス（セクション6.2）により、機能要件とテストケースの対応が可視化されている
- Planning Documentとの整合性が完璧（見積もり「約10件」に対して15件のテストケースを提供）
- テスト環境要件、モック/スタブ、実行方法が具体的に記載されており、実行可能性が非常に高い

**主な改善提案**:
- TC-015の優先度を明示（ただし現状でも十分明確）
- カバレッジ測定の具体的な指標を明記（ただし実装フェーズで決定可能）
- 将来の拡張性についての言及（ただしスコープ外として適切に分離されている）

**総括コメント**:

本テストシナリオは、「80点で十分」の原則に基づいても、実際には**95点レベル**の品質に達しています。すべての品質ゲートを満たし、Planning Documentのすべてのタスクが完了しており、要件定義書の受け入れ基準と完全に対応しています。改善提案はすべて「nice-to-have」レベルであり、現状のまま実装フェーズに進んで全く問題ありません。

特に評価すべき点は、各テストケースに実装例（TypeScriptコード）が含まれていることです。これにより、実装フェーズでの解釈の相違や手戻りのリスクが最小化されています。また、テストカバレッジマトリクスにより、要件とテストケースの対応関係が明確であり、レビュー時および実装後の検証が容易になっています。

自信を持って次フェーズ（実装）に進むことを推奨します。

---
**判定: PASS_WITH_SUGGESTIONS**