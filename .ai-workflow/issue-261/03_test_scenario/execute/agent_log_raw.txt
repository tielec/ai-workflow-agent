{"type":"system","subtype":"init","cwd":"/tmp/ai-workflow-repos-11-92f1577c/ai-workflow-agent","session_id":"90421cfc-f915-42a9-95f1-8515a3d7f09d","tools":["Task","Bash","Glob","Grep","ExitPlanMode","Read","Edit","Write","NotebookEdit","WebFetch","TodoWrite","WebSearch","BashOutput","KillShell","Skill","SlashCommand"],"mcp_servers":[],"model":"claude-sonnet-4-5-20250929","permissionMode":"bypassPermissions","slash_commands":["compact","context","cost","init","output-style:new","pr-comments","release-notes","todos","review","security-review"],"apiKeySource":"none","claude_code_version":"2.0.21","output_style":"default","agents":["general-purpose","statusline-setup","output-style-setup","Explore"],"uuid":"7d264b3c-d38a-4de8-a3d7-e70f1d8889ce"}
{"type":"assistant","message":{"model":"claude-sonnet-4-5-20250929","id":"msg_01G5rewwkQtqd8j9zEUMDvPs","type":"message","role":"assistant","content":[{"type":"text","text":"I'll create comprehensive test scenarios for the finalize command based on the planning, requirements, and design documents."}],"stop_reason":null,"stop_sequence":null,"usage":{"input_tokens":2,"cache_creation_input_tokens":46421,"cache_read_input_tokens":12202,"cache_creation":{"ephemeral_5m_input_tokens":46421,"ephemeral_1h_input_tokens":0},"output_tokens":1,"service_tier":"standard"}},"parent_tool_use_id":null,"session_id":"90421cfc-f915-42a9-95f1-8515a3d7f09d","uuid":"7bb036c9-8af9-4ceb-90f2-404690939646"}
{"type":"assistant","message":{"model":"claude-sonnet-4-5-20250929","id":"msg_01G5rewwkQtqd8j9zEUMDvPs","type":"message","role":"assistant","content":[{"type":"tool_use","id":"toolu_01VXUEZpEQ7wpGmUvbsEjZGT","name":"Write","input":{"file_path":"/tmp/ai-workflow-repos-11-92f1577c/ai-workflow-agent/.ai-workflow/issue-261/03_test_scenario/output/test-scenario.md","content":"# テストシナリオ - Issue #261: feat(cli): Add finalize command for workflow completion\n\n**作成日**: 2025-01-30\n**Issue番号**: #261\n**Issue URL**: https://github.com/tielec/ai-workflow-agent/issues/261\n\n---\n\n## 目次\n\n1. [テスト戦略サマリー](#1-テスト戦略サマリー)\n2. [Unitテストシナリオ](#2-unitテストシナリオ)\n3. [Integrationテストシナリオ](#3-integrationテストシナリオ)\n4. [テストデータ](#4-テストデータ)\n5. [テスト環境要件](#5-テスト環境要件)\n6. [品質ゲートチェックリスト](#6-品質ゲートチェックリスト)\n\n---\n\n## 1. テスト戦略サマリー\n\n### 1.1 選択されたテスト戦略\n\n**テスト戦略**: **UNIT_INTEGRATION**\n\n（Phase 2 - 設計書より引用）\n\n### 1.2 テスト対象の範囲\n\n| テスト種別 | 対象範囲 |\n|-----------|---------|\n| **Unitテスト** | - `handleFinalizeCommand()` の各ステップロジック<br>- `PullRequestClient.markPRReady()` の新規メソッド<br>- `PullRequestClient.updateBaseBranch()` の新規メソッド<br>- `SquashManager.squashCommitsForFinalize()` の新規オーバーロード<br>- CLIオプションの挙動検証<br>- エラーハンドリングの検証 |\n| **Integrationテスト** | - 5ステップ全体の統合フロー<br>- `MetadataManager`, `ArtifactCleaner`, `SquashManager`, `PullRequestClient` の統合動作<br>- Git操作とGitHub API呼び出しの統合<br>- エンドツーエンドのワークフロー検証 |\n\n### 1.3 テストの目的\n\n1. **正確性の保証**: finalize コマンドが要件定義通りに動作することを検証\n2. **信頼性の確保**: エラーハンドリングが適切に機能することを検証\n3. **統合動作の検証**: 既存モジュールとの統合が正常に動作することを検証\n4. **リグレッション防止**: 既存の cleanup / execute コマンドへの影響がないことを確認\n\n---\n\n## 2. Unitテストシナリオ\n\n### 2.1 `handleFinalizeCommand()` - メイン関数\n\n#### UC-01: finalize_正常系_全ステップ実行\n\n- **目的**: 全5ステップが順次実行されることを検証\n- **前提条件**:\n  - metadata.json に base_commit が記録されている\n  - .ai-workflow/issue-123/ ディレクトリが存在する\n  - PR が存在する（Draft状態）\n- **入力**:\n  ```typescript\n  {\n    issue: \"123\",\n    dryRun: false,\n    skipSquash: false,\n    skipPrUpdate: false,\n    baseBranch: \"main\"\n  }\n  ```\n- **期待結果**:\n  - Step 1-5 が順次実行される\n  - 各ステップの成功ログが出力される\n  - 最終的に \"✅ Finalize completed successfully.\" が出力される\n  - exit code 0 で終了する\n- **テストデータ**: テストデータセット TD-01（後述）\n\n---\n\n#### UC-02: finalize_異常系_base_commit不在\n\n- **目的**: base_commit が存在しない場合にエラーが発生することを検証\n- **前提条件**: metadata.json に base_commit が存在しない\n- **入力**:\n  ```typescript\n  {\n    issue: \"123\",\n    dryRun: false,\n    skipSquash: false,\n    skipPrUpdate: false,\n    baseBranch: \"main\"\n  }\n  ```\n- **期待結果**:\n  - Step 1 でエラーが発生する\n  - エラーメッセージ: \"base_commit not found in metadata. Please ensure the workflow was initialized with the 'init' command.\"\n  - 処理が中断される\n  - exit code 1 で終了する\n- **テストデータ**: テストデータセット TD-02（後述）\n\n---\n\n#### UC-03: finalize_異常系_PR番号取得失敗\n\n- **目的**: PR が存在しない場合にエラーが発生することを検証\n- **前提条件**:\n  - metadata.json に base_commit が記録されている\n  - PR が存在しない\n- **入力**:\n  ```typescript\n  {\n    issue: \"123\",\n    dryRun: false,\n    skipSquash: false,\n    skipPrUpdate: false,\n    baseBranch: \"main\"\n  }\n  ```\n- **期待結果**:\n  - Step 4 でエラーが発生する\n  - エラーメッセージ: \"Pull request not found for issue #123\"\n  - 処理が中断される\n  - exit code 1 で終了する\n- **テストデータ**: テストデータセット TD-03（後述）\n\n---\n\n### 2.2 CLIオプションの挙動検証\n\n#### UC-04: dryRun_オプション_プレビュー表示\n\n- **目的**: --dry-run オプションでプレビューモードが動作することを検証\n- **前提条件**: metadata.json に base_commit が記録されている\n- **入力**:\n  ```typescript\n  {\n    issue: \"123\",\n    dryRun: true,\n    skipSquash: false,\n    skipPrUpdate: false,\n    baseBranch: \"main\"\n  }\n  ```\n- **期待結果**:\n  - プレビューログが出力される:\n    - \"[DRY RUN] Finalize preview:\"\n    - \"Steps to be executed:\"\n    - \"1. Retrieve base_commit from metadata\"\n    - \"2. Clean up workflow artifacts\"\n    - \"3. Squash commits from base_commit to HEAD\"\n    - \"4. Update PR body with final content\"\n    - \"5. Change PR base branch to 'main'\"\n    - \"6. Mark PR as ready for review\"\n  - 実際の削除・コミット・プッシュ・PR更新は実行されない\n  - exit code 0 で終了する\n- **テストデータ**: テストデータセット TD-01（後述）\n\n---\n\n#### UC-05: skipSquash_オプション_Step3スキップ\n\n- **目的**: --skip-squash オプションで Step 3 がスキップされることを検証\n- **前提条件**: metadata.json に base_commit が記録されている\n- **入力**:\n  ```typescript\n  {\n    issue: \"123\",\n    dryRun: false,\n    skipSquash: true,\n    skipPrUpdate: false,\n    baseBranch: \"main\"\n  }\n  ```\n- **期待結果**:\n  - Step 1-2 が実行される\n  - Step 3 がスキップされる\n  - ログ: \"Skipping commit squash (--skip-squash option)\"\n  - Step 4-5 が実行される\n  - exit code 0 で終了する\n- **テストデータ**: テストデータセット TD-01（後述）\n\n---\n\n#### UC-06: skipPrUpdate_オプション_Step4_5スキップ\n\n- **目的**: --skip-pr-update オプションで Step 4-5 がスキップされることを検証\n- **前提条件**: metadata.json に base_commit が記録されている\n- **入力**:\n  ```typescript\n  {\n    issue: \"123\",\n    dryRun: false,\n    skipSquash: false,\n    skipPrUpdate: true,\n    baseBranch: \"main\"\n  }\n  ```\n- **期待結果**:\n  - Step 1-3 が実行される\n  - Step 4-5 がスキップされる\n  - ログ: \"Skipping PR update and draft conversion (--skip-pr-update option)\"\n  - exit code 0 で終了する\n- **テストデータ**: テストデータセット TD-01（後述）\n\n---\n\n#### UC-07: baseBranch_オプション_develop指定\n\n- **目的**: --base-branch オプションでマージ先ブランチが変更されることを検証\n- **前提条件**:\n  - metadata.json に base_commit が記録されている\n  - PR が存在する\n- **入力**:\n  ```typescript\n  {\n    issue: \"123\",\n    dryRun: false,\n    skipSquash: false,\n    skipPrUpdate: false,\n    baseBranch: \"develop\"\n  }\n  ```\n- **期待結果**:\n  - Step 4 で `updateBaseBranch(\"develop\")` が呼び出される\n  - ログ: \"✅ PR #456 base branch changed to 'develop'.\"\n  - exit code 0 で終了する\n- **テストデータ**: テストデータセット TD-01（後述）\n\n---\n\n### 2.3 `validateFinalizeOptions()` - バリデーション\n\n#### UC-08: validation_異常系_issue番号なし\n\n- **目的**: --issue オプションが指定されていない場合にエラーが発生することを検証\n- **前提条件**: なし\n- **入力**:\n  ```typescript\n  {\n    issue: \"\",\n    dryRun: false,\n    skipSquash: false,\n    skipPrUpdate: false,\n    baseBranch: \"main\"\n  }\n  ```\n- **期待結果**:\n  - エラーメッセージ: \"Error: --issue option is required\"\n  - exit code 1 で終了する\n- **テストデータ**: なし\n\n---\n\n#### UC-09: validation_異常系_issue番号が不正\n\n- **目的**: --issue に不正な値が指定された場合にエラーが発生することを検証\n- **前提条件**: なし\n- **入力**:\n  ```typescript\n  {\n    issue: \"abc\",\n    dryRun: false,\n    skipSquash: false,\n    skipPrUpdate: false,\n    baseBranch: \"main\"\n  }\n  ```\n- **期待結果**:\n  - エラーメッセージ: \"Error: Invalid issue number: abc. Must be a positive integer.\"\n  - exit code 1 で終了する\n- **テストデータ**: なし\n\n---\n\n#### UC-10: validation_異常系_baseBranchが空文字\n\n- **目的**: --base-branch に空文字が指定された場合にエラーが発生することを検証\n- **前提条件**: なし\n- **入力**:\n  ```typescript\n  {\n    issue: \"123\",\n    dryRun: false,\n    skipSquash: false,\n    skipPrUpdate: false,\n    baseBranch: \"\"\n  }\n  ```\n- **期待結果**:\n  - エラーメッセージ: \"Error: --base-branch cannot be empty\"\n  - exit code 1 で終了する\n- **テストデータ**: なし\n\n---\n\n### 2.4 `executeStep1()` - base_commit取得\n\n#### UC-11: step1_正常系_base_commit取得成功\n\n- **目的**: base_commit が正常に取得されることを検証\n- **前提条件**: metadata.json に base_commit が \"abc123def456\" として記録されている\n- **入力**: MetadataManager のモックインスタンス\n- **期待結果**:\n  - `metadataManager.getBaseCommit()` が呼び出される\n  - \"abc123def456\" が返される\n  - ログ: \"base_commit: abc123def456\"\n- **テストデータ**: テストデータセット TD-01（後述）\n\n---\n\n#### UC-12: step1_異常系_base_commit不在\n\n- **目的**: base_commit が存在しない場合にエラーが発生することを検証\n- **前提条件**: metadata.json に base_commit が存在しない\n- **入力**: MetadataManager のモックインスタンス（getBaseCommit() が null を返す）\n- **期待結果**:\n  - エラーがスローされる\n  - エラーメッセージ: \"base_commit not found in metadata. Please ensure the workflow was initialized with the 'init' command.\"\n- **テストデータ**: テストデータセット TD-02（後述）\n\n---\n\n### 2.5 `executeStep2()` - ディレクトリ削除\n\n#### UC-13: step2_正常系_ディレクトリ削除成功\n\n- **目的**: ワークフローディレクトリが削除され、コミット・プッシュされることを検証\n- **前提条件**:\n  - .ai-workflow/issue-123/ ディレクトリが存在する\n  - Git リポジトリが初期化されている\n- **入力**:\n  - metadataManager: MetadataManager のモックインスタンス\n  - workflowDir: \"/path/to/repo\"\n  - options: { issue: \"123\", ... }\n- **期待結果**:\n  - `artifactCleaner.cleanupWorkflowArtifacts(true)` が呼び出される\n  - `gitManager.commitCleanupLogs(123, 'finalize')` が呼び出される\n  - `gitManager.pushToRemote()` が呼び出される\n  - ログ: \"Cleanup committed: <commit_hash>\"\n  - ログ: \"✅ Step 2 completed: Workflow artifacts cleaned up.\"\n- **テストデータ**: テストデータセット TD-01（後述）\n\n---\n\n#### UC-14: step2_異常系_コミット失敗\n\n- **目的**: コミット失敗時にエラーが発生することを検証\n- **前提条件**: Git コミットが失敗する状態\n- **入力**:\n  - metadataManager: MetadataManager のモックインスタンス\n  - workflowDir: \"/path/to/repo\"\n  - options: { issue: \"123\", ... }\n- **期待結果**:\n  - `gitManager.commitCleanupLogs()` が失敗を返す\n  - エラーがスローされる\n  - エラーメッセージ: \"Commit failed\"\n- **テストデータ**: テストデータセット TD-01（後述）\n\n---\n\n#### UC-15: step2_異常系_プッシュ失敗\n\n- **目的**: プッシュ失敗時にエラーが発生することを検証\n- **前提条件**: Git プッシュが失敗する状態\n- **入力**:\n  - metadataManager: MetadataManager のモックインスタンス\n  - workflowDir: \"/path/to/repo\"\n  - options: { issue: \"123\", ... }\n- **期待結果**:\n  - `gitManager.pushToRemote()` が失敗を返す\n  - エラーがスローされる\n  - エラーメッセージ: \"Push failed\"\n- **テストデータ**: テストデータセット TD-01（後述）\n\n---\n\n### 2.6 `executeStep3()` - コミットスカッシュ\n\n#### UC-16: step3_正常系_スカッシュ成功\n\n- **目的**: コミットスカッシュが正常に実行されることを検証\n- **前提条件**:\n  - base_commit から HEAD までに複数のコミットが存在する\n- **入力**:\n  - metadataManager: MetadataManager のモックインスタンス\n  - workflowDir: \"/path/to/repo\"\n  - baseCommit: \"abc123def456\"\n  - options: { issue: \"123\", ... }\n- **期待結果**:\n  - `squashManager.squashCommitsForFinalize()` が呼び出される\n  - FinalizeContext が以下の内容で渡される:\n    ```typescript\n    {\n      issueNumber: 123,\n      baseCommit: \"abc123def456\",\n      targetBranch: \"main\"\n    }\n    ```\n  - ログ: \"✅ Step 3 completed: Commits squashed.\"\n- **テストデータ**: テストデータセット TD-01（後述）\n\n---\n\n#### UC-17: step3_異常系_スカッシュ失敗\n\n- **目的**: スカッシュ失敗時にエラーが発生することを検証\n- **前提条件**: スカッシュが失敗する状態（例: ブランチ保護違反）\n- **入力**:\n  - metadataManager: MetadataManager のモックインスタンス\n  - workflowDir: \"/path/to/repo\"\n  - baseCommit: \"abc123def456\"\n  - options: { issue: \"123\", ... }\n- **期待結果**:\n  - `squashManager.squashCommitsForFinalize()` がエラーをスローする\n  - エラーがハンドラに伝播される\n- **テストデータ**: テストデータセット TD-01（後述）\n\n---\n\n### 2.7 `executeStep4And5()` - PR更新とドラフト解除\n\n#### UC-18: step4_5_正常系_PR更新とドラフト解除成功\n\n- **目的**: PR 本文更新、マージ先変更、ドラフト解除が正常に実行されることを検証\n- **前提条件**:\n  - PR #456 が存在する（Draft状態）\n  - Issue #123 に対応する PR が存在する\n- **入力**:\n  - metadataManager: MetadataManager のモックインスタンス\n  - options: { issue: \"123\", baseBranch: \"develop\", ... }\n- **期待結果**:\n  - `prClient.getPullRequestNumber(123)` が 456 を返す\n  - `prClient.updatePullRequest(456, <PR本文>)` が呼び出される\n  - `prClient.updateBaseBranch(456, \"develop\")` が呼び出される\n  - `prClient.markPRReady(456)` が呼び出される\n  - ログ: \"✅ PR #456 updated with final content.\"\n  - ログ: \"✅ PR #456 base branch changed to 'develop'.\"\n  - ログ: \"✅ PR #456 marked as ready for review.\"\n- **テストデータ**: テストデータセット TD-01（後述）\n\n---\n\n#### UC-19: step4_5_異常系_PR番号取得失敗\n\n- **目的**: PR 番号が取得できない場合にエラーが発生することを検証\n- **前提条件**: Issue #123 に対応する PR が存在しない\n- **入力**:\n  - metadataManager: MetadataManager のモックインスタンス\n  - options: { issue: \"123\", ... }\n- **期待結果**:\n  - `prClient.getPullRequestNumber(123)` が null を返す\n  - エラーがスローされる\n  - エラーメッセージ: \"Pull request not found for issue #123\"\n- **テストデータ**: テストデータセット TD-03（後述）\n\n---\n\n#### UC-20: step4_5_異常系_PR更新失敗\n\n- **目的**: PR 更新失敗時にエラーが発生することを検証\n- **前提条件**: PR 更新 API が失敗する状態\n- **入力**:\n  - metadataManager: MetadataManager のモックインスタンス\n  - options: { issue: \"123\", ... }\n- **期待結果**:\n  - `prClient.updatePullRequest()` が失敗を返す\n  - エラーがスローされる\n  - エラーメッセージ: \"Failed to update PR: <error>\"\n- **テストデータ**: テストデータセット TD-01（後述）\n\n---\n\n#### UC-21: step4_5_異常系_ドラフト解除失敗\n\n- **目的**: ドラフト解除失敗時にエラーが発生することを検証\n- **前提条件**: ドラフト解除 API が失敗する状態\n- **入力**:\n  - metadataManager: MetadataManager のモックインスタンス\n  - options: { issue: \"123\", ... }\n- **期待結果**:\n  - `prClient.markPRReady()` が失敗を返す\n  - エラーがスローされる\n  - エラーメッセージ: \"Failed to mark PR as ready: <error>\"\n- **テストデータ**: テストデータセット TD-01（後述）\n\n---\n\n### 2.8 `PullRequestClient.markPRReady()` - ドラフト解除\n\n#### UC-22: markPRReady_正常系_GraphQL成功\n\n- **目的**: GraphQL mutation によるドラフト解除が成功することを検証\n- **前提条件**: PR #456 が Draft 状態\n- **入力**: prNumber = 456\n- **期待結果**:\n  - `octokit.pulls.get()` が呼び出され、node_id が取得される\n  - GraphQL mutation が実行される\n  - レスポンスの `isDraft` が false になる\n  - { success: true, error: null } が返される\n  - ログ: \"PR #456 marked as ready for review.\"\n- **テストデータ**: テストデータセット TD-04（後述）\n\n---\n\n#### UC-23: markPRReady_正常系_ghコマンドフォールバック\n\n- **目的**: GraphQL 失敗時に gh コマンドへのフォールバックが動作することを検証\n- **前提条件**:\n  - PR #456 が Draft 状態\n  - GraphQL mutation が失敗する\n- **入力**: prNumber = 456\n- **期待結果**:\n  - GraphQL mutation が失敗する\n  - ログ: \"GraphQL mutation failed, attempting fallback: <error>\"\n  - `gh pr ready 456` コマンドが実行される\n  - { success: true, error: null } が返される\n  - ログ: \"PR #456 marked as ready via gh command.\"\n- **テストデータ**: テストデータセット TD-04（後述）\n\n---\n\n#### UC-24: markPRReady_異常系_両方失敗\n\n- **目的**: GraphQL と gh コマンドの両方が失敗した場合にエラーが返されることを検証\n- **前提条件**:\n  - GraphQL mutation が失敗する\n  - gh コマンドも失敗する\n- **入力**: prNumber = 456\n- **期待結果**:\n  - GraphQL mutation が失敗する\n  - gh コマンドが失敗する\n  - { success: false, error: \"<error message>\" } が返される\n  - ログ: \"Failed to mark PR as ready: <error>\"\n- **テストデータ**: テストデータセット TD-04（後述）\n\n---\n\n#### UC-25: markPRReady_異常系_node_id取得失敗\n\n- **目的**: PR の node_id 取得失敗時にエラーが返されることを検証\n- **前提条件**: PR が存在するが node_id が null\n- **入力**: prNumber = 456\n- **期待結果**:\n  - `octokit.pulls.get()` が node_id なしのレスポンスを返す\n  - { success: false, error: \"PR node_id not found\" } が返される\n- **テストデータ**: テストデータセット TD-05（後述）\n\n---\n\n### 2.9 `PullRequestClient.updateBaseBranch()` - マージ先変更\n\n#### UC-26: updateBaseBranch_正常系_develop変更成功\n\n- **目的**: マージ先ブランチが develop に変更されることを検証\n- **前提条件**: PR #456 が存在する\n- **入力**: prNumber = 456, baseBranch = \"develop\"\n- **期待結果**:\n  - `octokit.pulls.update()` が以下のパラメータで呼び出される:\n    ```typescript\n    {\n      owner: \"tielec\",\n      repo: \"ai-workflow-agent\",\n      pull_number: 456,\n      base: \"develop\"\n    }\n    ```\n  - { success: true, error: null } が返される\n  - ログ: \"PR #456 base branch changed to 'develop'.\"\n- **テストデータ**: テストデータセット TD-04（後述）\n\n---\n\n#### UC-27: updateBaseBranch_異常系_ブランチ不在\n\n- **目的**: 存在しないブランチが指定された場合にエラーが返されることを検証\n- **前提条件**: \"nonexistent\" ブランチが存在しない\n- **入力**: prNumber = 456, baseBranch = \"nonexistent\"\n- **期待結果**:\n  - `octokit.pulls.update()` が GitHub API エラーを返す（422 Unprocessable Entity）\n  - { success: false, error: \"GitHub API error: 422 - ...\" } が返される\n  - ログ: \"Failed to update base branch: ...\"\n- **テストデータ**: テストデータセット TD-04（後述）\n\n---\n\n#### UC-28: updateBaseBranch_異常系_権限不足\n\n- **目的**: 権限不足時にエラーが返されることを検証\n- **前提条件**: GitHub Token に repo 権限がない\n- **入力**: prNumber = 456, baseBranch = \"develop\"\n- **期待結果**:\n  - `octokit.pulls.update()` が GitHub API エラーを返す（403 Forbidden）\n  - { success: false, error: \"GitHub API error: 403 - ...\" } が返される\n  - ログ: \"Failed to update base branch: ...\"\n- **テストデータ**: テストデータセット TD-04（後述）\n\n---\n\n### 2.10 `SquashManager.squashCommitsForFinalize()` - スカッシュ\n\n#### UC-29: squashCommitsForFinalize_正常系_複数コミットスカッシュ\n\n- **目的**: 複数のコミットが正常にスカッシュされることを検証\n- **前提条件**:\n  - base_commit から HEAD までに 5 つのコミットが存在する\n- **入力**:\n  ```typescript\n  {\n    issueNumber: 123,\n    baseCommit: \"abc123def456\",\n    targetBranch: \"main\"\n  }\n  ```\n- **期待結果**:\n  - `getCommitsToSquash()` が 5 つのコミットを返す\n  - ログ: \"Found 5 commits to squash.\"\n  - `validateBranchProtection()` が呼び出される\n  - `metadataManager.setPreSquashCommits()` が呼び出される\n  - `generateFinalizeMessage()` が呼び出され、以下のメッセージが生成される:\n    ```\n    feat: Complete workflow for Issue #123\n\n    AI Workflow finalization completed.\n\n    Fixes #123\n    ```\n  - `executeSquash()` が呼び出される\n  - `metadataManager.setSquashedAt()` が呼び出される\n  - ログ: \"✅ Commit squash completed successfully.\"\n- **テストデータ**: テストデータセット TD-06（後述）\n\n---\n\n#### UC-30: squashCommitsForFinalize_正常系_1コミットのみスキップ\n\n- **目的**: コミット数が 1 以下の場合にスカッシュがスキップされることを検証\n- **前提条件**: base_commit から HEAD までに 1 つのコミットのみ存在する\n- **入力**:\n  ```typescript\n  {\n    issueNumber: 123,\n    baseCommit: \"abc123def456\",\n    targetBranch: \"main\"\n  }\n  ```\n- **期待結果**:\n  - `getCommitsToSquash()` が 1 つのコミットを返す\n  - ログ: \"Only 1 commit(s) found. Skipping squash.\"\n  - スカッシュ処理がスキップされる\n- **テストデータ**: テストデータセット TD-07（後述）\n\n---\n\n#### UC-31: squashCommitsForFinalize_異常系_ブランチ保護違反\n\n- **目的**: ブランチ保護違反時にエラーがスローされることを検証\n- **前提条件**: 現在のブランチが main / master\n- **入力**:\n  ```typescript\n  {\n    issueNumber: 123,\n    baseCommit: \"abc123def456\",\n    targetBranch: \"main\"\n  }\n  ```\n- **期待結果**:\n  - `validateBranchProtection()` がエラーをスローする\n  - エラーメッセージ: \"Cannot squash commits on protected branch: main\"\n  - ログ: \"❌ Commit squash failed: ...\"\n- **テストデータ**: テストデータセット TD-06（後述）\n\n---\n\n### 2.11 `generateFinalPrBody()` - PR本文生成\n\n#### UC-32: generateFinalPrBody_正常系_全フェーズ完了\n\n- **目的**: 全フェーズ完了時の PR 本文が正しく生成されることを検証\n- **前提条件**: すべてのフェーズ（planning〜evaluation）が completed 状態\n- **入力**:\n  - metadataManager: MetadataManager のモックインスタンス（TD-08）\n  - issueNumber: 123\n- **期待結果**:\n  - 以下の内容を含む Markdown 形式の本文が返される:\n    - \"## 変更サマリー\"\n    - \"- Issue番号: #123\"\n    - \"- タイトル: feat(cli): Add finalize command\"\n    - \"- 完了ステータス: All phases completed\"\n    - \"## フェーズステータス\"\n    - \"- ✅ planning: completed\"\n    - \"- ✅ requirements: completed\"\n    - （以下、全フェーズの completed ステータス）\n    - \"## テスト結果\"\n    - \"✅ Passed\"\n    - \"## クリーンアップ状況\"\n    - \"- ✅ ワークフローディレクトリ削除済み\"\n    - \"- ✅ コミットスカッシュ完了\"\n- **テストデータ**: テストデータセット TD-08（後述）\n\n---\n\n#### UC-33: generateFinalPrBody_正常系_一部フェーズ未完了\n\n- **目的**: 一部フェーズが未完了の場合でも PR 本文が生成されることを検証\n- **前提条件**: testing フェーズのみ pending 状態\n- **入力**:\n  - metadataManager: MetadataManager のモックインスタンス（TD-09）\n  - issueNumber: 123\n- **期待結果**:\n  - 以下の内容を含む Markdown 形式の本文が返される:\n    - \"- ⏳ testing: pending\"\n    - \"## テスト結果\"\n    - \"⏳ Pending\"\n- **テストデータ**: テストデータセット TD-09（後述）\n\n---\n\n### 2.12 `previewFinalize()` - プレビューモード\n\n#### UC-34: previewFinalize_正常系_全ステップ表示\n\n- **目的**: ドライランモードで全ステップのプレビューが表示されることを検証\n- **前提条件**: なし\n- **入力**:\n  ```typescript\n  {\n    issue: \"123\",\n    dryRun: true,\n    skipSquash: false,\n    skipPrUpdate: false,\n    baseBranch: \"main\"\n  }\n  ```\n- **期待結果**:\n  - 以下のログが出力される:\n    - \"[DRY RUN] Finalize preview:\"\n    - \"Steps to be executed:\"\n    - \"  1. Retrieve base_commit from metadata\"\n    - \"  2. Clean up workflow artifacts (.ai-workflow/issue-<NUM>/)\"\n    - \"  3. Squash commits from base_commit to HEAD\"\n    - \"  4. Update PR body with final content\"\n    - \"  6. Mark PR as ready for review (convert from draft)\"\n    - \"[DRY RUN] No changes were made. Remove --dry-run to execute.\"\n- **テストデータ**: テストデータセット TD-01（後述）\n\n---\n\n#### UC-35: previewFinalize_正常系_スキップオプション反映\n\n- **目的**: スキップオプションがプレビューに反映されることを検証\n- **前提条件**: なし\n- **入力**:\n  ```typescript\n  {\n    issue: \"123\",\n    dryRun: true,\n    skipSquash: true,\n    skipPrUpdate: true,\n    baseBranch: \"main\"\n  }\n  ```\n- **期待結果**:\n  - 以下のログが出力される:\n    - \"  3. [SKIPPED] Squash commits (--skip-squash)\"\n    - \"  4-6. [SKIPPED] PR update and draft conversion (--skip-pr-update)\"\n- **テストデータ**: テストデータセット TD-01（後述）\n\n---\n\n## 3. Integrationテストシナリオ\n\n### 3.1 エンドツーエンドフロー\n\n#### IT-01: 統合テスト_正常系_全ステップ完全実行\n\n- **目的**: finalize コマンド全体が正常に動作することを検証\n- **前提条件**:\n  - Git リポジトリが初期化されている\n  - Issue #123 のワークフローが完了している（Evaluation Phase = completed）\n  - metadata.json に base_commit が記録されている\n  - .ai-workflow/issue-123/ ディレクトリが存在する\n  - PR #456 が Draft 状態で存在する\n  - GitHub Token が環境変数 GITHUB_TOKEN に設定されている\n- **テスト手順**:\n  1. `ai-workflow finalize --issue 123` を実行\n  2. 各ステップの実行をモニタリング\n  3. 最終状態を確認\n- **期待結果**:\n  - **Step 1**: base_commit が取得される\n  - **Step 2**: .ai-workflow/issue-123/ が削除され、コミット・プッシュされる\n  - **Step 3**: base_commit から HEAD までのコミットがスカッシュされ、強制プッシュされる\n  - **Step 4**: PR #456 の本文が最終版に更新される\n  - **Step 5**: PR #456 が Ready for Review 状態になる\n  - コマンド全体が成功終了（exit code 0）\n- **確認項目**:\n  - [ ] .ai-workflow/issue-123/ ディレクトリが削除されている\n  - [ ] Git ログにクリーンアップコミットが存在する\n  - [ ] Git ログにスカッシュコミットが存在する（\"feat: Complete workflow for Issue #123\"）\n  - [ ] PR #456 の本文が更新されている\n  - [ ] PR #456 が Draft 解除されている\n  - [ ] metadata.json の pre_squash_commits にスカッシュ前のコミット履歴が記録されている\n  - [ ] metadata.json の squashed_at にタイムスタンプが記録されている\n\n---\n\n#### IT-02: 統合テスト_正常系_develop指定\n\n- **目的**: --base-branch オプションでマージ先ブランチが変更されることを検証\n- **前提条件**:\n  - Git リポジトリが初期化されている\n  - develop ブランチが存在する\n  - PR #456 が存在する\n- **テスト手順**:\n  1. `ai-workflow finalize --issue 123 --base-branch develop` を実行\n  2. PR の base ブランチを確認\n- **期待結果**:\n  - Step 4 で PR #456 のマージ先ブランチが develop に変更される\n  - GitHub API でマージ先が develop になっていることを確認\n- **確認項目**:\n  - [ ] PR #456 の base ブランチが develop になっている\n\n---\n\n#### IT-03: 統合テスト_正常系_skip-squash\n\n- **目的**: --skip-squash オプションでスカッシュがスキップされることを検証\n- **前提条件**:\n  - Git リポジトリが初期化されている\n  - base_commit から HEAD までに複数のコミットが存在する\n- **テスト手順**:\n  1. `ai-workflow finalize --issue 123 --skip-squash` を実行\n  2. Git ログを確認\n- **期待結果**:\n  - Step 1-2 が実行される\n  - Step 3 がスキップされる\n  - Step 4-5 が実行される\n  - Git ログのコミット数が変わらない（スカッシュされていない）\n- **確認項目**:\n  - [ ] Git ログに複数のコミットが残っている（スカッシュされていない）\n  - [ ] .ai-workflow/issue-123/ ディレクトリが削除されている\n  - [ ] PR #456 が Draft 解除されている\n\n---\n\n#### IT-04: 統合テスト_正常系_skip-pr-update\n\n- **目的**: --skip-pr-update オプションで PR 更新がスキップされることを検証\n- **前提条件**:\n  - Git リポジトリが初期化されている\n  - PR #456 が Draft 状態で存在する\n- **テスト手順**:\n  1. PR #456 の初期状態を記録\n  2. `ai-workflow finalize --issue 123 --skip-pr-update` を実行\n  3. PR #456 の状態を確認\n- **期待結果**:\n  - Step 1-3 が実行される\n  - Step 4-5 がスキップされる\n  - PR #456 の本文・ドラフト状態が変更されていない\n- **確認項目**:\n  - [ ] .ai-workflow/issue-123/ ディレクトリが削除されている\n  - [ ] コミットがスカッシュされている\n  - [ ] PR #456 の本文が更新されていない\n  - [ ] PR #456 が Draft のまま（解除されていない）\n\n---\n\n### 3.2 エラーハンドリング統合テスト\n\n#### IT-05: 統合テスト_異常系_base_commit不在でエラー終了\n\n- **目的**: base_commit 不在時にエラーで終了することを検証\n- **前提条件**:\n  - metadata.json に base_commit が記録されていない\n- **テスト手順**:\n  1. `ai-workflow finalize --issue 123` を実行\n  2. エラーメッセージを確認\n- **期待結果**:\n  - Step 1 でエラーが発生\n  - エラーメッセージ: \"base_commit not found in metadata. Please ensure the workflow was initialized with the 'init' command.\"\n  - exit code 1 で終了\n  - 後続の Step 2-5 は実行されない\n- **確認項目**:\n  - [ ] .ai-workflow/issue-123/ ディレクトリが削除されていない\n  - [ ] Git ログに変更がない\n  - [ ] PR #456 に変更がない\n\n---\n\n#### IT-06: 統合テスト_異常系_PR不在でエラー終了\n\n- **目的**: PR 不在時にエラーで終了することを検証\n- **前提条件**:\n  - metadata.json に base_commit が記録されている\n  - Issue #123 に対応する PR が存在しない\n- **テスト手順**:\n  1. `ai-workflow finalize --issue 123` を実行\n  2. エラーメッセージを確認\n- **期待結果**:\n  - Step 1-3 が実行される\n  - Step 4 でエラーが発生\n  - エラーメッセージ: \"Pull request not found for issue #123\"\n  - exit code 1 で終了\n  - Step 5 は実行されない\n- **確認項目**:\n  - [ ] .ai-workflow/issue-123/ ディレクトリが削除されている\n  - [ ] コミットがスカッシュされている\n  - [ ] PR 更新・ドラフト解除は実行されていない\n\n---\n\n#### IT-07: 統合テスト_異常系_GitHub_API権限不足\n\n- **目的**: GitHub API 権限不足時にエラーで終了することを検証\n- **前提条件**:\n  - GitHub Token に repo 権限がない\n  - PR #456 が存在する\n- **テスト手順**:\n  1. `ai-workflow finalize --issue 123` を実行\n  2. エラーメッセージを確認\n- **期待結果**:\n  - Step 4 または Step 5 で GitHub API エラーが発生\n  - エラーメッセージに \"GitHub API error: 403\" が含まれる\n  - exit code 1 で終了\n- **確認項目**:\n  - [ ] エラーログに権限不足のメッセージが含まれている\n  - [ ] PR #456 に変更がない（または一部のみ更新）\n\n---\n\n### 3.3 既存コマンドへの影響確認\n\n#### IT-08: 統合テスト_既存影響なし_cleanup正常動作\n\n- **目的**: finalize コマンド追加後も cleanup コマンドが正常動作することを検証\n- **前提条件**:\n  - finalize コマンドが実装されている\n  - .ai-workflow/issue-123/ ディレクトリが存在する\n- **テスト手順**:\n  1. `ai-workflow cleanup --issue 123 --phase all` を実行\n  2. 動作を確認\n- **期待結果**:\n  - cleanup コマンドが正常に実行される\n  - .ai-workflow/issue-123/ ディレクトリが削除される\n  - エラーが発生しない\n- **確認項目**:\n  - [ ] cleanup コマンドがエラーなく実行される\n  - [ ] .ai-workflow/issue-123/ ディレクトリが削除されている\n\n---\n\n#### IT-09: 統合テスト_既存影響なし_execute正常動作\n\n- **目的**: finalize コマンド追加後も execute コマンドが正常動作することを検証\n- **前提条件**:\n  - finalize コマンドが実装されている\n  - Job DSL の SQUASH_ON_COMPLETE デフォルト値が false に変更されている\n- **テスト手順**:\n  1. `ai-workflow execute --issue 123 --phase planning` を実行\n  2. 動作を確認\n- **期待結果**:\n  - execute コマンドが正常に実行される\n  - --squash-on-complete オプションが未指定の場合、スカッシュが実行されない（デフォルト = false）\n  - エラーが発生しない\n- **確認項目**:\n  - [ ] execute コマンドがエラーなく実行される\n  - [ ] スカッシュが実行されていない（デフォルト動作）\n\n---\n\n### 3.4 モジュール統合テスト\n\n#### IT-10: 統合テスト_モジュール連携_MetadataManager連携\n\n- **目的**: MetadataManager との連携が正常に動作することを検証\n- **前提条件**:\n  - metadata.json が存在する\n  - base_commit が記録されている\n- **テスト手順**:\n  1. `ai-workflow finalize --issue 123` を実行\n  2. metadata.json の変更を確認\n- **期待結果**:\n  - MetadataManager.getBaseCommit() が正しく呼び出される\n  - MetadataManager.setPreSquashCommits() が呼び出され、スカッシュ前のコミット履歴が記録される\n  - MetadataManager.setSquashedAt() が呼び出され、タイムスタンプが記録される\n- **確認項目**:\n  - [ ] metadata.json の pre_squash_commits にコミット履歴が記録されている\n  - [ ] metadata.json の squashed_at にタイムスタンプが記録されている\n\n---\n\n#### IT-11: 統合テスト_モジュール連携_ArtifactCleaner連携\n\n- **目的**: ArtifactCleaner との連携が正常に動作することを検証\n- **前提条件**:\n  - .ai-workflow/issue-123/ ディレクトリが存在する\n- **テスト手順**:\n  1. `ai-workflow finalize --issue 123` を実行\n  2. ディレクトリの削除を確認\n- **期待結果**:\n  - ArtifactCleaner.cleanupWorkflowArtifacts(true) が呼び出される\n  - .ai-workflow/issue-123/ ディレクトリが削除される\n- **確認項目**:\n  - [ ] .ai-workflow/issue-123/ ディレクトリが削除されている\n  - [ ] Git ログにクリーンアップコミットが存在する\n\n---\n\n#### IT-12: 統合テスト_モジュール連携_SquashManager連携\n\n- **目的**: SquashManager との連携が正常に動作することを検証\n- **前提条件**:\n  - base_commit から HEAD までに複数のコミットが存在する\n- **テスト手順**:\n  1. `ai-workflow finalize --issue 123` を実行\n  2. スカッシュ結果を確認\n- **期待結果**:\n  - SquashManager.squashCommitsForFinalize() が呼び出される\n  - FinalizeContext が正しく渡される\n  - コミットがスカッシュされる\n  - \"feat: Complete workflow for Issue #123\" というメッセージのコミットが作成される\n- **確認項目**:\n  - [ ] Git ログにスカッシュコミットが存在する\n  - [ ] コミットメッセージが \"feat: Complete workflow for Issue #123\" になっている\n  - [ ] コミット数が 1 になっている（スカッシュ成功）\n\n---\n\n#### IT-13: 統合テスト_モジュール連携_PullRequestClient連携\n\n- **目的**: PullRequestClient との連携が正常に動作することを検証\n- **前提条件**:\n  - PR #456 が Draft 状態で存在する\n- **テスト手順**:\n  1. `ai-workflow finalize --issue 123` を実行\n  2. PR の状態を確認\n- **期待結果**:\n  - PullRequestClient.getPullRequestNumber() が呼び出される\n  - PullRequestClient.updatePullRequest() が呼び出される\n  - PullRequestClient.updateBaseBranch() が呼び出される（--base-branch 指定時）\n  - PullRequestClient.markPRReady() が呼び出される\n  - PR #456 が Ready for Review 状態になる\n- **確認項目**:\n  - [ ] PR #456 の本文が更新されている\n  - [ ] PR #456 が Draft 解除されている\n  - [ ] PR #456 のマージ先ブランチが正しい（--base-branch 指定時）\n\n---\n\n## 4. テストデータ\n\n### TD-01: 正常系テストデータ（基本）\n\n**metadata.json**:\n```json\n{\n  \"issue_number\": 123,\n  \"base_commit\": \"abc123def456\",\n  \"issue_info\": {\n    \"title\": \"feat(cli): Add finalize command\",\n    \"state\": \"open\"\n  },\n  \"phases\": {\n    \"planning\": { \"status\": \"completed\" },\n    \"requirements\": { \"status\": \"completed\" },\n    \"design\": { \"status\": \"completed\" },\n    \"test_scenario\": { \"status\": \"completed\" },\n    \"implementation\": { \"status\": \"completed\" },\n    \"test_implementation\": { \"status\": \"completed\" },\n    \"testing\": { \"status\": \"completed\" },\n    \"documentation\": { \"status\": \"completed\" },\n    \"report\": { \"status\": \"completed\" },\n    \"evaluation\": { \"status\": \"completed\" }\n  }\n}\n```\n\n**Git リポジトリ状態**:\n- base_commit: abc123def456\n- HEAD までに 5 つのコミットが存在\n- 現在のブランチ: feature/issue-123\n- リモート: origin\n\n**PR 状態**:\n- PR番号: 456\n- 状態: Draft\n- マージ先: main\n\n**ディレクトリ構造**:\n```\n.ai-workflow/\n└── issue-123/\n    ├── 00_planning/\n    ├── 01_requirements/\n    └── ...\n```\n\n---\n\n### TD-02: 異常系テストデータ（base_commit不在）\n\n**metadata.json**:\n```json\n{\n  \"issue_number\": 123,\n  \"issue_info\": {\n    \"title\": \"feat(cli): Add finalize command\",\n    \"state\": \"open\"\n  },\n  \"phases\": {\n    \"planning\": { \"status\": \"completed\" }\n  }\n}\n```\n\n**注意**: base_commit フィールドが存在しない\n\n---\n\n### TD-03: 異常系テストデータ（PR不在）\n\n**metadata.json**: TD-01 と同じ\n\n**PR 状態**: Issue #123 に対応する PR が存在しない\n\n---\n\n### TD-04: PullRequestClient テストデータ\n\n**PR 情報**:\n```json\n{\n  \"number\": 456,\n  \"node_id\": \"PR_kwDOABCD1234\",\n  \"draft\": true,\n  \"base\": {\n    \"ref\": \"main\"\n  }\n}\n```\n\n**GitHub API レスポンス（markPRReady成功）**:\n```json\n{\n  \"markPullRequestReadyForReview\": {\n    \"pullRequest\": {\n      \"isDraft\": false\n    }\n  }\n}\n```\n\n---\n\n### TD-05: 異常系テストデータ（node_id不在）\n\n**PR 情報**:\n```json\n{\n  \"number\": 456,\n  \"node_id\": null,\n  \"draft\": true\n}\n```\n\n---\n\n### TD-06: SquashManager テストデータ（複数コミット）\n\n**コミット履歴**:\n```\nabc123def456 (base_commit) - Initial commit\ndef456abc123 - Add planning phase\n123abc456def - Add requirements phase\n456def123abc - Add design phase\n789ghi012jkl - Add implementation phase\n012jkl345mno (HEAD) - Add testing phase\n```\n\n**コミット数**: 5\n\n---\n\n### TD-07: SquashManager テストデータ（1コミット）\n\n**コミット履歴**:\n```\nabc123def456 (base_commit, HEAD) - Initial commit\n```\n\n**コミット数**: 1\n\n---\n\n### TD-08: PR本文生成テストデータ（全完了）\n\n**metadata.json**: TD-01 と同じ（全フェーズ completed）\n\n**期待される PR 本文**:\n```markdown\n## 変更サマリー\n\n- Issue番号: #123\n- タイトル: feat(cli): Add finalize command\n- 完了ステータス: All phases completed\n\n## フェーズステータス\n\n- ✅ planning: completed\n- ✅ requirements: completed\n- ✅ design: completed\n- ✅ test_scenario: completed\n- ✅ implementation: completed\n- ✅ test_implementation: completed\n- ✅ testing: completed\n- ✅ documentation: completed\n- ✅ report: completed\n- ✅ evaluation: completed\n\n## テスト結果\n\n✅ Passed\n\n## クリーンアップ状況\n\n- ✅ ワークフローディレクトリ削除済み\n- ✅ コミットスカッシュ完了\n\n---\n\n**AI Workflow Agent - Finalize Command**\n```\n\n---\n\n### TD-09: PR本文生成テストデータ（一部未完了）\n\n**metadata.json**:\n```json\n{\n  \"issue_number\": 123,\n  \"base_commit\": \"abc123def456\",\n  \"issue_info\": {\n    \"title\": \"feat(cli): Add finalize command\",\n    \"state\": \"open\"\n  },\n  \"phases\": {\n    \"planning\": { \"status\": \"completed\" },\n    \"requirements\": { \"status\": \"completed\" },\n    \"design\": { \"status\": \"completed\" },\n    \"test_scenario\": { \"status\": \"completed\" },\n    \"implementation\": { \"status\": \"completed\" },\n    \"test_implementation\": { \"status\": \"completed\" },\n    \"testing\": { \"status\": \"pending\" },\n    \"documentation\": { \"status\": \"completed\" },\n    \"report\": { \"status\": \"completed\" },\n    \"evaluation\": { \"status\": \"completed\" }\n  }\n}\n```\n\n**期待される PR 本文** (一部抜粋):\n```markdown\n- ⏳ testing: pending\n\n## テスト結果\n\n⏳ Pending\n```\n\n---\n\n## 5. テスト環境要件\n\n### 5.1 Unitテスト環境\n\n| 項目 | 要件 |\n|-----|------|\n| **Node.js バージョン** | 20 以上 |\n| **テストフレームワーク** | Jest または Vitest |\n| **モック/スタブ** | - MetadataManager のモック<br>- ArtifactCleaner のモック<br>- SquashManager のモック<br>- PullRequestClient のモック<br>- GitManager のモック<br>- Octokit のモック |\n| **カバレッジツール** | c8 または Istanbul |\n| **カバレッジ目標** | 80% 以上 |\n\n### 5.2 Integrationテスト環境\n\n| 項目 | 要件 |\n|-----|------|\n| **Node.js バージョン** | 20 以上 |\n| **Git** | 2.0 以上 |\n| **GitHub Token** | 環境変数 GITHUB_TOKEN（repo, workflow スコープ） |\n| **テストリポジトリ** | テスト専用の GitHub リポジトリ（または sandbox リポジトリ） |\n| **テスト用 PR** | テスト実行前に Draft PR を作成 |\n| **gh CLI** | オプション（ドラフト解除のフォールバック用） |\n| **外部依存** | - GitHub REST API<br>- GitHub GraphQL API<br>- Git リモートリポジトリ |\n\n### 5.3 CI/CD 環境\n\n| 項目 | 要件 |\n|-----|------|\n| **CI/CD プラットフォーム** | GitHub Actions または Jenkins |\n| **シークレット管理** | GITHUB_TOKEN を環境変数として設定 |\n| **テスト実行コマンド** | - `npm run test:unit`<br>- `npm run test:integration` |\n| **テストタイムアウト** | 各テストケース 30 秒、全体 10 分 |\n\n---\n\n## 6. 品質ゲートチェックリスト\n\n### 6.1 Phase 2の戦略に沿ったテストシナリオである\n\n- [x] **UNIT_INTEGRATION 戦略に基づいている**\n  - Unitテストシナリオ（UC-01 〜 UC-35）を作成\n  - Integrationテストシナリオ（IT-01 〜 IT-13）を作成\n  - BDDシナリオは含まない（戦略に含まれないため）\n\n### 6.2 主要な正常系がカバーされている\n\n- [x] **主要な正常系がカバーされている**\n  - UC-01: 全ステップ実行\n  - UC-04: ドライランモード\n  - UC-05: スカッシュスキップ\n  - UC-06: PR更新スキップ\n  - UC-07: マージ先ブランチ変更\n  - UC-11: base_commit 取得成功\n  - UC-13: ディレクトリ削除成功\n  - UC-16: スカッシュ成功\n  - UC-18: PR更新とドラフト解除成功\n  - UC-22: GraphQL によるドラフト解除成功\n  - UC-26: マージ先ブランチ変更成功\n  - UC-29: 複数コミットスカッシュ成功\n  - UC-32: PR本文生成（全完了）\n  - UC-34: プレビューモード（全ステップ表示）\n  - IT-01: エンドツーエンド（全ステップ完全実行）\n  - IT-02: develop 指定\n  - IT-03: skip-squash\n  - IT-04: skip-pr-update\n\n### 6.3 主要な異常系がカバーされている\n\n- [x] **主要な異常系がカバーされている**\n  - UC-02: base_commit 不在\n  - UC-03: PR番号取得失敗\n  - UC-08: issue番号なし\n  - UC-09: issue番号が不正\n  - UC-10: baseBranch が空文字\n  - UC-12: base_commit 不在（Step 1）\n  - UC-14: コミット失敗\n  - UC-15: プッシュ失敗\n  - UC-17: スカッシュ失敗\n  - UC-19: PR番号取得失敗（Step 4-5）\n  - UC-20: PR更新失敗\n  - UC-21: ドラフト解除失敗\n  - UC-24: GraphQL と gh コマンド両方失敗\n  - UC-25: node_id 取得失敗\n  - UC-27: ブランチ不在\n  - UC-28: 権限不足\n  - UC-31: ブランチ保護違反\n  - IT-05: base_commit 不在でエラー終了\n  - IT-06: PR 不在でエラー終了\n  - IT-07: GitHub API 権限不足\n\n### 6.4 期待結果が明確である\n\n- [x] **期待結果が明確である**\n  - すべてのテストケースで期待結果を明記\n  - 具体的なログメッセージ、エラーメッセージ、exit code を記載\n  - 確認項目をチェックリスト形式で列挙（Integrationテスト）\n  - テストデータを詳細に定義（TD-01 〜 TD-09）\n\n---\n\n## 品質ゲート判定\n\n✅ **すべての品質ゲートを満たしています**\n\n- ✅ Phase 2の戦略（UNIT_INTEGRATION）に沿ったテストシナリオである\n- ✅ 主要な正常系がカバーされている（18ケース）\n- ✅ 主要な異常系がカバーされている（20ケース）\n- ✅ 期待結果が明確である（すべてのケースで詳細記載）\n\n---\n\n**テストシナリオ作成完了日**: 2025-01-30\n**レビュー準備完了**: ✅\n"}}],"stop_reason":null,"stop_sequence":null,"usage":{"input_tokens":2,"cache_creation_input_tokens":46421,"cache_read_input_tokens":12202,"cache_creation":{"ephemeral_5m_input_tokens":46421,"ephemeral_1h_input_tokens":0},"output_tokens":1,"service_tier":"standard"}},"parent_tool_use_id":null,"session_id":"90421cfc-f915-42a9-95f1-8515a3d7f09d","uuid":"ff79dfdc-851f-48b8-bb42-b886ef80546b"}
{"type":"user","message":{"role":"user","content":[{"tool_use_id":"toolu_01VXUEZpEQ7wpGmUvbsEjZGT","type":"tool_result","content":"File created successfully at: /tmp/ai-workflow-repos-11-92f1577c/ai-workflow-agent/.ai-workflow/issue-261/03_test_scenario/output/test-scenario.md"}]},"parent_tool_use_id":null,"session_id":"90421cfc-f915-42a9-95f1-8515a3d7f09d","uuid":"e2d76ad1-41c2-4d0a-96b2-8ba725469a0d"}
{"type":"assistant","message":{"model":"claude-sonnet-4-5-20250929","id":"msg_01Y3zzcjW6wjPrvLY2kKjfBa","type":"message","role":"assistant","content":[{"type":"text","text":"I've successfully created a comprehensive test scenario document for Issue #261. Here's a summary of what was included:\n\n## 📋 Test Scenario Summary\n\n### Test Strategy: **UNIT_INTEGRATION**\nBased on Phase 2 design decisions, combining unit tests for individual components and integration tests for end-to-end flows.\n\n### Coverage Overview\n\n#### **Unit Tests (35 test cases)**\n- `handleFinalizeCommand()` main function (UC-01 to UC-03)\n- CLI option behaviors (UC-04 to UC-07)\n- Validation functions (UC-08 to UC-10)\n- Step 1: base_commit retrieval (UC-11 to UC-12)\n- Step 2: directory cleanup (UC-13 to UC-15)\n- Step 3: commit squashing (UC-16 to UC-17)\n- Step 4-5: PR update and draft conversion (UC-18 to UC-21)\n- `PullRequestClient.markPRReady()` (UC-22 to UC-25)\n- `PullRequestClient.updateBaseBranch()` (UC-26 to UC-28)\n- `SquashManager.squashCommitsForFinalize()` (UC-29 to UC-31)\n- `generateFinalPrBody()` (UC-32 to UC-33)\n- `previewFinalize()` (UC-34 to UC-35)\n\n#### **Integration Tests (13 test cases)**\n- End-to-end flows (IT-01 to IT-04)\n- Error handling integration (IT-05 to IT-07)\n- Existing command compatibility (IT-08 to IT-09)\n- Module integration (IT-10 to IT-13)\n\n### Test Data (9 datasets)\n- TD-01: Normal case basic data\n- TD-02: base_commit missing\n- TD-03: PR not found\n- TD-04: PullRequestClient test data\n- TD-05: node_id missing\n- TD-06: Multiple commits for squash\n- TD-07: Single commit (skip squash)\n- TD-08: All phases completed\n- TD-09: Some phases pending\n\n### Quality Gates: ✅ All Passed\n\n- ✅ **Follows Phase 2 strategy** (UNIT_INTEGRATION)\n- ✅ **Main success paths covered** (18 scenarios)\n- ✅ **Main error paths covered** (20 scenarios)\n- ✅ **Expected results are clear** (detailed for all cases)\n\nThe test scenarios are ready for the next phase (Implementation) and provide a solid foundation for test-driven development!"}],"stop_reason":null,"stop_sequence":null,"usage":{"input_tokens":5,"cache_creation_input_tokens":16527,"cache_read_input_tokens":58623,"cache_creation":{"ephemeral_5m_input_tokens":16527,"ephemeral_1h_input_tokens":0},"output_tokens":1,"service_tier":"standard"}},"parent_tool_use_id":null,"session_id":"90421cfc-f915-42a9-95f1-8515a3d7f09d","uuid":"00dc512c-1e16-4334-afa9-146cde841f01"}
{"type":"result","subtype":"success","is_error":false,"duration_ms":231561,"duration_api_ms":233172,"num_turns":7,"result":"I've successfully created a comprehensive test scenario document for Issue #261. Here's a summary of what was included:\n\n## 📋 Test Scenario Summary\n\n### Test Strategy: **UNIT_INTEGRATION**\nBased on Phase 2 design decisions, combining unit tests for individual components and integration tests for end-to-end flows.\n\n### Coverage Overview\n\n#### **Unit Tests (35 test cases)**\n- `handleFinalizeCommand()` main function (UC-01 to UC-03)\n- CLI option behaviors (UC-04 to UC-07)\n- Validation functions (UC-08 to UC-10)\n- Step 1: base_commit retrieval (UC-11 to UC-12)\n- Step 2: directory cleanup (UC-13 to UC-15)\n- Step 3: commit squashing (UC-16 to UC-17)\n- Step 4-5: PR update and draft conversion (UC-18 to UC-21)\n- `PullRequestClient.markPRReady()` (UC-22 to UC-25)\n- `PullRequestClient.updateBaseBranch()` (UC-26 to UC-28)\n- `SquashManager.squashCommitsForFinalize()` (UC-29 to UC-31)\n- `generateFinalPrBody()` (UC-32 to UC-33)\n- `previewFinalize()` (UC-34 to UC-35)\n\n#### **Integration Tests (13 test cases)**\n- End-to-end flows (IT-01 to IT-04)\n- Error handling integration (IT-05 to IT-07)\n- Existing command compatibility (IT-08 to IT-09)\n- Module integration (IT-10 to IT-13)\n\n### Test Data (9 datasets)\n- TD-01: Normal case basic data\n- TD-02: base_commit missing\n- TD-03: PR not found\n- TD-04: PullRequestClient test data\n- TD-05: node_id missing\n- TD-06: Multiple commits for squash\n- TD-07: Single commit (skip squash)\n- TD-08: All phases completed\n- TD-09: Some phases pending\n\n### Quality Gates: ✅ All Passed\n\n- ✅ **Follows Phase 2 strategy** (UNIT_INTEGRATION)\n- ✅ **Main success paths covered** (18 scenarios)\n- ✅ **Main error paths covered** (20 scenarios)\n- ✅ **Expected results are clear** (detailed for all cases)\n\nThe test scenarios are ready for the next phase (Implementation) and provide a solid foundation for test-driven development!","session_id":"90421cfc-f915-42a9-95f1-8515a3d7f09d","total_cost_usd":0.5152715,"usage":{"input_tokens":7,"cache_creation_input_tokens":62948,"cache_read_input_tokens":70825,"output_tokens":17099,"server_tool_use":{"web_search_requests":0},"service_tier":"standard","cache_creation":{"ephemeral_1h_input_tokens":0,"ephemeral_5m_input_tokens":62948}},"modelUsage":{"claude-haiku-4-5-20251001":{"inputTokens":633,"outputTokens":166,"cacheReadInputTokens":0,"cacheCreationInputTokens":0,"webSearchRequests":0,"costUSD":0.0014629999999999999,"contextWindow":200000},"claude-sonnet-4-5-20250929":{"inputTokens":7,"outputTokens":17099,"cacheReadInputTokens":70825,"cacheCreationInputTokens":62948,"webSearchRequests":0,"costUSD":0.5138085,"contextWindow":200000}},"permission_denials":[],"uuid":"5e826c11-0243-4dea-a046-b1954396a014"}