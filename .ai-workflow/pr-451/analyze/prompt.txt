# PRレビューコメント — 分析フェーズ

PRレビューコメントのトリアージを支援します。提供された**すべて**のコメントを一括で分析し、単一の対応計画を提案してください。

## 目標
- 各コメントを以下のいずれかに分類: `code_change`, `reply`, `discussion`, `skip`
- 信頼度を提供: `high` | `medium` | `low`
- `code_change` の場合、最小限で安全な変更を提案（機密ファイルは避ける）
- 各コメントへの返信メッセージを作成

## 入力コンテキスト
- PR番号: 451
- PRタイトル: pr-comment finalize が中間生成物の削除を Git にコミットしない
- 対象リポジトリ: /tmp/ai-workflow-repos-55-09c8b358/ai-workflow-agent
- コメント（一括）:
### Comment #2637501959
- File: jenkins/jobs/pipeline/ai-workflow/pr-comment-execute/Jenkinsfile
- Line: 158
- Author: yuto-takashi
- Body:
```
Check Resumeこのステージが削除されていますが、これは意図した修正ですか？
```
- Diff:
```diff

```
- File Content:
```
/**
 * AI Workflow - PR Comment Execute
 *
 * PRレビューコメントの初期化と自動対応を行うJenkinsfile。
 * pr-comment init/analyze/execute サブコマンドを実行し、未解決コメントに対する返信・修正を自動化します。
 *
 * ワークフロー:
 * 1. init: PRから未解決コメントを取得してメタデータを初期化
 * 2. analyze: 全コメントを一括分析してresponse-plan.mdを生成（エージェント起動1回目）
 * 3. execute: response-plan.mdに基づいて対応を実行（エージェント起動2回目）
 *
 * パラメータ（Job DSLで定義）:
 * - PR_URL: Pull Request URL（必須、例: https://github.com/owner/repo/pull/123）
 * - AGENT_MODE: エージェントモード（auto/codex/claude）
 * - DRY_RUN: ドライランモード（デフォルト: false）
 * - BATCH_SIZE: 一度に処理するコメント数（デフォルト: 5）
 * - GITHUB_TOKEN: GitHub Personal Access Token（必須）
 * - CODEX_AUTH_JSON: Codex ~/.codex/auth.json の内容（オプション）
 * - その他: APIキー、Git設定
 */

def common

pipeline {
    agent {
        dockerfile {
            label 'ec2-fleet'
            dir '.'
            filename 'Dockerfile'
            args "-v \${WORKSPACE}:/workspace -w /workspace -e CLAUDE_DANGEROUSLY_SKIP_PERMISSIONS=1"
        }
    }

    options {
        timestamps()
        ansiColor('xterm')
    }

    environment {
        // Claude Agent SDK設定
        CLAUDE_DANGEROUSLY_SKIP_PERMISSIONS = '1'

        // AI Workflow設定
        WORKFLOW_DIR = '.'
        WORKFLOW_VERSION = '0.6.0'
        EXECUTION_MODE = 'pr_comment_execute'
        CODEX_HOME = ''

        // ログ設定
        LOG_LEVEL = "${(params.LOG_LEVEL ?: 'INFO').toLowerCase()}"
        LOG_NO_COLOR = 'true'

        // Git設定
        GIT_COMMIT_USER_NAME = "${params.GIT_COMMIT_USER_NAME ?: 'AI Workflow Bot'}"
        GIT_COMMIT_USER_EMAIL = "${params.GIT_COMMIT_USER_EMAIL ?: 'ai-workflow@example.com'}"

        // GitHub認証情報
        GITHUB_TOKEN = "${params.GITHUB_TOKEN}"

        // OpenAI系認証情報
        CODEX_API_KEY = "${params.CODEX_API_KEY ?: ''}"
        OPENAI_API_KEY = "${params.OPENAI_API_KEY ?: ''}"

        // Claude系認証情報
        CLAUDE_CODE_OAUTH_TOKEN = "${params.CLAUDE_CODE_OAUTH_TOKEN ?: ''}"
        CLAUDE_CODE_API_KEY = "${params.CLAUDE_CODE_API_KEY ?: ''}"
        ANTHROPIC_API_KEY = "${params.ANTHROPIC_API_KEY ?: ''}"
    }

    stages {
        stage('Load Common Library') {
            steps {
                script {
                    echo "========================================="
                    echo "AI Workflow Orchestrator v${env.WORKFLOW_VERSION}"
                    echo "Mode: PR Comment Execute"
                    echo "========================================="

                    common = load 'jenkins/shared/common.groovy'
                    echo "Common library loaded successfully"
                }
            }
        }

        stage('Prepare Codex auth.json') {
            steps {
                script {
                    common.prepareCodexAuthFile()
                }
            }
        }

        stage('Prepare Agent Credentials') {
            steps {
                script {
                    common.prepareAgentCredentials()
                }
            }
        }

        stage('Validate Parameters') {
            steps {
                script {
                    echo "========================================="
                    echo "Stage: Validate Parameters"
                    echo "========================================="

                    if (!params.PR_URL) {
                        error("PR_URL parameter is required")
                    }

                    // PR URLからowner/repo/numberを抽出
                    // 例: https://github.com/tielec/ai-workflow-agent/pull/123
                    def prUrlPattern = ~/^https:\/\/github\.com\/([^\/]+)\/([^\/]+)\/pull\/(\d+)$/
                    def matcher = (params.PR_URL =~ prUrlPattern)

                    if (!matcher.matches()) {
                        error("PR_URL must be in the format 'https://github.com/owner/repo/pull/number': ${params.PR_URL}")
                    }

                    env.REPO_OWNER = matcher[0][1]
                    env.REPO_NAME = matcher[0][2]
                    env.PR_NUMBER = matcher[0][3]
                    env.ISSUE_NUMBER = env.PR_NUMBER  // 共通処理との互換用
                    env.GITHUB_REPOSITORY = "${env.REPO_OWNER}/${env.REPO_NAME}"

                    def dryRunLabel = params.DRY_RUN ? ' [DRY RUN]' : ''
                    currentBuild.description = "PR #${env.PR_NUMBER}${dryRunLabel} | Execute | ${env.REPO_OWNER}/${env.REPO_NAME}"

                    echo "PR URL: ${params.PR_URL}"
                    echo "PR Number: ${env.PR_NUMBER}"
                    echo "Repository Owner: ${env.REPO_OWNER}"
                    echo "Repository Name: ${env.REPO_NAME}"
                    echo "GitHub Repository: ${env.GITHUB_REPOSITORY}"
                    echo "Agent Mode: ${params.AGENT_MODE ?: 'auto'}"
                    echo "Batch Size: ${params.BATCH_SIZE ?: '5'}"
                    echo "Dry Run: ${params.DRY_RUN ?: false}"
                }
            }
        }

        stage('Setup Environment') {
            steps {
                script {
                    common.setupEnvironment()
                }
            }
        }

        stage('Setup Node.js Environment') {
            steps {
                script {
                    common.setupNodeEnvironment()
                }
            }
        }

        stage('PR Comment Init') {
            steps {
                script {
                    echo "========================================="
                    echo "Stage: PR Comment Init"
                    echo "========================================="

                    dir(env.WORKFLOW_DIR) {
                        def dryRunFlag = params.DRY_RUN ? '--dry-run' : ''

                        sh """
                            node dist/index.js pr-comment init \
                                --pr-url ${params.PR_URL} \
                                ${dryRunFlag}
                        """
                    }
                }
            }
        }

        stage('PR Comment Execute') {
            steps {
                script {
                    echo "========================================="
                    echo "Stage: PR Comment Execute"
                    echo "========================================="
                    echo "PR Number: ${env.PR_NUMBER}"
                    echo "Agent Mode: ${params.AGENT_MODE ?: 'auto'}"
                    echo "Batch Size: ${params.BATCH_SIZE ?: '5'}"
                    echo "Dry Run: ${params.DRY_RUN ?: false}"

                    def dryRunLabel = params.DRY_RUN ? ' [DRY RUN]' : ''
                    currentBuild.description = "PR #${env.PR_NUMBER}${dryRunLabel} | Execute Running | ${env.REPO_OWNER}/${env.REPO_NAME}"

                    dir(env.WORKFLOW_DIR) {
                        def dryRunFlag = params.DRY_RUN ? '--dry-run' : ''
                        def batchSizeFlag = params.BATCH_SIZE ? "--batch-size ${params.BATCH_SIZE}" : ''

                        sh """
                            node dist/index.js pr-comment execute \
                                --pr-url ${params.PR_URL} \
                                --agent ${params.AGENT_MODE ?: 'auto'} \
                                ${dryRunFlag} \
                                ${batchSizeFlag}
                        """
                    }
                }
            }
        }
    }

    post {
        always {
            script {
                echo "========================================="
                echo "Post Processing"
                echo "========================================="

                def dryRunLabel = params.DRY_RUN ? ' [DRY RUN]' : ''
                currentBuild.description = "PR #${env.PR_NUMBER}${dryRunLabel} | Execute | ${env.REPO_OWNER}/${env.REPO_NAME}"

                if (env.PR_NUMBER) {
                    def artifactPath = "${env.REPOS_ROOT}/${env.REPO_NAME}/.ai-workflow/pr-${env.PR_NUMBER}/**/*"
                    echo "Archiving artifacts from: ${artifactPath}"
                    archiveArtifacts artifacts: artifactPath, allowEmptyArchive: true
                }

                // REPOS_ROOTクリーンアップ
                if (env.REPOS_ROOT) {
                    sh """
                        rm -rf ${env.REPOS_ROOT}
                    """
                    echo "REPOS_ROOT cleaned up: ${env.REPOS_ROOT}"
                }

                if (env.CODEX_HOME?.trim()) {
                    sh """
                        rm -rf ${env.CODEX_HOME}
                    """
                    echo "CODEX_HOME cleaned up: ${env.CODEX_HOME}"
                }

                // ワークスペースのクリーンアップ
                cleanWs()
                echo "Workspace cleaned up"
            }
        }

        success {
            script {
                echo "========================================="
                echo "✅ AI Workflow - PR Comment Execute Success"
                echo "========================================="
                echo "PR: #${env.PR_NUMBER}"
                echo "Repository: ${env.REPO_OWNER}/${env.REPO_NAME}"
            }
        }

        failure {
            script {
                echo "========================================="
                echo "❌ AI Workflow - PR Comment Execute Failure"
                echo "========================================="
                echo "PR: #${env.PR_NUMBER}"
                echo "Repository: ${env.REPO_OWNER}/${env.REPO_NAME}"
                echo "Please check the logs"
            }
        }
    }
}

```

### Comment #2637502152
- File: jenkins/jobs/pipeline/ai-workflow/pr-comment-execute/Jenkinsfile
- Line: 205
- Author: yuto-takashi
- Body:
```
PR Comment Analyze　のステージも削除されています。これも意図的な修正ですか？確認して報告してください。
```
- Diff:
```diff

```
- File Content:
```
/**
 * AI Workflow - PR Comment Execute
 *
 * PRレビューコメントの初期化と自動対応を行うJenkinsfile。
 * pr-comment init/analyze/execute サブコマンドを実行し、未解決コメントに対する返信・修正を自動化します。
 *
 * ワークフロー:
 * 1. init: PRから未解決コメントを取得してメタデータを初期化
 * 2. analyze: 全コメントを一括分析してresponse-plan.mdを生成（エージェント起動1回目）
 * 3. execute: response-plan.mdに基づいて対応を実行（エージェント起動2回目）
 *
 * パラメータ（Job DSLで定義）:
 * - PR_URL: Pull Request URL（必須、例: https://github.com/owner/repo/pull/123）
 * - AGENT_MODE: エージェントモード（auto/codex/claude）
 * - DRY_RUN: ドライランモード（デフォルト: false）
 * - BATCH_SIZE: 一度に処理するコメント数（デフォルト: 5）
 * - GITHUB_TOKEN: GitHub Personal Access Token（必須）
 * - CODEX_AUTH_JSON: Codex ~/.codex/auth.json の内容（オプション）
 * - その他: APIキー、Git設定
 */

def common

pipeline {
    agent {
        dockerfile {
            label 'ec2-fleet'
            dir '.'
            filename 'Dockerfile'
            args "-v \${WORKSPACE}:/workspace -w /workspace -e CLAUDE_DANGEROUSLY_SKIP_PERMISSIONS=1"
        }
    }

    options {
        timestamps()
        ansiColor('xterm')
    }

    environment {
        // Claude Agent SDK設定
        CLAUDE_DANGEROUSLY_SKIP_PERMISSIONS = '1'

        // AI Workflow設定
        WORKFLOW_DIR = '.'
        WORKFLOW_VERSION = '0.6.0'
        EXECUTION_MODE = 'pr_comment_execute'
        CODEX_HOME = ''

        // ログ設定
        LOG_LEVEL = "${(params.LOG_LEVEL ?: 'INFO').toLowerCase()}"
        LOG_NO_COLOR = 'true'

        // Git設定
        GIT_COMMIT_USER_NAME = "${params.GIT_COMMIT_USER_NAME ?: 'AI Workflow Bot'}"
        GIT_COMMIT_USER_EMAIL = "${params.GIT_COMMIT_USER_EMAIL ?: 'ai-workflow@example.com'}"

        // GitHub認証情報
        GITHUB_TOKEN = "${params.GITHUB_TOKEN}"

        // OpenAI系認証情報
        CODEX_API_KEY = "${params.CODEX_API_KEY ?: ''}"
        OPENAI_API_KEY = "${params.OPENAI_API_KEY ?: ''}"

        // Claude系認証情報
        CLAUDE_CODE_OAUTH_TOKEN = "${params.CLAUDE_CODE_OAUTH_TOKEN ?: ''}"
        CLAUDE_CODE_API_KEY = "${params.CLAUDE_CODE_API_KEY ?: ''}"
        ANTHROPIC_API_KEY = "${params.ANTHROPIC_API_KEY ?: ''}"
    }

    stages {
        stage('Load Common Library') {
            steps {
                script {
                    echo "========================================="
                    echo "AI Workflow Orchestrator v${env.WORKFLOW_VERSION}"
                    echo "Mode: PR Comment Execute"
                    echo "========================================="

                    common = load 'jenkins/shared/common.groovy'
                    echo "Common library loaded successfully"
                }
            }
        }

        stage('Prepare Codex auth.json') {
            steps {
                script {
                    common.prepareCodexAuthFile()
                }
            }
        }

        stage('Prepare Agent Credentials') {
            steps {
                script {
                    common.prepareAgentCredentials()
                }
            }
        }

        stage('Validate Parameters') {
            steps {
                script {
                    echo "========================================="
                    echo "Stage: Validate Parameters"
                    echo "========================================="

                    if (!params.PR_URL) {
                        error("PR_URL parameter is required")
                    }

                    // PR URLからowner/repo/numberを抽出
                    // 例: https://github.com/tielec/ai-workflow-agent/pull/123
                    def prUrlPattern = ~/^https:\/\/github\.com\/([^\/]+)\/([^\/]+)\/pull\/(\d+)$/
                    def matcher = (params.PR_URL =~ prUrlPattern)

                    if (!matcher.matches()) {
                        error("PR_URL must be in the format 'https://github.com/owner/repo/pull/number': ${params.PR_URL}")
                    }

                    env.REPO_OWNER = matcher[0][1]
                    env.REPO_NAME = matcher[0][2]
                    env.PR_NUMBER = matcher[0][3]
                    env.ISSUE_NUMBER = env.PR_NUMBER  // 共通処理との互換用
                    env.GITHUB_REPOSITORY = "${env.REPO_OWNER}/${env.REPO_NAME}"

                    def dryRunLabel = params.DRY_RUN ? ' [DRY RUN]' : ''
                    currentBuild.description = "PR #${env.PR_NUMBER}${dryRunLabel} | Execute | ${env.REPO_OWNER}/${env.REPO_NAME}"

                    echo "PR URL: ${params.PR_URL}"
                    echo "PR Number: ${env.PR_NUMBER}"
                    echo "Repository Owner: ${env.REPO_OWNER}"
                    echo "Repository Name: ${env.REPO_NAME}"
                    echo "GitHub Repository: ${env.GITHUB_REPOSITORY}"
                    echo "Agent Mode: ${params.AGENT_MODE ?: 'auto'}"
                    echo "Batch Size: ${params.BATCH_SIZE ?: '5'}"
                    echo "Dry Run: ${params.DRY_RUN ?: false}"
                }
            }
        }

        stage('Setup Environment') {
            steps {
                script {
                    common.setupEnvironment()
                }
            }
        }

        stage('Setup Node.js Environment') {
            steps {
                script {
                    common.setupNodeEnvironment()
                }
            }
        }

        stage('PR Comment Init') {
            steps {
                script {
                    echo "========================================="
                    echo "Stage: PR Comment Init"
                    echo "========================================="

                    dir(env.WORKFLOW_DIR) {
                        def dryRunFlag = params.DRY_RUN ? '--dry-run' : ''

                        sh """
                            node dist/index.js pr-comment init \
                                --pr-url ${params.PR_URL} \
                                ${dryRunFlag}
                        """
                    }
                }
            }
        }

        stage('PR Comment Execute') {
            steps {
                script {
                    echo "========================================="
                    echo "Stage: PR Comment Execute"
                    echo "========================================="
                    echo "PR Number: ${env.PR_NUMBER}"
                    echo "Agent Mode: ${params.AGENT_MODE ?: 'auto'}"
                    echo "Batch Size: ${params.BATCH_SIZE ?: '5'}"
                    echo "Dry Run: ${params.DRY_RUN ?: false}"

                    def dryRunLabel = params.DRY_RUN ? ' [DRY RUN]' : ''
                    currentBuild.description = "PR #${env.PR_NUMBER}${dryRunLabel} | Execute Running | ${env.REPO_OWNER}/${env.REPO_NAME}"

                    dir(env.WORKFLOW_DIR) {
                        def dryRunFlag = params.DRY_RUN ? '--dry-run' : ''
                        def batchSizeFlag = params.BATCH_SIZE ? "--batch-size ${params.BATCH_SIZE}" : ''

                        sh """
                            node dist/index.js pr-comment execute \
                                --pr-url ${params.PR_URL} \
                                --agent ${params.AGENT_MODE ?: 'auto'} \
                                ${dryRunFlag} \
                                ${batchSizeFlag}
                        """
                    }
                }
            }
        }
    }

    post {
        always {
            script {
                echo "========================================="
                echo "Post Processing"
                echo "========================================="

                def dryRunLabel = params.DRY_RUN ? ' [DRY RUN]' : ''
                currentBuild.description = "PR #${env.PR_NUMBER}${dryRunLabel} | Execute | ${env.REPO_OWNER}/${env.REPO_NAME}"

                if (env.PR_NUMBER) {
                    def artifactPath = "${env.REPOS_ROOT}/${env.REPO_NAME}/.ai-workflow/pr-${env.PR_NUMBER}/**/*"
                    echo "Archiving artifacts from: ${artifactPath}"
                    archiveArtifacts artifacts: artifactPath, allowEmptyArchive: true
                }

                // REPOS_ROOTクリーンアップ
                if (env.REPOS_ROOT) {
                    sh """
                        rm -rf ${env.REPOS_ROOT}
                    """
                    echo "REPOS_ROOT cleaned up: ${env.REPOS_ROOT}"
                }

                if (env.CODEX_HOME?.trim()) {
                    sh """
                        rm -rf ${env.CODEX_HOME}
                    """
                    echo "CODEX_HOME cleaned up: ${env.CODEX_HOME}"
                }

                // ワークスペースのクリーンアップ
                cleanWs()
                echo "Workspace cleaned up"
            }
        }

        success {
            script {
                echo "========================================="
                echo "✅ AI Workflow - PR Comment Execute Success"
                echo "========================================="
                echo "PR: #${env.PR_NUMBER}"
                echo "Repository: ${env.REPO_OWNER}/${env.REPO_NAME}"
            }
        }

        failure {
            script {
                echo "========================================="
                echo "❌ AI Workflow - PR Comment Execute Failure"
                echo "========================================="
                echo "PR: #${env.PR_NUMBER}"
                echo "Repository: ${env.REPO_OWNER}/${env.REPO_NAME}"
                echo "Please check the logs"
            }
        }
    }
}

```

## セキュリティ・安全ガードレール
- 以下のファイルは絶対に変更・提案しない: `.env`, `.env.*`, `credentials.*`, `secrets.*`, `*.pem`, `*.key`
- リポジトリ相対パスのみ使用（絶対パスやパストラバーサル `..` は禁止）
- `code_change` の信頼度が `low` になる場合は、`discussion` にダウングレード
- 返信は簡潔で、プロフェッショナルで、実行可能な内容にする

## 出力
**出力先**: `/tmp/ai-workflow-repos-55-09c8b358/ai-workflow-agent/.ai-workflow/pr-451/output/response-plan.json`

**重要**: 必ず指定されたファイルパス（`{output_file_path}`）にJSONを書き出してください。  
ファイル書き込みツールを使用して、以下の構造のJSONファイルを作成してください。

```json
{
  "pr_number": 123,
  "analyzer_agent": "codex|claude|auto",
  "comments": [
    {
      "comment_id": "c001",
      "file": "src/app.ts",
      "line": 42,
      "author": "reviewer",
      "body": "...コメントテキスト...",
      "type": "code_change|reply|discussion|skip",
      "confidence": "high|medium|low",
      "rationale": "この選択の理由",
      "proposed_changes": [
        {
          "action": "modify|create|delete",
          "file": "src/app.ts",
          "line_range": "40-55",
          "changes": "modify/createの場合、新しいファイルの完全な内容をここに記載。deleteの場合は空文字列。"
        }
      ],
      "reply_message": "GitHubに投稿する返信メッセージ"
    }
  ]
}
```

禁止事項:
- イベントストリーム（JSON Lines）形式での出力
- Markdownコードブロック以外の場所への説明テキスト追加
- 複数のJSONオブジェクトや前後のコメントを出力すること

注意事項:
- JSON形式は上記の構造に厳密に従ってください
- ファイルが正常に書き込まれたことを確認してください
- 入力された全てのコメントを1回ずつ含める
- `proposed_changes` は `code_change` 以外のタイプでは空配列でよい
- ファイルが見つからない場合は、`proposed_changes` を空配列にし、`discussion` または `reply` を選択
