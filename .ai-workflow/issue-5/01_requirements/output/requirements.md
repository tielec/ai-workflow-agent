# 要件定義書 - Issue #5: Evaluation Phase ファイル保存問題の修正

## 0. Planning Document の確認

Planning Phase で策定された開発計画を確認しました：

- **実装戦略**: EXTEND（既存コードの拡張）
- **テスト戦略**: UNIT_INTEGRATION（ユニット＋統合テスト）
- **テストコード戦略**: BOTH_TEST（既存テスト拡張＋新規テスト作成）
- **見積もり工数**: 6~10時間
- **リスク評価**: 低（プロンプト修正が中心、他フェーズへの影響最小限）

本要件定義では、Planning Documentで特定された根本原因仮説（プロンプトの明示性不足）を踏まえ、修正要件を明確化します。

---

## 1. 概要

### 背景

AI Workflow Orchestrator の Evaluation Phase (Phase 9) 実行時に、エージェントが評価レポートの内容を生成するものの、`evaluation_report.md` ファイルが保存されない問題が発生しています。エージェントログ（agent_log.md）では Turn 2 で 345 行分の詳細な評価レポートが生成されていますが、Write ツールが一度も呼び出されておらず、Phase 実行が失敗します。

他の 8 つのフェーズ（Planning、Requirements、Design 等）では同様の「保存してください」指示で正常に動作しているため、Evaluation Phase 固有の問題であると推定されます。

### 目的

1. **根本原因の特定**: エージェントがファイル保存を実行しない理由を明確化
2. **確実なファイル保存の実現**: Evaluation Phase で `evaluation_report.md` が 100% 作成されるようにする
3. **再発防止**: プロンプト設計のベストプラクティスを確立し、将来的な同様の問題を防止
4. **他フェーズへの影響回避**: 既存の正常動作しているフェーズに影響を与えない

### ビジネス価値・技術的価値

- **ビジネス価値**: Evaluation Phase が完了しないとワークフロー全体が失敗し、Issue 対応が完了できないため、開発生産性の向上に直結
- **技術的価値**: プロンプトエンジニアリングの知見蓄積、AI エージェントの信頼性向上、フェーズ実装パターンの標準化

---

## 2. 機能要件

### FR-1: プロンプト分析と比較調査（優先度: 高）

**要件**:
全フェーズ（Phase 0 〜 Phase 9）のプロンプト（execute.txt）を比較分析し、Evaluation Phase でファイル保存が実行されない原因を特定する。

**詳細**:
- 各フェーズのプロンプト長（行数、文字数）を測定
- ファイル保存指示の位置を特定（何行目にあるか、プロンプト全体の何%の位置か）
- 保存指示の表現を比較（「保存してください」「Write ツールを使用」等の明示性）
- 成功フェーズ（Planning、Requirements 等）のパターンを特定

**成果物**:
- プロンプト比較分析レポート（表形式）
- Evaluation Phase の問題箇所の特定

### FR-2: Evaluation Phase プロンプトの改善（優先度: 高）

**要件**:
プロンプト分析結果に基づき、`src/prompts/evaluation/execute.txt` を修正し、エージェントが確実にファイル保存を実行するようにする。

**詳細**:
- ファイル保存指示をプロンプトの最後に「最終ステップ」として明示的に配置
- Write ツール使用を明示（「必ず Write ツールを使用してください」等）
- ステップバイステップ形式の導入（1. 評価実施 → 2. レポート生成 → 3. ファイル保存）
- 保存が必須であることを強調（「重要: このファイルが存在しない場合、フェーズは失敗します」）

**成果物**:
- 修正された `src/prompts/evaluation/execute.txt`

### FR-3: ファイル保存検証の強化（優先度: 中）

**要件**:
`src/phases/evaluation.ts` のファイル保存検証ロジックを強化し、エージェント実行後に確実にファイルが作成されていることを確認する。

**詳細**:
- `executeWithAgent()` 完了後の即座のファイル存在チェック（現行動作の検証）
- エラーメッセージの改善（どのファイルが不足しているか明示）
- デバッグログの追加（エージェントの動作トレース、Turn ごとのツール呼び出し記録）

**成果物**:
- 修正された `src/phases/evaluation.ts`

### FR-4: プロンプト効果検証のテスト（優先度: 高）

**要件**:
修正後のプロンプトで Evaluation Phase を複数回実行し、ファイル保存の成功率を検証する。

**詳細**:
- 最低 3 回の実行で 100% の成功率を確認
- エージェントログで Write ツール呼び出しを確認
- `evaluation_report.md` の内容が妥当であることを確認（評価基準 7 項目、決定タイプ、推奨事項が含まれる）

**成果物**:
- テスト実行ログ
- 成功率レポート

### FR-5: 他フェーズのプロンプト検証（優先度: 低）

**要件**:
同様の問題が他のフェーズで発生していないか確認し、必要に応じて予防的な修正を適用する。

**詳細**:
- 各フェーズのエージェントログで Write ツール呼び出しを確認
- ファイル保存失敗の事例がないか過去ログを調査
- Evaluation Phase のプロンプト修正パターンが他フェーズにも適用可能か検討

**成果物**:
- 他フェーズの検証レポート
- 必要に応じて予防的修正を適用

---

## 3. 非機能要件

### NFR-1: パフォーマンス要件

- **プロンプト実行時間**: 修正後のプロンプトでも、エージェント実行時間は従来と同等（maxTurns: 50 以内で完了）
- **ファイルサイズ**: evaluation_report.md のサイズは 1MB 以下（通常は 10KB 〜 50KB 程度）

### NFR-2: 信頼性要件

- **ファイル保存成功率**: 100%（3 回連続実行で 3 回とも成功）
- **エラーハンドリング**: ファイル保存失敗時に明確なエラーメッセージを出力

### NFR-3: 保守性要件

- **プロンプトの可読性**: 修正後のプロンプトは、人間が読んで意図を理解できる構造
- **コードの可読性**: evaluation.ts の修正は既存のコーディングスタイルに準拠
- **ドキュメント化**: プロンプト設計のベストプラクティスを TROUBLESHOOTING.md に記録

### NFR-4: 拡張性要件

- **再利用性**: プロンプト修正パターンを他フェーズや今後の新規フェーズに適用可能
- **汎用性**: Codex / Claude 両エージェントで動作する（エージェント固有の実装に依存しない）

---

## 4. 制約事項

### 技術的制約

- **既存アーキテクチャの保持**: BasePhase の execute/review/revise サイクルは変更しない
- **エージェント API の制約**: Codex / Claude の API 仕様に準拠（プロンプト長の上限等）
- **互換性**: TypeScript 版 AI Workflow（v0.3.0）の既存機能との互換性を維持

### リソース制約

- **工数**: 6~10 時間以内で完了（Planning Document の見積もりに準拠）
- **影響範囲**: Evaluation Phase のみの修正に限定（Phase 4-3 で他フェーズの検証は実施するが、大規模修正は避ける）

### ポリシー制約

- **コーディング規約**: CLAUDE.md、ARCHITECTURE.md のガイドラインに準拠
- **テスト要件**: UNIT_INTEGRATION テスト戦略（ユニットテスト＋統合テスト）に従う
- **レビュー要件**: 品質ゲート（Phase 1 〜 Phase 8）を通過すること

---

## 5. 前提条件

### システム環境

- Node.js 20 以上
- TypeScript 5.x
- AI Workflow Orchestrator v0.3.0

### 依存コンポーネント

- `src/core/codex-agent-client.ts`: Codex エージェントクライアント
- `src/core/claude-agent-client.ts`: Claude エージェントクライアント
- `src/core/content-parser.ts`: レビュー結果の解析（Evaluation Phase では使用されないが、review() で必要）
- `src/core/metadata-manager.ts`: メタデータ管理
- `fs-extra`: ファイル操作

### 外部システム連携

- Codex API（gpt-5-codex）
- Claude Agent SDK
- GitHub API（Issue、PR、コメント投稿）

---

## 6. 受け入れ基準

### AC-1: プロンプト分析完了

**Given**: 全フェーズのプロンプト（execute.txt）が存在する
**When**: プロンプト比較分析を実施
**Then**:
- 各フェーズのプロンプト長（行数、文字数）が表形式でまとめられている
- ファイル保存指示の位置（行数、プロンプト全体の%）が特定されている
- Evaluation Phase の問題箇所が明確に記載されている

### AC-2: Evaluation Phase プロンプト修正完了

**Given**: プロンプト分析結果が存在する
**When**: `src/prompts/evaluation/execute.txt` を修正
**Then**:
- プロンプトの最後に「最終ステップ - ファイル保存（必須）」セクションが追加されている
- Write ツール使用が明示されている（「必ず Write ツールを使用」等）
- ステップバイステップ形式（1. 評価 → 2. レポート生成 → 3. 保存）が記載されている

### AC-3: ファイル保存検証強化完了

**Given**: `src/phases/evaluation.ts` が存在する
**When**: ファイル保存検証ロジックを修正
**Then**:
- `executeWithAgent()` 完了後にファイル存在チェックが実行される
- ファイルが存在しない場合、明確なエラーメッセージが出力される
- デバッグログでエージェントの動作（Turn ごとのツール呼び出し）がトレースできる

### AC-4: プロンプト効果検証完了

**Given**: 修正後のプロンプトが存在する
**When**: Evaluation Phase を 3 回実行
**Then**:
- 3 回とも `evaluation_report.md` が作成される（成功率 100%）
- エージェントログで Write ツール呼び出しが記録されている
- `evaluation_report.md` に評価基準 7 項目、決定タイプ、推奨事項が含まれている

### AC-5: テストコード実装完了

**Given**: 修正後のコードとプロンプトが存在する
**When**: ユニットテスト＋統合テストを実装
**Then**:
- ContentParser.parseEvaluationDecision() のユニットテストが存在する（PASS、FAIL_PHASE_*、ABORT のパターン）
- Evaluation Phase の E2E 統合テストが存在する（execute() → ファイル保存 → review() サイクル）
- テストカバレッジが 80% 以上である

### AC-6: ドキュメント作成完了

**Given**: 修正完了
**When**: プロンプト設計ガイドラインを作成
**Then**:
- ファイル保存指示のベストプラクティスが文書化されている
- TROUBLESHOOTING.md に再発防止策が追記されている
- 今後の新規フェーズ開発時の参考資料として整備されている

---

## 7. スコープ外

### 明確にスコープ外とする事項

1. **BasePhase の大規模リファクタリング**: execute/review/revise サイクルの変更は行わない
2. **全フェーズのプロンプト一斉修正**: Evaluation Phase 以外のフェーズのプロンプトは、問題が確認された場合のみ修正（予防的修正は Task 4-3 に限定）
3. **エージェント API の変更**: Codex / Claude の API パラメータ（temperature、max_tokens 等）の調整は行わない
4. **新規フェーズの追加**: Issue #5 の範囲外
5. **BDD テストの導入**: Planning Document でテスト戦略として UNIT_INTEGRATION が選定されており、BDD は不要

### 将来的な拡張候補

- **エージェントのリマインダー機能**: Turn 数が一定数を超えた場合、エージェントに「ファイル保存を忘れていませんか?」とプロンプトで再通知
- **maxTurns の自動調整**: フェーズごとに最適な maxTurns を学習する機構
- **プロンプトテンプレートエンジン**: ファイル保存指示を共通テンプレートとして抽出し、全フェーズで再利用

---

## 8. 補足情報

### 関連ファイル

- `src/phases/evaluation.ts`: Evaluation Phase 実装（110 行目でファイル存在チェック）
- `src/prompts/evaluation/execute.txt`: Evaluation Phase プロンプト（152 行目に保存指示）
- `src/core/content-parser.ts`: 評価決定の解析ロジック（parseEvaluationDecision）
- `.ai-workflow/issue-2/09_evaluation/execute/agent_log.md`: 失敗したエージェントログ（参考資料）

### 既知の問題

- **エージェントの非決定的動作**: AI エージェントは非決定的であるため、100% の再現性は保証できない（軽減策: 複数回テスト実行）
- **プロンプト長の上限**: Codex / Claude のプロンプト長に上限があるため、プロンプト修正時には文字数を確認する必要がある

### Planning Document との整合性

本要件定義は、Planning Document（.ai-workflow/issue-5/00_planning/output/planning.md）で策定された以下の戦略に準拠しています：

- **実装戦略**: EXTEND（既存コードの拡張）
- **テスト戦略**: UNIT_INTEGRATION（ユニット＋統合テスト）
- **タスク分割**: Phase 1（要件定義）〜 Phase 8（レポート）の 8 フェーズ構成
- **リスク評価**: 低（プロンプト修正が中心、他フェーズへの影響最小限）

---

**作成日**: 2025-01-20
**対象 Issue**: #5 - Evaluation Phase: 評価レポートファイルが作成されない問題の調査と修正
**優先度**: High
**想定工数**: 6~10 時間（Planning Document に準拠）
