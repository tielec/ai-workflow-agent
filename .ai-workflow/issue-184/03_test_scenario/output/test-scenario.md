# テストシナリオ

## 0. Planning Documentの確認

Planning Document（@.ai-workflow/issue-184/00_planning/output/planning.md）で策定された開発計画を確認しました：

- **実装戦略**: EXTEND（既存Jenkinsfileの拡張）
- **テスト戦略**: INTEGRATION_ONLY（Jenkins Job実行時の動作検証）
- **テストコード戦略**: CREATE_TEST（テストシナリオドキュメントを新規作成、自動テストスクリプトは不要）
- **複雑度**: 簡単（単一ファイルの修正のみ）
- **見積もり工数**: 2~3時間
- **リスク評価**: 低

この計画に基づき、以下のテストシナリオを実施します。

---

## 1. テスト戦略サマリー

### 1.1 選択されたテスト戦略

**INTEGRATION_ONLY** - Jenkins Job実行時の統合テストのみを実施

### 1.2 テスト対象の範囲

- Jenkinsfileの`environment`セクションの変更
- パラメータから環境変数への値の伝播
- Docker コンテナ内での環境変数設定
- Jenkins画面でのパラメータマスキング
- コンソール出力でのシークレットマスキング

### 1.3 テストの目的

1. **パラメータ受け取りの検証**: Jenkins Job DSLからパラメータが正しく受け取られることを確認
2. **環境変数設定の検証**: パラメータが環境変数として正しく設定されることを確認
3. **マスキングの検証**: セキュリティ要件（password型のマスキング）が満たされることを確認
4. **統合動作の検証**: AI Workflow CLIがパラメータで渡された認証情報を正しく利用できることを確認
5. **後方互換性の検証**: 既存のAWS認証情報パターンと一貫性があることを確認

---

## 2. Integrationテストシナリオ

### シナリオ2-1: パラメータ入力画面での表示確認

**目的**: Jenkins Job実行時に、新しく追加したパラメータが正しく表示され、password型でマスキングされることを検証

**前提条件**:
- Jenkinsfileがリポジトリにプッシュされている
- Jenkins Jobが最新のJenkinsfileを参照している

**テスト手順**:
1. Jenkins WebUIにアクセス
2. 対象のJenkins Job（AI Workflow Orchestrator）を選択
3. 「Build with Parameters」をクリック
4. パラメータ入力画面を確認

**期待結果**:
- `OPENAI_API_KEY`パラメータが表示される
- `GITHUB_TOKEN`パラメータが表示される
- 両パラメータの入力フィールドが`password`型（`****`表示）である
- パラメータの説明文が正しく表示される
  - `OPENAI_API_KEY`: "OpenAI API Key"
  - `GITHUB_TOKEN`: "GitHub Personal Access Token"

**確認項目**:
- [ ] パラメータ入力フィールドが表示される
- [ ] 入力値が`****`でマスキングされる
- [ ] 説明文が正しく表示される
- [ ] AWS認証情報パラメータと同じ表示形式である

---

### シナリオ2-2: パラメータ設定とJenkins Job実行

**目的**: パラメータを設定してJenkins Jobを実行し、ビルドが正常に完了することを検証

**前提条件**:
- シナリオ2-1が完了している
- 有効なOPENAI_API_KEYとGITHUB_TOKENを準備している

**テスト手順**:
1. Jenkins WebUIのパラメータ入力画面で以下を設定：
   - `OPENAI_API_KEY`: （有効なOpenAI APIキー）
   - `GITHUB_TOKEN`: （有効なGitHub Personal Access Token）
   - その他の必須パラメータ（AWS認証情報等）を設定
2. 「Build」ボタンをクリック
3. ビルドが開始されることを確認
4. ビルドログを監視

**期待結果**:
- ビルドが正常に開始される
- エラーなくビルドが進行する
- ビルドが成功する（SUCCESS）

**確認項目**:
- [ ] ビルドが正常に開始される
- [ ] 認証情報エラーが発生しない
- [ ] ビルドがSUCCESSで完了する

---

### シナリオ2-3: コンソール出力でのマスキング検証

**目的**: Jenkins Jobのコンソール出力で、パラメータ値が`****`でマスキングされることを検証

**前提条件**:
- シナリオ2-2でビルドが実行されている

**テスト手順**:
1. Jenkins WebUIでビルドログ（Console Output）を開く
2. `OPENAI_API_KEY`の記載を検索
3. `GITHUB_TOKEN`の記載を検索
4. 環境変数設定部分のログを確認

**期待結果**:
- `OPENAI_API_KEY`の値が`****`でマスキングされている
- `GITHUB_TOKEN`の値が`****`でマスキングされている
- パラメータの実際の値が平文でログに記録されていない
- AWS認証情報と同じマスキング動作である

**確認項目**:
- [ ] `OPENAI_API_KEY`がマスキングされている
- [ ] `GITHUB_TOKEN`がマスキングされている
- [ ] 実際の値（APIキーやトークン）が平文で表示されていない
- [ ] AWS認証情報と同じマスキングパターンである

**検証コマンド** (Console Output内で確認):
```
# environment セクションのログを確認
# 期待: OPENAI_API_KEY = ****
# 期待: GITHUB_TOKEN = ****
```

---

### シナリオ2-4: Docker コンテナ内での環境変数設定検証

**目的**: Docker コンテナ内で、パラメータで指定した値が環境変数として正しく設定されていることを検証

**前提条件**:
- シナリオ2-2でビルドが実行されている
- Dockerコンテナが起動している

**テスト手順**:
1. Jenkins Jobの実行中に、Docker コンテナ内でシェルコマンドを実行する（Jenkinsfileの`sh`ステージで実装）
2. 以下のコマンドを実行：
   ```bash
   echo "OPENAI_API_KEY length: ${#OPENAI_API_KEY}"
   echo "GITHUB_TOKEN length: ${#GITHUB_TOKEN}"
   ```
3. コンソール出力を確認

**期待結果**:
- `OPENAI_API_KEY`環境変数が設定されている（文字列長が0でない）
- `GITHUB_TOKEN`環境変数が設定されている（文字列長が0でない）
- 環境変数の値がパラメータで指定した値と一致している（長さで確認）

**確認項目**:
- [ ] `OPENAI_API_KEY`環境変数が設定されている
- [ ] `GITHUB_TOKEN`環境変数が設定されている
- [ ] 環境変数の値が空でない
- [ ] パラメータで指定した値と一致している（長さで検証）

**注意事項**:
- セキュリティのため、環境変数の実際の値をログに出力しない
- 文字列長（`${#変数名}`）で値が設定されていることのみ確認する

---

### シナリオ2-5: AI Workflow CLIでの認証情報利用確認

**目的**: AI Workflow CLIが、パラメータで渡された認証情報を正しく利用できることを検証

**前提条件**:
- シナリオ2-2でビルドが実行されている
- AI Workflow CLIが実行される

**テスト手順**:
1. Jenkins Jobの実行中に、AI Workflow CLIが実行されることを確認
2. コンソール出力で、以下のログを確認：
   - OpenAI APIへのリクエストが成功している
   - GitHub APIへのリクエストが成功している
3. ビルドが正常に完了することを確認

**期待結果**:
- OpenAI APIへのリクエストが成功する
- GitHub APIへのリクエストが成功する
- 認証エラーが発生しない
- AI Workflow CLIが正常に動作する

**確認項目**:
- [ ] OpenAI APIリクエストが成功する
- [ ] GitHub APIリクエストが成功する
- [ ] 認証エラー（401 Unauthorized等）が発生しない
- [ ] AI Workflow CLIが正常に完了する

**検証ログ例**:
```
# 期待されるログパターン
✓ OpenAI API connection successful
✓ GitHub API connection successful
✓ AI Workflow CLI execution completed
```

---

### シナリオ2-6: AWS認証情報パターンとの一貫性検証

**目的**: `OPENAI_API_KEY`と`GITHUB_TOKEN`のパラメータ化パターンが、AWS認証情報と一貫性があることを検証

**前提条件**:
- Jenkinsfileが修正されている

**テスト手順**:
1. Jenkinsfileの`environment`セクションを確認
2. AWS認証情報のパターンと比較：
   ```groovy
   // AWS認証情報（既存パターン）
   AWS_ACCESS_KEY_ID = "${params.AWS_ACCESS_KEY_ID ?: ''}"

   // OPENAI_API_KEY（新規パターン）
   OPENAI_API_KEY = "${params.OPENAI_API_KEY}"
   ```
3. パラメータ型を確認（`password`型）

**期待結果**:
- `OPENAI_API_KEY`と`GITHUB_TOKEN`が`"${params.xxx}"`パターンで記載されている
- AWS認証情報と同じ構文パターンである
- パラメータ型が`password`である

**確認項目**:
- [ ] `"${params.OPENAI_API_KEY}"`形式で記載されている
- [ ] `"${params.GITHUB_TOKEN}"`形式で記載されている
- [ ] AWS認証情報と同じ構文パターンである
- [ ] パラメータ型が`password`である

**注意事項**:
- AWS認証情報は`?: ''`によるフォールバック（空文字列）を提供しているが、`OPENAI_API_KEY`と`GITHUB_TOKEN`は必須パラメータとして扱うため、フォールバックは不要

---

### シナリオ2-7: credentials参照の完全削除確認

**目的**: Jenkinsfileから`credentials('openai-api-key')`と`credentials('github-token')`の参照が完全に削除されていることを検証

**前提条件**:
- Jenkinsfileが修正されている

**テスト手順**:
1. Jenkinsfile全体を`credentials('openai-api-key')`で検索
2. Jenkinsfile全体を`credentials('github-token')`で検索
3. 検索結果が0件であることを確認

**期待結果**:
- `credentials('openai-api-key')`が検索でヒットしない
- `credentials('github-token')`が検索でヒットしない
- 既存の`credentials()`参照が完全に削除されている

**確認項目**:
- [ ] `credentials('openai-api-key')`がヒットしない
- [ ] `credentials('github-token')`がヒットしない
- [ ] 他の`credentials()`参照（claude-code-oauth-token）は残っている

**検証コマンド**:
```bash
grep -n "credentials('openai-api-key')" Jenkinsfile
grep -n "credentials('github-token')" Jenkinsfile
# 期待: どちらも0件
```

---

### シナリオ2-8: パラメータ未設定時のエラーハンドリング検証

**目的**: パラメータを設定せずにビルドを実行した場合、適切なエラーメッセージが表示されることを検証

**前提条件**:
- Jenkinsfileがリポジトリにプッシュされている

**テスト手順**:
1. Jenkins WebUIのパラメータ入力画面で、`OPENAI_API_KEY`と`GITHUB_TOKEN`を**空のまま**にする
2. 「Build」ボタンをクリック
3. ビルドログを確認

**期待結果**:
- ビルドがエラーで停止する（FAILURE）
- エラーメッセージが表示される（認証情報が未設定である旨）
- セキュリティ上、デフォルト値が設定されていない

**確認項目**:
- [ ] ビルドがFAILUREで停止する
- [ ] エラーメッセージが明確である
- [ ] デフォルト値が設定されていない（セキュリティ要件）

**注意事項**:
- このテストは、リスク軽減策として「パラメータ未設定時のエラーメッセージ」を検証するもの
- パラメータにデフォルト値を設定しないことがセキュリティ要件である

---

### シナリオ2-9: 後方互換性の検証

**目的**: パラメータ追加が既存のJenkins Jobに影響を与えないことを検証

**前提条件**:
- Jenkinsfileが修正されている
- 既存のJenkins Jobが存在する

**テスト手順**:
1. 既存のJenkins Job（パラメータ未設定）をビルド実行
2. パラメータ入力画面が表示されることを確認
3. 新しいパラメータ（`OPENAI_API_KEY`、`GITHUB_TOKEN`）が表示されることを確認

**期待結果**:
- 既存のJobがエラーなく開ける
- パラメータ入力画面が表示される
- 新しいパラメータが追加されている

**確認項目**:
- [ ] 既存のJobが正常に開ける
- [ ] パラメータ入力画面が表示される
- [ ] 新しいパラメータが追加表示される
- [ ] 既存のJobの設定が壊れていない

**注意事項**:
- パラメータ追加は後方互換性があるため、既存のJobは影響を受けない
- ただし、新しいパラメータを設定しない限り、ビルドが失敗する（意図的な動作）

---

## 3. テストデータ

### 3.1 正常データ

| パラメータ名 | テストデータ | 説明 |
|-------------|-------------|------|
| `OPENAI_API_KEY` | `sk-test1234567890abcdef` | 有効なOpenAI APIキー（テスト用） |
| `GITHUB_TOKEN` | `ghp_test1234567890abcdef` | 有効なGitHub Personal Access Token（テスト用） |
| `AWS_ACCESS_KEY_ID` | `AKIA1234567890ABCDEF` | 有効なAWS Access Key ID（テスト用） |
| `AWS_SECRET_ACCESS_KEY` | `abcd1234567890ABCD` | 有効なAWS Secret Access Key（テスト用） |
| `AWS_SESSION_TOKEN` | `session1234567890` | 有効なAWS Session Token（テスト用） |

### 3.2 異常データ

| パラメータ名 | テストデータ | 期待されるエラー |
|-------------|-------------|-----------------|
| `OPENAI_API_KEY` | （空文字列） | ビルド失敗（認証エラー） |
| `GITHUB_TOKEN` | （空文字列） | ビルド失敗（認証エラー） |
| `OPENAI_API_KEY` | `invalid-key` | OpenAI API認証エラー |
| `GITHUB_TOKEN` | `invalid-token` | GitHub API認証エラー |

### 3.3 境界値データ

| パラメータ名 | テストデータ | 説明 |
|-------------|-------------|------|
| `OPENAI_API_KEY` | （最小長のAPIキー） | OpenAI APIキーの最小文字数 |
| `GITHUB_TOKEN` | （最小長のトークン） | GitHub Tokenの最小文字数 |

**注意事項**:
- 実際のテスト実行時は、本番環境の認証情報を使用しないこと
- テスト用の認証情報を準備し、テスト完了後は削除すること

---

## 4. テスト環境要件

### 4.1 必要なテスト環境

- **Jenkins環境**:
  - Jenkinsサーバーが稼働している
  - Jenkins Job（AI Workflow Orchestrator）が設定されている
  - Job DSLでパラメータが定義されている

- **Docker環境**:
  - Dockerイメージが利用可能である
  - Docker実行権限がある

- **認証情報**:
  - テスト用のOPENAI_API_KEY
  - テスト用のGITHUB_TOKEN
  - テスト用のAWS認証情報

### 4.2 必要な外部サービス

- **OpenAI API**: APIリクエストのテストに必要
- **GitHub API**: APIリクエストのテストに必要
- **AWS**: AWS認証情報のテストに必要（オプション）

### 4.3 モック/スタブの必要性

**不要**

- 統合テスト戦略（INTEGRATION_ONLY）のため、実際のシステムで検証
- モック/スタブは使用しない

---

## 5. テスト実行の前提条件チェックリスト

テスト実行前に、以下の前提条件を確認してください：

- [ ] Jenkinsfileが修正され、リポジトリにプッシュされている
- [ ] Jenkins Jobが最新のJenkinsfileを参照している
- [ ] Jenkins Job DSLでパラメータ（`OPENAI_API_KEY`、`GITHUB_TOKEN`）が定義されている
- [ ] テスト用の認証情報を準備している
- [ ] Jenkinsサーバーにアクセス可能である
- [ ] Docker環境が利用可能である

---

## 6. テスト実行スケジュール

| テストシナリオ | 実行順序 | 依存関係 | 見積もり時間 |
|--------------|---------|---------|-------------|
| シナリオ2-1: パラメータ入力画面での表示確認 | 1 | なし | 5分 |
| シナリオ2-2: パラメータ設定とJenkins Job実行 | 2 | シナリオ2-1完了 | 10分 |
| シナリオ2-3: コンソール出力でのマスキング検証 | 3 | シナリオ2-2完了 | 5分 |
| シナリオ2-4: Docker コンテナ内での環境変数設定検証 | 4 | シナリオ2-2完了 | 5分 |
| シナリオ2-5: AI Workflow CLIでの認証情報利用確認 | 5 | シナリオ2-2完了 | 10分 |
| シナリオ2-6: AWS認証情報パターンとの一貫性検証 | 6 | なし | 5分 |
| シナリオ2-7: credentials参照の完全削除確認 | 7 | なし | 5分 |
| シナリオ2-8: パラメータ未設定時のエラーハンドリング検証 | 8 | なし | 5分 |
| シナリオ2-9: 後方互換性の検証 | 9 | なし | 5分 |

**総見積もり時間**: 約1時間（55分）

---

## 7. テスト完了基準

以下の条件をすべて満たした場合、テストは完了とします：

- [ ] すべてのテストシナリオ（2-1 ~ 2-9）が実行されている
- [ ] すべての確認項目がチェックされている
- [ ] パラメータが正しくマスキングされている
- [ ] 環境変数が正しく設定されている
- [ ] AI Workflow CLIが正常に動作している
- [ ] AWS認証情報との一貫性が確認されている
- [ ] credentials参照が完全に削除されている
- [ ] 後方互換性が確認されている
- [ ] ブロッカー（次フェーズに進めない問題）が存在しない

---

## 8. リスクと軽減策（テスト観点）

### リスク1: テスト用認証情報の漏洩

- **影響度**: 高
- **確率**: 低
- **軽減策**:
  - テスト用の認証情報を使用し、本番環境のものを使用しない
  - テスト完了後、テスト用認証情報を削除する
  - Jenkinsログに認証情報が平文で記録されないことを確認（シナリオ2-3で検証）

### リスク2: Jenkins環境へのアクセス権限不足

- **影響度**: 中
- **確率**: 低
- **軽減策**:
  - テスト実行前に、Jenkins環境へのアクセス権限を確認する
  - 必要に応じて、管理者に権限付与を依頼する

### リスク3: テスト実行時のビルド失敗

- **影響度**: 中
- **確率**: 中
- **軽減策**:
  - テスト実行前に、前提条件チェックリストを確認する
  - ビルド失敗時は、コンソール出力を確認し、エラー原因を特定する
  - 必要に応じて、Jenkinsfileを修正し、再テストする

---

## 9. 品質ゲート（Phase 3: Test Scenario）

- [x] **Phase 2の戦略に沿ったテストシナリオである**
  - INTEGRATION_ONLY戦略に基づき、Jenkins Job実行時の統合テストシナリオを作成
- [x] **主要な正常系がカバーされている**
  - パラメータ設定、環境変数設定、マスキング、AI Workflow CLI連携が正常に動作することを検証
- [x] **主要な異常系がカバーされている**
  - パラメータ未設定時のエラーハンドリングを検証
- [x] **期待結果が明確である**
  - 各シナリオで期待結果と確認項目を明記

---

## 10. まとめ

このテストシナリオでは、Jenkinsfileの認証情報管理を`credentials()`から`params`に統一する変更について、統合テスト（INTEGRATION_ONLY）の観点から検証します。

**主要なテストシナリオ**:
1. パラメータ入力画面での表示確認
2. パラメータ設定とJenkins Job実行
3. コンソール出力でのマスキング検証
4. Docker コンテナ内での環境変数設定検証
5. AI Workflow CLIでの認証情報利用確認
6. AWS認証情報パターンとの一貫性検証
7. credentials参照の完全削除確認
8. パラメータ未設定時のエラーハンドリング検証
9. 後方互換性の検証

**テストの目的**:
- パラメータから環境変数への値の伝播を検証
- セキュリティ要件（マスキング）が満たされることを確認
- AI Workflow CLIが正常に動作することを確認
- AWS認証情報との一貫性を確認

**総見積もり時間**: 約1時間

**次のアクション**: Phase 4（Implementation）に進み、Jenkinsfileの修正を実施してください。

---

**作成日**: 2025-01-XX
**バージョン**: 1.0
**ステータス**: Draft
