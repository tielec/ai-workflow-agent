# 要件定義書 - Issue #105

**Issue番号**: #105
**タイトル**: [FOLLOW-UP] Issue #102 - 残タスク
**作成日**: 2025-01-31
**ステータス**: Requirements Phase

---

## 0. Planning Document の確認

Planning Phase (Phase 0) で策定された開発計画を確認しました：

### 開発計画の全体像
- **複雑度**: 中程度
- **総工数**: 4〜6時間（8フェーズ）
- **実装戦略**: EXTEND（既存コードの拡張）
- **テスト戦略**: UNIT_INTEGRATION（ユニットテスト + 統合テスト）
- **テストコード戦略**: EXTEND_TEST（既存テストファイルの修正）

### スコープ
- Issue #102 評価レポートで特定された2つの残タスクの完了
- テストインフラストラクチャの改善のみ（本体コード変更なし）
- Jest設定の拡張（ESMパッケージ対応）
- commit-manager.test.ts の統合テスト実行可能化
- プロジェクト全体のテスト修正（103個の失敗テストのうち高優先度のみ）

### 技術選定
- 既存の Jest + ts-jest エコシステムを維持
- chalk の ESM対応（transformIgnorePatterns 拡張）
- experimental-vm-modules の導入は状況に応じて判断

### リスク
1. chalk内部依存（#ansi-styles）のESM対応が複雑（影響度: 中、確率: 中）
2. 103個の失敗テストすべてを修正できない（影響度: 中、確率: 高）
3. Jest ESMサポートの不安定性（影響度: 高、確率: 低）
4. 本体コードへの予期しない影響（影響度: 低、確率: 低）

### スケジュール
- Phase 1: 要件定義（0.5〜0.75h）
- Phase 2: 設計（0.5〜0.75h）
- Phase 3: テストシナリオ（0.5〜0.75h）
- Phase 4: 実装（1〜2h）
- Phase 5: テストコード実装（0.5〜0.75h）
- Phase 6: テスト実行（0.5〜0.75h）
- Phase 7: ドキュメント（0.25〜0.5h）
- Phase 8: レポート（0.25〜0.5h）

---

## 1. 概要

### 背景
Issue #102 の実施により、以下の成果が得られました：
- テスト期待値の修正（file-selector.test.ts、commit-message-builder.test.ts）
- Jest設定の修正（transformIgnorePatterns に chalk を追加）
- 全ユニットテストの成功（32ケース、100% 成功）

しかし、Evaluation Phase（Phase 9）で以下の2つの残タスクが特定されました：
1. **commit-manager.test.ts の完全な実行可能化**: chalk の内部依存（#ansi-styles）が ESM 形式エラーを引き起こし、統合テストが実行できない
2. **プロジェクト全体のテストスイート修正**: 103個の失敗テストが Issue #102 とは無関係な既存の問題として残存

Issue #102 では Jest が chalk を変換対象として認識するまで完了しましたが、chalk の内部依存（#ansi-styles）の完全な ESM 対応と、プロジェクト全体のテスト修正は別途対応が必要と判断されました。

### 目的
Issue #105 の目的は、Issue #102 で残存した2つのタスクを完了させ、プロジェクト全体のテストインフラストラクチャを安定化させることです。具体的には：

1. **統合テストの実行可能化**: commit-manager.test.ts の統合テストが完全に実行可能になる
2. **失敗テスト数の削減**: 103個の失敗テストを調査・修正し、高優先度テスト（ブロッカー）をすべて解消する
3. **Jest ESM対応の強化**: transformIgnorePatterns の拡張により、chalk 内部依存（#ansi-styles）を含む ESM パッケージを適切に変換する

### ビジネス価値・技術的価値

**ビジネス価値**:
- **品質保証の強化**: 統合テストが実行可能になることで、Git コミット機能の品質を保証
- **CI/CD の安定化**: 失敗テスト数の削減により、Jenkins Job の成功率が向上
- **開発速度の向上**: テストインフラが安定することで、開発者が新機能開発に集中可能

**技術的価値**:
- **ESM 対応の完了**: Node.js エコシステムの標準である ESM パッケージに完全対応
- **テストカバレッジの向上**: 統合テストの実行により、カバレッジが 90.6% → 95% 以上に向上（期待値）
- **技術的負債の削減**: 103個の失敗テストという技術的負債を削減し、保守性を向上

---

## 2. 機能要件

### FR-1: Jest設定の拡張（ESMパッケージ対応）

**優先度**: 高（ブロッカー）

**説明**:
`jest.config.cjs` の `transformIgnorePatterns` を拡張し、chalk の内部依存（#ansi-styles）を含む ESM パッケージを変換対象に含める。

**詳細**:
- **現状**: `transformIgnorePatterns: ['/node_modules/(?!(strip-ansi|ansi-regex|chalk)/)']`（Issue #102 で追加）
- **目標**: #ansi-styles を含める形に拡張（例: `/node_modules/(?!(strip-ansi|ansi-regex|chalk|#ansi-styles)/)`）
- **技術的根拠**: chalk v5.3.0 は ESM only パッケージであり、内部依存（#ansi-styles）も ESM 形式のため、Jest が CommonJS として扱う場合にエラーが発生する

**受け入れ基準**:
- **Given**: Jest設定ファイル `jest.config.cjs` が存在する
- **When**: transformIgnorePatterns に #ansi-styles を追加する
- **Then**:
  - Jest が chalk および #ansi-styles を変換対象として認識する
  - `npm test` 実行時に chalk 関連の ESM エラーが発生しない
  - commit-manager.test.ts が実行可能になる

---

### FR-2: commit-manager.test.ts の統合テスト実行可能化

**優先度**: 高（ブロッカー）

**説明**:
commit-manager.test.ts の統合テストが完全に実行可能になるように、chalk インポートの問題とモック設定の問題を修正する。

**詳細**:
- **問題1**: chalk インポートのESMエラー（FR-1で解決）
- **問題2**: simple-git のモック型定義の問題
- **修正方針**: FR-1の完了後、モック設定を見直し、TypeScript型エラーを解消

**受け入れ基準**:
- **Given**: commit-manager.test.ts ファイルが存在する
- **When**: `npm test` でテストを実行する
- **Then**:
  - すべてのテストケースが実行完了する（SKIP なし）
  - すべてのテストケースが PASS する
  - エラーメッセージが表示されない

---

### FR-3: 高優先度テストの修正（ブロッカーの解消）

**優先度**: 高（ブロッカー）

**説明**:
103個の失敗テストのうち、高優先度テスト（ブロッカー、頻出エラー）を修正する。

**詳細**:
- **対象**: Phase 1（要件定義）で分析される上位5〜10個の代表的なエラーパターン
- **修正方針**: TypeScript型エラー、モック設定の問題、テスト期待値のずれを修正
- **スコープ**: すべての失敗テストを修正することは Issue #105 のスコープ外（Phase 8で次のフォローアップIssue作成を判断）

**受け入れ基準**:
- **Given**: 103個の失敗テストが存在する
- **When**: 高優先度テスト（ブロッカー）を修正する
- **Then**:
  - 失敗テスト数が 103個 → 50個以下に削減される
  - 高優先度テスト（ブロッカー）がすべて PASS する
  - CI環境（Jenkins）でビルドが成功する

---

### FR-4: experimental-vm-modules 導入の判断（条件付き）

**優先度**: 中（オプショナル）

**説明**:
FR-1（transformIgnorePatterns 拡張）で解決しない場合、Jest の experimental-vm-modules を導入する。

**詳細**:
- **条件**: FR-1 の修正後も chalk 内部依存のエラーが解消しない場合のみ実施
- **実装内容**:
  - `package.json` の `scripts` に `NODE_OPTIONS=--experimental-vm-modules` を追加
  - Jenkinsfile の Jest実行コマンドを更新
- **リスク**: experimental-vm-modules は実験的機能であり、不安定な可能性あり（リスク3）

**受け入れ基準**:
- **Given**: FR-1 の修正後も chalk エラーが解消しない
- **When**: experimental-vm-modules を導入する
- **Then**:
  - commit-manager.test.ts が実行可能になる
  - 既存のテストケースが引き続き PASS する
  - CI環境（Jenkins）でテストが正常に実行される

---

### FR-5: CLAUDE.md の更新（Jest設定の詳細説明）

**優先度**: 中

**説明**:
CLAUDE.md に Jest設定の詳細説明を追加し、transformIgnorePatterns の拡張内容と experimental-vm-modules（導入した場合）の説明を記載する。

**詳細**:
- **追加セクション**: 「### Jest設定（ESMパッケージ対応）」
- **記載内容**:
  - transformIgnorePatterns の拡張内容（#ansi-styles を含める理由）
  - experimental-vm-modules の説明（導入した場合）
  - Issue #105 への参照リンク

**受け入れ基準**:
- **Given**: CLAUDE.md ファイルが存在する
- **When**: Jest設定の詳細説明を追加する
- **Then**:
  - 「### Jest設定（ESMパッケージ対応）」セクションが追加される
  - transformIgnorePatterns の拡張内容が明記される
  - Issue #105 への参照リンクが追加される

---

### FR-6: CHANGELOG.md の更新（Issue #105 の変更履歴）

**優先度**: 中

**説明**:
CHANGELOG.md の Unreleased セクションに Issue #105 の変更履歴を追加する。

**詳細**:
- **追加セクション**: `## [Unreleased]` 配下の `### Fixed` または `### Changed`
- **記載内容**:
  - Jest設定拡張の説明
  - テスト修正のサマリー
  - Issue #105 への参照リンク

**受け入れ基準**:
- **Given**: CHANGELOG.md ファイルが存在する
- **When**: Issue #105 の変更履歴を追加する
- **Then**:
  - `## [Unreleased]` セクションに変更履歴が追加される
  - 修正内容のサマリーが記載される
  - Issue #105 への参照リンク（`#105`）が追加される

---

## 3. 非機能要件

### NFR-1: パフォーマンス要件

**テスト実行時間**:
- **要件**: 全テストスイート実行時間が Issue #102 と同等（2〜3分以内）を維持する
- **根拠**: transformIgnorePatterns 拡張により変換対象が増えるが、実行時間への影響は最小限に抑える
- **測定方法**: `npm test` の実行時間を計測

**CI/CDビルド時間**:
- **要件**: Jenkins Job の実行時間が 10% 以上増加しない
- **根拠**: 失敗テスト数の削減により、全体としてはビルド時間が短縮される期待値
- **測定方法**: Jenkins Job の Build Duration を計測

---

### NFR-2: セキュリティ要件

**依存関係のセキュリティ**:
- **要件**: 新規依存関係を追加しない（既存の chalk、jest、ts-jest のみ使用）
- **根拠**: セキュリティリスクを最小化
- **検証方法**: `npm audit` でセキュリティ脆弱性がないことを確認

**機密情報の管理**:
- **要件**: テストコードに機密情報（APIキー、トークン等）を含めない
- **根拠**: テストコードはバージョン管理対象であり、機密情報が漏洩するリスクを防ぐ
- **検証方法**: コードレビューで機密情報が含まれていないことを確認

---

### NFR-3: 可用性・信頼性要件

**回帰テストの成功**:
- **要件**: Issue #102 で修正したテストが引き続き PASS する
- **根拠**: 後方互換性の維持
- **検証方法**: file-selector.test.ts、commit-message-builder.test.ts が PASS することを確認

**テストカバレッジの維持**:
- **要件**: プロジェクト全体のテストカバレッジが 90% 以上を維持する
- **根拠**: コード品質の保証
- **測定方法**: `npm run test:coverage` でカバレッジレポートを確認

---

### NFR-4: 保守性・拡張性要件

**本体コード変更なし**:
- **要件**: src/ 配下のコード変更を0行に抑える
- **根拠**: テストインフラの改善であり、プロダクション環境への影響を避ける
- **検証方法**: `git diff` で src/ 配下の変更がないことを確認

**ロールバック可能性**:
- **要件**: 問題が発生した場合、git revert で Issue #102 完了時の状態に戻せる
- **根拠**: リスク軽減策（Planning Document のリスク4）
- **検証方法**: ロールバック手順を Phase 2（設計）で明記

**ドキュメントの完全性**:
- **要件**: CLAUDE.md、CHANGELOG.md に変更内容が正確に記載される
- **根拠**: 将来の開発者が Jest設定の意図を理解できるようにする
- **検証方法**: ドキュメントレビューで正確性を確認

---

## 4. 制約事項

### 技術的制約

**使用技術**:
- **制約**: 既存の Jest + ts-jest エコシステムを維持する
- **理由**: プロジェクト標準のテストフレームワークとして採用されている
- **影響**: Vitest 等の他のテストランナーへの移行は検討しない

**ESMパッケージ**:
- **制約**: chalk v5.3.0（ESM only）を使用する
- **理由**: logger.ts で chalk を使用しており、CommonJS版（v4.x）への切り替えは最終手段
- **影響**: Jest の transformIgnorePatterns で ESM パッケージを適切に変換する必要がある

**Node.js バージョン**:
- **制約**: Node.js 20 以上を使用する
- **理由**: プロジェクトの `.nvmrc` で指定されている
- **影響**: Node.js の ESM/CommonJS 相互運用性の制約を受ける

---

### リソース制約

**工数**:
- **制約**: 総工数 4〜6時間（8フェーズ）
- **理由**: Planning Document で見積もり済み
- **影響**: すべての失敗テスト（103個）を修正することは工数不足のため、高優先度テストのみ修正

**スコープ**:
- **制約**: 本体コード（src/）への変更は0行
- **理由**: テストインフラの改善のみを目的とする
- **影響**: logger.ts の chalk 依存を最小化する修正は実施しない

---

### ポリシー制約

**コーディング規約**:
- **制約**: CLAUDE.md で定義されたコーディング規約に準拠する
- **具体例**:
  - ロギング: 統一loggerモジュール（`src/utils/logger.ts`）を使用し、console.log/error/warn の直接使用は禁止
  - エラーハンドリング: `as Error` 型アサーションの使用は禁止、`getErrorMessage()` を使用
  - 環境変数アクセス: `process.env` への直接アクセスは禁止、`config.getXxx()` を使用
- **影響**: テストコード修正時にも規約を遵守する必要がある

**バージョン管理**:
- **制約**: `.ai-workflow/` ディレクトリはフィーチャーブランチにコミットする
- **理由**: ワークフローメタデータをバージョン管理対象とする
- **影響**: メタデータの変更もPRに含まれる

---

## 5. 前提条件

### システム環境

**開発環境**:
- Node.js 20 以上
- npm 10 以上
- Git 2.30 以上

**CI環境（Jenkins）**:
- Docker 24 以上
- Node.js 20 ベースのコンテナ
- Jenkins 2.400 以上

---

### 依存コンポーネント

**npm パッケージ**:
- chalk v5.3.0（ESM only）
- jest v29.x
- ts-jest v29.4.5
- simple-git v3.27.0
- @types/jest v29.x

**プロジェクトモジュール**:
- `src/utils/logger.ts`: chalk を使用するロガーモジュール
- `src/core/git/commit-manager.ts`: Git コミット機能（統合テスト対象）

---

### 外部システム連携

**GitHub**:
- Issue #102 の評価レポート（`.ai-workflow/issue-102/09_evaluation/output/evaluation_report.md`）
- Issue #105 の情報

**Git リポジトリ**:
- ブランチ: `ai-workflow/issue-105`（初期化時に作成）
- リモート: `origin`（GitHub）

---

## 6. 受け入れ基準

### AC-1: commit-manager.test.ts の統合テストが実行可能になる

- **Given**: commit-manager.test.ts ファイルが存在する
- **When**: `npm test` でテストを実行する
- **Then**:
  - すべての統合テストケースが実行完了する（SKIP なし）
  - すべての統合テストケースが PASS する
  - chalk 内部依存のエラーが発生しない

---

### AC-2: 失敗テスト数が削減される

- **Given**: 103個の失敗テストが存在する
- **When**: 高優先度テスト（ブロッカー）を修正する
- **Then**:
  - 失敗テスト数が 50個以下に削減される（目標）
  - 高優先度テスト（ブロッカー）がすべて PASS する
  - `npm test` の終了コードが 0 になる（CI環境での成功判定）

---

### AC-3: 回帰テストが成功する

- **Given**: Issue #102 で修正したテストケースが存在する
- **When**: `npm test` で全テストスイートを実行する
- **Then**:
  - file-selector.test.ts がすべて PASS する
  - commit-message-builder.test.ts がすべて PASS する
  - 既存の成功テストケース（32ケース）が引き続き PASS する

---

### AC-4: 本体コードへの影響がない

- **Given**: src/ 配下のソースコードが存在する
- **When**: Issue #105 の変更を適用する
- **Then**:
  - src/ 配下のコード変更が0行である
  - `git diff src/` の結果が空である
  - プロダクション環境への影響がない

---

### AC-5: CLAUDE.md が更新されている

- **Given**: CLAUDE.md ファイルが存在する
- **When**: Jest設定の詳細説明を追加する
- **Then**:
  - 「### Jest設定（ESMパッケージ対応）」セクションが追加される
  - transformIgnorePatterns の拡張内容が明記される
  - Issue #105 への参照リンクが追加される

---

### AC-6: CHANGELOG.md が更新されている

- **Given**: CHANGELOG.md ファイルが存在する
- **When**: Issue #105 の変更履歴を追加する
- **Then**:
  - `## [Unreleased]` セクションに変更履歴が追加される
  - 修正内容のサマリー（Jest設定拡張、テスト修正）が記載される
  - Issue #105 への参照リンク（`#105`）が追加される

---

## 7. スコープ外

### 明確にスコープ外とする事項

**すべての失敗テスト（103個）の修正**:
- **理由**: 工数不足（4〜6時間では対応不可）
- **対応**: 高優先度テスト（ブロッカー）のみ修正し、残りは次のフォローアップIssue（Issue #106?）で対応

**chalk の CommonJS版（v4.x）への切り替え**:
- **理由**: 最終手段として検討するが、Issue #105 では transformIgnorePatterns 拡張で解決することを優先
- **対応**: transformIgnorePatterns で解決しない場合のみ、次のフォローアップIssueで検討

**本体コード（src/）の変更**:
- **理由**: テストインフラの改善のみを目的とし、プロダクション環境への影響を避ける
- **対応**: logger.ts の chalk 依存を最小化する修正は実施しない

**テストカバレッジの向上**:
- **理由**: 主要目的ではない（現在90.6%を維持すれば十分）
- **対応**: 統合テストの実行により自然にカバレッジが向上する期待値だが、95%以上を目標とはしない（Nice to Have）

**Jest の代替テストランナー（Vitest等）への移行**:
- **理由**: プロジェクト標準のテストフレームワークを維持する
- **対応**: Jest エコシステム内で問題を解決する

---

### 将来的な拡張候補

**フォローアップIssue #106（仮）**:
- 残りの失敗テスト（50個以下）の修正
- 中・低優先度テストの修正
- テストカバレッジの 95% 以上への向上

**Jest ESMサポートの安定化**:
- experimental-vm-modules の安定版リリース待ち
- Node.js の ESM/CommonJS 相互運用性の改善

**テスト実行時間の最適化**:
- Jest の並列実行設定の調整
- テストケースの分割（ユニットテスト／統合テスト）

---

## 8. 品質ゲートの確認

本要件定義書は、Phase 1（Requirements）の品質ゲートを満たしていることを確認します。

### ✅ 機能要件が明確に記載されている
- FR-1: Jest設定の拡張（ESMパッケージ対応）
- FR-2: commit-manager.test.ts の統合テスト実行可能化
- FR-3: 高優先度テストの修正（ブロッカーの解消）
- FR-4: experimental-vm-modules 導入の判断（条件付き）
- FR-5: CLAUDE.md の更新（Jest設定の詳細説明）
- FR-6: CHANGELOG.md の更新（Issue #105 の変更履歴）

各機能要件は優先度（高/中/低）を付与し、具体的かつ測定可能な形で記述されています。

### ✅ 受け入れ基準が定義されている
- AC-1: commit-manager.test.ts の統合テストが実行可能になる
- AC-2: 失敗テスト数が削減される
- AC-3: 回帰テストが成功する
- AC-4: 本体コードへの影響がない
- AC-5: CLAUDE.md が更新されている
- AC-6: CHANGELOG.md が更新されている

各受け入れ基準は Given-When-Then 形式で記述され、検証可能な形になっています。

### ✅ スコープが明確である
- **スコープ内**: Jest設定拡張、commit-manager.test.ts の修正、高優先度テストの修正、ドキュメント更新
- **スコープ外**: すべての失敗テスト（103個）の修正、chalk の CommonJS版への切り替え、本体コード変更、テストランナーの移行

スコープ外の事項と将来的な拡張候補を明確に記載しています。

### ✅ 論理的な矛盾がない
- 機能要件と受け入れ基準が対応している
- 非機能要件と制約事項が矛盾していない
- Planning Document の開発計画と整合性が取れている
- リスク軽減策が制約事項と矛盾していない

---

## 9. 次のステップ

本要件定義書の承認後、Phase 2（Design）へ進み、以下を実施します：

1. **Jest設定の詳細設計** (Task 2-1)
   - transformIgnorePatterns の拡張設計（#ansi-styles を含める）
   - experimental-vm-modules 導入の要否判断
   - package.json scripts の更新設計

2. **テスト修正の詳細設計** (Task 2-2)
   - commit-manager.test.ts の問題箇所の特定と修正方針
   - 103個の失敗テストの修正優先順位決定（高優先度: ブロッカー、中優先度: 型エラー、低優先度: その他）
   - テスト修正の共通パターン抽出（モック設定、型定義、etc.）

---

**要件定義フェーズ完了**

このドキュメントは Issue #105 の実装を成功させるための詳細な要件定義です。すべての品質ゲートを満たすことで、次フェーズへの円滑な移行を保証します。
