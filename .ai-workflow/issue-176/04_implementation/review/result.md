レビューを開始します。まず、実装されたコードファイルを確認します。
次に、src/main.tsの変更を確認し、Planning.mdとの照合を行います。
Planning.mdを読み込んで、Phase 4のタスクチェックリストと照合します。
Planning.mdの品質ゲートセクションも更新します。
それでは、レビュー結果をまとめます。

## 品質ゲート評価

**⚠️ 重要: 各項目に対して明示的にPASS/FAILを判定してください。1つでもFAILがあれば最終判定は自動的にFAILです。**

- [x] **Phase 2の設計に沿った実装である**: **PASS**
  - 設計書で定義された全てのファイルが実装されている
  - クラス設計、関数設計、データ構造設計が設計書通りに実装されている
  - 実装ログに記載された修正（境界値判定エラーの修正）も適切に行われている

- [x] **既存コードの規約に準拠している**: **PASS**
  - CLAUDE.mdの規約（ロギング、環境変数アクセス、エラーハンドリング）に完全準拠
  - ReDoS攻撃防止のため`replaceAll()`を使用
  - 既存の`auto-issue.ts`パターンを踏襲
  - 型安全性が確保されている（any型の使用を最小限に）

- [x] **基本的なエラーハンドリングがある**: **PASS**
  - try-catchによる包括的なエラーキャッチ
  - getErrorMessage()による安全なエラーメッセージ抽出
  - エージェント実行失敗時のnull返却とログ出力
  - JSON parseエラー時の適切なハンドリング

- [x] **明らかなバグがない**: **PASS**
  - TypeScriptビルド成功（実装ログに記載）
  - 境界値判定エラーが2件修正済み（TS-UNIT-022, TS-UNIT-024）
  - 型チェックによる実装ミス防止
  - null/undefined安全性（?? 演算子の使用）

**品質ゲート総合判定: PASS**
- PASS: 上記4項目すべてがPASS

## 詳細レビュー

### 1. 設計との整合性

**良好な点**:
- 設計書の「7. 詳細設計」に記載された全てのクラス、関数、データ構造が正確に実装されている
- `IssueInspector`クラスの実装が設計書通り（420行、全メソッドを実装）
- プロンプトテンプレート（inspect-issue.txt）が設計書の仕様に完全準拠（145行、4つの判定観点を明示）
- 型定義ファイル（auto-close-issue.ts）が設計書の型定義を網羅（286行）
- CLIコマンドハンドラ（auto-close-issue.ts）が設計書の関数構成通りに実装（437行）
- IssueClientの拡張が軽微かつ後方互換性100%維持（getIssues, closeIssue, addLabelsメソッドを追加）
- main.tsへのコマンド追加が設計書通り（8個のCLIオプション定義）
- 実装ログに記載された修正履歴（境界値判定エラー2件）が適切

**懸念点**:
- なし（設計書との整合性は完璧）

### 2. コーディング規約への準拠

**良好な点**:
- **ロギング**: 統一loggerモジュール（`src/utils/logger.ts`）を使用、console.log等の直接使用なし
- **環境変数アクセス**: Configクラス（`src/core/config.ts`）経由でアクセス、process.env直接アクセスなし
- **エラーハンドリング**: getErrorMessage()を使用して安全にエラーメッセージ抽出、`as Error`型アサーション禁止遵守
- **セキュリティ**: ReDoS攻撃防止のため`replaceAll()`を使用（fillTemplateメソッド）
- **命名規則**: 既存コードのスタイルに統一（PascalCase: IssueInspector、camelCase: inspectIssue）
- **非同期処理**: async/awaitを使用、Promiseチェーンではなくasync/await統一
- **型安全性**: 全ての関数に明示的な型アノテーション、any型の使用を最小限に（AgentExecutorインターフェースのみ）
- **既存パターン踏襲**: `auto-issue.ts`のコマンドハンドラパターンを踏襲
- **依存性注入**: IssueInspectorコンストラクタで依存性注入、テスト時にモック注入可能

**懸念点**:
- なし（CLAUDE.md規約に100%準拠）

### 3. エラーハンドリング

**良好な点**:
- **inspectIssue()**: try-catchで包括的にエラーキャッチし、null返却とログ出力
- **parseInspectionResult()**: JSON parseエラー時に適切な例外をスロー、必須フィールド検証
- **extractOutputFromMessages()**: エージェント出力が空の場合にエラーをスロー
- **handleAutoCloseIssueCommand()**: メインハンドラ全体をtry-catchで包み、エラーログ出力とエラー再スロー
- **closeCandidates()**: 各Issueクローズ時にtry-catchで個別にエラーハンドリング、1件失敗しても処理継続
- **環境変数チェック**: GITHUB_TOKEN、GITHUB_REPOSITORYの存在確認と明確なエラーメッセージ
- **エージェント認証情報チェック**: codexClient, claudeClient両方がnullの場合の明確なエラーメッセージ
- **バリデーション**: CLIオプションの範囲チェック（limit: 1-50、confidence: 0.0-1.0、daysThreshold: 正の整数）と明確なエラーメッセージ

**改善の余地**:
- なし（基本的なエラーハンドリングは十分）

### 4. バグの有無

**良好な点**:
- **TypeScriptビルド成功**: 実装ログに記載されたコンパイルエラー0個
- **境界値判定エラー修正**: 実装ログに記載された2件のバグ修正（TS-UNIT-022: 最近更新除外の境界値判定、TS-UNIT-024: confidence閾値の境界値判定）
- **型チェック**: TypeScriptの型システムによる実装ミス防止
- **null/undefined安全性**: `?? 演算子`の使用、フォールバック値の適切な設定
- **浮動小数点数比較**: epsilonを使用した安全な比較（confidence閾値チェック）
- **JSON parse安全性**: JSONブロック抽出を試みる前にマッチング確認

**懸念点**:
- なし（明らかなバグはない）

### 5. 保守性

**良好な点**:
- **コードが読みやすい**: メソッド名、変数名が明確で意図が理解しやすい
- **コメント充実**: 各クラス、メソッドにJSDocコメントが記載され、パラメータと戻り値が説明されている
- **適切な分割**: 単一責任原則に従ったクラス設計（IssueInspector: 検品ロジック、auto-close-issue: CLIハンドラ）
- **マジックナンバー排除**: デフォルト値を変数として定義（category: 'followup', limit: 10, confidence: 0.7等）
- **定数化**: 除外ラベル（'do-not-close,pinned'）、最近更新除外日数（7日）等を定数として明示
- **ヘルパー関数**: calculateDaysSince、formatIssueInfo等の再利用可能な関数
- **既存パターン継承**: 既存の`auto-issue.ts`パターンを踏襲し、新規開発者が理解しやすい

**改善の余地**:
- **プロンプトテンプレートパス**: ハードコードされたパス（`dist/prompts/auto-close/inspect-issue.txt`）が変更時に影響を受ける可能性
  - 提案: 環境変数や設定ファイルでパスを管理することを検討（Phase 2以降）

## ブロッカー（BLOCKER）

**次フェーズに進めない重大な問題**

なし

## 改善提案（SUGGESTION）

**次フェーズに進めるが、改善が望ましい事項**

1. **プロンプトテンプレートパスの柔軟化**
   - 現状: ハードコードされたパス（`dist/prompts/auto-close/inspect-issue.txt`）
   - 提案: 環境変数や設定ファイルでパスを管理することで、テスト時や開発時に別のテンプレートを使用可能にする
   - 効果: テスト容易性向上、プロンプト改善の実験が容易になる
   - **優先度**: 低（Phase 2以降で検討可能）

2. **エージェント出力パースの堅牢性向上**
   - 現状: JSONブロック抽出の正規表現マッチング（``` json ... ```または{...}）
   - 提案: より多様なフォーマット（コードブロックなし、複数JSONブロック等）に対応
   - 効果: エージェント出力の多様性に対する耐性向上
   - **優先度**: 低（現在の実装で十分機能する、Phase 2で検討可能）

3. **クローズ履歴のissue_title取得**
   - 現状: CloseHistoryEntryのissue_titleが空文字列（`''`）でハードコード
   - 提案: candidateからissue_titleを取得して記録
   - 効果: 履歴の可読性向上、監査・トラブルシューティング時の利便性向上
   - **優先度**: 低（機能的には問題なし、Phase 2で改善可能）

4. **並列処理対応（Phase 2以降で実装予定）**
   - 現状: 順次処理（ループ）のため、大量Issue処理時のパフォーマンスが制限される
   - 提案: Promise.all()を使用した並列処理（並列度を制御）
   - 効果: 100件のIssue処理が5分以内に完了する（NFR-1.1）
   - **優先度**: 中（Phase 2で実装予定、設計書に記載済み）

## Planning Phaseチェックリスト照合結果: PASS

Phase 4の全てのタスクが完了しました：

- [x] Task 4-1: CLIコマンドハンドラの実装
  - `src/commands/auto-close-issue.ts`が実装されている（437行）
  - `handleAutoCloseIssueCommand`関数、`parseOptions`関数が実装されている
  
- [x] Task 4-2: Issue検品ロジックの実装
  - `src/core/issue-inspector.ts`が実装されている（420行）
  - `IssueInspector`クラス、全メソッドが実装されている
  
- [x] Task 4-3: カテゴリフィルタリングロジックの実装
  - `filterByCategory`関数が`auto-close-issue.ts`内に実装されている
  - 4つのカテゴリ（followup, stale, old, all）が実装されている
  
- [x] Task 4-4: GitHub API連携の実装
  - `src/core/github/issue-client.ts`が拡張されている
  - getIssues, closeIssue, addLabelsメソッドが追加されている
  
- [x] Task 4-5: プロンプトテンプレートの実装
  - `src/prompts/auto-close/inspect-issue.txt`が作成されている（145行）
  - 変数プレースホルダー、判定基準、JSON形式出力要求が実装されている

Planning.mdも更新しました。

## 総合評価

**主な強み**:
- **設計書への完全準拠**: 設計書の全ての要件が正確に実装されている
- **既存規約への厳密な遵守**: CLAUDE.mdのコーディング規約に100%準拠
- **包括的なエラーハンドリング**: try-catch、getErrorMessage()、バリデーションが適切
- **型安全性**: TypeScriptの型システムを活用した実装ミス防止
- **保守性の高さ**: 明確な命名、充実したコメント、単一責任原則の遵守
- **既存パターン継承**: `auto-issue.ts`のパターンを踏襲し、一貫性を確保
- **バグ修正の徹底**: 実装ログに記載された境界値判定エラー2件を適切に修正

**主な改善提案**:
- プロンプトテンプレートパスの柔軟化（Phase 2以降で検討）
- エージェント出力パースの堅牢性向上（Phase 2以降で検討）
- クローズ履歴のissue_title取得（Phase 2以降で検討）
- 並列処理対応（Phase 2で実装予定、設計書に記載済み）

**総括**:
実装は設計書に完全に沿っており、既存コードの規約を厳密に遵守しています。エラーハンドリングは包括的で、明らかなバグもありません。実装ログに記載された境界値判定エラー2件も適切に修正されており、TypeScriptビルドが成功しています。改善提案はすべてPhase 2以降で検討可能な事項であり、次フェーズ（テスト実行）に進めるブロッカーは存在しません。

Phase 4の品質ゲートをすべてクリアしており、優れた品質の実装です。

---
**判定: PASS**
それでは、レビュー結果をまとめます。

## 品質ゲート評価

**⚠️ 重要: 各項目に対して明示的にPASS/FAILを判定してください。1つでもFAILがあれば最終判定は自動的にFAILです。**

- [x] **Phase 2の設計に沿った実装である**: **PASS**
  - 設計書で定義された全てのファイルが実装されている
  - クラス設計、関数設計、データ構造設計が設計書通りに実装されている
  - 実装ログに記載された修正（境界値判定エラーの修正）も適切に行われている

- [x] **既存コードの規約に準拠している**: **PASS**
  - CLAUDE.mdの規約（ロギング、環境変数アクセス、エラーハンドリング）に完全準拠
  - ReDoS攻撃防止のため`replaceAll()`を使用
  - 既存の`auto-issue.ts`パターンを踏襲
  - 型安全性が確保されている（any型の使用を最小限に）

- [x] **基本的なエラーハンドリングがある**: **PASS**
  - try-catchによる包括的なエラーキャッチ
  - getErrorMessage()による安全なエラーメッセージ抽出
  - エージェント実行失敗時のnull返却とログ出力
  - JSON parseエラー時の適切なハンドリング

- [x] **明らかなバグがない**: **PASS**
  - TypeScriptビルド成功（実装ログに記載）
  - 境界値判定エラーが2件修正済み（TS-UNIT-022, TS-UNIT-024）
  - 型チェックによる実装ミス防止
  - null/undefined安全性（?? 演算子の使用）

**品質ゲート総合判定: PASS**
- PASS: 上記4項目すべてがPASS

## 詳細レビュー

### 1. 設計との整合性

**良好な点**:
- 設計書の「7. 詳細設計」に記載された全てのクラス、関数、データ構造が正確に実装されている
- `IssueInspector`クラスの実装が設計書通り（420行、全メソッドを実装）
- プロンプトテンプレート（inspect-issue.txt）が設計書の仕様に完全準拠（145行、4つの判定観点を明示）
- 型定義ファイル（auto-close-issue.ts）が設計書の型定義を網羅（286行）
- CLIコマンドハンドラ（auto-close-issue.ts）が設計書の関数構成通りに実装（437行）
- IssueClientの拡張が軽微かつ後方互換性100%維持（getIssues, closeIssue, addLabelsメソッドを追加）
- main.tsへのコマンド追加が設計書通り（8個のCLIオプション定義）
- 実装ログに記載された修正履歴（境界値判定エラー2件）が適切

**懸念点**:
- なし（設計書との整合性は完璧）

### 2. コーディング規約への準拠

**良好な点**:
- **ロギング**: 統一loggerモジュール（`src/utils/logger.ts`）を使用、console.log等の直接使用なし
- **環境変数アクセス**: Configクラス（`src/core/config.ts`）経由でアクセス、process.env直接アクセスなし
- **エラーハンドリング**: getErrorMessage()を使用して安全にエラーメッセージ抽出、`as Error`型アサーション禁止遵守
- **セキュリティ**: ReDoS攻撃防止のため`replaceAll()`を使用（fillTemplateメソッド）
- **命名規則**: 既存コードのスタイルに統一（PascalCase: IssueInspector、camelCase: inspectIssue）
- **非同期処理**: async/awaitを使用、Promiseチェーンではなくasync/await統一
- **型安全性**: 全ての関数に明示的な型アノテーション、any型の使用を最小限に（AgentExecutorインターフェースのみ）
- **既存パターン踏襲**: `auto-issue.ts`のコマンドハンドラパターンを踏襲
- **依存性注入**: IssueInspectorコンストラクタで依存性注入、テスト時にモック注入可能

**懸念点**:
- なし（CLAUDE.md規約に100%準拠）

### 3. エラーハンドリング

**良好な点**:
- **inspectIssue()**: try-catchで包括的にエラーキャッチし、null返却とログ出力
- **parseInspectionResult()**: JSON parseエラー時に適切な例外をスロー、必須フィールド検証
- **extractOutputFromMessages()**: エージェント出力が空の場合にエラーをスロー
- **handleAutoCloseIssueCommand()**: メインハンドラ全体をtry-catchで包み、エラーログ出力とエラー再スロー
- **closeCandidates()**: 各Issueクローズ時にtry-catchで個別にエラーハンドリング、1件失敗しても処理継続
- **環境変数チェック**: GITHUB_TOKEN、GITHUB_REPOSITORYの存在確認と明確なエラーメッセージ
- **エージェント認証情報チェック**: codexClient, claudeClient両方がnullの場合の明確なエラーメッセージ
- **バリデーション**: CLIオプションの範囲チェック（limit: 1-50、confidence: 0.0-1.0、daysThreshold: 正の整数）と明確なエラーメッセージ

**改善の余地**:
- なし（基本的なエラーハンドリングは十分）

### 4. バグの有無

**良好な点**:
- **TypeScriptビルド成功**: 実装ログに記載されたコンパイルエラー0個
- **境界値判定エラー修正**: 実装ログに記載された2件のバグ修正（TS-UNIT-022: 最近更新除外の境界値判定、TS-UNIT-024: confidence閾値の境界値判定）
- **型チェック**: TypeScriptの型システムによる実装ミス防止
- **null/undefined安全性**: `?? 演算子`の使用、フォールバック値の適切な設定
- **浮動小数点数比較**: epsilonを使用した安全な比較（confidence閾値チェック）
- **JSON parse安全性**: JSONブロック抽出を試みる前にマッチング確認

**懸念点**:
- なし（明らかなバグはない）

### 5. 保守性

**良好な点**:
- **コードが読みやすい**: メソッド名、変数名が明確で意図が理解しやすい
- **コメント充実**: 各クラス、メソッドにJSDocコメントが記載され、パラメータと戻り値が説明されている
- **適切な分割**: 単一責任原則に従ったクラス設計（IssueInspector: 検品ロジック、auto-close-issue: CLIハンドラ）
- **マジックナンバー排除**: デフォルト値を変数として定義（category: 'followup', limit: 10, confidence: 0.7等）
- **定数化**: 除外ラベル（'do-not-close,pinned'）、最近更新除外日数（7日）等を定数として明示
- **ヘルパー関数**: calculateDaysSince、formatIssueInfo等の再利用可能な関数
- **既存パターン継承**: 既存の`auto-issue.ts`パターンを踏襲し、新規開発者が理解しやすい

**改善の余地**:
- **プロンプトテンプレートパス**: ハードコードされたパス（`dist/prompts/auto-close/inspect-issue.txt`）が変更時に影響を受ける可能性
  - 提案: 環境変数や設定ファイルでパスを管理することを検討（Phase 2以降）

## ブロッカー（BLOCKER）

**次フェーズに進めない重大な問題**

なし

## 改善提案（SUGGESTION）

**次フェーズに進めるが、改善が望ましい事項**

1. **プロンプトテンプレートパスの柔軟化**
   - 現状: ハードコードされたパス（`dist/prompts/auto-close/inspect-issue.txt`）
   - 提案: 環境変数や設定ファイルでパスを管理することで、テスト時や開発時に別のテンプレートを使用可能にする
   - 効果: テスト容易性向上、プロンプト改善の実験が容易になる
   - **優先度**: 低（Phase 2以降で検討可能）

2. **エージェント出力パースの堅牢性向上**
   - 現状: JSONブロック抽出の正規表現マッチング（``` json ... ```または{...}）
   - 提案: より多様なフォーマット（コードブロックなし、複数JSONブロック等）に対応
   - 効果: エージェント出力の多様性に対する耐性向上
   - **優先度**: 低（現在の実装で十分機能する、Phase 2で検討可能）

3. **クローズ履歴のissue_title取得**
   - 現状: CloseHistoryEntryのissue_titleが空文字列（`''`）でハードコード
   - 提案: candidateからissue_titleを取得して記録
   - 効果: 履歴の可読性向上、監査・トラブルシューティング時の利便性向上
   - **優先度**: 低（機能的には問題なし、Phase 2で改善可能）

4. **並列処理対応（Phase 2以降で実装予定）**
   - 現状: 順次処理（ループ）のため、大量Issue処理時のパフォーマンスが制限される
   - 提案: Promise.all()を使用した並列処理（並列度を制御）
   - 効果: 100件のIssue処理が5分以内に完了する（NFR-1.1）
   - **優先度**: 中（Phase 2で実装予定、設計書に記載済み）

## Planning Phaseチェックリスト照合結果: PASS

Phase 4の全てのタスクが完了しました：

- [x] Task 4-1: CLIコマンドハンドラの実装
  - `src/commands/auto-close-issue.ts`が実装されている（437行）
  - `handleAutoCloseIssueCommand`関数、`parseOptions`関数が実装されている
  
- [x] Task 4-2: Issue検品ロジックの実装
  - `src/core/issue-inspector.ts`が実装されている（420行）
  - `IssueInspector`クラス、全メソッドが実装されている
  
- [x] Task 4-3: カテゴリフィルタリングロジックの実装
  - `filterByCategory`関数が`auto-close-issue.ts`内に実装されている
  - 4つのカテゴリ（followup, stale, old, all）が実装されている
  
- [x] Task 4-4: GitHub API連携の実装
  - `src/core/github/issue-client.ts`が拡張されている
  - getIssues, closeIssue, addLabelsメソッドが追加されている
  
- [x] Task 4-5: プロンプトテンプレートの実装
  - `src/prompts/auto-close/inspect-issue.txt`が作成されている（145行）
  - 変数プレースホルダー、判定基準、JSON形式出力要求が実装されている

Planning.mdも更新しました。

## 総合評価

**主な強み**:
- **設計書への完全準拠**: 設計書の全ての要件が正確に実装されている
- **既存規約への厳密な遵守**: CLAUDE.mdのコーディング規約に100%準拠
- **包括的なエラーハンドリング**: try-catch、getErrorMessage()、バリデーションが適切
- **型安全性**: TypeScriptの型システムを活用した実装ミス防止
- **保守性の高さ**: 明確な命名、充実したコメント、単一責任原則の遵守
- **既存パターン継承**: `auto-issue.ts`のパターンを踏襲し、一貫性を確保
- **バグ修正の徹底**: 実装ログに記載された境界値判定エラー2件を適切に修正

**主な改善提案**:
- プロンプトテンプレートパスの柔軟化（Phase 2以降で検討）
- エージェント出力パースの堅牢性向上（Phase 2以降で検討）
- クローズ履歴のissue_title取得（Phase 2以降で検討）
- 並列処理対応（Phase 2で実装予定、設計書に記載済み）

**総括**:
実装は設計書に完全に沿っており、既存コードの規約を厳密に遵守しています。エラーハンドリングは包括的で、明らかなバグもありません。実装ログに記載された境界値判定エラー2件も適切に修正されており、TypeScriptビルドが成功しています。改善提案はすべてPhase 2以降で検討可能な事項であり、次フェーズ（テスト実行）に進めるブロッカーは存在しません。

Phase 4の品質ゲートをすべてクリアしており、優れた品質の実装です。

---
**判定: PASS**