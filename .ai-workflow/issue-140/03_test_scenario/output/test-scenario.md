# テストシナリオ書 - Issue #140

## 0. Planning Documentの確認

Planning Phase（Phase 0）およびDesign Phase（Phase 2）で策定された以下の戦略を踏まえて、テストシナリオを作成します：

### テスト戦略
- **テスト戦略**: UNIT_INTEGRATION（ユニットテスト + インテグレーションテスト）
- **テストコード戦略**: EXTEND_TEST（既存テストファイルに追加 + 新規統合テストファイル作成）
- **推奨修正案**: `String.prototype.replaceAll()`の使用
- **主要な検証ポイント**: ReDoS脆弱性の排除、特殊文字の安全な処理、後方互換性の維持

---

## 1. テスト戦略サマリー

### 1.1 選択されたテスト戦略

**UNIT_INTEGRATION**

### 1.2 テスト対象の範囲

**修正対象コード**:
- `src/core/claude-agent-client.ts`の`fillTemplate`メソッド（85-91行目）

**テスト対象機能**:
- テンプレート変数の安全な置換（FR-1）
- ReDoSパターンの無効化（FR-2）
- 既存のテンプレート処理の後方互換性維持（FR-3）
- エッジケースの処理（FR-4）
- パフォーマンス要件（NFR-1）

### 1.3 テストの目的

1. **セキュリティ検証**: ReDoS脆弱性が完全に排除されていることを確認
2. **機能検証**: 特殊文字を含むテンプレート変数キーが正常に処理されることを確認
3. **後方互換性検証**: 既存のテンプレート処理の挙動が維持されることを確認
4. **パフォーマンス検証**: いかなる入力に対しても1秒以内に処理が完了することを確認
5. **統合検証**: Claude Agent SDK全体のテンプレート処理フローが正常に動作することを確認

---

## 2. Unitテストシナリオ

### 2.1 テスト対象メソッド

**メソッド名**: `ClaudeAgentClient.fillTemplate`（privateメソッド）

**テスト経路**: `executeTaskFromFile`メソッド経由でテスト

**テストファイル**: `tests/unit/claude-agent-client.test.ts`（既存ファイルに追加）

---

### 2.2 正常系テストケース（3ケース）

#### TC-U-001: 単一変数の置換

- **目的**: 単一のテンプレート変数が正常に置換されることを検証
- **前提条件**: ClaudeAgentClientが初期化されている
- **入力**:
  - テンプレートファイル: `"Hello {name}, welcome!"`
  - テンプレート変数: `{ "name": "Alice" }`
- **期待結果**: `"Hello Alice, welcome!"`が返される
- **テストデータ**: 上記入力データ

#### TC-U-002: 複数変数の置換

- **目的**: 複数のテンプレート変数が正常に置換されることを検証
- **前提条件**: ClaudeAgentClientが初期化されている
- **入力**:
  - テンプレートファイル: `"Hello {firstName} {lastName}, your email is {email}"`
  - テンプレート変数: `{ "firstName": "John", "lastName": "Doe", "email": "john@example.com" }`
- **期待結果**: `"Hello John Doe, your email is john@example.com"`が返される
- **テストデータ**: 上記入力データ

#### TC-U-003: 同一変数の複数箇所置換

- **目的**: 同一のテンプレート変数が複数箇所で正常に置換されることを検証
- **前提条件**: ClaudeAgentClientが初期化されている
- **入力**:
  - テンプレートファイル: `"Hello {name}! Welcome, {name}. Your username is {name}."`
  - テンプレート変数: `{ "name": "Alice" }`
- **期待結果**: `"Hello Alice! Welcome, Alice. Your username is Alice."`が返される
- **テストデータ**: 上記入力データ

---

### 2.3 特殊文字を含むキーのテストケース（10ケース）

#### TC-U-004: プラス記号（+）を含むキー

- **目的**: `+`（1回以上の繰り返し）が正規表現メタ文字として解釈されず、文字列リテラルとして扱われることを検証
- **前提条件**: ClaudeAgentClientが初期化されている
- **入力**:
  - テンプレートファイル: `"Result: {a+b}"`
  - テンプレート変数: `{ "a+b": "value1" }`
- **期待結果**: `"Result: value1"`が返される
- **テストデータ**: 上記入力データ

#### TC-U-005: アスタリスク（*）を含むキー

- **目的**: `*`（0回以上の繰り返し）が正規表現メタ文字として解釈されず、文字列リテラルとして扱われることを検証
- **前提条件**: ClaudeAgentClientが初期化されている
- **入力**:
  - テンプレートファイル: `"Result: {a*b}"`
  - テンプレート変数: `{ "a*b": "value2" }`
- **期待結果**: `"Result: value2"`が返される
- **テストデータ**: 上記入力データ

#### TC-U-006: ドット（.）を含むキー

- **目的**: `.`（任意の1文字）が正規表現メタ文字として解釈されず、文字列リテラルとして扱われることを検証
- **前提条件**: ClaudeAgentClientが初期化されている
- **入力**:
  - テンプレートファイル: `"Result: {a.b}"`
  - テンプレート変数: `{ "a.b": "value3" }`
- **期待結果**: `"Result: value3"`が返される
- **テストデータ**: 上記入力データ

#### TC-U-007: 疑問符（?）を含むキー

- **目的**: `?`（0回または1回）が正規表現メタ文字として解釈されず、文字列リテラルとして扱われることを検証
- **前提条件**: ClaudeAgentClientが初期化されている
- **入力**:
  - テンプレートファイル: `"Result: {a?b}"`
  - テンプレート変数: `{ "a?b": "value4" }`
- **期待結果**: `"Result: value4"`が返される
- **テストデータ**: 上記入力データ

#### TC-U-008: キャレット（^）を含むキー

- **目的**: `^`（行頭）が正規表現メタ文字として解釈されず、文字列リテラルとして扱われることを検証
- **前提条件**: ClaudeAgentClientが初期化されている
- **入力**:
  - テンプレートファイル: `"Result: {a^b}"`
  - テンプレート変数: `{ "a^b": "value5" }`
- **期待結果**: `"Result: value5"`が返される
- **テストデータ**: 上記入力データ

#### TC-U-009: ドル記号（$）を含むキー

- **目的**: `$`（行末）が正規表現メタ文字として解釈されず、文字列リテラルとして扱われることを検証
- **前提条件**: ClaudeAgentClientが初期化されている
- **入力**:
  - テンプレートファイル: `"Result: {a$b}"`
  - テンプレート変数: `{ "a$b": "value6" }`
- **期待結果**: `"Result: value6"`が返される
- **テストデータ**: 上記入力データ

#### TC-U-010: 波括弧（{}）を含むキー

- **目的**: `{}`（量指定子）が正規表現メタ文字として解釈されず、文字列リテラルとして扱われることを検証
- **前提条件**: ClaudeAgentClientが初期化されている
- **入力**:
  - テンプレートファイル: `"Result: {a{2}b}"`
  - テンプレート変数: `{ "a{2}b": "value7" }`
- **期待結果**: `"Result: value7"`が返される
- **テストデータ**: 上記入力データ

#### TC-U-011: 丸括弧（()）を含むキー

- **目的**: `()`（グループ化）が正規表現メタ文字として解釈されず、文字列リテラルとして扱われることを検証
- **前提条件**: ClaudeAgentClientが初期化されている
- **入力**:
  - テンプレートファイル: `"Result: {a(b)c}"`
  - テンプレート変数: `{ "a(b)c": "value8" }`
- **期待結果**: `"Result: value8"`が返される
- **テストデータ**: 上記入力データ

#### TC-U-012: パイプ（|）を含むキー

- **目的**: `|`（OR）が正規表現メタ文字として解釈されず、文字列リテラルとして扱われることを検証
- **前提条件**: ClaudeAgentClientが初期化されている
- **入力**:
  - テンプレートファイル: `"Result: {a|b}"`
  - テンプレート変数: `{ "a|b": "value9" }`
- **期待結果**: `"Result: value9"`が返される
- **テストデータ**: 上記入力データ

#### TC-U-013: 角括弧（[]）を含むキー

- **目的**: `[]`（文字クラス）が正規表現メタ文字として解釈されず、文字列リテラルとして扱われることを検証
- **前提条件**: ClaudeAgentClientが初期化されている
- **入力**:
  - テンプレートファイル: `"Result: {a[b]c}"`
  - テンプレート変数: `{ "a[b]c": "value10" }`
- **期待結果**: `"Result: value10"`が返される
- **テストデータ**: 上記入力データ

---

### 2.4 ReDoSパターンのテストケース（5ケース）

#### TC-U-014: ネストされた繰り返し（+）

- **目的**: `(a+)+b`のようなネストされた繰り返しパターンがReDoS攻撃を引き起こさず、安全に処理されることを検証
- **前提条件**: ClaudeAgentClientが初期化されている
- **入力**:
  - テンプレートファイル: `"Test {(a+)+b}, end"`
  - テンプレート変数: `{ "(a+)+b": "safe_value" }`
- **期待結果**:
  - 結果: `"Test safe_value, end"`が返される
  - 処理時間: 1秒以内に完了
- **テストデータ**: 上記入力データ

#### TC-U-015: ネストされた繰り返し（*）

- **目的**: `(a*)*b`のようなネストされた繰り返しパターン（0回以上）がReDoS攻撃を引き起こさず、安全に処理されることを検証
- **前提条件**: ClaudeAgentClientが初期化されている
- **入力**:
  - テンプレートファイル: `"Test {(a*)*b}, end"`
  - テンプレート変数: `{ "(a*)*b": "safe_value" }`
- **期待結果**:
  - 結果: `"Test safe_value, end"`が返される
  - 処理時間: 1秒以内に完了
- **テストデータ**: 上記入力データ

#### TC-U-016: 選択肢の重複

- **目的**: `(a|a)*b`のような選択肢の重複パターンがReDoS攻撃を引き起こさず、安全に処理されることを検証
- **前提条件**: ClaudeAgentClientが初期化されている
- **入力**:
  - テンプレートファイル: `"Test {(a|a)*b}, end"`
  - テンプレート変数: `{ "(a|a)*b": "safe_value" }`
- **期待結果**:
  - 結果: `"Test safe_value, end"`が返される
  - 処理時間: 1秒以内に完了
- **テストデータ**: 上記入力データ

#### TC-U-017: 重複するパターン

- **目的**: `(a|ab)*c`のような重複するパターンがReDoS攻撃を引き起こさず、安全に処理されることを検証
- **前提条件**: ClaudeAgentClientが初期化されている
- **入力**:
  - テンプレートファイル: `"Test {(a|ab)*c}, end"`
  - テンプレート変数: `{ "(a|ab)*c": "safe_value" }`
- **期待結果**:
  - 結果: `"Test safe_value, end"`が返される
  - 処理時間: 1秒以内に完了
- **テストデータ**: 上記入力データ

#### TC-U-018: 長大な入力でのReDoSパターン

- **目的**: ReDoSパターン`(a+)+b`に長大な入力が渡されても、安全に処理されることを検証
- **前提条件**: ClaudeAgentClientが初期化されている
- **入力**:
  - テンプレートファイル: `"Test {(a+)+b}, end. Input: aaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaX"`
  - テンプレート変数: `{ "(a+)+b": "safe_value" }`
- **期待結果**:
  - 結果: `"Test safe_value, end. Input: aaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaX"`が返される
  - 処理時間: 1秒以内に完了（バックトラッキングが発生しない）
- **テストデータ**: 上記入力データ

---

### 2.5 エッジケースのテストケース（5ケース）

#### TC-U-019: 空文字列キー

- **目的**: 空文字列キー（`""`）が無視され、例外がスローされないことを検証
- **前提条件**: ClaudeAgentClientが初期化されている
- **入力**:
  - テンプレートファイル: `"Hello {}, welcome!"`
  - テンプレート変数: `{ "": "Alice" }`
- **期待結果**: `"Hello {}, welcome!"`が返される（空キーは置換されない）
- **テストデータ**: 上記入力データ

#### TC-U-020: 空文字列値

- **目的**: 空文字列値が正常に処理され、キーが空文字列に置換されることを検証
- **前提条件**: ClaudeAgentClientが初期化されている
- **入力**:
  - テンプレートファイル: `"Hello {name}, welcome!"`
  - テンプレート変数: `{ "name": "" }`
- **期待結果**: `"Hello , welcome!"`が返される
- **テストデータ**: 上記入力データ

#### TC-U-021: 長大なキー（10,000文字）

- **目的**: 長大なキー（10,000文字）が線形時間（O(n)）で処理されることを検証
- **前提条件**: ClaudeAgentClientが初期化されている
- **入力**:
  - テンプレートファイル: `"Result: {LONG_KEY}"`
  - テンプレート変数: `{ "LONG_KEY": "a".repeat(10000) }` → キーが10,000文字の`a`の繰り返し
- **期待結果**:
  - 結果: 正常に置換される
  - 処理時間: 1秒以内に完了
- **テストデータ**: 上記入力データ

#### TC-U-022: 長大な値（10,000文字）

- **目的**: 長大な値（10,000文字）が線形時間（O(n)）で処理されることを検証
- **前提条件**: ClaudeAgentClientが初期化されている
- **入力**:
  - テンプレートファイル: `"Result: {key}"`
  - テンプレート変数: `{ "key": "b".repeat(10000) }` → 値が10,000文字の`b`の繰り返し
- **期待結果**:
  - 結果: `"Result: bbbbb..."`（10,000文字の`b`）が返される
  - 処理時間: 1秒以内に完了
- **テストデータ**: 上記入力データ

#### TC-U-023: 特殊文字のみのキー

- **目的**: すべての正規表現特殊文字を含むキーが安全に処理されることを検証
- **前提条件**: ClaudeAgentClientが初期化されている
- **入力**:
  - テンプレートファイル: `"Result: {.*+?^${}()|[]\}"`
  - テンプレート変数: `{ ".*+?^${}()|[]\\": "all_special_chars" }`
- **期待結果**: `"Result: all_special_chars"`が返される
- **テストデータ**: 上記入力データ

---

### 2.6 パフォーマンステストケース（2ケース）

#### TC-U-024: 大量のテンプレート変数（1000個）

- **目的**: 1000個のテンプレート変数が1秒以内に処理されることを検証
- **前提条件**: ClaudeAgentClientが初期化されている
- **入力**:
  - テンプレートファイル: `"{var0} {var1} {var2} ... {var999}"`（1000個のプレースホルダー）
  - テンプレート変数: `{ "var0": "value0", "var1": "value1", ..., "var999": "value999" }`（1000個のキー・値ペア）
- **期待結果**:
  - 結果: すべてのプレースホルダーが正常に置換される
  - 処理時間: 1秒以内に完了
- **テストデータ**: プログラムで生成（1000個のキー・値ペア）

#### TC-U-025: 長大なテンプレート文字列（10,000文字）

- **目的**: 10,000文字のテンプレート文字列が1秒以内に処理されることを検証
- **前提条件**: ClaudeAgentClientが初期化されている
- **入力**:
  - テンプレートファイル: `"a".repeat(5000) + "{key}" + "b".repeat(5000)`（10,000文字のテンプレート）
  - テンプレート変数: `{ "key": "value" }`
- **期待結果**:
  - 結果: プレースホルダーが正常に置換される
  - 処理時間: 1秒以内に完了
- **テストデータ**: 上記入力データ

---

### 2.7 後方互換性テストケース（3ケース）

#### TC-U-026: アンダースコアを含むキー

- **目的**: 既存のアンダースコアを含むキーが正常に動作することを検証
- **前提条件**: ClaudeAgentClientが初期化されている
- **入力**:
  - テンプレートファイル: `"Hello {user_name}, welcome!"`
  - テンプレート変数: `{ "user_name": "Alice" }`
- **期待結果**: `"Hello Alice, welcome!"`が返される
- **テストデータ**: 上記入力データ

#### TC-U-027: ハイフンを含むキー

- **目的**: 既存のハイフンを含むキーが正常に動作することを検証
- **前提条件**: ClaudeAgentClientが初期化されている
- **入力**:
  - テンプレートファイル: `"Your API key: {api-key}"`
  - テンプレート変数: `{ "api-key": "12345-ABCDE" }`
- **期待結果**: `"Your API key: 12345-ABCDE"`が返される
- **テストデータ**: 上記入力データ

#### TC-U-028: 数字を含むキー

- **目的**: 既存の数字を含むキーが正常に動作することを検証
- **前提条件**: ClaudeAgentClientが初期化されている
- **入力**:
  - テンプレートファイル: `"Item {item123} is available"`
  - テンプレート変数: `{ "item123": "Product A" }`
- **期待結果**: `"Item Product A is available"`が返される
- **テストデータ**: 上記入力データ

---

### 2.8 Unitテストケース数サマリー

| カテゴリ | テストケース数 |
|---------|--------------|
| 正常系 | 3 |
| 特殊文字を含むキー | 10 |
| ReDoSパターン | 5 |
| エッジケース | 5 |
| パフォーマンステスト | 2 |
| 後方互換性 | 3 |
| **合計** | **28** |

---

## 3. Integrationテストシナリオ

### 3.1 テスト対象

**統合ポイント**: ClaudeAgentClientの`executeTaskFromFile`メソッドとClaude Agent SDK全体のテンプレート処理フロー

**テストファイル**: `tests/integration/claude-agent-client-template.test.ts`（新規作成）

---

### 3.2 プロンプトファイル読み込みテスト（2ケース）

#### IS-001: 実際のプロンプトファイル読み込みと変数置換

- **目的**: 実際のプロンプトファイルを読み込み、テンプレート変数が正常に置換されることを検証
- **前提条件**:
  - ClaudeAgentClientが初期化されている
  - テスト用プロンプトファイル（`test-prompt.md`）が存在する
- **テスト手順**:
  1. テスト用プロンプトファイルを作成（内容: `"Hello {name}, your role is {role}."`）
  2. `executeTaskFromFile`メソッドを呼び出す
  3. テンプレート変数 `{ "name": "Alice", "role": "Developer" }` を渡す
  4. 実行結果を取得
- **期待結果**:
  - プロンプトファイルが正常に読み込まれる
  - テンプレート変数が置換される
  - 最終的なプロンプトは `"Hello Alice, your role is Developer."` となる
- **確認項目**:
  - [ ] プロンプトファイルが存在することを確認
  - [ ] ファイル読み込みが成功することを確認
  - [ ] テンプレート変数が正常に置換されることを確認
  - [ ] Claude Agent SDKへのプロンプト送信が成功することを確認

#### IS-002: 複数のテンプレート変数を含むプロンプト処理

- **目的**: 複数のテンプレート変数を含むプロンプトが正常に処理されることを検証
- **前提条件**:
  - ClaudeAgentClientが初期化されている
  - テスト用プロンプトファイル（`test-multi-vars.md`）が存在する
- **テスト手順**:
  1. テスト用プロンプトファイルを作成（内容: `"Project: {project_name}\nVersion: {version}\nAuthor: {author}\nDescription: {description}"`）
  2. `executeTaskFromFile`メソッドを呼び出す
  3. テンプレート変数 `{ "project_name": "AI Workflow", "version": "1.0.0", "author": "Claude", "description": "Automated workflow system" }` を渡す
  4. 実行結果を取得
- **期待結果**:
  - すべてのテンプレート変数が正常に置換される
  - 最終的なプロンプトは以下となる:
    ```
    Project: AI Workflow
    Version: 1.0.0
    Author: Claude
    Description: Automated workflow system
    ```
- **確認項目**:
  - [ ] 複数のテンプレート変数がすべて置換されることを確認
  - [ ] 改行を含むテンプレートが正常に処理されることを確認
  - [ ] Claude Agent SDKへのプロンプト送信が成功することを確認

---

### 3.3 Claude Agent SDK統合テスト（3ケース）

#### IS-003: 通常のテンプレート変数での正常実行

- **目的**: 通常のテンプレート変数を含むプロンプトでClaude Agent SDKが正常に実行されることを検証
- **前提条件**:
  - ClaudeAgentClientが初期化されている
  - 認証情報が正しく設定されている
- **テスト手順**:
  1. テスト用プロンプトファイルを作成（内容: `"Please summarize the following topic: {topic}"`）
  2. `executeTaskFromFile`メソッドを呼び出す
  3. テンプレート変数 `{ "topic": "Artificial Intelligence" }` を渡す
  4. Claude Agent SDKの実行結果を取得
- **期待結果**:
  - テンプレート変数が置換される
  - Claude Agent SDKが正常に実行される
  - エラーがスローされない
- **確認項目**:
  - [ ] テンプレート変数が正常に置換されることを確認
  - [ ] Claude Agent SDKが正常に応答を返すことを確認
  - [ ] 例外がスローされないことを確認

#### IS-004: 特殊文字を含むテンプレート変数での正常実行

- **目的**: 特殊文字を含むテンプレート変数を使用しても、Claude Agent SDKが正常に実行されることを検証
- **前提条件**:
  - ClaudeAgentClientが初期化されている
  - 認証情報が正しく設定されている
- **テスト手順**:
  1. テスト用プロンプトファイルを作成（内容: `"Please explain the pattern: {regex_pattern}"`）
  2. `executeTaskFromFile`メソッドを呼び出す
  3. テンプレート変数 `{ "regex_pattern": "(a+)+b" }` を渡す（ReDoSパターン）
  4. Claude Agent SDKの実行結果を取得
- **期待結果**:
  - テンプレート変数が文字列リテラルとして置換される
  - Claude Agent SDKが正常に実行される
  - ReDoS攻撃が発生しない
  - タイムアウトが発生しない
- **確認項目**:
  - [ ] 特殊文字を含むテンプレート変数が正常に置換されることを確認
  - [ ] Claude Agent SDKが正常に応答を返すことを確認
  - [ ] 処理時間が1秒以内であることを確認
  - [ ] 例外がスローされないことを確認

#### IS-005: ReDoSパターンを含むテンプレート変数での正常実行

- **目的**: ReDoSパターンを含むテンプレート変数を使用しても、セキュリティ脆弱性が発生しないことを検証
- **前提条件**:
  - ClaudeAgentClientが初期化されている
  - 認証情報が正しく設定されている
- **テスト手順**:
  1. テスト用プロンプトファイルを作成（内容: `"Pattern: {dangerous_pattern}, Description: {description}"`）
  2. `executeTaskFromFile`メソッドを呼び出す
  3. テンプレート変数 `{ "dangerous_pattern": "(a*)*b", "description": "Nested repetition" }` を渡す
  4. Claude Agent SDKの実行結果を取得
  5. 処理時間を測定
- **期待結果**:
  - テンプレート変数が安全に置換される
  - バックトラッキングが発生しない
  - 処理時間が1秒以内に完了
  - Claude Agent SDKが正常に実行される
- **確認項目**:
  - [ ] ReDoSパターンが文字列リテラルとして扱われることを確認
  - [ ] 処理時間が1秒以内であることを確認（タイムアウト検証）
  - [ ] Claude Agent SDKが正常に応答を返すことを確認
  - [ ] CPUリソースが枯渇しないことを確認

---

### 3.4 パフォーマンステスト（1ケース）

#### IS-006: 大量のテンプレート変数と長大なテンプレートでのパフォーマンス検証

- **目的**: 大量のテンプレート変数（100個）と長大なテンプレート文字列（10,000文字）が1秒以内に処理されることを検証
- **前提条件**:
  - ClaudeAgentClientが初期化されている
  - 認証情報が正しく設定されている
- **テスト手順**:
  1. 大量のテンプレート変数を含むプロンプトファイルを動的に生成（100個のプレースホルダー）
  2. テンプレート文字列の長さを10,000文字にする
  3. `executeTaskFromFile`メソッドを呼び出す
  4. 処理開始時刻を記録
  5. 処理完了時刻を記録
  6. 処理時間を計算
- **期待結果**:
  - すべてのテンプレート変数が正常に置換される
  - 処理時間が1秒以内に完了
  - メモリリークが発生しない
- **確認項目**:
  - [ ] 100個のテンプレート変数がすべて置換されることを確認
  - [ ] 10,000文字のテンプレート文字列が正常に処理されることを確認
  - [ ] 処理時間が1秒以内であることを確認
  - [ ] メモリ使用量が適切な範囲内であることを確認

---

### 3.5 Integrationテストケース数サマリー

| カテゴリ | シナリオ数 |
|---------|-----------|
| プロンプトファイル読み込み | 2 |
| Claude Agent SDK統合 | 3 |
| パフォーマンステスト | 1 |
| **合計** | **6** |

---

## 4. テストデータ

### 4.1 正常データ

**単一変数**:
```json
{
  "template": "Hello {name}, welcome!",
  "variables": { "name": "Alice" },
  "expected": "Hello Alice, welcome!"
}
```

**複数変数**:
```json
{
  "template": "Hello {firstName} {lastName}, your email is {email}",
  "variables": {
    "firstName": "John",
    "lastName": "Doe",
    "email": "john@example.com"
  },
  "expected": "Hello John Doe, your email is john@example.com"
}
```

### 4.2 特殊文字データ

**正規表現メタ文字の網羅**:
```json
[
  { "key": "a+b", "value": "value1", "special_char": "+" },
  { "key": "a*b", "value": "value2", "special_char": "*" },
  { "key": "a.b", "value": "value3", "special_char": "." },
  { "key": "a?b", "value": "value4", "special_char": "?" },
  { "key": "a^b", "value": "value5", "special_char": "^" },
  { "key": "a$b", "value": "value6", "special_char": "$" },
  { "key": "a{2}b", "value": "value7", "special_char": "{}" },
  { "key": "a(b)c", "value": "value8", "special_char": "()" },
  { "key": "a|b", "value": "value9", "special_char": "|" },
  { "key": "a[b]c", "value": "value10", "special_char": "[]" }
]
```

### 4.3 ReDoSパターンデータ

**ReDoS攻撃パターン**:
```json
[
  { "pattern": "(a+)+b", "description": "ネストされた繰り返し（+）" },
  { "pattern": "(a*)*b", "description": "ネストされた繰り返し（*）" },
  { "pattern": "(a|a)*b", "description": "選択肢の重複" },
  { "pattern": "(a|ab)*c", "description": "重複するパターン" },
  { "pattern": "(a+)+b with long input", "description": "長大な入力でのReDoS" }
]
```

### 4.4 エッジケースデータ

**境界値・異常データ**:
```json
[
  { "key": "", "value": "Alice", "description": "空文字列キー" },
  { "key": "name", "value": "", "description": "空文字列値" },
  { "key": "a".repeat(10000), "value": "value", "description": "長大なキー" },
  { "key": "key", "value": "b".repeat(10000), "description": "長大な値" },
  { "key": ".*+?^${}()|[]\\", "value": "all_special_chars", "description": "特殊文字のみ" }
]
```

### 4.5 パフォーマンステストデータ

**大量変数**:
```javascript
// プログラムで生成
const variables = {};
for (let i = 0; i < 1000; i++) {
  variables[`var${i}`] = `value${i}`;
}
```

**長大なテンプレート**:
```javascript
// プログラムで生成
const template = "a".repeat(5000) + "{key}" + "b".repeat(5000);
```

---

## 5. テスト環境要件

### 5.1 必要なテスト環境

**ローカル環境**:
- Node.js: 20.x（`String.prototype.replaceAll()`のサポート）
- TypeScript: プロジェクトで使用されているバージョン
- Jest: テストフレームワーク

**CI/CD環境**:
- Jenkins: 既存のCIパイプライン
- Node.js: 20.x

### 5.2 必要な外部サービス・データベース

**Claude Agent SDK**:
- 認証情報: テスト用のAPIトークン
- モック化: Integrationテストでは実際のClaude Agent SDKを使用（Unitテストではモック化）

**ファイルシステム**:
- テスト用プロンプトファイルの読み書き
- 既存のfs-extraモックを使用

### 5.3 モック/スタブの必要性

**Unitテスト**:
- `fs-extra`: プロンプトファイル読み込みのモック（既存のモック再利用）
- Claude Agent SDK: モック化（実際のAPI呼び出しを回避）

**Integrationテスト**:
- `fs-extra`: 実際のファイルシステムを使用（テスト用ファイルを作成）
- Claude Agent SDK: 実際のSDKを使用（ただし、テスト用認証情報で制限された実行）

---

## 6. 品質ゲート達成状況

### 6.1 Phase 2の戦略に沿ったテストシナリオである

✅ **達成**:
- テスト戦略: UNIT_INTEGRATION（ユニットテスト + インテグレーションテスト）
- Unitテストシナリオ: 28ケース（セクション2）
- Integrationテストシナリオ: 6ケース（セクション3）

### 6.2 主要な正常系がカバーされている

✅ **達成**:
- TC-U-001: 単一変数の置換
- TC-U-002: 複数変数の置換
- TC-U-003: 同一変数の複数箇所置換
- IS-001: 実際のプロンプトファイル読み込みと変数置換
- IS-003: 通常のテンプレート変数での正常実行

### 6.3 主要な異常系がカバーされている

✅ **達成**:
- ReDoSパターン: 5ケース（TC-U-014〜TC-U-018）
- 特殊文字を含むキー: 10ケース（TC-U-004〜TC-U-013）
- エッジケース: 5ケース（TC-U-019〜TC-U-023）
- IS-004: 特殊文字を含むテンプレート変数での正常実行
- IS-005: ReDoSパターンを含むテンプレート変数での正常実行

### 6.4 期待結果が明確である

✅ **達成**:
- すべてのテストケースに「期待結果」セクションを記載
- 具体的な入力・出力を明記
- パフォーマンステストでは処理時間の上限（1秒以内）を明記
- 確認項目チェックリストを含む（Integrationテスト）

---

## 7. テストシナリオのサマリー

### 7.1 総テストケース数

| テスト種別 | テストケース数 |
|-----------|--------------|
| Unitテスト | 28 |
| Integrationテスト | 6 |
| **合計** | **34** |

### 7.2 カバレッジ目標

- **コードカバレッジ**: 95%以上（`fillTemplate`メソッド）
- **機能カバレッジ**: 100%（FR-1〜FR-5、NFR-1〜NFR-4のすべての要件をカバー）
- **ReDoSパターンカバレッジ**: 5パターン以上（目標達成）
- **特殊文字カバレッジ**: 10パターン以上（目標達成）

### 7.3 重要な検証ポイント

1. **セキュリティ検証**: ReDoS脆弱性が完全に排除されている（TC-U-014〜TC-U-018、IS-005）
2. **機能検証**: 特殊文字を含むキーが安全に処理される（TC-U-004〜TC-U-013、IS-004）
3. **後方互換性検証**: 既存のテンプレート処理が維持される（TC-U-026〜TC-U-028）
4. **パフォーマンス検証**: 1秒以内に処理が完了する（TC-U-024、TC-U-025、IS-006）
5. **統合検証**: Claude Agent SDK全体のフローが正常に動作する（IS-001〜IS-006）

---

## 8. 次フェーズへの引き継ぎ事項

### Implementation Phase（Phase 4）への引き継ぎ
- セクション2のUnitテストシナリオ（28ケース）を`tests/unit/claude-agent-client.test.ts`に実装
- セクション3のIntegrationテストシナリオ（6ケース）を`tests/integration/claude-agent-client-template.test.ts`に実装
- テストデータ（セクション4）を各テストケースで使用

### Test Execution Phase（Phase 6）への引き継ぎ
- カバレッジ目標（95%以上）の達成確認
- すべてのテストケース（34ケース）の成功確認
- パフォーマンステスト（1秒以内）の達成確認

---

## 9. まとめ

本テストシナリオ書は、Issue #140（ReDoS脆弱性）の修正に必要なすべてのテストシナリオを網羅しています。Planning PhaseおよびDesign Phaseで策定された戦略（UNIT_INTEGRATION、`replaceAll()`の使用、包括的なテスト）を踏まえ、以下の重要なポイントを達成しました：

### 重要なポイント
1. **テスト戦略準拠**: UNIT_INTEGRATION（Unitテスト28ケース + Integrationテスト6ケース）
2. **セキュリティ最優先**: ReDoSパターン5ケース、特殊文字10ケースの包括的なテスト
3. **後方互換性検証**: 既存のテンプレート処理が維持されることを3ケースで検証
4. **パフォーマンス検証**: 1秒以内の処理完了を3ケースで検証
5. **統合検証**: Claude Agent SDK全体のフローを6ケースで検証

### 品質ゲート達成状況
- [x] Phase 2の戦略に沿ったテストシナリオである
- [x] 主要な正常系がカバーされている
- [x] 主要な異常系がカバーされている
- [x] 期待結果が明確である

すべての品質ゲートを満たしており、次フェーズ（Implementation Phase）への移行準備が完了しています。
