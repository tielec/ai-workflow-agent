# 要件定義フェーズ - 修正プロンプト

## ⚠️ 最重要：必須アクション

**Write ツールまたは Edit ツールを使用して、要件定義書を以下のパスに必ず保存してください：**

```
.ai-workflow/issue-119/01_requirements/output/requirements.md
```

**このファイルが存在しない場合、Requirements Phase は失敗します。**

---

## タスク概要

レビューで指摘された問題を修正し、改善された要件定義書を作成してください。

**重要**: 前回のレビュー結果を踏まえ、ブロッカー（BLOCKER）を必ず解消してください。

## 元の成果物

以下の要件定義書をレビューした結果、修正が必要と判定されました。

@.ai-workflow/issue-119/01_requirements/output/requirements.md

## レビュー結果

# 要件定義レビュー

## 品質ゲート評価
- [ ] 機能要件が明確に記載されている: **PASS** - FR-1〜FR-5で対象機能・入力・出力が具体的に定義されています（`.ai-workflow/issue-119/01_requirements/output/requirements.md:19`）。
- [ ] 受け入れ基準が定義されている: **PASS** - 各FRに対してGiven/When/Then形式の検証条件が揃っています（`.ai-workflow/issue-119/01_requirements/output/requirements.md:41`）。
- [ ] スコープが明確である: **PASS** - スコープ外項目が列挙され、境界が明示されています（`.ai-workflow/issue-119/01_requirements/output/requirements.md:63`）。
- [ ] 論理的な矛盾がない: **PASS** - 非機能要件と機能要件が整合し、相互に矛盾は見当たりません（`.ai-workflow/issue-119/01_requirements/output/requirements.md:25`）。

**品質ゲート総合判定: PASS**

## Planning Phaseチェックリスト照合結果: FAIL
以下のタスクが未完了です：
- [ ] Task 1-1: 現行フォローアップIssue生成フローの分析  
  - 不足: 要件定義書に `issue-client.ts` のシーケンス整理や `RemainingTask`/`IssueContext` のデータフローが盛り込まれていません（`.ai-workflow/issue-119/00_planning/output/planning.md:36` → `.ai-workflow/issue-119/01_requirements/output/requirements.md`全体）。
- [ ] Task 1-2: LLM統合要件の明確化  
  - 不足: API利用要件のうちモデル候補やトークン制限が具体化されておらず、洗い出しが未完です（`.ai-workflow/issue-119/00_planning/output/planning.md:40` と `.ai-workflow/issue-119/01_requirements/output/requirements.md:22`）。

## 詳細レビュー

### 1. 具体性（Specificity）
- 良い点: タイトル文字数、本文セクション構成、ログ内容などが明文化されており実装判断がしやすいです（`.ai-workflow/issue-119/01_requirements/output/requirements.md:19`）。
- 課題: モデル選択肢やトークン上限が未定義で、LLM呼び出し条件が曖昧です（`.ai-workflow/issue-119/01_requirements/output/requirements.md:22`）。

### 2. 完全性（Completeness）
- 良い点: 非機能要件・制約・前提が幅広くカバーされています（`.ai-workflow/issue-119/01_requirements/output/requirements.md:25`、`:31`、`:36`）。
- 課題: 現行フロー分析やデータフロー整理が欠落し、PlanningのTask 1-1が満たされていません。

### 3. 検証可能性（Verifiability）
- 良い点: 受け入れ基準がテスト観点に直結しており検証可能です（`.ai-workflow/issue-119/01_requirements/output/requirements.md:41`）。
- 課題: モデル・トークン制限が不明なため、テストケースの境界条件を定義しきれません。

### 4. 整合性（Consistency）
- 良い点: フォールバック要件と可用性要件が一致しており矛盾は見当たりません（`.ai-workflow/issue-119/01_requirements/output/requirements.md:21`、`:28`）。

### 5. 実現可能性（Feasibility）
- 良い点: 既存スタックや依存関係を前提にしており実装可能性は高いです（`.ai-workflow/issue-119/01_requirements/output/requirements.md:31`）。

### 6. 優先度（Priority）
- 良い点: 各機能要件に優先度が付されMVP範囲が判断できます（`.ai-workflow/issue-119/01_requirements/output/requirements.md:17`）。

### 7. セキュリティ（Security）
- 良い点: APIキー取り扱いと機密情報フィルタが定義されています（`.ai-workflow/issue-119/01_requirements/output/requirements.md:27`）。

### 8. パフォーマンス（Performance）
- 良い点: レスポンス時間とリトライ上限が設定され、監視ログ要件とも整合しています（`.ai-workflow/issue-119/01_requirements/output/requirements.md:25`、`:23`）。

## ブロッカー（BLOCKER）
- Task 1-1が未完了：現行 `issue-client.ts` の処理フロー・データフローが要件定義書に反映されていません（`.ai-workflow/issue-119/00_planning/output/planning.md:36`）。
- Task 1-2が未完了：モデル候補やトークン制限などAPI利用要件の具体化が不足しています（`.ai-workflow/issue-119/00_planning/output/planning.md:40`、`.ai-workflow/issue-119/01_requirements/output/requirements.md:22`）。

## 改善提案（SUGGESTION）
- 現行フローのシーケンス図またはテキスト説明を追加し、`RemainingTask` と `IssueContext` の項目がLLM入力へどう流れるかを明示してください。
- LLM利用条件としてサポートするモデル名・max tokens・プロンプト/レスポンス制限を仕様化し、設定項目のデフォルト値も明記すると実装とテストが揃えやすくなります。
- ログ要件に関して、警告ログの構造（例: コード、メッセージ、フォールバック種別）を定義すると一貫した監査が可能になります。

## 総合評価
ドキュメント自体の品質ゲートは満たしていますが、Planning Phaseで要求された要件整理タスクが未完了のままです。この状態では現行フローの理解とLLM設定条件が不十分で、設計フェーズへ進むと手戻りリスクが高いと判断します。上記ブロッカーを解消したうえで再提出してください。

---
判定: FAIL

## 前回の実行ログ（参考）

以下は前回の実行ログの一部です。要件定義書内容がログに含まれている場合は、それを使用してファイルを作成できます：

```
# Codex Agent 実行ログ

開始日時: 2025/11/3 1:40:36

---

## Turn 1: スレッド開始

**Thread ID**: `019a475f-9206-7503-9867-8f278e229db9`

## Turn 2: ツール実行

**種別**: コマンド実行
**コマンド**: `bash -lc 'cat .ai-workflow/issue-119/00_planning/output/planning.md'`
**ステータス**: completed (exit_code=0)

```text
# プロジェクト計画書 - Issue #119 フォローアップIssue生成品質の改善（LLM活用）

## 1. Issue分析
- **複雑度**: 複雑  
  - 新規AI連携モジュールの追加と既存GitHub連携コードの拡張を伴い、外部API統合・エラーハンドリング・フォールバック設計が必要。
  - テストレイヤーが複数（LLM呼び出しのモック検証と実APIを用いた統合テスト）に渡る。
- **見積もり工数**: 22~26時間  
  - 設計/要件整理: 6~7h、実装: 7~9h、テスト（設計＋実装＋実行）: 6~7h、ドキュメント/レポート: 3h を想定。
- **リスク評価**: 中  
  - LLM APIの不確定要素と生成品質の主観評価が残る一方、既存コードへの影響は限定範囲に収まる見込み。

## 2. 実装戦略判断
- **実装戦略**: EXTEND  
  - 既存の `issue-client.ts` を中心に機能拡張し、新たな `issue-ai-generator.ts` を追加してL TM生成ロジックを組み込む。全体構造は維持したまま責務分割を拡張。
- **テスト戦略**: UNIT_INTEGRATION  
  - プロンプト生成・フォールバック制御はモックを使ったユニットテストで網羅し、実API呼び出しは環境変数制御下で統合テストを追加して品質を確認。
- **テストコード戦略**: BOTH_TEST  
  - 既存フォローアップ生成ロジックのテストを拡張しつつ、新規 `issue-ai-generator` 用の専用テストファイルを新設する必要がある。

## 3. 影響範囲分析
- **既存コードへの影響**  
  - `src/core/github/issue-client.ts`: LLM優先フロー追加、フォールバック制御、ログ出力変更。  
  - `src/types.ts`: 新しいオプションインターフェースとIssue生成データ構造の拡張。  
  - `src/commands/execute/agent-setup.ts` などのクライアント初期化部: LLM設定引き回しが必要な場合は拡張。
- **依存関係の変更**  
  - 新規AIクライアント実装に伴う依存ライブラリ（公式SDK、HTTPクライアント）の追加検討。  
  - `.env` や設定ファイルにAPIキー/モデル指定を追加する可能性。
- **マイグレーション要否**  
  - コード上のマイグレーションは不要。  
  - 設定ファイル・ドキュメントへの追記（APIキー設定、プロンプトファイル）を行う。  
  - 将来的な `.ai-workflow/config.yml` 拡張を見据えた設計が必要。

## 4. タスク分割

### Phase 1: 要件定義 (見積もり: 3~4h)
- [ ] Task 1-1: 現行フォローアップIssue生成フローの分析 (1~1.5h)
  - `issue-client.ts` のタイトル/本文生成ロジックをシーケンス図レベルで整理
  - Evaluation Phase から渡る `RemainingTask` / `IssueContext` のデータフローを確認
- [ ] Task 1-2: LLM統合要件の明確化 (1.5~2h)
  - API利用要件（モデル、トークン制限、リトライ戦略）を洗い出す
  - 生成物の品質条件・受け入れ基準を仕様として文書化

### Phase 2: 設計 (見積もり: 4~5h)
- [ ] Task 2-1: issue-ai-generatorモジュール設計 (2~2.5h)
  - クラス/関数責務、依存注入方法、フォールバックパスを設計
  - プロンプトテンプレートとレスポンス検証手順を定義
- [ ] Task 2-2: 設定・エラーハンドリング設計 (2~2.5h)
  - API鍵の取得経路とマスキン
```

## 修正指示

### ケース A: 要件定義書ファイルが未作成の場合

前回の実行でファイルが作成されなかった場合、以下の手順で対応してください：

1. **前回のログから要件定義書内容を抽出**（ログに要件定義書内容が含まれている場合）
   - 機能要件、受け入れ基準、スコープなどを抽出
   - 整形して requirements.md として保存

2. **新たに要件定義書を作成**（ログに要件定義書内容が不十分な場合）
   - Issue情報とPlanning情報に基づいて簡潔に要件定義書を作成
   - 必須項目（機能要件、受け入れ基準、スコープ）を含める
   - Write ツールで requirements.md として保存

### ケース B: レビューフィードバックに基づく修正の場合

#### ブロッカー（BLOCKER）の解消

レビュー結果の「ブロッカー」セクションに記載された問題は、**次フェーズに進めない重大な問題**です。これらを必ず解消してください。

#### 改善提案（SUGGESTION）の検討

レビュー結果の「改善提案」セクションに記載された項目は、可能な範囲で反映してください。ただし、これらは次フェーズに進むための必須要件ではありません。

## Issue情報（参考）

元のIssue情報を再度確認してください：

## Issue概要

- **Issue番号**: #119
- **タイトル**: フォローアップIssue生成品質の改善（LLM活用）
- **状態**: open
- **URL**: https://github.com/tielec/ai-workflow-agent/issues/119
- **ラベル**: なし

### 本文

# フォローアップIssue生成品質の改善（LLM活用）

## 概要

PR #107 でフォローアップIssueの自動生成機能を実装したが、実際に生成されるIssueは以下の問題を抱えている：

1. **タイトルが依然としてわかりにくい**
   - キーワード抽出ロジック（`extractKeywords()`）が単純な単語分割に依存
   - 技術的に重要なフレーズが分断される（例：「Coverage improvement」→「Coverage」だけ抽出）
   - 結果として、Issue #104で生成されたようなフォローアップIssueのタイトルが不明瞭

2. **残タスク詳細が不明瞭**
   - `formatTaskDetails()` は単なるフィールドの箇条書き
   - "結局何をすればいいか" が一目でわからない
   - 実行可能な具体的アクションに落とし込めていない

3. **コンテキスト理解不足**
   - 元のIssueやPRの背景が活用されていない
   - なぜこのタスクが残ったのか、どういう優先順位なのかが不明

## 提案解決策

### LLMを活用した生成品質の向上

既存の `issue-client.ts` に **LLM統合機能** を追加し、以下を実現：

#### 1. **インテリジェントなタイトル生成**
```typescript
async generateIntelligentTitle(
  task: RemainingTask,
  context: IssueContext
): Promise<string>
```

- Claude APIまたはCodex APIを使用
- 元のIssue、PRサマリー、タスク内容を総合的に分析
- 技術的に正確で検索可能なタイトルを生成（50-80文字）
- 例：`カバレッジ90%達成 - core/git/モジュール群の単体テスト追加`

#### 2. **構造化されたタスク本文の自動生成**
```typescript
async generateTaskDescription(
  task: RemainingTask,
  context: IssueContext
): Promise<string>
```

LLMに以下を生成させる：
- **背景**: なぜこのタスクが必要か（2-3文）
- **目的**: 何を達成するか（1文）
- **具体的なアクション**:
  - 対象ファイルと変更内容
  - 実行手順（ステップバイステップ）
  - テスト方法
- **受け入れ基準**: 完了条件（チェックリスト形式）
- **関連リソース**: 参考ドキュメント、関連Issue/PR

#### 3. **フォールバック機構**
- LLM API失敗時は現在の実装にフォールバック
- エラーログに警告を出力し、手動レビューを促す

## 実装詳細

### 新規ファイル
- `src/core/github/issue-ai-generator.ts`: LLM統合ロジック
  - プロンプトテンプレート管理
  - API呼び出しとレスポンス検証
  - レート制限・エラーハンドリング

### 修正ファイル
- `src/core/github/issue-client.ts`:
  - `createIssueFromEvaluation()` を修正し、LLM生成を優先的に使用
  - 既存の `extractKeywords()`, `generateFollowUpTitle()`, `formatTaskDetails()` をフォールバック用として保持

- `src/types.ts`:
  - `IssueGenerationOptions` インターフェース追加（LLM有効化フラグ、モデル選択等）

### プロンプト設計例

```
あなたはソフトウェア開発プロジェクトのIssue作成アシスタントです。

以下の情報から、実行可能で明確なフォローアップIssueを作成してください：

【元のIssue】
タイトル: {{original_issue_title}}
概要: {{original_issue_summary}}

【関連PR】
タイトル: {{pr_title}}
実装内容: {{pr_summary}}

【残タスク】
タスク名: {{task.title}}
説明: {{task.description}}
優先度: {{task.priority}}

【要求事項】
1. タイトルは50-80文字、技術的に正確で検索可能なこと
2. 本文は以下のセクションを含むこと：
   - ## 背景 (なぜ必要か)
   - ## 目的 (何を達成するか)
   - ## 実行内容 (具体的なステップ)
   - ## 受け入れ基準 (完了条件)
   - ## 関連リソース

出力形式：
{
  "title": "...",
  "body": "..."
}
```

## 受け入れ基準

- [ ] LLM統合機能が実装され、Claude/Codex APIを呼び出せる
- [ ] 生成されたタイトルが元のタイトルより明確（主観評価+ユニットテスト）
- [ ] 生成された本文に必須セクション（背景、目的、実行内容、受け入れ基準）が含まれる
- [ ] API失敗時に既存実装へのフォールバックが動作する
- [ ] ユニットテスト追加（モックAPI、プロンプト検証、フォールバック動作）
- [ ] 統合テスト追加（実際のAPI呼び出し、生成品質評価）
- [ ] ARCHITECTURE.md、CLAUDE.md にLLM統合について記載

## 補足

### コスト考慮
- Evaluation Phase（Phase 9）は各ワークフローで1回のみ実行
- タスク数は通常1-5個程度
- 1回のフォローアップIssue生成あたりのコストは小さい（数セント以下）

### セキュリティ
- API キーは環境変数経由で安全に管理
- 送信するコンテキスト情報に機密情報が含まれないよう注意（センシティブデータのフィルタリング）

### 将来拡張
- ユーザーがカスタムプロンプトを指定可能にする（`.ai-workflow/config.yml`）
- 生成されたIssueに対する人間によるレビュー・編集ワークフローの追加

## 品質ゲート（Phase 1）

修正後の要件定義書は、以下の品質ゲートを満たす必要があります：

- [ ] **機能要件が明確に記載されている**
- [ ] **受け入れ基準が定義されている**
- [ ] **スコープが明確である**
- [ ] **論理的な矛盾がない**

## 修正方針

1. **ブロッカーを最優先で解消**: レビューで指摘されたブロッカーを必ず修正
2. **品質ゲートの確認**: 4つの必須要件を満たすことを確認
3. **改善提案の反映**: 可能な範囲で改善提案を反映（完璧を求めない）
4. **元の内容を尊重**: 問題のない部分は変更しない

## 注意事項

1. **レビュー指摘に焦点を当てる**: レビューで指摘されていない部分を大幅に変更しない
2. **ブロッカーと改善提案を区別**: ブロッカーは必須、改善提案は推奨
3. **具体性を維持**: 修正によって曖昧さが増えないように注意
4. **整合性の確保**: 修正箇所が他のセクションと矛盾しないか確認

## 出力形式

修正した要件定義書を以下のファイルに保存してください：

```
.ai-workflow/issue-{issue_number}/01_requirements/output/requirements.md
```

元のファイルを上書きする形で修正してください。

## 参考情報

必要に応じて以下を参照してください：
- @CLAUDE.md - プロジェクトの全体方針とコーディングガイドライン
- @ARCHITECTURE.md - アーキテクチャ設計思想
- 関連する@CONTRIBUTION.md - 開発ガイドライン
