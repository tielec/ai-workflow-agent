# 要件定義フェーズ - 実行プロンプト

## タスク概要

GitHubのIssue情報から詳細な要件定義書を作成してください。

## 入力情報

### Planning Phase成果物
- Planning Document: @.ai-workflow/issue-119/00_planning/output/planning.md

**注意**: Planning Phaseが実行されている場合、開発計画（実装戦略、テスト戦略、リスク、スケジュール）を必ず確認してください。

### GitHub Issue情報

## Issue概要

- **Issue番号**: #119
- **タイトル**: フォローアップIssue生成品質の改善（LLM活用）
- **状態**: open
- **URL**: https://github.com/tielec/ai-workflow-agent/issues/119
- **ラベル**: なし

### 本文

# フォローアップIssue生成品質の改善（LLM活用）

## 概要

PR #107 でフォローアップIssueの自動生成機能を実装したが、実際に生成されるIssueは以下の問題を抱えている：

1. **タイトルが依然としてわかりにくい**
   - キーワード抽出ロジック（`extractKeywords()`）が単純な単語分割に依存
   - 技術的に重要なフレーズが分断される（例：「Coverage improvement」→「Coverage」だけ抽出）
   - 結果として、Issue #104で生成されたようなフォローアップIssueのタイトルが不明瞭

2. **残タスク詳細が不明瞭**
   - `formatTaskDetails()` は単なるフィールドの箇条書き
   - "結局何をすればいいか" が一目でわからない
   - 実行可能な具体的アクションに落とし込めていない

3. **コンテキスト理解不足**
   - 元のIssueやPRの背景が活用されていない
   - なぜこのタスクが残ったのか、どういう優先順位なのかが不明

## 提案解決策

### LLMを活用した生成品質の向上

既存の `issue-client.ts` に **LLM統合機能** を追加し、以下を実現：

#### 1. **インテリジェントなタイトル生成**
```typescript
async generateIntelligentTitle(
  task: RemainingTask,
  context: IssueContext
): Promise<string>
```

- Claude APIまたはCodex APIを使用
- 元のIssue、PRサマリー、タスク内容を総合的に分析
- 技術的に正確で検索可能なタイトルを生成（50-80文字）
- 例：`カバレッジ90%達成 - core/git/モジュール群の単体テスト追加`

#### 2. **構造化されたタスク本文の自動生成**
```typescript
async generateTaskDescription(
  task: RemainingTask,
  context: IssueContext
): Promise<string>
```

LLMに以下を生成させる：
- **背景**: なぜこのタスクが必要か（2-3文）
- **目的**: 何を達成するか（1文）
- **具体的なアクション**:
  - 対象ファイルと変更内容
  - 実行手順（ステップバイステップ）
  - テスト方法
- **受け入れ基準**: 完了条件（チェックリスト形式）
- **関連リソース**: 参考ドキュメント、関連Issue/PR

#### 3. **フォールバック機構**
- LLM API失敗時は現在の実装にフォールバック
- エラーログに警告を出力し、手動レビューを促す

## 実装詳細

### 新規ファイル
- `src/core/github/issue-ai-generator.ts`: LLM統合ロジック
  - プロンプトテンプレート管理
  - API呼び出しとレスポンス検証
  - レート制限・エラーハンドリング

### 修正ファイル
- `src/core/github/issue-client.ts`:
  - `createIssueFromEvaluation()` を修正し、LLM生成を優先的に使用
  - 既存の `extractKeywords()`, `generateFollowUpTitle()`, `formatTaskDetails()` をフォールバック用として保持

- `src/types.ts`:
  - `IssueGenerationOptions` インターフェース追加（LLM有効化フラグ、モデル選択等）

### プロンプト設計例

```
あなたはソフトウェア開発プロジェクトのIssue作成アシスタントです。

以下の情報から、実行可能で明確なフォローアップIssueを作成してください：

【元のIssue】
タイトル: {{original_issue_title}}
概要: {{original_issue_summary}}

【関連PR】
タイトル: {{pr_title}}
実装内容: {{pr_summary}}

【残タスク】
タスク名: {{task.title}}
説明: {{task.description}}
優先度: {{task.priority}}

【要求事項】
1. タイトルは50-80文字、技術的に正確で検索可能なこと
2. 本文は以下のセクションを含むこと：
   - ## 背景 (なぜ必要か)
   - ## 目的 (何を達成するか)
   - ## 実行内容 (具体的なステップ)
   - ## 受け入れ基準 (完了条件)
   - ## 関連リソース

出力形式：
{
  "title": "...",
  "body": "..."
}
```

## 受け入れ基準

- [ ] LLM統合機能が実装され、Claude/Codex APIを呼び出せる
- [ ] 生成されたタイトルが元のタイトルより明確（主観評価+ユニットテスト）
- [ ] 生成された本文に必須セクション（背景、目的、実行内容、受け入れ基準）が含まれる
- [ ] API失敗時に既存実装へのフォールバックが動作する
- [ ] ユニットテスト追加（モックAPI、プロンプト検証、フォールバック動作）
- [ ] 統合テスト追加（実際のAPI呼び出し、生成品質評価）
- [ ] ARCHITECTURE.md、CLAUDE.md にLLM統合について記載

## 補足

### コスト考慮
- Evaluation Phase（Phase 9）は各ワークフローで1回のみ実行
- タスク数は通常1-5個程度
- 1回のフォローアップIssue生成あたりのコストは小さい（数セント以下）

### セキュリティ
- API キーは環境変数経由で安全に管理
- 送信するコンテキスト情報に機密情報が含まれないよう注意（センシティブデータのフィルタリング）

### 将来拡張
- ユーザーがカスタムプロンプトを指定可能にする（`.ai-workflow/config.yml`）
- 生成されたIssueに対する人間によるレビュー・編集ワークフローの追加

## 要件定義書の構成

以下のセクションを含む要件定義書を作成してください：

### 0. Planning Documentの確認（Planning Phaseが実行されている場合）
- 開発計画の全体像を把握
- スコープ、技術選定、リスク、スケジュールを確認
- Planning Documentで策定された戦略を踏まえて要件定義を実施

### 1. 概要
- Issue本文の「## 概要」セクションを要約
- 背景と目的を明確に記述
- ビジネス価値・技術的価値を説明

### 2. 機能要件
- Issue本文の「## TODO」セクションから機能要件を抽出
- 各要件を明確かつ検証可能な形で記述
- 優先度（高/中/低）を付与

### 3. 非機能要件
- パフォーマンス要件
- セキュリティ要件
- 可用性・信頼性要件
- 保守性・拡張性要件

### 4. 制約事項
- 技術的制約（使用技術、既存システムとの整合性）
- リソース制約（時間、人員、予算）
- ポリシー制約（セキュリティポリシー、コーディング規約）

### 5. 前提条件
- システム環境
- 依存コンポーネント
- 外部システム連携

### 6. 受け入れ基準
- 各機能要件の受け入れ基準（Given-When-Then形式推奨）
- テスト可能な形で記述

### 7. スコープ外
- 明確にスコープ外とする事項
- 将来的な拡張候補

## 出力形式

Markdown形式で要件定義書を作成し、以下のファイルに保存してください：

```
.ai-workflow/issue-119/01_requirements/output/requirements.md
```

## 品質ゲート（Phase 1）

作成する要件定義書は、以下の品質ゲートを満たす必要があります：

- [ ] **機能要件が明確に記載されている**
- [ ] **受け入れ基準が定義されている**
- [ ] **スコープが明確である**
- [ ] **論理的な矛盾がない**

これらの品質ゲートは**必須要件**です。作成後、クリティカルシンキングレビューが実施され、品質ゲートを満たさない場合は修正が必要になります。

## 注意事項

1. **具体性**: 曖昧な表現を避け、具体的かつ測定可能な要件を記述
   - NG例: "適切に処理する"、"必要に応じて対応"
   - OK例: "3秒以内にレスポンスを返す"、"エラー発生時は管理者に通知"

2. **整合性**: 各セクション間で矛盾がないか確認
   - 機能要件と受け入れ基準が対応しているか
   - 非機能要件と制約事項が矛盾していないか

3. **完全性**: Issue本文の情報を漏れなく反映
   - TODOセクションの項目をすべて機能要件に反映
   - 概要セクションの背景・目的を明確に記述

4. **検証可能性**: 各要件が検証可能（テスト可能）な形で記述
   - 受け入れ基準は Given-When-Then 形式で記述
   - 成功条件・失敗条件が明確に識別可能

5. **レビューされることを意識**: 作成した要件定義書はクリティカルシンキングレビューが実施されます
   - 品質ゲート（4つの必須要件）を最優先で満たすこと
   - ブロッカー（次フェーズに進めない問題）がないように注意
   - 改善提案は歓迎されるが、ブロッカーは修正が必須

## 参考情報

必要に応じて以下を参照してください（存在する場合）：
- @CLAUDE.md - プロジェクトの全体方針とコーディングガイドライン
- @ARCHITECTURE.md - アーキテクチャ設計思想
- @CONTRIBUTION.md - 開発ガイドライン
- @README.md - プロジェクト概要と使用方法
- その他、プロジェクト固有のドキュメント
