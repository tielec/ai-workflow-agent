# 詳細設計フェーズ - 修正プロンプト

## ⚠️ 最重要：必須アクション

**Write ツールまたは Edit ツールを使用して、設計書を以下のパスに必ず保存してください：**

```
.ai-workflow/issue-119/02_design/output/design.md
```

**このファイルが存在しない場合、Design Phase は失敗します。**

---

## タスク概要
レビューで指摘された問題を修正し、改善された設計書を作成してください。

## 元の成果物
@.ai-workflow/issue-119/02_design/output/design.md

## レビュー結果
## 品質ゲート評価

- [x] **実装戦略の判断根拠が明記されている**: **PASS** - EXTEND を選んだ理由が既存フロー維持とフォールバック確保の観点で整理されています（design.md:60）。
- [x] **テスト戦略の判断根拠が明記されている**: **PASS** - ユニット／統合それぞれの役割分担が明確です（design.md:69）。
- [x] **既存コードへの影響範囲が分析されている**: **PASS** - 影響ファイルと依存関係の整理が網羅的です（design.md:85）。
- [ ] **変更が必要なファイルがリストアップされている**: **FAIL** - LLM入力をマスクするために必須となる `SecretMasker` の拡張が設計に記載されている一方、変更ファイル一覧に `src/core/secret-masker.ts` が含まれていません（design.md:108, design.md:179, src/core/secret-masker.ts:24）。
- [ ] **設計が実装可能である**: **FAIL** - 設計が依存する `SecretMasker.maskObject` が現行コードに存在せず、追加方法も定義されていないため、このままでは実装できません（design.md:179, src/core/secret-masker.ts:24）。

**品質ゲート総合判定: FAIL**

## 詳細レビュー

### 1. 戦略判断の妥当性
**良好な点**: EXTEND 戦略で既存フローを保護しつつ LLM を組み込む方針が要件と整合しています（design.md:60）。  
**懸念点**: 特になし。

### 2. 影響範囲分析の適切性
**良好な点**: 主要モジュールと依存設定の更新が整理されており、想定範囲が把握できます（design.md:85）。  
**懸念点**: `PhaseContext` を拡張すると明記しているものの、`PhaseFactory` や `BasePhase` など伝搬に必要なファイルが変更リストに含まれていません（design.md:85, design.md:108）。

### 3. ファイルリストの完全性
**良好な点**: 新規モジュールと主要既存ファイルの更新予定が列挙されています（design.md:108）。  
**懸念点**: LLM入力をマスクするための `SecretMasker` 変更が漏れており、必要作業が反映されていません（design.md:179, src/core/secret-masker.ts:24）。

### 4. 設計の実装可能性
**良好な点**: LLM応答の検証やフォールバック手順が段階的に整理されています（design.md:176）。  
**懸念点**: `SecretMasker.maskObject` を利用する前提ですが、現行クラスには該当メソッドが存在せず実装方法も未定義で、設計通りに実装できません（design.md:179, src/core/secret-masker.ts:24）。

### 5. 要件との対応
**良好な点**: 要件トレーサビリティ表で各機能要件への対応が紐付けられています（design.md:210）。  
**懸念点**: 特になし。

### 6. セキュリティ考慮
**良好な点**: 機密情報マスキングやHTML拒否などの対策が記載されています（design.md:176, design.md:218）。  
**改善の余地**: 実際にマスキングを担う `SecretMasker` へどのような拡張を行うか明文化すると、実装者が迷いません。

### 7. 非機能要件への対応
**良好な点**: タイムアウトとリトライの上限設計、コスト配慮などが示されています（design.md:240）。  
**改善の余地**: 特になし。

## ブロッカー（BLOCKER）

1. **SecretMasker 拡張の欠落**
   - 問題: `IssueAIGenerator` が `SecretMasker.maskObject` を利用するとしているが、そのメソッドは現行クラスに存在せず、どこで追加するかも設計に含まれていません（design.md:179, src/core/secret-masker.ts:24）。
   - 影響: マスキング処理が実装できず、設計通りにLLMへ安全な入力を渡せません。
   - 対策: `SecretMasker` にオブジェクトマスキング機能を追加する設計（メソッド仕様・置換ロジック・テスト方針）を明記し、変更ファイルリストにも `src/core/secret-masker.ts` を加えてください。

## 改善提案（SUGGESTION）

1. **PhaseContext 伝搬ファイルの明示**
   - 現状: `PhaseContext.issueGenerationOptions` を追加すると記載されていますが、`PhaseFactory` や `BasePhase` などで値を渡す作業が変更一覧に載っていません（design.md:85, design.md:108）。
   - 提案: どのファイルでコンテキストを保持・参照するかを具体的に列挙し、変更リストにも追記すると実装計画の抜け漏れ防止につながります。
   - 効果: 設計と作業計画の整合性が上がり、実装時の見落としを減らせます。

## 総合評価

**主な強み**:
- EXTEND 戦略とテスト方針が要件と一致し、フォールバック設計も整っています（design.md:60, design.md:69）。
- LLM出力の検証手順やメタデータ付与など、実務利用を意識した詳細設計が充実しています（design.md:176, design.md:205）。

**主な改善提案**:
- `SecretMasker` のオブジェクトマスキング仕様を明示し、変更ファイルリストを補完してください（design.md:179, src/core/secret-masker.ts:24）。
- `PhaseContext` 伝搬に関わる基盤ファイルを変更対象として追記することで、実装計画の抜け漏れを防ぐと安心です（design.md:85, design.md:108）。

`SecretMasker` への依存ギャップが解消されれば、実装に進む準備が整った設計になると思います。まずはマスキング機構の設計補強と変更リストの更新をご検討ください。

---
判定: FAIL

## 前回の実行ログ（参考）

以下は前回の実行ログの一部です。設計書内容がログに含まれている場合は、それを使用してファイルを作成できます：

```
# Codex Agent 実行ログ

開始日時: 2025/11/3 2:45:15

---

## Turn 1: スレッド開始

**Thread ID**: `019a479a-c19c-7c72-8456-650e94ab5ab3`

## Turn 2: ツール実行

**種別**: コマンド実行
**コマンド**: `bash -lc 'cat .ai-workflow/issue-119/00_planning/output/planning.md'`
**ステータス**: completed (exit_code=0)

```text
# プロジェクト計画書 - Issue #119 フォローアップIssue生成品質の改善（LLM活用）

## 1. Issue分析
- **複雑度**: 複雑  
  - 新規AI連携モジュールの追加と既存GitHub連携コードの拡張を伴い、外部API統合・エラーハンドリング・フォールバック設計が必要。
  - テストレイヤーが複数（LLM呼び出しのモック検証と実APIを用いた統合テスト）に渡る。
- **見積もり工数**: 22~26時間  
  - 設計/要件整理: 6~7h、実装: 7~9h、テスト（設計＋実装＋実行）: 6~7h、ドキュメント/レポート: 3h を想定。
- **リスク評価**: 中  
  - LLM APIの不確定要素と生成品質の主観評価が残る一方、既存コードへの影響は限定範囲に収まる見込み。

## 2. 実装戦略判断
- **実装戦略**: EXTEND  
  - 既存の `issue-client.ts` を中心に機能拡張し、新たな `issue-ai-generator.ts` を追加してL TM生成ロジックを組み込む。全体構造は維持したまま責務分割を拡張。
- **テスト戦略**: UNIT_INTEGRATION  
  - プロンプト生成・フォールバック制御はモックを使ったユニットテストで網羅し、実API呼び出しは環境変数制御下で統合テストを追加して品質を確認。
- **テストコード戦略**: BOTH_TEST  
  - 既存フォローアップ生成ロジックのテストを拡張しつつ、新規 `issue-ai-generator` 用の専用テストファイルを新設する必要がある。

## 3. 影響範囲分析
- **既存コードへの影響**  
  - `src/core/github/issue-client.ts`: LLM優先フロー追加、フォールバック制御、ログ出力変更。  
  - `src/types.ts`: 新しいオプションインターフェースとIssue生成データ構造の拡張。  
  - `src/commands/execute/agent-setup.ts` などのクライアント初期化部: LLM設定引き回しが必要な場合は拡張。
- **依存関係の変更**  
  - 新規AIクライアント実装に伴う依存ライブラリ（公式SDK、HTTPクライアント）の追加検討。  
  - `.env` や設定ファイルにAPIキー/モデル指定を追加する可能性。
- **マイグレーション要否**  
  - コード上のマイグレーションは不要。  
  - 設定ファイル・ドキュメントへの追記（APIキー設定、プロンプトファイル）を行う。  
  - 将来的な `.ai-workflow/config.yml` 拡張を見据えた設計が必要。

## 4. タスク分割

### Phase 1: 要件定義 (見積もり: 3~4h)
- [x] Task 1-1: 現行フォローアップIssue生成フローの分析 (1~1.5h)
  - `issue-client.ts` のタイトル/本文生成ロジックをシーケンス図レベルで整理
  - Evaluation Phase から渡る `RemainingTask` / `IssueContext` のデータフローを確認
  - レビュー結果: 要件定義書にシーケンス分析とデータフロー整理が反映されたため完了
- [x] Task 1-2: LLM統合要件の明確化 (1.5~2h)
  - API利用要件（モデル、トークン制限、リトライ戦略）を洗い出す
  - 生成物の品質条件・受け入れ基準を仕様として文書化
  - レビュー結果: モデル候補・トークン制限・リトライ戦略が要件定義書に詳細化されたため完了

### Phase 2: 設計 (見積もり: 4~5h)
- [ ] Task 2-1: issue-ai-generatorモジュール設計 (2~2.5h)
  - クラス/関数責務、依存注入方法、フォールバッ
```

## 参考情報

### 要件定義書
@.ai-workflow/issue-119/01_requirements/output/requirements.md

### GitHub Issue情報
## Issue概要

- **Issue番号**: #119
- **タイトル**: フォローアップIssue生成品質の改善（LLM活用）
- **状態**: open
- **URL**: https://github.com/tielec/ai-workflow-agent/issues/119
- **ラベル**: なし

### 本文

# フォローアップIssue生成品質の改善（LLM活用）

## 概要

PR #107 でフォローアップIssueの自動生成機能を実装したが、実際に生成されるIssueは以下の問題を抱えている：

1. **タイトルが依然としてわかりにくい**
   - キーワード抽出ロジック（`extractKeywords()`）が単純な単語分割に依存
   - 技術的に重要なフレーズが分断される（例：「Coverage improvement」→「Coverage」だけ抽出）
   - 結果として、Issue #104で生成されたようなフォローアップIssueのタイトルが不明瞭

2. **残タスク詳細が不明瞭**
   - `formatTaskDetails()` は単なるフィールドの箇条書き
   - "結局何をすればいいか" が一目でわからない
   - 実行可能な具体的アクションに落とし込めていない

3. **コンテキスト理解不足**
   - 元のIssueやPRの背景が活用されていない
   - なぜこのタスクが残ったのか、どういう優先順位なのかが不明

## 提案解決策

### LLMを活用した生成品質の向上

既存の `issue-client.ts` に **LLM統合機能** を追加し、以下を実現：

#### 1. **インテリジェントなタイトル生成**
```typescript
async generateIntelligentTitle(
  task: RemainingTask,
  context: IssueContext
): Promise<string>
```

- Claude APIまたはCodex APIを使用
- 元のIssue、PRサマリー、タスク内容を総合的に分析
- 技術的に正確で検索可能なタイトルを生成（50-80文字）
- 例：`カバレッジ90%達成 - core/git/モジュール群の単体テスト追加`

#### 2. **構造化されたタスク本文の自動生成**
```typescript
async generateTaskDescription(
  task: RemainingTask,
  context: IssueContext
): Promise<string>
```

LLMに以下を生成させる：
- **背景**: なぜこのタスクが必要か（2-3文）
- **目的**: 何を達成するか（1文）
- **具体的なアクション**:
  - 対象ファイルと変更内容
  - 実行手順（ステップバイステップ）
  - テスト方法
- **受け入れ基準**: 完了条件（チェックリスト形式）
- **関連リソース**: 参考ドキュメント、関連Issue/PR

#### 3. **フォールバック機構**
- LLM API失敗時は現在の実装にフォールバック
- エラーログに警告を出力し、手動レビューを促す

## 実装詳細

### 新規ファイル
- `src/core/github/issue-ai-generator.ts`: LLM統合ロジック
  - プロンプトテンプレート管理
  - API呼び出しとレスポンス検証
  - レート制限・エラーハンドリング

### 修正ファイル
- `src/core/github/issue-client.ts`:
  - `createIssueFromEvaluation()` を修正し、LLM生成を優先的に使用
  - 既存の `extractKeywords()`, `generateFollowUpTitle()`, `formatTaskDetails()` をフォールバック用として保持

- `src/types.ts`:
  - `IssueGenerationOptions` インターフェース追加（LLM有効化フラグ、モデル選択等）

### プロンプト設計例

```
あなたはソフトウェア開発プロジェクトのIssue作成アシスタントです。

以下の情報から、実行可能で明確なフォローアップIssueを作成してください：

【元のIssue】
タイトル: {{original_issue_title}}
概要: {{original_issue_summary}}

【関連PR】
タイトル: {{pr_title}}
実装内容: {{pr_summary}}

【残タスク】
タスク名: {{task.title}}
説明: {{task.description}}
優先度: {{task.priority}}

【要求事項】
1. タイトルは50-80文字、技術的に正確で検索可能なこと
2. 本文は以下のセクションを含むこと：
   - ## 背景 (なぜ必要か)
   - ## 目的 (何を達成するか)
   - ## 実行内容 (具体的なステップ)
   - ## 受け入れ基準 (完了条件)
   - ## 関連リソース

出力形式：
{
  "title": "...",
  "body": "..."
}
```

## 受け入れ基準

- [ ] LLM統合機能が実装され、Claude/Codex APIを呼び出せる
- [ ] 生成されたタイトルが元のタイトルより明確（主観評価+ユニットテスト）
- [ ] 生成された本文に必須セクション（背景、目的、実行内容、受け入れ基準）が含まれる
- [ ] API失敗時に既存実装へのフォールバックが動作する
- [ ] ユニットテスト追加（モックAPI、プロンプト検証、フォールバック動作）
- [ ] 統合テスト追加（実際のAPI呼び出し、生成品質評価）
- [ ] ARCHITECTURE.md、CLAUDE.md にLLM統合について記載

## 補足

### コスト考慮
- Evaluation Phase（Phase 9）は各ワークフローで1回のみ実行
- タスク数は通常1-5個程度
- 1回のフォローアップIssue生成あたりのコストは小さい（数セント以下）

### セキュリティ
- API キーは環境変数経由で安全に管理
- 送信するコンテキスト情報に機密情報が含まれないよう注意（センシティブデータのフィルタリング）

### 将来拡張
- ユーザーがカスタムプロンプトを指定可能にする（`.ai-workflow/config.yml`）
- 生成されたIssueに対する人間によるレビュー・編集ワークフローの追加

## 修正指示

### ケース A: 設計書ファイルが未作成の場合

前回の実行でファイルが作成されなかった場合、以下の手順で対応してください：

1. **前回のログから設計書内容を抽出**（ログに設計書内容が含まれている場合）
   - 実装戦略、テスト戦略、影響範囲分析、ファイルリストなどを抽出
   - 整形して design.md として保存

2. **新たに設計書を作成**（ログに設計書内容が不十分な場合）
   - 要件定義書とPlanning情報に基づいて簡潔に設計書を作成
   - 必須項目（実装戦略、テスト戦略、影響範囲、ファイルリスト）を含める
   - Write ツールで design.md として保存

### ケース B: レビューフィードバックに基づく修正の場合

#### ブロッカー（BLOCKER）の解消

レビュー結果の「ブロッカー」セクションに記載された問題は、**次フェーズに進めない重大な問題**です。これらを必ず解消してください。

**ブロッカーの典型例**:
- 3つの戦略判断（実装・テスト・テストコード）が欠落 → 追加する
- 判断根拠が不十分 → 具体的かつ論理的に補強する
- ファイルリストが未記載 → リストアップする
- 設計が実装不可能 → 実装可能な設計に修正する
- 重大なセキュリティリスク → 対策を追加する

#### 改善提案（SUGGESTION）の検討

レビュー結果の「改善提案」セクションに記載された項目は、可能な範囲で反映してください。

**改善提案の優先度**:
1. 設計の品質を大きく向上させる提案 → 優先的に反映
2. ドキュメントの充実（図表追加等） → 可能であれば反映
3. 細かい表現の改善 → 時間があれば反映

## 品質ゲート（Phase 2）

修正後の設計書は、以下の品質ゲートをすべて満たす必要があります：

- [ ] **実装戦略の判断根拠が明記されている**
- [ ] **テスト戦略の判断根拠が明記されている**
- [ ] **既存コードへの影響範囲が分析されている**
- [ ] **変更が必要なファイルがリストアップされている**
- [ ] **設計が実装可能である**

## 修正方針

### 1. ブロッカー対応（最優先）

レビューで指摘されたブロッカーを1つずつ解消してください。

**対応方法**:
- 元の設計書を読み込む
- ブロッカー指摘箇所を特定
- 指摘内容を理解し、適切に修正
- 修正後、ブロッカーが解消されたか確認

### 2. 改善提案の反映（推奨）

可能な範囲で、レビューの改善提案を反映してください。

**対応方法**:
- 改善提案を読み込む
- 実装可能かつ効果的な提案を選択
- 元の設計書に追記・修正
- 全体の整合性を確認

### 3. 元の成果物の尊重

レビューで問題がなかった部分は、基本的に変更しないでください。

**注意点**:
- ブロッカー解消に必要な修正のみ実施
- 不必要な変更は避ける
- 元の設計の良い部分は維持する

## 修正後の確認事項

修正完了後、以下を確認してください：

1. **ブロッカーが解消されたか**
   - レビューで指摘されたすべてのブロッカーに対応したか
   - 対応内容が適切か

2. **品質ゲートを満たしているか**
   - 5つの品質ゲートすべてをクリアしているか

3. **全体の整合性**
   - 修正によって新たな矛盾が生まれていないか
   - ドキュメント全体が一貫しているか

4. **実装可能性**
   - 修正後の設計が実装可能か
   - 次フェーズ（テストシナリオ）に進めるか

## 出力形式

修正した設計書を `.ai-workflow/issue-{issue_number}/02_design/output/design.md` として保存してください。

**上書き形式**で保存してください（元のファイルを置き換え）。

## 修正開始

上記を踏まえ、レビュー指摘事項を反映した改善版の設計書を作成してください。
