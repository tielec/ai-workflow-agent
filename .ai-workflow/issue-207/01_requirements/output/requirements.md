# 要件定義書

## 0. Planning Documentの確認

Planning Phase（Phase 0）で策定された開発計画を確認しました。主要な方針は以下の通りです：

- **実装戦略**: EXTEND（既存のプロンプトファイルを修正）
- **テスト戦略**: UNIT_INTEGRATION（ユニットテスト + インテグレーションテスト）
- **テストコード戦略**: EXTEND_TEST（既存テストに追加）
- **見積もり工数**: 8~12時間
- **リスク**: 低（プロンプトファイルの修正のみ、実装コードの変更なし）

この計画に基づき、以下の要件定義を実施します。

## 1. 概要

### 背景

現在のAI Workflowでは、各フェーズ（Phase 0-9）で詳細なドキュメントが生成されます。これはLLMが後続フェーズで参照するために設計されていますが、以下の問題が発生しています：

- **レビュー負荷の増加**: 人間がレビューする際に情報過多で確認しきれない
- **コンテキスト制限**: Phase 8（Report）やPhase 9（Evaluation）でコンテキスト制限エラーが発生（Issue #202）
- **可読性の低下**: 重要な情報が埋もれてしまう

### 目的

中盤フェーズ（Phase 4-8）の出力ドキュメントを簡潔化することで、以下を実現します：

1. **レビュー時間の短縮**: 重要な情報に集中できるようにする
2. **コンテキスト消費の削減**: Evaluation Phaseのエラーを防止
3. **可読性の向上**: 必要な情報が見つけやすくする

### スコープ

- **対象**: Phase 4-8の出力フォーマット指示（プロンプトファイル）
- **非対象**: Phase 0-2（Planning, Requirements, Design）は詳細を維持
- **アプローチ**: プロンプトファイルの修正のみ（実装コードは変更しない）

### ビジネス価値・技術的価値

- **ビジネス価値**: レビュー工数の削減（約30-50%の時間短縮を期待）
- **技術的価値**: コンテキスト制限エラーの解消、ワークフロー全体の安定性向上

## 2. 機能要件

### FR-1: Phase 4（Implementation）の出力フォーマット簡潔化【優先度: 高】

**詳細**:
- 実装詳細セクションを削除し、「変更ファイル一覧」テーブルフォーマットに置き換える
- 「主要な変更点」セクションを3-5個の箇条書きに簡潔化する

**現状（変更前）**:
```markdown
## 実装詳細

### ファイル1: path/to/file.py
- **変更内容**: （何を実装したか）
- **理由**: （なぜこの実装にしたか）
- **注意点**: （レビュー時の注意点）

（以下、各ファイルについて記載）
```

**要求仕様（変更後）**:
```markdown
## 変更ファイル一覧

| ファイル | 変更種別 | 概要 |
|---------|---------|------|
| `path/to/file.py` | 新規 | XXX機能を実装 |
| `path/to/existing.py` | 修正 | YYY処理を追加 |

## 主要な変更点
- （重要な変更点を3-5個の箇条書きで）
```

**対象ファイル**: `src/prompts/implementation/execute.txt`

### FR-2: Phase 5（Test Implementation）の出力フォーマット簡潔化【優先度: 高】

**詳細**:
- テストケース詳細セクションを削除し、「テストファイル一覧」テーブルフォーマットに置き換える
- 「テストカバレッジ」セクションを数値サマリーに簡潔化する

**現状（変更前）**:
```markdown
## テストケース詳細

### ファイル: tests/test_xxx.py
- **test_function1**: （テスト内容の詳細説明）
- **test_function2**: （テスト内容の詳細説明）
```

**要求仕様（変更後）**:
```markdown
## テストファイル一覧

| ファイル | テスト数 | カバー対象 |
|---------|---------|-----------|
| `tests/test_xxx.py` | 5 | XXXモジュール |

## テストカバレッジ
- ユニットテスト: X件
- 統合テスト: Y件
```

**対象ファイル**: `src/prompts/test_implementation/execute.txt`

### FR-3: Phase 6（Testing）の出力フォーマット簡潔化【優先度: 高】

**詳細**:
- 成功時: サマリーのみ（総数、成功率）を出力
- 失敗時: 失敗したテストの詳細のみを出力
- 成功したテストの詳細リストは削除

**要求仕様**:
- 成功時の出力例:
  ```markdown
  ## テスト結果サマリー
  - 総テスト数: 120件
  - 成功: 120件
  - 失敗: 0件
  - 成功率: 100%
  ```
- 失敗時の出力例:
  ```markdown
  ## テスト結果サマリー
  - 総テスト数: 120件
  - 成功: 115件
  - 失敗: 5件
  - 成功率: 95.8%

  ## 失敗したテスト詳細
  - `tests/test_xxx.py::test_function1`: AssertionError: ...
  - `tests/test_xxx.py::test_function2`: ValueError: ...
  ```

**対象ファイル**: `src/prompts/testing/execute.txt`

### FR-4: Phase 7（Documentation）の出力フォーマット簡潔化【優先度: 高】

**詳細**:
- 「更新サマリー」テーブルフォーマットに置き換える
- 更新不要と判断したファイルのリストは省略
- 各ドキュメントの詳細な変更内容は省略

**現状（変更前）**:
```markdown
## 調査したドキュメント
（全ての.mdファイルをリストアップ）

## 更新したドキュメント
### `README.md`
**更新理由**: ...
**主な変更内容**:
- （変更点1）
- （変更点2）
```

**要求仕様（変更後）**:
```markdown
## 更新サマリー

| ファイル | 更新理由 |
|---------|---------|
| `README.md` | 新機能XXXの使用方法を追加 |
| `CLAUDE.md` | 環境変数YYYを追記 |
```

**対象ファイル**: `src/prompts/documentation/execute.txt`

### FR-5: Phase 8（Report）の出力フォーマット大幅簡潔化【優先度: 高】

**詳細**:
- エグゼクティブサマリーセクションを追加
- マージチェックリストセクションを簡潔化
- リスク・注意点セクションを簡潔化
- 詳細参照セクションを追加（@requirements.md、@design.md等へのリンク）
- 各フェーズの詳細再掲載セクションを削除

**現状（変更前）**: 全フェーズの内容を詳細に再掲載（非常に長い）

**要求仕様（変更後）**:
```markdown
# レポート

## エグゼクティブサマリー
- **実装内容**: （1-2文）
- **変更規模**: 新規X件、修正Y件
- **テスト結果**: 全Z件成功
- **マージ推奨**: ✅ / ⚠️ / ❌

## マージチェックリスト
- [ ] 要件充足
- [ ] テスト成功
- [ ] ドキュメント更新

## リスク・注意点
- （あれば記載）

## 詳細参照
各フェーズの詳細は以下を参照:
- 要件: @requirements.md
- 設計: @design.md
- 実装: @implementation.md
- テスト結果: @test-result.md
```

**対象ファイル**: `src/prompts/report/execute.txt`

### FR-6: Phase 0-2（Planning, Requirements, Design）は変更しない【優先度: 高】

**詳細**:
- 序盤フェーズ（Phase 0-2）は実装の要となるため、詳細を維持する
- 以下のプロンプトファイルは変更対象外:
  - `src/prompts/planning/execute.txt`
  - `src/prompts/requirements/execute.txt`
  - `src/prompts/design/execute.txt`

## 3. 非機能要件

### NFR-1: パフォーマンス要件

- **コンテキスト消費量**: Phase 8（Report）およびPhase 9（Evaluation）で、従来比30-50%のコンテキスト削減を達成すること
- **生成時間**: プロンプト修正により、ドキュメント生成時間に悪影響を与えないこと（±10%以内）

### NFR-2: 品質要件

- **情報損失の最小化**: LLMが後続フェーズで必要とする最低限の情報は保持すること
- **可読性**: 人間が読みやすい形式（テーブル、箇条書き）を採用すること
- **一貫性**: 簡潔化後も、各フェーズの品質ゲート（Planning Documentで定義）を維持すること

### NFR-3: 保守性要件

- **プロンプト規約準拠**: 既存のプロンプト規約（CLAUDE.md記載）に準拠すること
- **後方互換性**: プロンプト修正後も、既存のワークフローが動作すること（出力ファイル名は変更しない）

### NFR-4: セキュリティ要件

- **機密情報の保護**: プロンプト修正により、機密情報の漏洩リスクが増加しないこと

## 4. 制約事項

### 技術的制約

- **修正対象**: プロンプトファイル（`src/prompts/` 配下）のみ修正可能
- **実装コード**: `src/phases/` 配下のTypeScriptコードは変更不可
- **ビルドプロセス**: `npm run build` でプロンプトファイルが `dist/prompts/` にコピーされることを前提とする

### リソース制約

- **工数**: 8~12時間（Planning Documentの見積もり）
- **優先度**: 中程度（Issue #202のコンテキスト制限問題の解決が主目的）

### ポリシー制約

- **品質ゲート**: Planning Documentで定義された各フェーズの品質ゲートを維持すること
- **テスト**: プロンプト修正後、Phase 4-8を含むワークフローを実行し、動作確認すること

## 5. 前提条件

### システム環境

- Node.js 20以上
- npm 10以上
- TypeScriptビルド環境（`npm run build` が正常に動作すること）

### 依存コンポーネント

- Codex / Claude エージェント（プロンプト実行環境）
- GitHub API（Issue取得、コメント投稿）
- Git（コミット、プッシュ）

### 外部システム連携

- なし（プロンプトファイルの修正のみ）

## 6. 受け入れ基準

### AC-1: Phase 4（Implementation）プロンプト修正

**Given**: Phase 4のプロンプトファイル（`src/prompts/implementation/execute.txt`）が存在する
**When**: プロンプトを修正し、Phase 4を実行する
**Then**:
- 出力ファイル（`implementation.md`）に「変更ファイル一覧」テーブルが含まれる
- 「主要な変更点」セクションが3-5個の箇条書きで記載される
- 実装詳細セクション（ファイルごとの詳細説明）が削除される

### AC-2: Phase 5（Test Implementation）プロンプト修正

**Given**: Phase 5のプロンプトファイル（`src/prompts/test_implementation/execute.txt`）が存在する
**When**: プロンプトを修正し、Phase 5を実行する
**Then**:
- 出力ファイル（`test-implementation.md`）に「テストファイル一覧」テーブルが含まれる
- 「テストカバレッジ」セクションが数値サマリー形式で記載される
- テストケース詳細セクション（各テスト関数の詳細説明）が削除される

### AC-3: Phase 6（Testing）プロンプト修正

**Given**: Phase 6のプロンプトファイル（`src/prompts/testing/execute.txt`）が存在する
**When**: プロンプトを修正し、Phase 6を実行する（成功ケース）
**Then**:
- 出力ファイル（`test-result.md`）に「テスト結果サマリー」のみ記載される（総数、成功率）
- 成功したテストの詳細リストが削除される

**When**: プロンプトを修正し、Phase 6を実行する（失敗ケース）
**Then**:
- 出力ファイル（`test-result.md`）に「テスト結果サマリー」と「失敗したテスト詳細」が記載される
- 成功したテストの詳細リストが削除される

### AC-4: Phase 7（Documentation）プロンプト修正

**Given**: Phase 7のプロンプトファイル（`src/prompts/documentation/execute.txt`）が存在する
**When**: プロンプトを修正し、Phase 7を実行する
**Then**:
- 出力ファイル（`documentation.md`）に「更新サマリー」テーブルが含まれる
- 更新不要と判断したファイルのリストが削除される
- 各ドキュメントの詳細な変更内容が削除される

### AC-5: Phase 8（Report）プロンプト修正

**Given**: Phase 8のプロンプトファイル（`src/prompts/report/execute.txt`）が存在する
**When**: プロンプトを修正し、Phase 8を実行する
**Then**:
- 出力ファイル（`report.md`）にエグゼクティブサマリーセクションが含まれる
- マージチェックリストセクションが簡潔化される
- 詳細参照セクション（@requirements.md等へのリンク）が含まれる
- 各フェーズの詳細再掲載セクションが削除される

### AC-6: Phase 0-2は変更されない

**Given**: Phase 0-2のプロンプトファイルが存在する
**When**: 本Issue実装後、Phase 0-2を実行する
**Then**:
- Phase 0-2の出力フォーマットが変更前と同一である
- 詳細が維持される

### AC-7: ビルドテスト

**Given**: プロンプトファイルを修正した
**When**: `npm run build` を実行する
**Then**:
- ビルドが成功する
- `dist/prompts/` に修正後のプロンプトファイルがコピーされる

### AC-8: インテグレーションテスト

**Given**: プロンプトファイルを修正し、ビルドした
**When**: Phase 4-8を含むワークフロー（`--phase all` または `--preset implementation`）を実行する
**Then**:
- 全フェーズが成功する
- 簡潔化された出力ファイルが生成される
- Phase 8でコンテキスト制限エラーが発生しない

### AC-9: コンテキスト削減効果の検証

**Given**: 修正前後のPhase 8出力ファイル（`report.md`）が存在する
**When**: 文字数を比較する
**Then**:
- 修正後のファイルが修正前より30-50%削減されている

## 7. スコープ外

### 今回実装しない事項

- **Phase 9（Evaluation）**: 本Issueでは対象外（将来的に検討）
- **プロンプトファイル以外の修正**: `src/phases/` 配下のTypeScriptコードは修正しない
- **出力ファイル名の変更**: `implementation.md`、`test-result.md` 等のファイル名は変更しない
- **品質ゲートの変更**: 各フェーズの品質ゲート（`BasePhase.validateOutput()` のロジック）は変更しない

### 将来的な拡張候補

- **Phase 9（Evaluation）の簡潔化**: Phase 8同様、詳細参照方式を採用
- **動的な詳細度調整**: 環境変数やCLIオプションで詳細度を制御可能にする
- **テンプレートエンジンの導入**: プロンプトファイルのメンテナンス性向上

## 8. リスク評価と軽減策

### リスク1: 簡潔化しすぎて必要な情報が失われる

- **影響度**: 中
- **確率**: 低
- **軽減策**:
  - Phase 8で@references方式を採用し、詳細は個別フェーズのファイルを参照可能にする
  - 序盤フェーズ（Phase 0-2）は詳細を維持する
  - LLMが後続フェーズで必要とする最低限の情報は残す
  - Phase 6（Testing）は失敗時のみ詳細を記載する方針にする

### リスク2: 既存のワークフローが動作しなくなる

- **影響度**: 高
- **確率**: 非常に低
- **軽減策**:
  - プロンプトの出力フォーマット指示のみを変更し、実装コードは変更しない
  - 出力ファイル名は変更しない（`implementation.md`、`test-implementation.md`等）
  - テスト実行で動作確認を徹底する
  - Phase 8でビルドテストを追加し、プロンプトファイルが正しくコピーされることを確認

### リスク3: コンテキスト制限の問題（Issue #202）が解決されない

- **影響度**: 中
- **確率**: 低
- **軽減策**:
  - Phase 8で最も大幅に簡潔化（詳細再掲載を削除）
  - Phase 4-7でも重複情報を削減（テーブルフォーマット採用）
  - 成功時のテスト詳細リストを削除（Phase 6）
  - インテグレーションテストでコンテキスト消費量を検証

## 9. 関連Issue・依存関係

- **Issue #202**: コンテキスト制限の問題（本Issueで解決を試みる）
- **Planning Document**: `.ai-workflow/issue-207/00_planning/output/planning.md`（開発計画の詳細）

## 10. 参考情報

- **CLAUDE.md**: プロンプト規約、コーディングガイドライン
- **ARCHITECTURE.md**: BasePhase のライフサイクル、プロンプト管理
- **README.md**: フェーズ概要、出力ファイルの役割

---

**作成日**: 2025-01-30
**承認**: レビュー待ち
**ステータス**: 初回ドラフト
