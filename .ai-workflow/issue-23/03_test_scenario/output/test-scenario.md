# ãƒ†ã‚¹ãƒˆã‚·ãƒŠãƒªã‚ª - Issue #23: BasePhase ã‚¢ãƒ¼ã‚­ãƒ†ã‚¯ãƒãƒ£ã®åˆ†å‰²

## 0. ãƒ†ã‚¹ãƒˆæˆ¦ç•¥ã‚µãƒãƒªãƒ¼

### é¸æŠã•ã‚ŒãŸãƒ†ã‚¹ãƒˆæˆ¦ç•¥
**UNIT_INTEGRATION** (Phase 2ã§æ±ºå®š)

### ãƒ†ã‚¹ãƒˆå¯¾è±¡ã®ç¯„å›²
1. **Unitãƒ†ã‚¹ãƒˆ**: æ–°è¦ä½œæˆã•ã‚Œã‚‹4ã¤ã®ãƒ¢ã‚¸ãƒ¥ãƒ¼ãƒ«ã®å˜ä½“å‹•ä½œæ¤œè¨¼
   - `LogFormatter` - ã‚¨ãƒ¼ã‚¸ã‚§ãƒ³ãƒˆãƒ­ã‚°ã®ãƒ•ã‚©ãƒ¼ãƒãƒƒãƒˆå¤‰æ›
   - `ProgressFormatter` - é€²æ—è¡¨ç¤ºãƒ•ã‚©ãƒ¼ãƒãƒƒãƒˆ
   - `AgentExecutor` - ã‚¨ãƒ¼ã‚¸ã‚§ãƒ³ãƒˆå®Ÿè¡Œãƒ­ã‚¸ãƒƒã‚¯
   - `ReviewCycleManager` - ãƒ¬ãƒ“ãƒ¥ãƒ¼ã‚µã‚¤ã‚¯ãƒ«ç®¡ç†

2. **Integrationãƒ†ã‚¹ãƒˆ**: BasePhaseã¨å„ãƒ¢ã‚¸ãƒ¥ãƒ¼ãƒ«ã®é€£æºå‹•ä½œæ¤œè¨¼
   - å…¨ãƒ•ã‚§ãƒ¼ã‚ºå®Ÿè¡Œãƒ†ã‚¹ãƒˆï¼ˆã‚¨ãƒ³ãƒ‰ãƒ„ãƒ¼ã‚¨ãƒ³ãƒ‰ï¼‰
   - ãƒ¬ãƒ“ãƒ¥ãƒ¼ã‚µã‚¤ã‚¯ãƒ«å‹•ä½œç¢ºèª
   - Git ã‚³ãƒŸãƒƒãƒˆï¼†ãƒ—ãƒƒã‚·ãƒ¥é€£æºç¢ºèª
   - ã‚¨ãƒ¼ã‚¸ã‚§ãƒ³ãƒˆãƒ­ã‚°ãƒ•ã‚©ãƒ¼ãƒãƒƒãƒˆç¶­æŒç¢ºèª

### ãƒ†ã‚¹ãƒˆã®ç›®çš„
1. **ãƒªã‚°ãƒ¬ãƒƒã‚·ãƒ§ãƒ³ã‚¼ãƒ­**: æ—¢å­˜ã®ãƒ•ã‚§ãƒ¼ã‚ºå®Ÿè¡Œå‹•ä½œã«å½±éŸ¿ãŒãªã„ã“ã¨ã‚’ç¢ºèª
2. **ãƒ¢ã‚¸ãƒ¥ãƒ¼ãƒ«ã®æ­£ç¢ºæ€§**: å„ãƒ¢ã‚¸ãƒ¥ãƒ¼ãƒ«ãŒè²¬å‹™ã‚’æ­£ã—ãæœãŸã™ã“ã¨ã‚’ç¢ºèª
3. **è¡Œæ•°å‰Šæ¸›ã®é”æˆ**: base-phase.ts ãŒ300è¡Œä»¥ä¸‹ã«å‰Šæ¸›ã•ã‚Œã¦ã„ã‚‹ã“ã¨ã‚’ç¢ºèª
4. **ä¿å®ˆæ€§ã®å‘ä¸Š**: å„ãƒ¢ã‚¸ãƒ¥ãƒ¼ãƒ«ãŒå˜ä¸€ã®è²¬å‹™ã‚’æŒã¡ã€ã‚³ãƒ¼ãƒ‰ã®è¦‹é€šã—ãŒè‰¯ã„ã“ã¨ã‚’ç¢ºèª

### ãƒ†ã‚¹ãƒˆã‚«ãƒãƒ¬ãƒƒã‚¸ç›®æ¨™
- **ãƒ¦ãƒ‹ãƒƒãƒˆãƒ†ã‚¹ãƒˆ**: 80%ä»¥ä¸Š
- **çµ±åˆãƒ†ã‚¹ãƒˆ**: æ—¢å­˜ãƒ†ã‚¹ãƒˆï¼ˆ`tests/integration/preset-execution.test.ts` ç­‰ï¼‰ãŒ100%ãƒ‘ã‚¹

---

## 1. Unitãƒ†ã‚¹ãƒˆã‚·ãƒŠãƒªã‚ª

### 1.1 LogFormatter ãƒ¢ã‚¸ãƒ¥ãƒ¼ãƒ«

#### ãƒ†ã‚¹ãƒˆãƒ•ã‚¡ã‚¤ãƒ«
`tests/unit/phases/formatters/log-formatter.test.ts`

---

#### ãƒ†ã‚¹ãƒˆã‚±ãƒ¼ã‚¹ 1-1: formatAgentLog_Claude_æ­£å¸¸ç³»

**ç›®çš„**: Claude ã‚¨ãƒ¼ã‚¸ã‚§ãƒ³ãƒˆã®ç”Ÿãƒ­ã‚°ãŒæ­£ã—ã Markdown ã«å¤‰æ›ã•ã‚Œã‚‹ã“ã¨ã‚’æ¤œè¨¼

**å‰ææ¡ä»¶**:
- LogFormatter ã‚¤ãƒ³ã‚¹ã‚¿ãƒ³ã‚¹ãŒç”Ÿæˆã•ã‚Œã¦ã„ã‚‹

**å…¥åŠ›**:
```typescript
messages = [
  '{"type": "turn_start", "turn_number": 1}',
  '{"type": "tool_use", "tool": "Read", "path": "/path/to/file.ts"}',
  '{"type": "turn_complete", "turn_number": 1}'
]
startTime = 1706000000000  // 2024-01-23 12:00:00
endTime = 1706000120000    // 2024-01-23 12:02:00
duration = 120000          // 2åˆ†
error = null
agentName = 'Claude Agent'
```

**æœŸå¾…çµæœ**:
- Markdown å½¢å¼ã®ãƒ­ã‚°ãŒè¿”ã•ã‚Œã‚‹
- ä»¥ä¸‹ã®æƒ…å ±ãŒå«ã¾ã‚Œã‚‹:
  - ã‚¨ãƒ¼ã‚¸ã‚§ãƒ³ãƒˆå: "Claude Agent"
  - å®Ÿè¡Œæ™‚é–“: "2åˆ†0ç§’"
  - é–‹å§‹æ™‚åˆ»: "2024-01-23 12:00:00"
  - çµ‚äº†æ™‚åˆ»: "2024-01-23 12:02:00"
  - ã‚¿ãƒ¼ãƒ³ã”ã¨ã®å†…è¨³ï¼ˆturn_startã€tool_useã€turn_completeï¼‰
- ã‚¨ãƒ©ãƒ¼æƒ…å ±ã¯å«ã¾ã‚Œãªã„

**ãƒ†ã‚¹ãƒˆãƒ‡ãƒ¼ã‚¿**: ä¸Šè¨˜ messages

---

#### ãƒ†ã‚¹ãƒˆã‚±ãƒ¼ã‚¹ 1-2: formatCodexAgentLog_æ­£å¸¸ç³»

**ç›®çš„**: Codex ã‚¨ãƒ¼ã‚¸ã‚§ãƒ³ãƒˆã® JSON ã‚¤ãƒ™ãƒ³ãƒˆã‚¹ãƒˆãƒªãƒ¼ãƒ ãŒæ­£ã—ã Markdown ã«å¤‰æ›ã•ã‚Œã‚‹ã“ã¨ã‚’æ¤œè¨¼

**å‰ææ¡ä»¶**:
- LogFormatter ã‚¤ãƒ³ã‚¹ã‚¿ãƒ³ã‚¹ãŒç”Ÿæˆã•ã‚Œã¦ã„ã‚‹

**å…¥åŠ›**:
```typescript
messages = [
  '{"type": "thread.started", "thread_id": "thread_123"}',
  '{"type": "item.started", "item": {"type": "tool_use", "name": "Glob"}}',
  '{"type": "item.output", "output": "matched 5 files"}',
  '{"type": "item.completed", "item": {"type": "tool_use", "name": "Glob"}}',
  '{"type": "response.completed", "usage": {"input_tokens": 100, "output_tokens": 50, "total_cost_usd": 0.005}}'
]
startTime = 1706000000000
endTime = 1706000060000
duration = 60000  // 1åˆ†
error = null
```

**æœŸå¾…çµæœ**:
- Markdown å½¢å¼ã®ãƒ­ã‚°ãŒè¿”ã•ã‚Œã‚‹
- ä»¥ä¸‹ã®æƒ…å ±ãŒå«ã¾ã‚Œã‚‹:
  - ã‚¨ãƒ¼ã‚¸ã‚§ãƒ³ãƒˆå: "Codex Agent"
  - å®Ÿè¡Œæ™‚é–“: "1åˆ†0ç§’"
  - ã‚¿ãƒ¼ãƒ³1ã®å†…è¨³:
    - ã‚¹ãƒ¬ãƒƒãƒ‰é–‹å§‹ (thread_id: thread_123)
    - ãƒ„ãƒ¼ãƒ«å®Ÿè¡Œ: Glob
    - å‡ºåŠ›: "matched 5 files"
    - ãƒ„ãƒ¼ãƒ«å®Œäº†
  - åˆ©ç”¨é‡: input_tokens=100, output_tokens=50, total_cost_usd=0.005

**ãƒ†ã‚¹ãƒˆãƒ‡ãƒ¼ã‚¿**: ä¸Šè¨˜ messages

---

#### ãƒ†ã‚¹ãƒˆã‚±ãƒ¼ã‚¹ 1-3: formatCodexAgentLog_4000æ–‡å­—è¶…é_åˆ‡ã‚Šè©°ã‚

**ç›®çš„**: 4000æ–‡å­—ã‚’è¶…ãˆã‚‹å‡ºåŠ›ãŒæ­£ã—ãåˆ‡ã‚Šè©°ã‚ã‚‰ã‚Œã‚‹ã“ã¨ã‚’æ¤œè¨¼

**å‰ææ¡ä»¶**:
- LogFormatter ã‚¤ãƒ³ã‚¹ã‚¿ãƒ³ã‚¹ãŒç”Ÿæˆã•ã‚Œã¦ã„ã‚‹

**å…¥åŠ›**:
```typescript
messages = [
  '{"type": "item.output", "output": "' + 'a'.repeat(5000) + '"}'
]
startTime = 1706000000000
endTime = 1706000060000
duration = 60000
error = null
```

**æœŸå¾…çµæœ**:
- Markdown å½¢å¼ã®ãƒ­ã‚°ãŒè¿”ã•ã‚Œã‚‹
- å‡ºåŠ›ãŒ4000æ–‡å­—ã«åˆ‡ã‚Šè©°ã‚ã‚‰ã‚Œã¦ã„ã‚‹
- "...(truncated)" ã®ã‚ˆã†ãªè¡¨ç¤ºãŒå«ã¾ã‚Œã‚‹

**ãƒ†ã‚¹ãƒˆãƒ‡ãƒ¼ã‚¿**: ä¸Šè¨˜ messages

---

#### ãƒ†ã‚¹ãƒˆã‚±ãƒ¼ã‚¹ 1-4: formatAgentLog_ã‚¨ãƒ©ãƒ¼ç™ºç”Ÿæ™‚

**ç›®çš„**: ã‚¨ãƒ¼ã‚¸ã‚§ãƒ³ãƒˆå®Ÿè¡Œä¸­ã®ã‚¨ãƒ©ãƒ¼ãŒæ­£ã—ããƒ­ã‚°ã«å«ã¾ã‚Œã‚‹ã“ã¨ã‚’æ¤œè¨¼

**å‰ææ¡ä»¶**:
- LogFormatter ã‚¤ãƒ³ã‚¹ã‚¿ãƒ³ã‚¹ãŒç”Ÿæˆã•ã‚Œã¦ã„ã‚‹

**å…¥åŠ›**:
```typescript
messages = []
startTime = 1706000000000
endTime = 1706000060000
duration = 60000
error = new Error('Authentication failed: invalid bearer token')
agentName = 'Codex Agent'
```

**æœŸå¾…çµæœ**:
- Markdown å½¢å¼ã®ãƒ­ã‚°ãŒè¿”ã•ã‚Œã‚‹
- ã‚¨ãƒ©ãƒ¼æƒ…å ±ãŒå«ã¾ã‚Œã‚‹:
  - ã‚¨ãƒ©ãƒ¼ãƒ¡ãƒƒã‚»ãƒ¼ã‚¸: "Authentication failed: invalid bearer token"
  - ã‚¨ãƒ©ãƒ¼ã‚»ã‚¯ã‚·ãƒ§ãƒ³ãŒæ˜ç¤ºçš„ã«è¡¨ç¤ºã•ã‚Œã‚‹

**ãƒ†ã‚¹ãƒˆãƒ‡ãƒ¼ã‚¿**: ä¸Šè¨˜ error

---

#### ãƒ†ã‚¹ãƒˆã‚±ãƒ¼ã‚¹ 1-5: formatCodexAgentLog_JSONè§£æå¤±æ•—

**ç›®çš„**: ä¸æ­£ãª JSON ãŒæ¸¡ã•ã‚ŒãŸå ´åˆã« null ãŒè¿”ã•ã‚Œã‚‹ã“ã¨ã‚’æ¤œè¨¼

**å‰ææ¡ä»¶**:
- LogFormatter ã‚¤ãƒ³ã‚¹ã‚¿ãƒ³ã‚¹ãŒç”Ÿæˆã•ã‚Œã¦ã„ã‚‹

**å…¥åŠ›**:
```typescript
messages = [
  'invalid json {{{',
  '{"type": "thread.started"}'
]
startTime = 1706000000000
endTime = 1706000060000
duration = 60000
error = null
```

**æœŸå¾…çµæœ**:
- `null` ãŒè¿”ã•ã‚Œã‚‹ï¼ˆJSON è§£æå¤±æ•—ï¼‰

**ãƒ†ã‚¹ãƒˆãƒ‡ãƒ¼ã‚¿**: ä¸Šè¨˜ messages

---

### 1.2 ProgressFormatter ãƒ¢ã‚¸ãƒ¥ãƒ¼ãƒ«

#### ãƒ†ã‚¹ãƒˆãƒ•ã‚¡ã‚¤ãƒ«
`tests/unit/phases/formatters/progress-formatter.test.ts`

---

#### ãƒ†ã‚¹ãƒˆã‚±ãƒ¼ã‚¹ 2-1: formatProgressComment_in_progress_æ­£å¸¸ç³»

**ç›®çš„**: é€²è¡Œä¸­ãƒ•ã‚§ãƒ¼ã‚ºã®é€²æ—ã‚³ãƒ¡ãƒ³ãƒˆãŒæ­£ã—ããƒ•ã‚©ãƒ¼ãƒãƒƒãƒˆã•ã‚Œã‚‹ã“ã¨ã‚’æ¤œè¨¼

**å‰ææ¡ä»¶**:
- ProgressFormatter ã‚¤ãƒ³ã‚¹ã‚¿ãƒ³ã‚¹ãŒç”Ÿæˆã•ã‚Œã¦ã„ã‚‹
- ãƒ¢ãƒƒã‚¯ã•ã‚ŒãŸ MetadataManager ãŒå­˜åœ¨ã™ã‚‹
  - planning: completed
  - requirements: in_progress (retry_count=1)
  - design: pending

**å…¥åŠ›**:
```typescript
currentPhase = 'requirements'
status = 'in_progress'
metadata = mockMetadataManager
details = 'Analyzing existing code...'
```

**æœŸå¾…çµæœ**:
- Markdown å½¢å¼ã®é€²æ—ã‚³ãƒ¡ãƒ³ãƒˆãŒè¿”ã•ã‚Œã‚‹
- ä»¥ä¸‹ã®æƒ…å ±ãŒå«ã¾ã‚Œã‚‹:
  - ãƒ•ã‚§ãƒ¼ã‚ºã‚¹ãƒ†ãƒ¼ã‚¿ã‚¹ä¸€è¦§:
    - âœ… Phase 0: Planning (å®Œäº†æ™‚åˆ»)
    - ğŸ”„ Phase 1: Requirements (é–‹å§‹æ™‚åˆ»)
    - â¸ï¸ Phase 2: Design
  - ç¾åœ¨ã®ãƒ•ã‚§ãƒ¼ã‚ºè©³ç´°:
    - ãƒ•ã‚§ãƒ¼ã‚ºå: Requirements
    - ã‚¹ãƒ†ãƒ¼ã‚¿ã‚¹: in_progress
    - è©¦è¡Œå›æ•°: 1å›ç›®
    - è©³ç´°: "Analyzing existing code..."
  - æœ€çµ‚æ›´æ–°æ™‚åˆ»

**ãƒ†ã‚¹ãƒˆãƒ‡ãƒ¼ã‚¿**: ãƒ¢ãƒƒã‚¯ã•ã‚ŒãŸ MetadataManager

---

#### ãƒ†ã‚¹ãƒˆã‚±ãƒ¼ã‚¹ 2-2: formatProgressComment_completed_æ­£å¸¸ç³»

**ç›®çš„**: å®Œäº†ãƒ•ã‚§ãƒ¼ã‚ºã®é€²æ—ã‚³ãƒ¡ãƒ³ãƒˆãŒæ­£ã—ããƒ•ã‚©ãƒ¼ãƒãƒƒãƒˆã•ã‚Œã‚‹ã“ã¨ã‚’æ¤œè¨¼

**å‰ææ¡ä»¶**:
- ProgressFormatter ã‚¤ãƒ³ã‚¹ã‚¿ãƒ³ã‚¹ãŒç”Ÿæˆã•ã‚Œã¦ã„ã‚‹
- ãƒ¢ãƒƒã‚¯ã•ã‚ŒãŸ MetadataManager ãŒå­˜åœ¨ã™ã‚‹
  - planning: completed
  - requirements: completed
  - design: in_progress

**å…¥åŠ›**:
```typescript
currentPhase = 'design'
status = 'in_progress'
metadata = mockMetadataManager
details = undefined
```

**æœŸå¾…çµæœ**:
- Markdown å½¢å¼ã®é€²æ—ã‚³ãƒ¡ãƒ³ãƒˆãŒè¿”ã•ã‚Œã‚‹
- å®Œäº†ã—ãŸãƒ•ã‚§ãƒ¼ã‚ºï¼ˆplanningã€requirementsï¼‰ã®è©³ç´°ãŒæŠ˜ã‚ŠãŸãŸã¿è¡¨ç¤ºï¼ˆ`<details>`ï¼‰ã§å«ã¾ã‚Œã‚‹
- ãƒ¬ãƒ“ãƒ¥ãƒ¼çµæœã€å®Œäº†æ™‚åˆ»ãŒè¡¨ç¤ºã•ã‚Œã‚‹

**ãƒ†ã‚¹ãƒˆãƒ‡ãƒ¼ã‚¿**: ãƒ¢ãƒƒã‚¯ã•ã‚ŒãŸ MetadataManager

---

#### ãƒ†ã‚¹ãƒˆã‚±ãƒ¼ã‚¹ 2-3: formatProgressComment_failed_ç•°å¸¸ç³»

**ç›®çš„**: å¤±æ•—ãƒ•ã‚§ãƒ¼ã‚ºã®é€²æ—ã‚³ãƒ¡ãƒ³ãƒˆãŒæ­£ã—ããƒ•ã‚©ãƒ¼ãƒãƒƒãƒˆã•ã‚Œã‚‹ã“ã¨ã‚’æ¤œè¨¼

**å‰ææ¡ä»¶**:
- ProgressFormatter ã‚¤ãƒ³ã‚¹ã‚¿ãƒ³ã‚¹ãŒç”Ÿæˆã•ã‚Œã¦ã„ã‚‹
- ãƒ¢ãƒƒã‚¯ã•ã‚ŒãŸ MetadataManager ãŒå­˜åœ¨ã™ã‚‹
  - planning: completed
  - requirements: failed (retry_count=3)

**å…¥åŠ›**:
```typescript
currentPhase = 'requirements'
status = 'failed'
metadata = mockMetadataManager
details = 'Max retries reached'
```

**æœŸå¾…çµæœ**:
- Markdown å½¢å¼ã®é€²æ—ã‚³ãƒ¡ãƒ³ãƒˆãŒè¿”ã•ã‚Œã‚‹
- ãƒ•ã‚§ãƒ¼ã‚ºã‚¹ãƒ†ãƒ¼ã‚¿ã‚¹ä¸€è¦§ã« âŒ ãŒè¡¨ç¤ºã•ã‚Œã‚‹
- è©³ç´°ã« "Max retries reached" ãŒå«ã¾ã‚Œã‚‹
- è©¦è¡Œå›æ•°ãŒ "3å›ç›®" ã¨è¡¨ç¤ºã•ã‚Œã‚‹

**ãƒ†ã‚¹ãƒˆãƒ‡ãƒ¼ã‚¿**: ãƒ¢ãƒƒã‚¯ã•ã‚ŒãŸ MetadataManager

---

#### ãƒ†ã‚¹ãƒˆã‚±ãƒ¼ã‚¹ 2-4: formatProgressComment_çµµæ–‡å­—ãƒãƒƒãƒ”ãƒ³ã‚°

**ç›®çš„**: å„ã‚¹ãƒ†ãƒ¼ã‚¿ã‚¹ã«å¯¾å¿œã™ã‚‹çµµæ–‡å­—ãŒæ­£ã—ãè¡¨ç¤ºã•ã‚Œã‚‹ã“ã¨ã‚’æ¤œè¨¼

**å‰ææ¡ä»¶**:
- ProgressFormatter ã‚¤ãƒ³ã‚¹ã‚¿ãƒ³ã‚¹ãŒç”Ÿæˆã•ã‚Œã¦ã„ã‚‹

**å…¥åŠ›**:
```typescript
å„ã‚¹ãƒ†ãƒ¼ã‚¿ã‚¹ï¼ˆpending, in_progress, completed, failedï¼‰ã«å¯¾ã—ã¦å®Ÿè¡Œ
```

**æœŸå¾…çµæœ**:
- pending â†’ â¸ï¸
- in_progress â†’ ğŸ”„
- completed â†’ âœ…
- failed â†’ âŒ

**ãƒ†ã‚¹ãƒˆãƒ‡ãƒ¼ã‚¿**: å„ã‚¹ãƒ†ãƒ¼ã‚¿ã‚¹ã®ãƒ¢ãƒƒã‚¯ MetadataManager

---

### 1.3 AgentExecutor ãƒ¢ã‚¸ãƒ¥ãƒ¼ãƒ«

#### ãƒ†ã‚¹ãƒˆãƒ•ã‚¡ã‚¤ãƒ«
`tests/unit/phases/core/agent-executor.test.ts`

---

#### ãƒ†ã‚¹ãƒˆã‚±ãƒ¼ã‚¹ 3-1: executeWithAgent_Codex_æ­£å¸¸ç³»

**ç›®çš„**: Codex ã‚¨ãƒ¼ã‚¸ã‚§ãƒ³ãƒˆãŒæ­£å¸¸ã«å®Ÿè¡Œã•ã‚Œã‚‹ã“ã¨ã‚’æ¤œè¨¼

**å‰ææ¡ä»¶**:
- AgentExecutor ã‚¤ãƒ³ã‚¹ã‚¿ãƒ³ã‚¹ãŒç”Ÿæˆã•ã‚Œã¦ã„ã‚‹ï¼ˆCodex ã‚ã‚Šã€Claude ãªã—ï¼‰
- ãƒ¢ãƒƒã‚¯ã•ã‚ŒãŸ CodexAgentClient ãŒå­˜åœ¨ã™ã‚‹
  - `executeTask()` ã¯æˆåŠŸã‚’è¿”ã™ï¼ˆmessages=['{"type": "response.completed"}']ï¼‰

**å…¥åŠ›**:
```typescript
prompt = 'Analyze the codebase'
options = { maxTurns: 10, verbose: true }
```

**æœŸå¾…çµæœ**:
- `executeTask()` ãŒ1å›å‘¼ã³å‡ºã•ã‚Œã‚‹
- è¿”ã‚Šå€¤ãŒ messages é…åˆ—ã§ã‚ã‚‹
- ãƒ—ãƒ­ãƒ³ãƒ—ãƒˆãƒ•ã‚¡ã‚¤ãƒ«ï¼ˆ`prompt.txt`ï¼‰ãŒä¿å­˜ã•ã‚Œã‚‹
- ç”Ÿãƒ­ã‚°ï¼ˆ`agent_log_raw.txt`ï¼‰ãŒä¿å­˜ã•ã‚Œã‚‹
- ãƒ•ã‚©ãƒ¼ãƒãƒƒãƒˆæ¸ˆã¿ãƒ­ã‚°ï¼ˆ`agent_log.md`ï¼‰ãŒä¿å­˜ã•ã‚Œã‚‹
- åˆ©ç”¨é‡ãƒ¡ãƒˆãƒªã‚¯ã‚¹ãŒè¨˜éŒ²ã•ã‚Œã‚‹ï¼ˆ`metadata.addCost()` ãŒå‘¼ã³å‡ºã•ã‚Œã‚‹ï¼‰

**ãƒ†ã‚¹ãƒˆãƒ‡ãƒ¼ã‚¿**: ãƒ¢ãƒƒã‚¯ã•ã‚ŒãŸ CodexAgentClient

---

#### ãƒ†ã‚¹ãƒˆã‚±ãƒ¼ã‚¹ 3-2: executeWithAgent_èªè¨¼ã‚¨ãƒ©ãƒ¼_ãƒ•ã‚©ãƒ¼ãƒ«ãƒãƒƒã‚¯

**ç›®çš„**: Codex ã®èªè¨¼ã‚¨ãƒ©ãƒ¼æ™‚ã« Claude ã¸ãƒ•ã‚©ãƒ¼ãƒ«ãƒãƒƒã‚¯ã™ã‚‹ã“ã¨ã‚’æ¤œè¨¼

**å‰ææ¡ä»¶**:
- AgentExecutor ã‚¤ãƒ³ã‚¹ã‚¿ãƒ³ã‚¹ãŒç”Ÿæˆã•ã‚Œã¦ã„ã‚‹ï¼ˆCodex ã‚ã‚Šã€Claude ã‚ã‚Šï¼‰
- ãƒ¢ãƒƒã‚¯ã•ã‚ŒãŸ CodexAgentClient ãŒå­˜åœ¨ã™ã‚‹
  - `executeTask()` ã¯èªè¨¼ã‚¨ãƒ©ãƒ¼ã‚’ã‚¹ãƒ­ãƒ¼ï¼ˆ"invalid bearer token"ï¼‰
- ãƒ¢ãƒƒã‚¯ã•ã‚ŒãŸ ClaudeAgentClient ãŒå­˜åœ¨ã™ã‚‹
  - `executeTask()` ã¯æˆåŠŸã‚’è¿”ã™

**å…¥åŠ›**:
```typescript
prompt = 'Analyze the codebase'
options = { maxTurns: 10 }
```

**æœŸå¾…çµæœ**:
- Codex ã® `executeTask()` ãŒ1å›å‘¼ã³å‡ºã•ã‚Œã‚‹ï¼ˆå¤±æ•—ï¼‰
- Claude ã® `executeTask()` ãŒ1å›å‘¼ã³å‡ºã•ã‚Œã‚‹ï¼ˆæˆåŠŸï¼‰
- ãƒ•ã‚©ãƒ¼ãƒ«ãƒãƒƒã‚¯ãƒ¡ãƒƒã‚»ãƒ¼ã‚¸ãŒãƒ­ã‚°ã«è¨˜éŒ²ã•ã‚Œã‚‹
- è¿”ã‚Šå€¤ãŒ Claude ã‹ã‚‰ã® messages é…åˆ—ã§ã‚ã‚‹

**ãƒ†ã‚¹ãƒˆãƒ‡ãƒ¼ã‚¿**: ãƒ¢ãƒƒã‚¯ã•ã‚ŒãŸ CodexAgentClientï¼ˆã‚¨ãƒ©ãƒ¼ï¼‰ã€ClaudeAgentClientï¼ˆæˆåŠŸï¼‰

---

#### ãƒ†ã‚¹ãƒˆã‚±ãƒ¼ã‚¹ 3-3: executeWithAgent_ç©ºå‡ºåŠ›_ãƒ•ã‚©ãƒ¼ãƒ«ãƒãƒƒã‚¯

**ç›®çš„**: ãƒ—ãƒ©ã‚¤ãƒãƒªã‚¨ãƒ¼ã‚¸ã‚§ãƒ³ãƒˆãŒç©ºå‡ºåŠ›ã‚’è¿”ã—ãŸå ´åˆã«ä»£æ›¿ã‚¨ãƒ¼ã‚¸ã‚§ãƒ³ãƒˆã¸ãƒ•ã‚©ãƒ¼ãƒ«ãƒãƒƒã‚¯ã™ã‚‹ã“ã¨ã‚’æ¤œè¨¼

**å‰ææ¡ä»¶**:
- AgentExecutor ã‚¤ãƒ³ã‚¹ã‚¿ãƒ³ã‚¹ãŒç”Ÿæˆã•ã‚Œã¦ã„ã‚‹ï¼ˆClaude ã‚ã‚Šã€Codex ã‚ã‚Šï¼‰
- ãƒ¢ãƒƒã‚¯ã•ã‚ŒãŸ ClaudeAgentClient ãŒå­˜åœ¨ã™ã‚‹
  - `executeTask()` ã¯ç©ºé…åˆ—ã‚’è¿”ã™ï¼ˆmessages=[]ï¼‰
- ãƒ¢ãƒƒã‚¯ã•ã‚ŒãŸ CodexAgentClient ãŒå­˜åœ¨ã™ã‚‹
  - `executeTask()` ã¯æˆåŠŸã‚’è¿”ã™

**å…¥åŠ›**:
```typescript
prompt = 'Analyze the codebase'
options = { maxTurns: 10 }
```

**æœŸå¾…çµæœ**:
- Claude ã® `executeTask()` ãŒ1å›å‘¼ã³å‡ºã•ã‚Œã‚‹ï¼ˆç©ºå‡ºåŠ›ï¼‰
- Codex ã® `executeTask()` ãŒ1å›å‘¼ã³å‡ºã•ã‚Œã‚‹ï¼ˆæˆåŠŸï¼‰
- ãƒ•ã‚©ãƒ¼ãƒ«ãƒãƒƒã‚¯ãƒ¡ãƒƒã‚»ãƒ¼ã‚¸ãŒãƒ­ã‚°ã«è¨˜éŒ²ã•ã‚Œã‚‹
- è¿”ã‚Šå€¤ãŒ Codex ã‹ã‚‰ã® messages é…åˆ—ã§ã‚ã‚‹

**ãƒ†ã‚¹ãƒˆãƒ‡ãƒ¼ã‚¿**: ãƒ¢ãƒƒã‚¯ã•ã‚ŒãŸ ClaudeAgentClientï¼ˆç©ºå‡ºåŠ›ï¼‰ã€CodexAgentClientï¼ˆæˆåŠŸï¼‰

---

#### ãƒ†ã‚¹ãƒˆã‚±ãƒ¼ã‚¹ 3-4: extractUsageMetrics_JSONè§£æ_æ­£å¸¸ç³»

**ç›®çš„**: JSON ãƒ¡ãƒƒã‚»ãƒ¼ã‚¸ã‹ã‚‰åˆ©ç”¨é‡ãƒ¡ãƒˆãƒªã‚¯ã‚¹ãŒæ­£ã—ãæŠ½å‡ºã•ã‚Œã‚‹ã“ã¨ã‚’æ¤œè¨¼

**å‰ææ¡ä»¶**:
- AgentExecutor ã‚¤ãƒ³ã‚¹ã‚¿ãƒ³ã‚¹ãŒç”Ÿæˆã•ã‚Œã¦ã„ã‚‹

**å…¥åŠ›**:
```typescript
messages = [
  '{"type": "other"}',
  '{"type": "response.completed", "usage": {"input_tokens": 1000, "output_tokens": 500, "total_cost_usd": 0.05}}'
]
```

**æœŸå¾…çµæœ**:
- åˆ©ç”¨é‡ãƒ¡ãƒˆãƒªã‚¯ã‚¹ãŒæ­£ã—ãæŠ½å‡ºã•ã‚Œã‚‹:
  - inputTokens: 1000
  - outputTokens: 500
  - totalCostUsd: 0.05
- `getLastExecutionMetrics()` ã§å–å¾—å¯èƒ½

**ãƒ†ã‚¹ãƒˆãƒ‡ãƒ¼ã‚¿**: ä¸Šè¨˜ messages

---

#### ãƒ†ã‚¹ãƒˆã‚±ãƒ¼ã‚¹ 3-5: extractUsageMetrics_æ­£è¦è¡¨ç¾ãƒ•ã‚©ãƒ¼ãƒ«ãƒãƒƒã‚¯

**ç›®çš„**: JSON è§£æå¤±æ•—æ™‚ã«æ­£è¦è¡¨ç¾ã§åˆ©ç”¨é‡ãƒ¡ãƒˆãƒªã‚¯ã‚¹ãŒæŠ½å‡ºã•ã‚Œã‚‹ã“ã¨ã‚’æ¤œè¨¼

**å‰ææ¡ä»¶**:
- AgentExecutor ã‚¤ãƒ³ã‚¹ã‚¿ãƒ³ã‚¹ãŒç”Ÿæˆã•ã‚Œã¦ã„ã‚‹

**å…¥åŠ›**:
```typescript
messages = [
  'Input tokens: 1200\nOutput tokens: 600\nTotal cost: $0.06'
]
```

**æœŸå¾…çµæœ**:
- æ­£è¦è¡¨ç¾ã§åˆ©ç”¨é‡ãƒ¡ãƒˆãƒªã‚¯ã‚¹ãŒæŠ½å‡ºã•ã‚Œã‚‹:
  - inputTokens: 1200
  - outputTokens: 600
  - totalCostUsd: 0.06

**ãƒ†ã‚¹ãƒˆãƒ‡ãƒ¼ã‚¿**: ä¸Šè¨˜ messages

---

#### ãƒ†ã‚¹ãƒˆã‚±ãƒ¼ã‚¹ 3-6: recordUsageMetrics_ãƒ¡ã‚¿ãƒ‡ãƒ¼ã‚¿è¨˜éŒ²

**ç›®çš„**: åˆ©ç”¨é‡ãƒ¡ãƒˆãƒªã‚¯ã‚¹ãŒãƒ¡ã‚¿ãƒ‡ãƒ¼ã‚¿ã«æ­£ã—ãè¨˜éŒ²ã•ã‚Œã‚‹ã“ã¨ã‚’æ¤œè¨¼

**å‰ææ¡ä»¶**:
- AgentExecutor ã‚¤ãƒ³ã‚¹ã‚¿ãƒ³ã‚¹ãŒç”Ÿæˆã•ã‚Œã¦ã„ã‚‹
- ãƒ¢ãƒƒã‚¯ã•ã‚ŒãŸ MetadataManager ãŒå­˜åœ¨ã™ã‚‹

**å…¥åŠ›**:
```typescript
metrics = {
  inputTokens: 1000,
  outputTokens: 500,
  totalCostUsd: 0.05
}
```

**æœŸå¾…çµæœ**:
- `metadata.addCost()` ãŒ1å›å‘¼ã³å‡ºã•ã‚Œã‚‹
- å‘¼ã³å‡ºã—å¼•æ•°ãŒä»¥ä¸‹ã¨ä¸€è‡´:
  - inputTokens: 1000
  - outputTokens: 500
  - totalCostUsd: 0.05

**ãƒ†ã‚¹ãƒˆãƒ‡ãƒ¼ã‚¿**: ä¸Šè¨˜ metrics

---

### 1.4 ReviewCycleManager ãƒ¢ã‚¸ãƒ¥ãƒ¼ãƒ«

#### ãƒ†ã‚¹ãƒˆãƒ•ã‚¡ã‚¤ãƒ«
`tests/unit/phases/core/review-cycle-manager.test.ts`

---

#### ãƒ†ã‚¹ãƒˆã‚±ãƒ¼ã‚¹ 4-1: performReviseStepWithRetry_1å›ç›®æˆåŠŸ

**ç›®çš„**: revise ã‚¹ãƒ†ãƒƒãƒ—ãŒ1å›ç›®ã§æˆåŠŸã™ã‚‹ã“ã¨ã‚’æ¤œè¨¼

**å‰ææ¡ä»¶**:
- ReviewCycleManager ã‚¤ãƒ³ã‚¹ã‚¿ãƒ³ã‚¹ãŒç”Ÿæˆã•ã‚Œã¦ã„ã‚‹
- ãƒ¢ãƒƒã‚¯ã•ã‚ŒãŸé–¢æ•°ãŒå­˜åœ¨ã™ã‚‹:
  - `reviewFn`: 1å›ç›®ã¯æˆåŠŸã‚’è¿”ã™ï¼ˆ`{ success: true }`ï¼‰
  - `reviseFn`: æˆåŠŸã‚’è¿”ã™ï¼ˆ`{ success: true }`ï¼‰
  - `postProgressFn`: æˆåŠŸã‚’è¿”ã™
  - `commitAndPushStepFn`: æˆåŠŸã‚’è¿”ã™

**å…¥åŠ›**:
```typescript
gitManager = mockGitManager
initialReviewResult = { success: false, feedback: 'Missing documentation' }
reviewFn = mockReviewFn
reviseFn = mockReviseFn
postProgressFn = mockPostProgressFn
commitAndPushStepFn = mockCommitAndPushStepFn
```

**æœŸå¾…çµæœ**:
- `reviseFn()` ãŒ1å›å‘¼ã³å‡ºã•ã‚Œã‚‹ï¼ˆfeedback='Missing documentation'ï¼‰
- `commitAndPushStepFn('revise')` ãŒ1å›å‘¼ã³å‡ºã•ã‚Œã‚‹
- `reviewFn()` ãŒ1å›å‘¼ã³å‡ºã•ã‚Œã‚‹ï¼ˆrevise å¾Œã®ãƒ¬ãƒ“ãƒ¥ãƒ¼ï¼‰
- `commitAndPushStepFn('review')` ãŒ1å›å‘¼ã³å‡ºã•ã‚Œã‚‹
- ãƒ¬ãƒ“ãƒ¥ãƒ¼ã‚µã‚¤ã‚¯ãƒ«ãŒæˆåŠŸã§çµ‚äº†
- ãƒªãƒˆãƒ©ã‚¤ã‚«ã‚¦ãƒ³ãƒˆãŒ1ã®ã¾ã¾

**ãƒ†ã‚¹ãƒˆãƒ‡ãƒ¼ã‚¿**: ãƒ¢ãƒƒã‚¯ã•ã‚ŒãŸé–¢æ•°

---

#### ãƒ†ã‚¹ãƒˆã‚±ãƒ¼ã‚¹ 4-2: performReviseStepWithRetry_3å›ç›®æˆåŠŸ

**ç›®çš„**: revise ã‚¹ãƒ†ãƒƒãƒ—ãŒ3å›ç›®ã§æˆåŠŸã™ã‚‹ã“ã¨ã‚’æ¤œè¨¼

**å‰ææ¡ä»¶**:
- ReviewCycleManager ã‚¤ãƒ³ã‚¹ã‚¿ãƒ³ã‚¹ãŒç”Ÿæˆã•ã‚Œã¦ã„ã‚‹
- ãƒ¢ãƒƒã‚¯ã•ã‚ŒãŸé–¢æ•°ãŒå­˜åœ¨ã™ã‚‹:
  - `reviewFn`: 1å›ç›®ãƒ»2å›ç›®ã¯å¤±æ•—ã€3å›ç›®ã¯æˆåŠŸã‚’è¿”ã™
  - `reviseFn`: æˆåŠŸã‚’è¿”ã™
  - `postProgressFn`: æˆåŠŸã‚’è¿”ã™
  - `commitAndPushStepFn`: æˆåŠŸã‚’è¿”ã™

**å…¥åŠ›**:
```typescript
gitManager = mockGitManager
initialReviewResult = { success: false, feedback: 'Issues found' }
reviewFn = mockReviewFn (1ãƒ»2å›ç›®å¤±æ•—ã€3å›ç›®æˆåŠŸ)
reviseFn = mockReviseFn
postProgressFn = mockPostProgressFn
commitAndPushStepFn = mockCommitAndPushStepFn
```

**æœŸå¾…çµæœ**:
- `reviseFn()` ãŒ3å›å‘¼ã³å‡ºã•ã‚Œã‚‹
- `commitAndPushStepFn('revise')` ãŒ3å›å‘¼ã³å‡ºã•ã‚Œã‚‹
- `reviewFn()` ãŒ3å›å‘¼ã³å‡ºã•ã‚Œã‚‹
- `commitAndPushStepFn('review')` ãŒ1å›å‘¼ã³å‡ºã•ã‚Œã‚‹ï¼ˆ3å›ç›®æˆåŠŸæ™‚ã®ã¿ï¼‰
- ãƒ¬ãƒ“ãƒ¥ãƒ¼ã‚µã‚¤ã‚¯ãƒ«ãŒæˆåŠŸã§çµ‚äº†
- ãƒªãƒˆãƒ©ã‚¤ã‚«ã‚¦ãƒ³ãƒˆãŒ3ã«æ›´æ–°ã•ã‚Œã‚‹

**ãƒ†ã‚¹ãƒˆãƒ‡ãƒ¼ã‚¿**: ãƒ¢ãƒƒã‚¯ã•ã‚ŒãŸé–¢æ•°

---

#### ãƒ†ã‚¹ãƒˆã‚±ãƒ¼ã‚¹ 4-3: performReviseStepWithRetry_æœ€å¤§ãƒªãƒˆãƒ©ã‚¤åˆ°é”_å¤±æ•—

**ç›®çš„**: æœ€å¤§ãƒªãƒˆãƒ©ã‚¤å›æ•°ï¼ˆ3å›ï¼‰ã«é”ã—ãŸå ´åˆã«ä¾‹å¤–ãŒã‚¹ãƒ­ãƒ¼ã•ã‚Œã‚‹ã“ã¨ã‚’æ¤œè¨¼

**å‰ææ¡ä»¶**:
- ReviewCycleManager ã‚¤ãƒ³ã‚¹ã‚¿ãƒ³ã‚¹ãŒç”Ÿæˆã•ã‚Œã¦ã„ã‚‹
- ãƒ¢ãƒƒã‚¯ã•ã‚ŒãŸé–¢æ•°ãŒå­˜åœ¨ã™ã‚‹:
  - `reviewFn`: å¸¸ã«å¤±æ•—ã‚’è¿”ã™
  - `reviseFn`: æˆåŠŸã‚’è¿”ã™
  - `postProgressFn`: æˆåŠŸã‚’è¿”ã™
  - `commitAndPushStepFn`: æˆåŠŸã‚’è¿”ã™

**å…¥åŠ›**:
```typescript
gitManager = mockGitManager
initialReviewResult = { success: false, feedback: 'Issues found' }
reviewFn = mockReviewFn (å¸¸ã«å¤±æ•—)
reviseFn = mockReviseFn
postProgressFn = mockPostProgressFn
commitAndPushStepFn = mockCommitAndPushStepFn
```

**æœŸå¾…çµæœ**:
- `reviseFn()` ãŒ3å›å‘¼ã³å‡ºã•ã‚Œã‚‹
- `reviewFn()` ãŒ3å›å‘¼ã³å‡ºã•ã‚Œã‚‹
- ä¾‹å¤–ãŒã‚¹ãƒ­ãƒ¼ã•ã‚Œã‚‹ï¼ˆ"Max retries reached" ã®ã‚ˆã†ãªãƒ¡ãƒƒã‚»ãƒ¼ã‚¸ï¼‰
- ãƒªãƒˆãƒ©ã‚¤ã‚«ã‚¦ãƒ³ãƒˆãŒ3ã«æ›´æ–°ã•ã‚Œã‚‹

**ãƒ†ã‚¹ãƒˆãƒ‡ãƒ¼ã‚¿**: ãƒ¢ãƒƒã‚¯ã•ã‚ŒãŸé–¢æ•°

---

#### ãƒ†ã‚¹ãƒˆã‚±ãƒ¼ã‚¹ 4-4: performReviseStepWithRetry_reviseå®Œäº†æ¸ˆã¿ã‚¹ã‚­ãƒƒãƒ—

**ç›®çš„**: revise ã‚¹ãƒ†ãƒƒãƒ—ãŒæ—¢ã«å®Œäº†ã—ã¦ã„ã‚‹å ´åˆã«ã‚¹ã‚­ãƒƒãƒ—ã•ã‚Œã‚‹ã“ã¨ã‚’æ¤œè¨¼

**å‰ææ¡ä»¶**:
- ReviewCycleManager ã‚¤ãƒ³ã‚¹ã‚¿ãƒ³ã‚¹ãŒç”Ÿæˆã•ã‚Œã¦ã„ã‚‹
- ãƒ¢ãƒƒã‚¯ã•ã‚ŒãŸ MetadataManager ãŒå­˜åœ¨ã™ã‚‹
  - completed_steps ã« 'revise' ãŒå«ã¾ã‚Œã¦ã„ã‚‹

**å…¥åŠ›**:
```typescript
gitManager = mockGitManager
initialReviewResult = { success: false, feedback: 'Issues found' }
reviewFn = mockReviewFn
reviseFn = mockReviseFn
postProgressFn = mockPostProgressFn
commitAndPushStepFn = mockCommitAndPushStepFn
```

**æœŸå¾…çµæœ**:
- `reviseFn()` ãŒå‘¼ã³å‡ºã•ã‚Œãªã„ï¼ˆã‚¹ã‚­ãƒƒãƒ—ï¼‰
- ãƒ¬ãƒ“ãƒ¥ãƒ¼ã‚µã‚¤ã‚¯ãƒ«ãŒã™ãã«çµ‚äº†

**ãƒ†ã‚¹ãƒˆãƒ‡ãƒ¼ã‚¿**: ãƒ¢ãƒƒã‚¯ã•ã‚ŒãŸ MetadataManager

---

#### ãƒ†ã‚¹ãƒˆã‚±ãƒ¼ã‚¹ 4-5: performReviseStepWithRetry_Gitç„¡åŠ¹æ™‚

**ç›®çš„**: Git ãƒãƒãƒ¼ã‚¸ãƒ£ãƒ¼ãŒ null ã®å ´åˆã§ã‚‚æ­£å¸¸å‹•ä½œã™ã‚‹ã“ã¨ã‚’æ¤œè¨¼

**å‰ææ¡ä»¶**:
- ReviewCycleManager ã‚¤ãƒ³ã‚¹ã‚¿ãƒ³ã‚¹ãŒç”Ÿæˆã•ã‚Œã¦ã„ã‚‹
- gitManager = null

**å…¥åŠ›**:
```typescript
gitManager = null
initialReviewResult = { success: false, feedback: 'Issues found' }
reviewFn = mockReviewFn (1å›ç›®æˆåŠŸ)
reviseFn = mockReviseFn
postProgressFn = mockPostProgressFn
commitAndPushStepFn = mockCommitAndPushStepFn (ä½•ã‚‚ã—ãªã„)
```

**æœŸå¾…çµæœ**:
- `commitAndPushStepFn()` ãŒå‘¼ã³å‡ºã•ã‚Œã‚‹ãŒã€å®Ÿéš›ã«ã¯ä½•ã‚‚ã—ãªã„
- ãƒ¬ãƒ“ãƒ¥ãƒ¼ã‚µã‚¤ã‚¯ãƒ«ãŒæ­£å¸¸çµ‚äº†

**ãƒ†ã‚¹ãƒˆãƒ‡ãƒ¼ã‚¿**: gitManager = null

---

## 2. Integrationãƒ†ã‚¹ãƒˆã‚·ãƒŠãƒªã‚ª

### 2.1 å…¨ãƒ•ã‚§ãƒ¼ã‚ºå®Ÿè¡Œãƒ†ã‚¹ãƒˆï¼ˆã‚¨ãƒ³ãƒ‰ãƒ„ãƒ¼ã‚¨ãƒ³ãƒ‰ï¼‰

#### ã‚·ãƒŠãƒªã‚ªå
BasePhase + å„ãƒ¢ã‚¸ãƒ¥ãƒ¼ãƒ«ã®é€£æºã«ã‚ˆã‚‹å…¨ãƒ•ã‚§ãƒ¼ã‚ºå®Ÿè¡Œ

#### ç›®çš„
ãƒªãƒ•ã‚¡ã‚¯ã‚¿ãƒªãƒ³ã‚°å¾Œã‚‚ã€æ—¢å­˜ã®å…¨ãƒ•ã‚§ãƒ¼ã‚ºå®Ÿè¡Œãƒ†ã‚¹ãƒˆãŒãƒ‘ã‚¹ã™ã‚‹ã“ã¨ã‚’æ¤œè¨¼

#### å‰ææ¡ä»¶
- æ—¢å­˜ã®çµ±åˆãƒ†ã‚¹ãƒˆ `tests/integration/preset-execution.test.ts` ãŒå­˜åœ¨ã™ã‚‹
- ãƒªãƒ•ã‚¡ã‚¯ã‚¿ãƒªãƒ³ã‚°å¾Œã® BasePhase ã¨å„ãƒ¢ã‚¸ãƒ¥ãƒ¼ãƒ«ãŒãƒ‡ãƒ—ãƒ­ã‚¤ã•ã‚Œã¦ã„ã‚‹
- ãƒ†ã‚¹ãƒˆç”¨ã®ãƒªãƒã‚¸ãƒˆãƒªãŒå­˜åœ¨ã™ã‚‹

#### ãƒ†ã‚¹ãƒˆæ‰‹é †
1. ãƒ†ã‚¹ãƒˆç”¨ Issue ã‚’ä½œæˆ
2. Planning Phase ã‚’å®Ÿè¡Œ
   - BasePhase.run() â†’ AgentExecutor.executeWithAgent() å‘¼ã³å‡ºã—ç¢ºèª
   - ProgressFormatter.formatProgressComment() å‘¼ã³å‡ºã—ç¢ºèª
   - LogFormatter.formatAgentLog() å‘¼ã³å‡ºã—ç¢ºèª
3. Requirements Phase ã‚’å®Ÿè¡Œ
   - ReviewCycleManager.performReviseStepWithRetry() å‘¼ã³å‡ºã—ç¢ºèª
4. å…¨10ãƒ•ã‚§ãƒ¼ã‚ºã‚’é †æ¬¡å®Ÿè¡Œ

#### æœŸå¾…çµæœ
- å…¨ãƒ•ã‚§ãƒ¼ã‚ºãŒæ­£å¸¸ã«å®Œäº†ã™ã‚‹ï¼ˆ`success: true`ï¼‰
- å„ãƒ•ã‚§ãƒ¼ã‚ºã®ãƒ¡ã‚¿ãƒ‡ãƒ¼ã‚¿ãŒæ­£ã—ãè¨˜éŒ²ã•ã‚Œã‚‹
- GitHub Issue ã‚³ãƒ¡ãƒ³ãƒˆãŒæ­£ã—ããƒ•ã‚©ãƒ¼ãƒãƒƒãƒˆã•ã‚Œã‚‹
- ã‚¨ãƒ¼ã‚¸ã‚§ãƒ³ãƒˆãƒ­ã‚°ãŒæ­£ã—ããƒ•ã‚©ãƒ¼ãƒãƒƒãƒˆã•ã‚Œã‚‹ï¼ˆCodex/Claudeï¼‰
- Git ã‚³ãƒŸãƒƒãƒˆï¼†ãƒ—ãƒƒã‚·ãƒ¥ãŒæ­£å¸¸å‹•ä½œã™ã‚‹

#### ç¢ºèªé …ç›®
- [ ] ã™ã¹ã¦ã®ãƒ•ã‚§ãƒ¼ã‚ºã‚¹ãƒ†ãƒ¼ã‚¿ã‚¹ãŒ `completed` ã«ãªã£ã¦ã„ã‚‹
- [ ] ãƒ¡ã‚¿ãƒ‡ãƒ¼ã‚¿ãƒ•ã‚¡ã‚¤ãƒ«ï¼ˆ`metadata.json`ï¼‰ãŒæ­£ã—ãæ›´æ–°ã•ã‚Œã¦ã„ã‚‹
- [ ] æˆæœç‰©ãƒ•ã‚¡ã‚¤ãƒ«ï¼ˆ`planning.md`ã€`requirements.md` ç­‰ï¼‰ãŒç”Ÿæˆã•ã‚Œã¦ã„ã‚‹
- [ ] GitHub Issue ã‚³ãƒ¡ãƒ³ãƒˆãŒæŠ•ç¨¿ã•ã‚Œã¦ã„ã‚‹
- [ ] ã‚¨ãƒ¼ã‚¸ã‚§ãƒ³ãƒˆãƒ­ã‚°ãƒ•ã‚¡ã‚¤ãƒ«ï¼ˆ`agent_log.md`ã€`agent_log_raw.txt`ï¼‰ãŒç”Ÿæˆã•ã‚Œã¦ã„ã‚‹
- [ ] Git ã‚³ãƒŸãƒƒãƒˆãŒå„ã‚¹ãƒ†ãƒƒãƒ—ã§ä½œæˆã•ã‚Œã¦ã„ã‚‹
- [ ] åˆ©ç”¨é‡ãƒ¡ãƒˆãƒªã‚¯ã‚¹ãŒè¨˜éŒ²ã•ã‚Œã¦ã„ã‚‹

---

### 2.2 ãƒ¬ãƒ“ãƒ¥ãƒ¼ã‚µã‚¤ã‚¯ãƒ«å‹•ä½œç¢ºèª

#### ã‚·ãƒŠãƒªã‚ªå
ReviewCycleManager ã«ã‚ˆã‚‹ãƒ¬ãƒ“ãƒ¥ãƒ¼ã‚µã‚¤ã‚¯ãƒ«ã®çµ±åˆãƒ†ã‚¹ãƒˆ

#### ç›®çš„
ãƒ¬ãƒ“ãƒ¥ãƒ¼ã‚µã‚¤ã‚¯ãƒ«ï¼ˆreview â†’ revise â†’ reviewï¼‰ãŒæ­£å¸¸å‹•ä½œã™ã‚‹ã“ã¨ã‚’æ¤œè¨¼

#### å‰ææ¡ä»¶
- BasePhase ã¨ ReviewCycleManager ãŒãƒ‡ãƒ—ãƒ­ã‚¤ã•ã‚Œã¦ã„ã‚‹
- ãƒ†ã‚¹ãƒˆç”¨ã®ãƒ•ã‚§ãƒ¼ã‚ºï¼ˆä¾‹: Requirements Phaseï¼‰ãŒå­˜åœ¨ã™ã‚‹
- ãƒ¢ãƒƒã‚¯ã•ã‚ŒãŸ review é–¢æ•°ãŒå­˜åœ¨ã™ã‚‹ï¼ˆ1å›ç›®å¤±æ•—ã€2å›ç›®æˆåŠŸï¼‰

#### ãƒ†ã‚¹ãƒˆæ‰‹é †
1. Requirements Phase ã‚’å®Ÿè¡Œ
2. execute ã‚¹ãƒ†ãƒƒãƒ—ãŒå®Œäº†
3. review ã‚¹ãƒ†ãƒƒãƒ—ãŒå®Ÿè¡Œã•ã‚Œã€å¤±æ•—ã‚’è¿”ã™
4. ReviewCycleManager.performReviseStepWithRetry() ãŒå‘¼ã³å‡ºã•ã‚Œã‚‹
5. revise ã‚¹ãƒ†ãƒƒãƒ—ãŒå®Ÿè¡Œã•ã‚Œã‚‹
6. Git ã‚³ãƒŸãƒƒãƒˆï¼†ãƒ—ãƒƒã‚·ãƒ¥ï¼ˆrevise ã‚¹ãƒ†ãƒƒãƒ—ï¼‰
7. å†åº¦ review ã‚¹ãƒ†ãƒƒãƒ—ãŒå®Ÿè¡Œã•ã‚Œã€æˆåŠŸã‚’è¿”ã™
8. Git ã‚³ãƒŸãƒƒãƒˆï¼†ãƒ—ãƒƒã‚·ãƒ¥ï¼ˆreview ã‚¹ãƒ†ãƒƒãƒ—ï¼‰

#### æœŸå¾…çµæœ
- ãƒ¬ãƒ“ãƒ¥ãƒ¼ã‚µã‚¤ã‚¯ãƒ«ãŒ2å›å®Ÿè¡Œã•ã‚Œã‚‹
- revise ã‚¹ãƒ†ãƒƒãƒ—ãŒ1å›å®Ÿè¡Œã•ã‚Œã‚‹
- Git ã‚³ãƒŸãƒƒãƒˆãŒ2å›ä½œæˆã•ã‚Œã‚‹ï¼ˆreviseã€reviewï¼‰
- ãƒ¡ã‚¿ãƒ‡ãƒ¼ã‚¿ã® retry_count ãŒ1ã«æ›´æ–°ã•ã‚Œã‚‹
- completed_steps ã« 'revise' ã¨ 'review' ãŒè¿½åŠ ã•ã‚Œã‚‹

#### ç¢ºèªé …ç›®
- [ ] ãƒ¬ãƒ“ãƒ¥ãƒ¼ãŒ2å›å®Ÿè¡Œã•ã‚Œã¦ã„ã‚‹ï¼ˆ1å›ç›®å¤±æ•—ã€2å›ç›®æˆåŠŸï¼‰
- [ ] revise ãŒ1å›å®Ÿè¡Œã•ã‚Œã¦ã„ã‚‹
- [ ] Git ã‚³ãƒŸãƒƒãƒˆãŒæ­£ã—ã„ã‚¹ãƒ†ãƒƒãƒ—ã§ä½œæˆã•ã‚Œã¦ã„ã‚‹
- [ ] retry_count ãŒæ­£ã—ãæ›´æ–°ã•ã‚Œã¦ã„ã‚‹
- [ ] completed_steps ãŒæ­£ã—ãæ›´æ–°ã•ã‚Œã¦ã„ã‚‹

---

### 2.3 ã‚¨ãƒ¼ã‚¸ã‚§ãƒ³ãƒˆãƒ•ã‚©ãƒ¼ãƒ«ãƒãƒƒã‚¯å‹•ä½œç¢ºèª

#### ã‚·ãƒŠãƒªã‚ªå
AgentExecutor ã«ã‚ˆã‚‹èªè¨¼ã‚¨ãƒ©ãƒ¼æ™‚ã®ãƒ•ã‚©ãƒ¼ãƒ«ãƒãƒƒã‚¯

#### ç›®çš„
Codex ã®èªè¨¼ã‚¨ãƒ©ãƒ¼æ™‚ã« Claude ã¸ãƒ•ã‚©ãƒ¼ãƒ«ãƒãƒƒã‚¯ã™ã‚‹ã“ã¨ã‚’æ¤œè¨¼

#### å‰ææ¡ä»¶
- BasePhase ã¨ AgentExecutor ãŒãƒ‡ãƒ—ãƒ­ã‚¤ã•ã‚Œã¦ã„ã‚‹
- Codex API ã‚­ãƒ¼ãŒç„¡åŠ¹ï¼ˆèªè¨¼ã‚¨ãƒ©ãƒ¼ç™ºç”Ÿï¼‰
- Claude Code èªè¨¼æƒ…å ±ãŒæœ‰åŠ¹

#### ãƒ†ã‚¹ãƒˆæ‰‹é †
1. Planning Phase ã‚’å®Ÿè¡Œï¼ˆexecute ã‚¹ãƒ†ãƒƒãƒ—ï¼‰
2. AgentExecutor.executeWithAgent() ãŒ Codex ã‚’å®Ÿè¡Œ
3. Codex ãŒèªè¨¼ã‚¨ãƒ©ãƒ¼ã‚’ã‚¹ãƒ­ãƒ¼ï¼ˆ"invalid bearer token"ï¼‰
4. AgentExecutor ãŒ Claude ã¸ãƒ•ã‚©ãƒ¼ãƒ«ãƒãƒƒã‚¯
5. Claude ãŒæ­£å¸¸ã«å®Ÿè¡Œã•ã‚Œã‚‹
6. ã‚¨ãƒ¼ã‚¸ã‚§ãƒ³ãƒˆãƒ­ã‚°ãŒä¿å­˜ã•ã‚Œã‚‹ï¼ˆClaude Agentï¼‰

#### æœŸå¾…çµæœ
- Codex ã®å®Ÿè¡ŒãŒè©¦ã¿ã‚‰ã‚Œã‚‹
- èªè¨¼ã‚¨ãƒ©ãƒ¼ãŒæ¤œå‡ºã•ã‚Œã‚‹
- Claude ã¸ãƒ•ã‚©ãƒ¼ãƒ«ãƒãƒƒã‚¯ã•ã‚Œã‚‹
- Claude ãŒæ­£å¸¸ã«å®Ÿè¡Œã•ã‚Œã‚‹
- ã‚¨ãƒ¼ã‚¸ã‚§ãƒ³ãƒˆãƒ­ã‚°ã« "Claude Agent" ãŒè¨˜éŒ²ã•ã‚Œã‚‹
- ãƒ•ã‚©ãƒ¼ãƒ«ãƒãƒƒã‚¯ãƒ¡ãƒƒã‚»ãƒ¼ã‚¸ãŒãƒ­ã‚°ã«è¨˜éŒ²ã•ã‚Œã‚‹

#### ç¢ºèªé …ç›®
- [ ] Codex ã®å®Ÿè¡ŒãŒè©¦ã¿ã‚‰ã‚Œã¦ã„ã‚‹ï¼ˆãƒ­ã‚°ç¢ºèªï¼‰
- [ ] èªè¨¼ã‚¨ãƒ©ãƒ¼ãŒæ¤œå‡ºã•ã‚Œã¦ã„ã‚‹
- [ ] Claude ã¸ãƒ•ã‚©ãƒ¼ãƒ«ãƒãƒƒã‚¯ã•ã‚Œã¦ã„ã‚‹
- [ ] ã‚¨ãƒ¼ã‚¸ã‚§ãƒ³ãƒˆãƒ­ã‚°ãƒ•ã‚¡ã‚¤ãƒ«ã« "Claude Agent" ãŒè¨˜éŒ²ã•ã‚Œã¦ã„ã‚‹
- [ ] ãƒ•ã‚©ãƒ¼ãƒ«ãƒãƒƒã‚¯ãƒ¡ãƒƒã‚»ãƒ¼ã‚¸ãŒè¨˜éŒ²ã•ã‚Œã¦ã„ã‚‹

---

### 2.4 ãƒ­ã‚°ãƒ•ã‚©ãƒ¼ãƒãƒƒãƒˆç¶­æŒç¢ºèª

#### ã‚·ãƒŠãƒªã‚ªå
LogFormatter ã«ã‚ˆã‚‹ãƒ­ã‚°ãƒ•ã‚©ãƒ¼ãƒãƒƒãƒˆã®çµ±åˆãƒ†ã‚¹ãƒˆ

#### ç›®çš„
ãƒªãƒ•ã‚¡ã‚¯ã‚¿ãƒªãƒ³ã‚°å¾Œã‚‚ã€æ—¢å­˜ã®ã‚¨ãƒ¼ã‚¸ã‚§ãƒ³ãƒˆãƒ­ã‚°ãƒ•ã‚©ãƒ¼ãƒãƒƒãƒˆãŒç¶­æŒã•ã‚Œã‚‹ã“ã¨ã‚’æ¤œè¨¼

#### å‰ææ¡ä»¶
- BasePhase ã¨ LogFormatter ãŒãƒ‡ãƒ—ãƒ­ã‚¤ã•ã‚Œã¦ã„ã‚‹
- Planning Phase ã‚’å®Ÿè¡Œæ¸ˆã¿ï¼ˆã‚¨ãƒ¼ã‚¸ã‚§ãƒ³ãƒˆãƒ­ã‚°ãŒç”Ÿæˆã•ã‚Œã¦ã„ã‚‹ï¼‰

#### ãƒ†ã‚¹ãƒˆæ‰‹é †
1. Planning Phase ã® `agent_log.md` ã‚’èª­ã¿è¾¼ã‚€
2. ä»¥ä¸‹ã®æƒ…å ±ãŒå«ã¾ã‚Œã¦ã„ã‚‹ã‹ç¢ºèª:
   - ã‚¨ãƒ¼ã‚¸ã‚§ãƒ³ãƒˆåï¼ˆCodex Agent ã¾ãŸã¯ Claude Agentï¼‰
   - å®Ÿè¡Œæ™‚é–“ï¼ˆXåˆ†Yç§’ï¼‰
   - é–‹å§‹æ™‚åˆ»ï¼ˆYYYY-MM-DD HH:MM:SSï¼‰
   - çµ‚äº†æ™‚åˆ»ï¼ˆYYYY-MM-DD HH:MM:SSï¼‰
   - ã‚¿ãƒ¼ãƒ³ã”ã¨ã®å†…è¨³ï¼ˆã‚¹ãƒ¬ãƒƒãƒ‰é–‹å§‹ã€ãƒ„ãƒ¼ãƒ«å®Ÿè¡Œã€å®Ÿè¡Œå®Œäº†ï¼‰
3. Codex ã®å ´åˆã€JSON ã‚¤ãƒ™ãƒ³ãƒˆã‚¹ãƒˆãƒªãƒ¼ãƒ ãŒæ­£ã—ãè§£æã•ã‚Œã¦ã„ã‚‹ã‹ç¢ºèª
4. Claude ã®å ´åˆã€JSON ãƒ¡ãƒƒã‚»ãƒ¼ã‚¸ãŒæ­£ã—ãè§£æã•ã‚Œã¦ã„ã‚‹ã‹ç¢ºèª

#### æœŸå¾…çµæœ
- ã‚¨ãƒ¼ã‚¸ã‚§ãƒ³ãƒˆãƒ­ã‚°ãŒ Markdown å½¢å¼ã§ç”Ÿæˆã•ã‚Œã¦ã„ã‚‹
- æ—¢å­˜ãƒ•ã‚©ãƒ¼ãƒãƒƒãƒˆã¨ä¸€è‡´ã—ã¦ã„ã‚‹
- åˆ©ç”¨é‡ãƒ¡ãƒˆãƒªã‚¯ã‚¹ãŒå«ã¾ã‚Œã¦ã„ã‚‹ï¼ˆCodex ã®å ´åˆï¼‰
- 4000æ–‡å­—ã‚’è¶…ãˆã‚‹å‡ºåŠ›ã¯åˆ‡ã‚Šè©°ã‚ã‚‰ã‚Œã¦ã„ã‚‹

#### ç¢ºèªé …ç›®
- [ ] ã‚¨ãƒ¼ã‚¸ã‚§ãƒ³ãƒˆåãŒè¨˜éŒ²ã•ã‚Œã¦ã„ã‚‹
- [ ] å®Ÿè¡Œæ™‚é–“ãŒè¨˜éŒ²ã•ã‚Œã¦ã„ã‚‹
- [ ] é–‹å§‹ãƒ»çµ‚äº†æ™‚åˆ»ãŒè¨˜éŒ²ã•ã‚Œã¦ã„ã‚‹
- [ ] ã‚¿ãƒ¼ãƒ³ã”ã¨ã®å†…è¨³ãŒå«ã¾ã‚Œã¦ã„ã‚‹
- [ ] åˆ©ç”¨é‡ãƒ¡ãƒˆãƒªã‚¯ã‚¹ãŒå«ã¾ã‚Œã¦ã„ã‚‹ï¼ˆè©²å½“ã™ã‚‹å ´åˆï¼‰
- [ ] 4000æ–‡å­—è¶…éæ™‚ã«åˆ‡ã‚Šè©°ã‚ã‚‰ã‚Œã¦ã„ã‚‹

---

### 2.5 é€²æ—è¡¨ç¤ºãƒ•ã‚©ãƒ¼ãƒãƒƒãƒˆç¢ºèª

#### ã‚·ãƒŠãƒªã‚ªå
ProgressFormatter ã«ã‚ˆã‚‹é€²æ—è¡¨ç¤ºã®çµ±åˆãƒ†ã‚¹ãƒˆ

#### ç›®çš„
ãƒªãƒ•ã‚¡ã‚¯ã‚¿ãƒªãƒ³ã‚°å¾Œã‚‚ã€GitHub Issue ã‚³ãƒ¡ãƒ³ãƒˆãŒæ­£ã—ããƒ•ã‚©ãƒ¼ãƒãƒƒãƒˆã•ã‚Œã‚‹ã“ã¨ã‚’æ¤œè¨¼

#### å‰ææ¡ä»¶
- BasePhase ã¨ ProgressFormatter ãŒãƒ‡ãƒ—ãƒ­ã‚¤ã•ã‚Œã¦ã„ã‚‹
- ãƒ†ã‚¹ãƒˆç”¨ Issue ãŒå­˜åœ¨ã™ã‚‹
- Planning Phase ã‚’å®Ÿè¡Œæ¸ˆã¿

#### ãƒ†ã‚¹ãƒˆæ‰‹é †
1. Planning Phase å®Ÿè¡Œä¸­ã® GitHub Issue ã‚³ãƒ¡ãƒ³ãƒˆã‚’ç¢ºèª
2. Requirements Phase å®Ÿè¡Œä¸­ã® GitHub Issue ã‚³ãƒ¡ãƒ³ãƒˆã‚’ç¢ºèª
3. ã™ã¹ã¦ã®ãƒ•ã‚§ãƒ¼ã‚ºå®Œäº†å¾Œã® GitHub Issue ã‚³ãƒ¡ãƒ³ãƒˆã‚’ç¢ºèª

#### æœŸå¾…çµæœ
- ãƒ•ã‚§ãƒ¼ã‚ºã‚¹ãƒ†ãƒ¼ã‚¿ã‚¹ä¸€è¦§ãŒæ­£ã—ãè¡¨ç¤ºã•ã‚Œã¦ã„ã‚‹
  - âœ… Phase 0: Planning (å®Œäº†æ™‚åˆ»)
  - ğŸ”„ Phase 1: Requirements (é–‹å§‹æ™‚åˆ»)
  - â¸ï¸ Phase 2: Design
  - ...
- ç¾åœ¨ã®ãƒ•ã‚§ãƒ¼ã‚ºè©³ç´°ãŒæ­£ã—ãè¡¨ç¤ºã•ã‚Œã¦ã„ã‚‹
  - ãƒ•ã‚§ãƒ¼ã‚ºåã€ã‚¹ãƒ†ãƒ¼ã‚¿ã‚¹ã€è©¦è¡Œå›æ•°
- å®Œäº†ã—ãŸãƒ•ã‚§ãƒ¼ã‚ºã®è©³ç´°ãŒæŠ˜ã‚ŠãŸãŸã¿è¡¨ç¤ºã•ã‚Œã¦ã„ã‚‹
- æœ€çµ‚æ›´æ–°æ™‚åˆ»ãŒè¡¨ç¤ºã•ã‚Œã¦ã„ã‚‹

#### ç¢ºèªé …ç›®
- [ ] ãƒ•ã‚§ãƒ¼ã‚ºã‚¹ãƒ†ãƒ¼ã‚¿ã‚¹ä¸€è¦§ãŒæ­£ã—ã„
- [ ] çµµæ–‡å­—ãŒæ­£ã—ããƒãƒƒãƒ”ãƒ³ã‚°ã•ã‚Œã¦ã„ã‚‹
- [ ] ç¾åœ¨ã®ãƒ•ã‚§ãƒ¼ã‚ºè©³ç´°ãŒæ­£ã—ã„
- [ ] å®Œäº†ãƒ•ã‚§ãƒ¼ã‚ºãŒæŠ˜ã‚ŠãŸãŸã¿è¡¨ç¤ºã•ã‚Œã¦ã„ã‚‹
- [ ] æœ€çµ‚æ›´æ–°æ™‚åˆ»ãŒè¡¨ç¤ºã•ã‚Œã¦ã„ã‚‹

---

### 2.6 Git ã‚³ãƒŸãƒƒãƒˆï¼†ãƒ—ãƒƒã‚·ãƒ¥é€£æºç¢ºèª

#### ã‚·ãƒŠãƒªã‚ªå
BasePhase ã¨ Git æ“ä½œã®çµ±åˆãƒ†ã‚¹ãƒˆ

#### ç›®çš„
ã‚¹ãƒ†ãƒƒãƒ—ã”ã¨ã® Git ã‚³ãƒŸãƒƒãƒˆï¼†ãƒ—ãƒƒã‚·ãƒ¥ãŒæ­£å¸¸å‹•ä½œã™ã‚‹ã“ã¨ã‚’æ¤œè¨¼

#### å‰ææ¡ä»¶
- BasePhase ãŒãƒ‡ãƒ—ãƒ­ã‚¤ã•ã‚Œã¦ã„ã‚‹
- Git ãƒªãƒã‚¸ãƒˆãƒªãŒå­˜åœ¨ã™ã‚‹
- ãƒ†ã‚¹ãƒˆç”¨ãƒ–ãƒ©ãƒ³ãƒãŒä½œæˆã•ã‚Œã¦ã„ã‚‹

#### ãƒ†ã‚¹ãƒˆæ‰‹é †
1. Planning Phase ã‚’å®Ÿè¡Œ
2. execute ã‚¹ãƒ†ãƒƒãƒ—å®Œäº†å¾Œã€Git ã‚³ãƒŸãƒƒãƒˆãŒä½œæˆã•ã‚Œã‚‹ã“ã¨ã‚’ç¢ºèª
3. review ã‚¹ãƒ†ãƒƒãƒ—å®Œäº†å¾Œã€Git ã‚³ãƒŸãƒƒãƒˆãŒä½œæˆã•ã‚Œã‚‹ã“ã¨ã‚’ç¢ºèª
4. revise ã‚¹ãƒ†ãƒƒãƒ—å®Œäº†å¾Œï¼ˆè©²å½“ã™ã‚‹å ´åˆï¼‰ã€Git ã‚³ãƒŸãƒƒãƒˆãŒä½œæˆã•ã‚Œã‚‹ã“ã¨ã‚’ç¢ºèª
5. ãƒªãƒ¢ãƒ¼ãƒˆãƒªãƒã‚¸ãƒˆãƒªã«ãƒ—ãƒƒã‚·ãƒ¥ã•ã‚Œã‚‹ã“ã¨ã‚’ç¢ºèª

#### æœŸå¾…çµæœ
- execute ã‚¹ãƒ†ãƒƒãƒ—å®Œäº†å¾Œã« Git ã‚³ãƒŸãƒƒãƒˆãŒä½œæˆã•ã‚Œã‚‹
  - ã‚³ãƒŸãƒƒãƒˆãƒ¡ãƒƒã‚»ãƒ¼ã‚¸: "[Planning] Execute step completed"
- review ã‚¹ãƒ†ãƒƒãƒ—å®Œäº†å¾Œã« Git ã‚³ãƒŸãƒƒãƒˆãŒä½œæˆã•ã‚Œã‚‹
  - ã‚³ãƒŸãƒƒãƒˆãƒ¡ãƒƒã‚»ãƒ¼ã‚¸: "[Planning] Review step completed"
- revise ã‚¹ãƒ†ãƒƒãƒ—å®Œäº†å¾Œï¼ˆè©²å½“ã™ã‚‹å ´åˆï¼‰ã« Git ã‚³ãƒŸãƒƒãƒˆãŒä½œæˆã•ã‚Œã‚‹
  - ã‚³ãƒŸãƒƒãƒˆãƒ¡ãƒƒã‚»ãƒ¼ã‚¸: "[Planning] Revise step completed"
- ãƒªãƒ¢ãƒ¼ãƒˆãƒªãƒã‚¸ãƒˆãƒªã«ãƒ—ãƒƒã‚·ãƒ¥ã•ã‚Œã‚‹

#### ç¢ºèªé …ç›®
- [ ] execute ã‚¹ãƒ†ãƒƒãƒ—å¾Œã« Git ã‚³ãƒŸãƒƒãƒˆãŒä½œæˆã•ã‚Œã¦ã„ã‚‹
- [ ] review ã‚¹ãƒ†ãƒƒãƒ—å¾Œã« Git ã‚³ãƒŸãƒƒãƒˆãŒä½œæˆã•ã‚Œã¦ã„ã‚‹
- [ ] revise ã‚¹ãƒ†ãƒƒãƒ—å¾Œã« Git ã‚³ãƒŸãƒƒãƒˆãŒä½œæˆã•ã‚Œã¦ã„ã‚‹ï¼ˆè©²å½“ã™ã‚‹å ´åˆï¼‰
- [ ] ã‚³ãƒŸãƒƒãƒˆãƒ¡ãƒƒã‚»ãƒ¼ã‚¸ãŒæ­£ã—ã„
- [ ] ãƒªãƒ¢ãƒ¼ãƒˆãƒªãƒã‚¸ãƒˆãƒªã«ãƒ—ãƒƒã‚·ãƒ¥ã•ã‚Œã¦ã„ã‚‹

---

### 2.7 BasePhase è¡Œæ•°å‰Šæ¸›é”æˆç¢ºèª

#### ã‚·ãƒŠãƒªã‚ªå
BasePhase ã®ãƒªãƒ•ã‚¡ã‚¯ã‚¿ãƒªãƒ³ã‚°æ¤œè¨¼

#### ç›®çš„
BasePhase ãŒ300è¡Œä»¥ä¸‹ã«å‰Šæ¸›ã•ã‚Œã¦ã„ã‚‹ã“ã¨ã‚’æ¤œè¨¼

#### å‰ææ¡ä»¶
- ãƒªãƒ•ã‚¡ã‚¯ã‚¿ãƒªãƒ³ã‚°å¾Œã® BasePhase ãŒå­˜åœ¨ã™ã‚‹

#### ãƒ†ã‚¹ãƒˆæ‰‹é †
1. `src/phases/base-phase.ts` ã®ãƒ•ã‚¡ã‚¤ãƒ«è¡Œæ•°ã‚’ç¢ºèª
2. å„ãƒ¢ã‚¸ãƒ¥ãƒ¼ãƒ«ï¼ˆLogFormatterã€ProgressFormatterã€AgentExecutorã€ReviewCycleManagerï¼‰ãŒæ­£ã—ãã‚¤ãƒ³ãƒãƒ¼ãƒˆã•ã‚Œã¦ã„ã‚‹ã‹ç¢ºèª
3. ä¸è¦ãªãƒ¡ã‚½ãƒƒãƒ‰ãŒå‰Šé™¤ã•ã‚Œã¦ã„ã‚‹ã‹ç¢ºèª
   - `formatAgentLog()`ã€`formatCodexAgentLog()`
   - `formatProgressComment()`
   - `executeWithAgent()`ã€`runAgentTask()`
   - `extractUsageMetrics()`ã€`recordUsageMetrics()`
   - `performReviseStepWithRetry()`

#### æœŸå¾…çµæœ
- BasePhase ã®ãƒ•ã‚¡ã‚¤ãƒ«è¡Œæ•°ãŒ300è¡Œä»¥ä¸‹ã§ã‚ã‚‹
- å„ãƒ¢ã‚¸ãƒ¥ãƒ¼ãƒ«ãŒæ­£ã—ãã‚¤ãƒ³ãƒãƒ¼ãƒˆã•ã‚Œã¦ã„ã‚‹
- ä¸è¦ãªãƒ¡ã‚½ãƒƒãƒ‰ãŒå‰Šé™¤ã•ã‚Œã¦ã„ã‚‹
- TypeScript ã‚³ãƒ³ãƒ‘ã‚¤ãƒ«ã‚¨ãƒ©ãƒ¼ãŒãªã„ï¼ˆ`npm run build` ãŒæˆåŠŸï¼‰

#### ç¢ºèªé …ç›®
- [ ] ãƒ•ã‚¡ã‚¤ãƒ«è¡Œæ•°ãŒ300è¡Œä»¥ä¸‹ã§ã‚ã‚‹
- [ ] å„ãƒ¢ã‚¸ãƒ¥ãƒ¼ãƒ«ãŒã‚¤ãƒ³ãƒãƒ¼ãƒˆã•ã‚Œã¦ã„ã‚‹
- [ ] ä¸è¦ãªãƒ¡ã‚½ãƒƒãƒ‰ãŒå‰Šé™¤ã•ã‚Œã¦ã„ã‚‹
- [ ] TypeScript ã‚³ãƒ³ãƒ‘ã‚¤ãƒ«ã‚¨ãƒ©ãƒ¼ãŒãªã„

---

## 3. ãƒ†ã‚¹ãƒˆãƒ‡ãƒ¼ã‚¿

### 3.1 LogFormatter ãƒ†ã‚¹ãƒˆãƒ‡ãƒ¼ã‚¿

#### Claude ã‚¨ãƒ¼ã‚¸ã‚§ãƒ³ãƒˆãƒ­ã‚°ã‚µãƒ³ãƒ—ãƒ«
```json
[
  "{\"type\": \"turn_start\", \"turn_number\": 1}",
  "{\"type\": \"tool_use\", \"tool\": \"Read\", \"path\": \"/path/to/file.ts\"}",
  "{\"type\": \"tool_result\", \"output\": \"file content here\"}",
  "{\"type\": \"turn_complete\", \"turn_number\": 1}"
]
```

#### Codex ã‚¨ãƒ¼ã‚¸ã‚§ãƒ³ãƒˆãƒ­ã‚°ã‚µãƒ³ãƒ—ãƒ«
```json
[
  "{\"type\": \"thread.started\", \"thread_id\": \"thread_abc123\"}",
  "{\"type\": \"item.started\", \"item\": {\"type\": \"tool_use\", \"name\": \"Glob\"}}",
  "{\"type\": \"item.output\", \"output\": \"matched 10 files\"}",
  "{\"type\": \"item.completed\", \"item\": {\"type\": \"tool_use\", \"name\": \"Glob\"}}",
  "{\"type\": \"response.completed\", \"usage\": {\"input_tokens\": 500, \"output_tokens\": 300, \"total_cost_usd\": 0.02}}"
]
```

### 3.2 ProgressFormatter ãƒ†ã‚¹ãƒˆãƒ‡ãƒ¼ã‚¿

#### ãƒ¢ãƒƒã‚¯ MetadataManager
```typescript
{
  getPhaseStatus: (phase) => {
    // planning: completed, requirements: in_progress, design: pending
    if (phase === 'planning') return { status: 'completed', completed_at: '2024-01-23 12:00:00' };
    if (phase === 'requirements') return { status: 'in_progress', started_at: '2024-01-23 12:05:00', retry_count: 1 };
    if (phase === 'design') return { status: 'pending' };
  }
}
```

### 3.3 AgentExecutor ãƒ†ã‚¹ãƒˆãƒ‡ãƒ¼ã‚¿

#### ãƒ¢ãƒƒã‚¯ CodexAgentClient
```typescript
{
  executeTask: jest.fn().mockResolvedValue([
    '{"type": "response.completed", "usage": {"input_tokens": 1000, "output_tokens": 500, "total_cost_usd": 0.05}}'
  ])
}
```

#### ãƒ¢ãƒƒã‚¯ ClaudeAgentClient
```typescript
{
  executeTask: jest.fn().mockResolvedValue([
    '{"type": "turn_complete", "turn_number": 1}'
  ])
}
```

### 3.4 ReviewCycleManager ãƒ†ã‚¹ãƒˆãƒ‡ãƒ¼ã‚¿

#### ãƒ¢ãƒƒã‚¯é–¢æ•°
```typescript
const mockReviewFn = jest.fn()
  .mockResolvedValueOnce({ success: false, feedback: 'Issues found' })  // 1å›ç›®å¤±æ•—
  .mockResolvedValueOnce({ success: true });  // 2å›ç›®æˆåŠŸ

const mockReviseFn = jest.fn().mockResolvedValue({ success: true });

const mockPostProgressFn = jest.fn().mockResolvedValue(undefined);

const mockCommitAndPushStepFn = jest.fn().mockResolvedValue(undefined);
```

---

## 4. ãƒ†ã‚¹ãƒˆç’°å¢ƒè¦ä»¶

### 4.1 ãƒ­ãƒ¼ã‚«ãƒ«ç’°å¢ƒ
- **Node.js**: 20ä»¥ä¸Š
- **npm**: 10ä»¥ä¸Š
- **Git**: æœ€æ–°ç‰ˆ
- **ç’°å¢ƒå¤‰æ•°**:
  - `GITHUB_TOKEN`: GitHub API ã‚¢ã‚¯ã‚»ã‚¹ãƒˆãƒ¼ã‚¯ãƒ³
  - `CODEX_API_KEY` ã¾ãŸã¯ `OPENAI_API_KEY`: Codex API ã‚­ãƒ¼ï¼ˆãƒ†ã‚¹ãƒˆæ™‚ã¯ç„¡åŠ¹ã§ã‚‚å¯ï¼‰
  - `CLAUDE_CODE_CREDENTIALS_PATH`: Claude Code èªè¨¼æƒ…å ±ãƒ‘ã‚¹ï¼ˆãƒ†ã‚¹ãƒˆæ™‚ã¯ç„¡åŠ¹ã§ã‚‚å¯ï¼‰

### 4.2 CI/CDç’°å¢ƒ
- **GitHub Actions**: ãƒ¦ãƒ‹ãƒƒãƒˆãƒ†ã‚¹ãƒˆãƒ»çµ±åˆãƒ†ã‚¹ãƒˆã‚’è‡ªå‹•å®Ÿè¡Œ
- **Jenkins**: æ—¢å­˜ã® CI/CD ãƒ‘ã‚¤ãƒ—ãƒ©ã‚¤ãƒ³ã‚’ä½¿ç”¨

### 4.3 å¤–éƒ¨ã‚µãƒ¼ãƒ“ã‚¹
- **GitHub API**: Issue ã‚³ãƒ¡ãƒ³ãƒˆæŠ•ç¨¿ã€PR ç®¡ç†
- **Codex API**: ã‚¨ãƒ¼ã‚¸ã‚§ãƒ³ãƒˆå®Ÿè¡Œï¼ˆçµ±åˆãƒ†ã‚¹ãƒˆæ™‚ï¼‰
- **Claude Code SDK**: ã‚¨ãƒ¼ã‚¸ã‚§ãƒ³ãƒˆå®Ÿè¡Œï¼ˆçµ±åˆãƒ†ã‚¹ãƒˆæ™‚ï¼‰

### 4.4 ãƒ¢ãƒƒã‚¯/ã‚¹ã‚¿ãƒ–ã®å¿…è¦æ€§
- **ãƒ¦ãƒ‹ãƒƒãƒˆãƒ†ã‚¹ãƒˆ**: ã™ã¹ã¦ ãƒ¢ãƒƒã‚¯/ã‚¹ã‚¿ãƒ– ã‚’ä½¿ç”¨
  - CodexAgentClientã€ClaudeAgentClient ã®ãƒ¢ãƒƒã‚¯
  - MetadataManager ã®ãƒ¢ãƒƒã‚¯
  - GitManager ã®ãƒ¢ãƒƒã‚¯
  - GitHub API ã‚¯ãƒ©ã‚¤ã‚¢ãƒ³ãƒˆã®ãƒ¢ãƒƒã‚¯
- **çµ±åˆãƒ†ã‚¹ãƒˆ**: å®Ÿéš›ã®å¤–éƒ¨ã‚µãƒ¼ãƒ“ã‚¹ã‚’ä½¿ç”¨ï¼ˆä¸€éƒ¨ãƒ¢ãƒƒã‚¯å¯ï¼‰

### 4.5 ãƒ†ã‚¹ãƒˆãƒ•ãƒ¬ãƒ¼ãƒ ãƒ¯ãƒ¼ã‚¯
- **Jest**: ãƒ¦ãƒ‹ãƒƒãƒˆãƒ†ã‚¹ãƒˆãƒ»çµ±åˆãƒ†ã‚¹ãƒˆ
  - `NODE_OPTIONS=--experimental-vm-modules jest`
  - TypeScript å¯¾å¿œï¼ˆ`ts-jest`ï¼‰
- **ã‚«ãƒãƒ¬ãƒƒã‚¸**: `jest --coverage`
  - ç›®æ¨™ã‚«ãƒãƒ¬ãƒƒã‚¸: 80%ä»¥ä¸Š

---

## 5. å“è³ªã‚²ãƒ¼ãƒˆç¢ºèª

### Phase 2ã®æˆ¦ç•¥ã«æ²¿ã£ãŸãƒ†ã‚¹ãƒˆã‚·ãƒŠãƒªã‚ªã§ã‚ã‚‹
âœ… **ç¢ºèªæ¸ˆã¿**: UNIT_INTEGRATION æˆ¦ç•¥ã«æ²¿ã£ã¦ã€Unitãƒ†ã‚¹ãƒˆã‚·ãƒŠãƒªã‚ªï¼ˆ1.1ã€œ1.4ï¼‰ã¨Integrationãƒ†ã‚¹ãƒˆã‚·ãƒŠãƒªã‚ªï¼ˆ2.1ã€œ2.7ï¼‰ã‚’ä½œæˆ

### ä¸»è¦ãªæ­£å¸¸ç³»ãŒã‚«ãƒãƒ¼ã•ã‚Œã¦ã„ã‚‹
âœ… **ç¢ºèªæ¸ˆã¿**:
- **Unitãƒ†ã‚¹ãƒˆ**: å„ãƒ¢ã‚¸ãƒ¥ãƒ¼ãƒ«ã®æ­£å¸¸ç³»ï¼ˆCodex/Claude å®Ÿè¡ŒæˆåŠŸã€ãƒ­ã‚°ãƒ•ã‚©ãƒ¼ãƒãƒƒãƒˆæ­£å¸¸ã€é€²æ—è¡¨ç¤ºæ­£å¸¸ã€ãƒ¬ãƒ“ãƒ¥ãƒ¼ã‚µã‚¤ã‚¯ãƒ«æˆåŠŸï¼‰
- **Integrationãƒ†ã‚¹ãƒˆ**: å…¨ãƒ•ã‚§ãƒ¼ã‚ºå®Ÿè¡Œã€ãƒ¬ãƒ“ãƒ¥ãƒ¼ã‚µã‚¤ã‚¯ãƒ«ã€ã‚¨ãƒ¼ã‚¸ã‚§ãƒ³ãƒˆãƒ•ã‚©ãƒ¼ãƒ«ãƒãƒƒã‚¯ã€ãƒ­ã‚°ãƒ•ã‚©ãƒ¼ãƒãƒƒãƒˆç¶­æŒã€é€²æ—è¡¨ç¤ºã€Git é€£æº

### ä¸»è¦ãªç•°å¸¸ç³»ãŒã‚«ãƒãƒ¼ã•ã‚Œã¦ã„ã‚‹
âœ… **ç¢ºèªæ¸ˆã¿**:
- **Unitãƒ†ã‚¹ãƒˆ**:
  - LogFormatter: JSONè§£æå¤±æ•—ã€4000æ–‡å­—è¶…éã€ã‚¨ãƒ©ãƒ¼ç™ºç”Ÿæ™‚
  - ProgressFormatter: å¤±æ•—ã‚¹ãƒ†ãƒ¼ã‚¿ã‚¹è¡¨ç¤º
  - AgentExecutor: èªè¨¼ã‚¨ãƒ©ãƒ¼ãƒ•ã‚©ãƒ¼ãƒ«ãƒãƒƒã‚¯ã€ç©ºå‡ºåŠ›ãƒ•ã‚©ãƒ¼ãƒ«ãƒãƒƒã‚¯
  - ReviewCycleManager: æœ€å¤§ãƒªãƒˆãƒ©ã‚¤åˆ°é”å¤±æ•—
- **Integrationãƒ†ã‚¹ãƒˆ**: èªè¨¼ã‚¨ãƒ©ãƒ¼æ™‚ã®ãƒ•ã‚©ãƒ¼ãƒ«ãƒãƒƒã‚¯

### æœŸå¾…çµæœãŒæ˜ç¢ºã§ã‚ã‚‹
âœ… **ç¢ºèªæ¸ˆã¿**: ã™ã¹ã¦ã®ãƒ†ã‚¹ãƒˆã‚±ãƒ¼ã‚¹ã«ã€ŒæœŸå¾…çµæœã€ã‚»ã‚¯ã‚·ãƒ§ãƒ³ã‚’è¨˜è¼‰ã—ã€æ¤œè¨¼å¯èƒ½ãªå…·ä½“çš„ãªçµæœã‚’æ˜è¨˜

---

## 6. è£œè¶³äº‹é …

### 6.1 ãƒ†ã‚¹ãƒˆå®Ÿè¡Œã‚³ãƒãƒ³ãƒ‰

#### ãƒ¦ãƒ‹ãƒƒãƒˆãƒ†ã‚¹ãƒˆ
```bash
npm run test:unit
npm run test:unit -- tests/unit/phases/formatters/log-formatter.test.ts
```

#### çµ±åˆãƒ†ã‚¹ãƒˆ
```bash
npm run test:integration
npm run test:integration -- tests/integration/preset-execution.test.ts
```

#### ã‚«ãƒãƒ¬ãƒƒã‚¸
```bash
npm run test:coverage
```

### 6.2 ãƒ†ã‚¹ãƒˆå„ªå…ˆé †ä½

1. **é«˜å„ªå…ˆåº¦**ï¼ˆãƒªã‚°ãƒ¬ãƒƒã‚·ãƒ§ãƒ³é˜²æ­¢ï¼‰:
   - å…¨ãƒ•ã‚§ãƒ¼ã‚ºå®Ÿè¡Œãƒ†ã‚¹ãƒˆï¼ˆ2.1ï¼‰
   - ãƒ¬ãƒ“ãƒ¥ãƒ¼ã‚µã‚¤ã‚¯ãƒ«å‹•ä½œç¢ºèªï¼ˆ2.2ï¼‰
   - ã‚¨ãƒ¼ã‚¸ã‚§ãƒ³ãƒˆãƒ•ã‚©ãƒ¼ãƒ«ãƒãƒƒã‚¯å‹•ä½œç¢ºèªï¼ˆ2.3ï¼‰

2. **ä¸­å„ªå…ˆåº¦**ï¼ˆãƒ¢ã‚¸ãƒ¥ãƒ¼ãƒ«æ­£ç¢ºæ€§ï¼‰:
   - AgentExecutor ãƒ¦ãƒ‹ãƒƒãƒˆãƒ†ã‚¹ãƒˆï¼ˆ1.3ï¼‰
   - ReviewCycleManager ãƒ¦ãƒ‹ãƒƒãƒˆãƒ†ã‚¹ãƒˆï¼ˆ1.4ï¼‰
   - LogFormatter ãƒ¦ãƒ‹ãƒƒãƒˆãƒ†ã‚¹ãƒˆï¼ˆ1.1ï¼‰

3. **ä½å„ªå…ˆåº¦**ï¼ˆUI/ãƒ•ã‚©ãƒ¼ãƒãƒƒãƒˆï¼‰:
   - ProgressFormatter ãƒ¦ãƒ‹ãƒƒãƒˆãƒ†ã‚¹ãƒˆï¼ˆ1.2ï¼‰
   - ãƒ­ã‚°ãƒ•ã‚©ãƒ¼ãƒãƒƒãƒˆç¶­æŒç¢ºèªï¼ˆ2.4ï¼‰
   - é€²æ—è¡¨ç¤ºãƒ•ã‚©ãƒ¼ãƒãƒƒãƒˆç¢ºèªï¼ˆ2.5ï¼‰

### 6.3 ãƒªã‚¹ã‚¯å¯¾å¿œ

#### ãƒªã‚¹ã‚¯1: ãƒ¦ãƒ‹ãƒƒãƒˆãƒ†ã‚¹ãƒˆã®ãƒ¢ãƒƒã‚¯ãŒè¤‡é›‘ã«ãªã‚‹
- **å¯¾ç­–**: ãƒ¢ãƒƒã‚¯ãƒ¦ãƒ¼ãƒ†ã‚£ãƒªãƒ†ã‚£ã‚’ä½œæˆï¼ˆ`tests/utils/mock-helpers.ts`ï¼‰
- **å¯¾ç­–**: å¿…è¦æœ€å°é™ã®ãƒ¢ãƒƒã‚¯ã«ç•™ã‚ã‚‹ï¼ˆéåº¦ãªè©³ç´°åŒ–ã‚’é¿ã‘ã‚‹ï¼‰

#### ãƒªã‚¹ã‚¯2: çµ±åˆãƒ†ã‚¹ãƒˆãŒä¸å®‰å®šã«ãªã‚‹
- **å¯¾ç­–**: ãƒªãƒˆãƒ©ã‚¤ãƒ­ã‚¸ãƒƒã‚¯ã‚’è¿½åŠ ï¼ˆæœ€å¤§3å›ï¼‰
- **å¯¾ç­–**: ãƒ†ã‚¹ãƒˆç’°å¢ƒã®äº‹å‰ç¢ºèªï¼ˆGitHub API æ¥ç¶šç¢ºèªç­‰ï¼‰

#### ãƒªã‚¹ã‚¯3: ã‚«ãƒãƒ¬ãƒƒã‚¸80%æœªé”
- **å¯¾ç­–**: å„ªå…ˆåº¦ã®é«˜ã„ãƒ¢ã‚¸ãƒ¥ãƒ¼ãƒ«ï¼ˆAgentExecutorã€ReviewCycleManagerï¼‰ã‚’é‡ç‚¹çš„ã«ãƒ†ã‚¹ãƒˆ
- **å¯¾ç­–**: ãƒ—ãƒ©ã‚¤ãƒ™ãƒ¼ãƒˆãƒ¡ã‚½ãƒƒãƒ‰ã¯é–“æ¥çš„ã«ãƒ†ã‚¹ãƒˆï¼ˆpublic ãƒ¡ã‚½ãƒƒãƒ‰çµŒç”±ï¼‰

---

**ä½œæˆæ—¥**: 2025-01-20
**ãƒãƒ¼ã‚¸ãƒ§ãƒ³**: 1.0
**ã‚¹ãƒ†ãƒ¼ã‚¿ã‚¹**: ãƒ¬ãƒ“ãƒ¥ãƒ¼å¾…ã¡
