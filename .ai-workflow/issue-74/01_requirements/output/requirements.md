# 要件定義書 - Issue #74

**Issue番号**: #74
**タイトル**: [FOLLOW-UP] Issue #51 - 残タスク
**作成日**: 2025-01-30
**バージョン**: 1.0

---

## 0. Planning Documentの確認

Planning Document（`.ai-workflow/issue-74/00_planning/output/planning.md`）を確認し、以下の開発計画を把握しました：

### 開発戦略
- **実装戦略**: EXTEND（既存テストファイルの拡張）
- **テスト戦略**: UNIT_ONLY（ユニットテストのみ）
- **テストコード戦略**: EXTEND_TEST（既存テストケースの拡張）
- **見積もり工数**: 2〜4時間（約3.5時間）
- **複雑度**: 簡単
- **リスク評価**: 低

### 主要な作業内容
- テストケース2.6.5、2.6.6のbeforeEach/afterEachフックで`JENKINS_HOME`環境変数を削除・復元
- テストの独立性を確保するための環境セットアップ処理の追加
- 将来的な拡張タスク（ESLint ルール追加、SecretMasker統合）の検討と別Issue作成要否の判断

本要件定義書は、この開発計画を踏まえて作成します。

---

## 1. 概要

### 背景
Issue #51「環境変数アクセスを一元化する設定管理を追加」のワークフロー完了後、Evaluation Phase（Phase 9）で3つのフォローアップタスクが識別されました。これらはマージのブロッカーではありませんが、プロジェクトの品質をさらに向上させるために対応が推奨されます。

### 目的
本Issueの目的は、Issue #51のEvaluation Reportで識別された残タスクを完了させることです：

1. **テストコード修正**: `tests/unit/core/config.test.ts`のテストケース2.6.5と2.6.6で、`JENKINS_HOME`環境変数を明示的に削除してテストの環境依存問題を解決
2. **ESLint ルール追加検討**: `no-process-env`ルールの別Issue作成を検討
3. **SecretMasker統合検討**: Config クラスとの統合の別Issue作成を検討

### ビジネス価値・技術的価値

**技術的価値**:
- **テスト品質の向上**: テストの環境依存問題を解決し、100%のテスト成功率を達成
- **テストの独立性**: CI環境（Jenkins）でも確実にテストが成功するようになる
- **将来的な改善の明確化**: ESLint ルール追加とSecretMasker統合の方針を明確にし、次のアクションを定義

**ビジネス価値**:
- **品質保証の強化**: テストの信頼性向上により、Config クラスの動作が保証される
- **開発効率の向上**: 環境に依存しないテストにより、開発者がローカル環境とCI環境の両方で一貫した結果を得られる

---

## 2. 機能要件

### FR-1: テストケース2.6.5の環境依存問題の修正
**優先度**: 高
**説明**: `tests/unit/core/config.test.ts`のテストケース2.6.5（`isCI_正常系_CIがfalseの場合`）で、`JENKINS_HOME`環境変数を明示的に削除する処理を追加します。

**詳細**:
- `beforeEach`フックで`JENKINS_HOME`環境変数を削除（`delete process.env.JENKINS_HOME;`）
- `afterEach`フックで元の値を復元（削除前の値を保存し、復元）
- テストケース内で`CI=false`かつ`JENKINS_HOME`が未設定の状態で`isCI()`が`false`を返すことを検証

**根拠**:
- Evaluation Report（行111-112, 127-222）によると、Jenkins CI環境で`JENKINS_HOME`が既に設定されているため、テストが失敗しています
- 実装コードには問題がなく、テスト環境のセットアップが不完全であることが原因です

---

### FR-2: テストケース2.6.6の環境依存問題の修正
**優先度**: 高
**説明**: `tests/unit/core/config.test.ts`のテストケース2.6.6（`isCI_正常系_CIが0の場合`）で、`JENKINS_HOME`環境変数を明示的に削除する処理を追加します。

**詳細**:
- FR-1と同じ方法で`JENKINS_HOME`環境変数を削除・復元
- テストケース内で`CI=0`かつ`JENKINS_HOME`が未設定の状態で`isCI()`が`false`を返すことを検証

**根拠**:
- FR-1と同じ理由で、テスト環境のセットアップが不完全です

---

### FR-3: ESLint ルール追加（no-process-env）の検討と別Issue作成要否の判断
**優先度**: 低
**説明**: `process.env`への直接アクセスを禁止するESLintルール（`no-process-env`）の追加を検討し、別Issue作成の要否を判断します。

**詳細**:
- Config クラスの使用を強制することで、環境変数アクセスの一貫性をさらに向上
- 既存コードへの影響範囲を評価（`src/core/helpers/env-setup.ts`、`src/core/secret-masker.ts`など）
- 別Issue作成が適切な場合、Issue本文と優先度を定義してEvaluation Phaseで記録

**根拠**:
- Evaluation Report（行269-271）で中期的なアクション（1〜2ヶ月）として推奨されています
- Config クラスの使用を強制することで、将来的なメンテナンス性が向上します

---

### FR-4: SecretMasker との統合の検討と別Issue作成要否の判断
**優先度**: 低
**説明**: Config クラスとSecretMaskerの統合を検討し、別Issue作成の要否を判断します。

**詳細**:
- Config クラスから環境変数リストを取得するようにSecretMaskerを変更
- または、Config クラスに`getSecretEnvVarNames(): string[]`メソッドを追加
- 既存コードへの影響範囲を評価（`src/core/secret-masker.ts`）
- 別Issue作成が適切な場合、Issue本文と優先度を定義してEvaluation Phaseで記録

**根拠**:
- Evaluation Report（行272-276）で中期的なアクション（1〜2ヶ月）として推奨されています
- Config クラスとSecretMaskerの統合により、環境変数管理の一元化が完成します

---

## 3. 非機能要件

### NFR-1: パフォーマンス要件
- **要件**: テストケース修正後も、テストスイート全体の実行時間は従来と同程度（±10%以内）である
- **測定方法**: `npm test`コマンドの実行時間を測定
- **目標値**: 既存の実行時間から10%以上増加しないこと

### NFR-2: 信頼性要件
- **要件**: テストケース2.6.5と2.6.6が、ローカル環境とCI環境（Jenkins）の両方で100%成功する
- **測定方法**: ローカル環境とJenkins CI環境でテストを実行し、成功率を確認
- **目標値**: 両環境で100%成功（56個中56個成功）

### NFR-3: 保守性要件
- **要件**: テストケースの環境変数セットアップ処理は、既存のベストプラクティス（`beforeEach`/`afterEach`フック）に準拠する
- **測定方法**: コードレビューで確認
- **目標値**: 既存の他のテストケース（例: 2.1〜2.5）と同じパターンで実装されていること

### NFR-4: ドキュメント品質要件
- **要件**: 将来的な拡張タスク（ESLint ルール追加、SecretMasker統合）の検討内容が、Evaluation Phaseで明確に記録される
- **測定方法**: Evaluation Reportに検討内容が記載されているか確認
- **目標値**: 別Issue作成の要否、優先度、理由が明記されていること

---

## 4. 制約事項

### 技術的制約
1. **既存テストフレームワークの使用**:
   - Jestテストフレームワークを使用（新規フレームワークの導入は不可）
   - ES modules対応（`NODE_OPTIONS=--experimental-vm-modules`）を維持
2. **既存テストファイルの拡張**:
   - 新規テストファイルの作成は不要（`tests/unit/core/config.test.ts`を修正）
   - 既存のテストケース構造（Given-When-Then）を維持
3. **実装コードへの変更は不可**:
   - `src/core/config.ts`の変更は不要（実装は仕様通りに動作）
   - テストコードのみを修正

### リソース制約
1. **工数制約**: 2〜4時間（Planning Documentの見積もり通り）
2. **スコープ制約**: Issue #51の残タスクのみを対象とし、新機能の追加は含まない

### ポリシー制約
1. **コーディング規約**:
   - TypeScript コーディング規約に準拠（ESLint設定）
   - コメントは必要に応じて追加（環境変数削除の理由を明記）
2. **テスト規約**:
   - 統一loggerモジュール（`src/utils/logger.ts`）を使用
   - `console.log`/`error`/`warn`の直接使用は禁止（ESLint `no-console`ルール）

---

## 5. 前提条件

### システム環境
- **Node.js**: 20以上
- **npm**: 10以上
- **テストフレームワーク**: Jest with ES modules
- **実行環境**: ローカル環境およびJenkins CI環境

### 依存コンポーネント
- **既存ファイル**: `tests/unit/core/config.test.ts`（Issue #51で作成済み）
- **実装コード**: `src/core/config.ts`（Issue #51で作成済み）
- **テストヘルパー**: `fs-extra`（ファイル操作用）

### 外部システム連携
- **Jenkins CI**: テスト実行環境として使用
- **GitHub**: Issueトラッキングと進捗管理

---

## 6. 受け入れ基準

### AC-1: テストケース2.6.5の修正完了
**Given**: `tests/unit/core/config.test.ts`のテストケース2.6.5が存在する
**When**: ローカル環境とJenkins CI環境でテストを実行する
**Then**: テストケース2.6.5が100%成功する

**検証方法**:
- ローカル環境で`npm test`を実行し、テストケース2.6.5が成功することを確認
- Jenkins CI環境でテストを実行し、テストケース2.6.5が成功することを確認

---

### AC-2: テストケース2.6.6の修正完了
**Given**: `tests/unit/core/config.test.ts`のテストケース2.6.6が存在する
**When**: ローカル環境とJenkins CI環境でテストを実行する
**Then**: テストケース2.6.6が100%成功する

**検証方法**:
- ローカル環境で`npm test`を実行し、テストケース2.6.6が成功することを確認
- Jenkins CI環境でテストを実行し、テストケース2.6.6が成功することを確認

---

### AC-3: 環境変数の適切な削除・復元
**Given**: テストケース2.6.5と2.6.6が実行される
**When**: `beforeEach`フックで`JENKINS_HOME`環境変数を削除する
**Then**: テスト実行中に`JENKINS_HOME`が未設定であることが確認できる

**検証方法**:
- テストコードで`process.env.JENKINS_HOME`が`undefined`であることを確認

**Given**: テストケース2.6.5と2.6.6が完了する
**When**: `afterEach`フックで`JENKINS_HOME`環境変数を復元する
**Then**: 他のテストケースに影響を与えないこと

**検証方法**:
- テストスイート全体（56個）を実行し、他のテストケースが成功することを確認

---

### AC-4: テストスイート全体の成功率100%
**Given**: `tests/unit/core/config.test.ts`の全テストケース（56個）が存在する
**When**: ローカル環境とJenkins CI環境でテストを実行する
**Then**: 56個中56個のテストが成功する（100%成功率）

**検証方法**:
- ローカル環境で`npm test -- tests/unit/core/config.test.ts`を実行し、56個すべてが成功することを確認
- Jenkins CI環境でテストを実行し、56個すべてが成功することを確認

---

### AC-5: ESLint ルール追加の検討完了
**Given**: Config クラスの使用を強制するESLintルール（`no-process-env`）の追加が提案されている
**When**: 既存コードへの影響範囲を評価する
**Then**: 別Issue作成の要否が明確に判断され、Evaluation Phaseで記録される

**検証方法**:
- Evaluation Reportに以下が記載されていること：
  - 別Issue作成の要否（「作成する」または「作成しない」）
  - 判断理由（既存コードへの影響範囲、優先度、工数見積もり）
  - 別Issue作成する場合は、Issue本文と優先度の提案

---

### AC-6: SecretMasker統合の検討完了
**Given**: Config クラスとSecretMaskerの統合が提案されている
**When**: 既存コードへの影響範囲を評価する
**Then**: 別Issue作成の要否が明確に判断され、Evaluation Phaseで記録される

**検証方法**:
- Evaluation Reportに以下が記載されていること：
  - 別Issue作成の要否（「作成する」または「作成しない」）
  - 判断理由（既存コードへの影響範囲、優先度、工数見積もり）
  - 別Issue作成する場合は、Issue本文と優先度の提案

---

### AC-7: ドキュメントの更新（必要な場合のみ）
**Given**: テストケースの修正が完了している
**When**: CLAUDE.mdのテスト関連セクションを確認する
**Then**: 環境変数管理のベストプラクティスが追記されているか、追記不要の理由が明確である

**検証方法**:
- CLAUDE.mdに以下のいずれかが記載されていること：
  - 環境変数管理のベストプラクティス（テストコードでの`beforeEach`/`afterEach`の使用）
  - または、既存の記載で十分であるという理由

---

### AC-8: リグレッションなし
**Given**: `tests/unit/core/config.test.ts`の全テストケースが修正されている
**When**: 他のテストファイル（`tests/unit/`配下の他のファイル）を実行する
**Then**: 他のテストに影響がない（既存のテスト成功率を維持）

**検証方法**:
- `npm test`を実行し、すべてのテストが成功することを確認
- テストカバレッジが96.4%以上を維持していることを確認

---

## 7. スコープ外

### 明確にスコープ外とする事項
1. **実装コードの変更**:
   - `src/core/config.ts`の修正は含まない（実装は仕様通りに動作）
   - Config クラスへの新規メソッド追加は含まない
2. **新規テストケースの追加**:
   - 既存の56個のテストケースの修正のみを対象とする
   - 新しいテストシナリオの追加は含まない
3. **ESLint ルールの実装**:
   - `no-process-env`ルールの実装は含まない（検討のみ）
   - 別Issueとして記録する場合は、本Issueでは実装しない
4. **SecretMasker統合の実装**:
   - Config クラスとSecretMaskerの統合実装は含まない（検討のみ）
   - 別Issueとして記録する場合は、本Issueでは実装しない
5. **残りの`process.env`直接アクセスの移行**:
   - `src/core/helpers/env-setup.ts`、`src/core/secret-masker.ts`の移行は含まない
   - 長期的なアクション（3ヶ月以上）として別途対応

### 将来的な拡張候補
1. **ESLint ルール追加**:
   - 優先度: 中
   - 想定工数: 4〜8時間
   - 中期的なアクション（1〜2ヶ月）として推奨
2. **SecretMasker統合**:
   - 優先度: 中
   - 想定工数: 4〜8時間
   - 中期的なアクション（1〜2ヶ月）として推奨
3. **残りの`process.env`直接アクセスの移行**:
   - 優先度: 低
   - 想定工数: 2〜4時間
   - 長期的なアクション（3ヶ月以上）として推奨

---

## 8. 成功基準

本Issueが成功とみなされる条件：

1. ✅ **テストケース2.6.5、2.6.6の環境依存問題が解決されている**
   - ローカル環境とJenkins CI環境の両方で100%成功
   - `JENKINS_HOME`環境変数が適切に削除・復元されている
2. ✅ **すべてのテストがCI環境を含む複数環境で成功している**
   - テストスイート全体（56個）が100%成功
   - テストカバレッジが96.4%以上を維持
3. ✅ **将来的な拡張タスクの方針が明確に記載されている**
   - ESLint ルール追加の検討内容がEvaluation Reportに記載
   - SecretMasker統合の検討内容がEvaluation Reportに記載
   - 別Issue作成の要否が明確に判断されている
4. ✅ **ドキュメントが更新され、今後の参考資料として活用可能である**
   - CLAUDE.mdに環境変数管理のベストプラクティスが追記（必要な場合）
   - Evaluation Reportに将来的な拡張タスクの優先度と工数見積もりが記載

---

## 9. 参考情報

### 関連ドキュメント
- **Planning Document**: `.ai-workflow/issue-74/00_planning/output/planning.md`
- **Issue #51 Evaluation Report**: `.ai-workflow/issue-51/09_evaluation/output/evaluation_report.md`
- **CLAUDE.md**: プロジェクトの全体方針とコーディングガイドライン
- **ARCHITECTURE.md**: アーキテクチャ設計思想

### 関連ファイル
- **テストファイル**: `tests/unit/core/config.test.ts`
- **実装ファイル**: `src/core/config.ts`
- **SecretMasker**: `src/core/secret-masker.ts`
- **env-setup**: `src/core/helpers/env-setup.ts`

### Issue #51の成果物
- **機能要件**: 7つ（FR-1〜FR-7）すべて実装済み
- **受け入れ基準**: 10個（AC-1〜AC-10）すべて達成済み
- **テストカバレッジ**: 96.4%（目標90%を上回る）
- **テスト成功率**: 96.4%（54/56、失敗2件は本Issueで修正）

---

## 10. リスクと対応策

### リスク1: テスト修正が他のテストケースに影響を与える
- **影響度**: 中
- **確率**: 低
- **軽減策**:
  - `beforeEach`/`afterEach`フックの適用範囲を最小限に限定（テストケース2.6.5と2.6.6のみ）
  - テストスイート全体を実行し、リグレッションを早期検出
  - 環境変数の復元処理を確実に実装

### リスク2: CI環境（Jenkins）でのテスト実行時に想定外の問題が発生
- **影響度**: 中
- **確率**: 低
- **軽減策**:
  - Phase 3でCI環境でのテスト実行計画を明確化
  - Phase 6でJenkins環境での実行確認を実施
  - 環境変数の有無による動作確認を徹底（`JENKINS_HOME`あり/なしの両方）

### リスク3: 将来的な拡張タスクの優先度判断が曖昧
- **影響度**: 低
- **確率**: 中
- **軽減策**:
  - Phase 2で別Issue作成要否の判断基準を明確化
  - Phase 7で検討内容を詳細にドキュメント化
  - Phase 8で最終判断を実施し、必要に応じて別Issueを作成

### リスク4: テストコードの修正が不十分で環境依存問題が再発
- **影響度**: 中
- **確率**: 低
- **軽減策**:
  - Phase 4で環境変数の削除・復元処理を確実に実装
  - Phase 6で複数パターン（環境変数あり/なし）のテスト実行
  - コードレビューで環境独立性を確認

---

## 11. タイムライン

想定スケジュール（Planning Documentより）：

| Phase | 作業時間 | 累積時間 |
|-------|---------|---------|
| Phase 0: Planning | 完了 | - |
| Phase 1: Requirements | 0.5h | 0.5h |
| Phase 2: Design | 0.5h | 1.0h |
| Phase 3: Test Scenario | 0.5h | 1.5h |
| Phase 4: Implementation | 0.5h | 2.0h |
| Phase 5: Test Implementation | 0h | 2.0h（Phase 4で完了） |
| Phase 6: Testing | 0.5h | 2.5h |
| Phase 7: Documentation | 0.5h | 3.0h |
| Phase 8: Report | 0.5h | 3.5h |

**合計**: 約3.5時間（余裕を見て2〜4時間）

---

## 12. まとめ

本要件定義書は、Issue #74の詳細な要件を記述したものです。

**重要ポイント**:
- **主作業**: テストケース2.6.5、2.6.6の環境依存問題の修正（`JENKINS_HOME`環境変数の削除・復元）
- **副作業**: 将来的な拡張タスク（ESLint ルール追加、SecretMasker統合）の検討と別Issue作成要否の判断
- **スコープ**: 既存テストコードの修正のみ（実装コードへの変更なし）
- **成功基準**: テスト成功率100%、将来的な拡張タスクの方針の明確化

**品質ゲート（必須要件）**:
1. ✅ **機能要件が明確に記載されている**: FR-1〜FR-4で4つの機能要件を明確に定義
2. ✅ **受け入れ基準が定義されている**: AC-1〜AC-8で8つの受け入れ基準を定義（Given-When-Then形式）
3. ✅ **スコープが明確である**: セクション7でスコープ外の事項を明確に記述
4. ✅ **論理的な矛盾がない**: 各セクション間で矛盾なく整合性を維持

本要件定義書に基づき、次のDesign Phaseで詳細設計を実施します。

---

**作成者**: AI Workflow Phase 1 (Requirements)
**作成日時**: 2025-01-30
**バージョン**: 1.0
