# 要件定義書 - Issue #16

## 0. Planning Documentの確認

Planning Phase (Phase 0) で策定された開発計画を確認しました：

### 開発戦略の概要
- **実装戦略**: EXTEND（既存クラス `GitManager` の機能拡張）
- **テスト戦略**: UNIT_INTEGRATION（ユニットテスト + 統合テスト）
- **テストコード戦略**: EXTEND_TEST（既存テストスイート `tests/unit/core/git-manager.test.ts` に追加）
- **複雑度**: 中程度（4ファイル修正、既存パターン踏襲）
- **見積もり工数**: 8〜12時間
- **リスク評価**: 低（既存パターン踏襲、影響範囲明確、破壊的変更なし）

### 主要な設計判断
1. **新メソッド追加**: `commitWorkflowInit()`, `commitCleanupLogs()` を `GitManager` に追加
2. **既存パターン踏襲**: `commitStepOutput()` と同じインターフェース（`CommitResult` を返す）
3. **4つの修正対象**: `src/core/git-manager.ts`, `src/main.ts`, `src/phases/report.ts`, `src/phases/evaluation.ts`
4. **Phase 0 ログ削除**: Planning Phase の `execute/`, `review/`, `revise/` を削除対象に追加（`output/planning.md` は保持）

---

## 1. 概要

### 背景
現在の AI Workflow では、以下のようなコミットメッセージの問題が存在します：

1. **メタデータ初期化時**: 「Phase 1 (planning) - completed」と表示されるが、実際はワークフロー初期化であり、Planning Phase の完了ではない
2. **ログクリーンアップ時**: Phase番号が誤って「Phase 9 (report)」と表示される（正しくは Phase 8）、またクリーンアップ内容が明示されていない
3. **Planning Phase ログ**: `00_planning/execute/`, `review/`, `revise/` が削除対象外になっており、リポジトリサイズ削減が不十分
4. **Evaluation Phase**: `--cleanup-on-complete` オプションでワークフロー全体削除はできるが、ログのみを削除するオプションがない

### 目的
Git コミット履歴を改善し、以下を実現します：

- **明確なコミット履歴**: 各操作の目的が一目でわかるコミットメッセージ
- **リポジトリサイズの削減**: Planning Phase ログも削除し、約5〜10%のサイズ削減（現状の70%削減から75%削減へ改善）
- **柔軟なクリーンアップ**: Evaluation Phase 完了後に、ログのみ削除か全体削除かを選択可能

### ビジネス価値・技術的価値

**ビジネス価値**:
- **PR レビュー効率化**: コミット履歴が明確になり、レビュワーが変更内容を理解しやすくなる
- **リポジトリサイズ削減**: CI/CD パイプラインの高速化（クローン時間短縮）
- **監査性向上**: コミットメッセージから操作内容が正確に追跡可能

**技術的価値**:
- **コードの一貫性**: 既存パターン（`commitStepOutput`）を踏襲し、保守性を維持
- **拡張性**: 新メソッドは将来的な機能追加にも対応しやすい設計
- **テスト容易性**: ユニットテストで Git 操作を検証可能

---

## 2. 機能要件

### FR-1: ワークフロー初期化時のコミットメッセージ改善
**優先度**: 高

**説明**:
`init` コマンド実行時（`src/main.ts:390`）、メタデータ初回コミットのメッセージを以下の形式に変更する。

**現在の動作**:
```
[ai-workflow] Phase 1 (planning) - completed

Issue: #123
Phase: 1 (planning)
Status: completed
Review: N/A

Auto-generated by AI Workflow
```

**改善後**:
```
[ai-workflow] Initialize workflow for issue #123

Issue: #123
Action: Create workflow metadata and directory structure
Branch: ai-workflow/issue-123

Auto-generated by AI Workflow
```

**実装方法**:
- `GitManager` に `commitWorkflowInit(issueNumber, branchName)` メソッドを追加
- `src/main.ts:390` で `commitPhaseOutput()` の代わりに `commitWorkflowInit()` を呼び出し

---

### FR-2: ログクリーンアップ時のコミットメッセージ改善
**優先度**: 高

**説明**:
Report Phase (Phase 8) および Evaluation Phase (Phase 9) のログクリーンアップ時、正確な Phase 番号と削除内容を明記したコミットメッセージを生成する。

**現在の動作** (Report Phase):
```
[ai-workflow] Phase 9 (report) - completed

Issue: #123
Phase: 9 (report)
Status: completed
Review: N/A

Auto-generated by AI Workflow
```

**改善後** (Report Phase):
```
[ai-workflow] Clean up workflow execution logs

Issue: #123
Phase: 8 (report)
Action: Remove agent execution logs (execute/review/revise directories)
Preserved: metadata.json, output/*.md

Auto-generated by AI Workflow
```

**改善後** (Evaluation Phase):
```
[ai-workflow] Clean up workflow execution logs

Issue: #123
Phase: 9 (evaluation)
Action: Remove agent execution logs (execute/review/revise directories)
Preserved: metadata.json, output/*.md

Auto-generated by AI Workflow
```

**実装方法**:
- `GitManager` に `commitCleanupLogs(issueNumber, phase)` メソッドを追加（`phase: 'report' | 'evaluation'`）
- `src/phases/report.ts:32-33` で `autoCommitAndPush()` を `commitCleanupLogs()` + 手動プッシュに置き換え
- `src/phases/evaluation.ts` でも同様に実装

---

### FR-3: Planning Phase (Phase 0) ログの削除
**優先度**: 高

**説明**:
Report Phase 完了時、Planning Phase (`00_planning`) の実行ログ（`execute/`, `review/`, `revise/`）も削除対象に含める。ただし、`output/planning.md` は Issue 参照ソースとして保持する。

**現在の動作**:
- `00_planning` ディレクトリ全体が削除対象外
- `01_requirements` 〜 `08_report` のみ削除

**改善後**:
- `00_planning/execute/`, `00_planning/review/`, `00_planning/revise/` を削除
- `00_planning/output/planning.md` は保持

**実装方法**:
- `src/phases/report.ts:324` の `phaseDirectories` 配列に `'00_planning'` を追加

---

### FR-4: Evaluation Phase でのログクリーンアップ実装
**優先度**: 中

**説明**:
Evaluation Phase 完了後、`--cleanup-on-complete` オプションが未指定の場合、ログのみを削除する機能を実装する。

**現在の動作**:
- `--cleanup-on-complete` 指定時: ワークフロー全体削除（`.ai-workflow/issue-<NUM>/` 全削除）
- 未指定時: 何も削除しない

**改善後**:
- `--cleanup-on-complete` 指定時: ワークフロー全体削除（既存動作維持）
- 未指定時: ログのみ削除（`execute/`, `review/`, `revise/` を削除、`metadata.json`, `output/*.md` は保持）

**実装方法**:
- `EvaluationPhase` に `cleanupWorkflowLogs()` メソッドを実装（Report Phase と同じパターン）
- `EvaluationPhase.run()` を拡張し、`options.cleanupOnComplete === false` の場合に `cleanupWorkflowLogs()` を実行
- Phase 00〜09 すべてを対象に削除

---

## 3. 非機能要件

### NFR-1: パフォーマンス要件
- **Git 操作の効率性**: コミット・プッシュは既存メソッド（`commitStepOutput`）と同等の処理時間（通常 1〜3秒以内）
- **ファイル削除の効率性**: ログクリーンアップは既存実装（Report Phase）と同等の処理時間（通常 5〜10秒以内、ファイル数に依存）

### NFR-2: 信頼性要件
- **エラーハンドリング**: Git コミット失敗時、適切なエラーメッセージを返し、`CommitResult.success = false` で通知
- **ファイル削除の安全性**: 削除対象ファイルが存在しない場合でもエラーにならず、警告ログのみ出力
- **ロールバック容易性**: コミットメッセージ生成ロジックのみの変更のため、問題発生時は容易にロールバック可能

### NFR-3: 保守性・拡張性要件
- **既存パターン踏襲**: `commitStepOutput()` と同じインターフェース（`CommitResult` を返す）を使用
- **コードの一貫性**: `createCommitMessage()` のフォーマットを参考に、新メソッド `createInitCommitMessage()`, `createCleanupCommitMessage()` を実装
- **テスト容易性**: ユニットテストで Git 操作をモック化し、コミットメッセージフォーマットを検証可能

### NFR-4: セキュリティ要件
- **Git 認証情報**: 既存の `ensureGitConfig()` を使用し、環境変数（`GIT_COMMIT_USER_NAME`, `GIT_COMMIT_USER_EMAIL`）または git config から取得
- **パストラバーサル防止**: ファイル削除時、パス検証を実施（既存実装と同様）

---

## 4. 制約事項

### 技術的制約
- **TypeScript**: Node.js 20+ および TypeScript 5.x を使用
- **Git ライブラリ**: `simple-git` を使用（既存依存関係）
- **ファイル操作**: `fs-extra` を使用（既存依存関係）
- **既存アーキテクチャ**: `GitManager` クラスの拡張のみ、新規クラス作成は不要
- **後方互換性**: 既存のコミット処理（`commitPhaseOutput`, `commitStepOutput`）は影響を受けない

### リソース制約
- **工数**: 8〜12時間（Planning Document の見積もり）
- **テスト**: ユニットテスト + 統合テストの両方を実装（既存テストスイートに追加）

### ポリシー制約
- **コーディング規約**: CLAUDE.md および既存コードのスタイルに従う
- **コミットメッセージ形式**: `[ai-workflow]` プレフィックスを維持
- **ドキュメント**: CLAUDE.md および ARCHITECTURE.md の更新が必須

---

## 5. 前提条件

### システム環境
- Node.js 20 以上
- npm 10 以上
- Git 2.30 以上（`simple-git` の要件）

### 依存コンポーネント
- `simple-git`: Git 操作
- `fs-extra`: ファイル操作
- `@types/node`: TypeScript 型定義

### 外部システム連携
- **GitHub**: リモートリポジトリへのプッシュ
- **CI/CD**: Jenkins 環境での動作保証

---

## 6. 受け入れ基準

### AC-1: ワークフロー初期化時のコミットメッセージ
**Given**: ユーザーが `init` コマンドを実行した
**When**: メタデータ初回コミットが作成される
**Then**:
- コミットメッセージの1行目が `[ai-workflow] Initialize workflow for issue #<NUM>` である
- メッセージ本文に `Issue: #<NUM>`, `Action: Create workflow metadata and directory structure`, `Branch: <BRANCH_NAME>` が含まれる
- `Phase` フィールドが含まれない

### AC-2: Report Phase ログクリーンアップ時のコミットメッセージ
**Given**: Report Phase が完了し、ログクリーンアップが実行された
**When**: クリーンアップのコミットが作成される
**Then**:
- コミットメッセージの1行目が `[ai-workflow] Clean up workflow execution logs` である
- メッセージ本文に `Phase: 8 (report)` が含まれる（Phase 9 ではない）
- メッセージ本文に `Action: Remove agent execution logs (execute/review/revise directories)` が含まれる
- メッセージ本文に `Preserved: metadata.json, output/*.md` が含まれる

### AC-3: Evaluation Phase ログクリーンアップ時のコミットメッセージ
**Given**: Evaluation Phase が完了し、ログクリーンアップが実行された（`--cleanup-on-complete` 未指定）
**When**: クリーンアップのコミットが作成される
**Then**:
- コミットメッセージの1行目が `[ai-workflow] Clean up workflow execution logs` である
- メッセージ本文に `Phase: 9 (evaluation)` が含まれる
- メッセージ本文に `Action: Remove agent execution logs (execute/review/revise directories)` が含まれる
- メッセージ本文に `Preserved: metadata.json, output/*.md` が含まれる

### AC-4: Planning Phase ログの削除
**Given**: Report Phase が完了した
**When**: ログクリーンアップが実行される
**Then**:
- `00_planning/execute/`, `00_planning/review/`, `00_planning/revise/` が削除される
- `00_planning/output/planning.md` が保持される
- `01_requirements` 〜 `08_report` の `execute/`, `review/`, `revise/` も削除される

### AC-5: Evaluation Phase でのログクリーンアップ実行
**Given**: Evaluation Phase が完了し、`--cleanup-on-complete` オプションが未指定
**When**: `EvaluationPhase.run()` が実行される
**Then**:
- `cleanupWorkflowLogs()` メソッドが呼び出される
- `00_planning` 〜 `09_evaluation` の `execute/`, `review/`, `revise/` が削除される
- `metadata.json` および `output/*.md` が保持される
- クリーンアップ後に Git コミット・プッシュが実行される

### AC-6: Evaluation Phase でのワークフロー全体削除（既存動作維持）
**Given**: Evaluation Phase が完了し、`--cleanup-on-complete` オプションが指定された
**When**: `EvaluationPhase.run()` が実行される
**Then**:
- `cleanupWorkflowLogs()` メソッドは呼び出されない
- `cleanupWorkflowArtifacts()` メソッドが呼び出される
- `.ai-workflow/issue-<NUM>/` ディレクトリ全体が削除される

### AC-7: エラーハンドリング
**Given**: Git コミット操作が失敗した
**When**: `commitWorkflowInit()` または `commitCleanupLogs()` が呼び出される
**Then**:
- `CommitResult.success = false` が返される
- `CommitResult.error` にエラーメッセージが含まれる
- コンソールにエラーログが出力される

### AC-8: ファイル不在時の動作
**Given**: コミット対象のファイルが存在しない
**When**: `commitWorkflowInit()` または `commitCleanupLogs()` が呼び出される
**Then**:
- 警告ログ `[WARNING] No files to commit for ...` が出力される
- `CommitResult.success = true` が返される（エラーではない）
- `CommitResult.commit_hash = null` が返される

### AC-9: 後方互換性
**Given**: 既存の `commitPhaseOutput()` または `commitStepOutput()` が呼び出される
**When**: ワークフローが実行される
**Then**:
- 既存のコミット処理は影響を受けず、正常に動作する
- 既存のコミットメッセージ形式は変更されない

### AC-10: テストカバレッジ
**Given**: ユニットテストおよび統合テストが実装された
**When**: `npm run test` が実行される
**Then**:
- 新メソッド（`commitWorkflowInit`, `commitCleanupLogs`）のユニットテストが100%カバーされる
- 統合テストで実際のワークフロー実行が検証される
- すべてのテストが成功する

---

## 7. スコープ外

以下の事項は本 Issue のスコープ外とします：

### 将来的な拡張候補
- **コミットメッセージのカスタマイズ**: ユーザーがコミットメッセージ形式を変更できる機能
- **コミット履歴の可視化**: Web UI でコミット履歴を可視化する機能
- **自動 Squash**: 複数のコミットを自動的に1つにまとめる機能

### 明確にスコープ外とする事項
- **既存のコミットメッセージ形式の変更**: `commitPhaseOutput()`, `commitStepOutput()` のメッセージ形式は変更しない
- **Git フック**: pre-commit, post-commit などの Git フックは使用しない
- **新規依存関係の追加**: 既存の `simple-git`, `fs-extra` のみを使用
- **データベーススキーマ変更**: メタデータの構造は変更しない（コミットメッセージのみ変更）

---

## 8. 実装の優先順位（Planning Document より）

Planning Document で策定された優先順位を踏まえ、以下の順序で実装します：

### 最優先（Phase 4 で最初に実装）
1. **FR-1: メタデータ初期化時のコミットメッセージ改善**
   - 影響度: HIGH（全てのワークフロー初期化で使用される）
   - ユーザー可視性: HIGH（`git log` で最初に表示される）
   - 実装難易度: LOW（新メソッド追加のみ）

### 高優先
2. **FR-2: ログクリーンアップ時のコミットメッセージ改善**
   - 影響度: MEDIUM（Report Phase 完了時のみ）
   - ユーザー可視性: HIGH（コミット履歴が改善される）
   - 実装難易度: LOW（新メソッド追加のみ）

3. **FR-3: Planning (Phase 0) のログ削除**
   - 影響度: MEDIUM（リポジトリサイズ削減）
   - ユーザー可視性: MEDIUM（PR サイズが小さくなる）
   - 実装難易度: VERY LOW（配列に1行追加のみ）

### 中優先
4. **FR-4: Evaluation Phase でのログクリーンアップ**
   - 影響度: LOW（オプション機能の拡張）
   - ユーザー可視性: MEDIUM（柔軟性が向上）
   - 実装難易度: MEDIUM（新メソッド実装 + run() 拡張）

---

## 9. 品質ゲート（Phase 1）

本要件定義書は、以下の品質ゲートを満たしています：

- [x] **機能要件が明確に記載されている**: FR-1〜FR-4 で4つの機能要件を具体的に記載
- [x] **受け入れ基準が定義されている**: AC-1〜AC-10 で10個の受け入れ基準を Given-When-Then 形式で記載
- [x] **スコープが明確である**: スコープ外の項目を明記し、将来的な拡張候補と明確に区別
- [x] **論理的な矛盾がない**: 機能要件と受け入れ基準が対応し、非機能要件と制約事項が矛盾していない

---

## 10. 次のフェーズへの引き継ぎ事項

Design Phase (Phase 2) では、以下を設計してください：

### 設計対象
1. **GitManager の新メソッド設計**
   - `commitWorkflowInit(issueNumber, branchName)` の詳細設計
   - `commitCleanupLogs(issueNumber, phase)` の詳細設計
   - プライベートメソッド `createInitCommitMessage()`, `createCleanupCommitMessage()` の設計

2. **呼び出し側の修正設計**
   - `src/main.ts:390` の修正方法
   - `src/phases/report.ts:32-33` の修正方法
   - `src/phases/evaluation.ts` の新規ログクリーンアップ処理設計

3. **インターフェース整合性確認**
   - `CommitResult` 型の整合性
   - エラーハンドリング設計

### 設計時の考慮事項
- 既存の `commitStepOutput()` パターンを踏襲
- Phase 番号の計算ロジックは `createCommitMessage()` を参考にする
- テストで既存機能に影響がないことを確認できる設計
