# 要件定義書 - Issue #16

## 0. Planning Documentの確認

Planning Phase（Phase 0）で策定された開発計画を確認しました：

### 実装戦略
- **判断**: EXTEND（既存クラスの機能拡張）
- **理由**: GitManagerクラスに新しいメソッドを追加し、既存の呼び出し側を修正する方針
- **影響範囲**: 4ファイル（git-manager.ts, main.ts, report.ts, evaluation.ts）

### テスト戦略
- **判断**: UNIT_INTEGRATION（ユニットテスト + 統合テスト）
- **理由**: コミットメッセージ生成ロジックはユニットテストで検証し、実際のGitコミット動作は統合テストで検証

### リスク評価
- **評価**: 低
- **理由**: 既存パターンの踏襲、影響範囲が明確、破壊的変更なし

### 見積もり工数
- **総工数**: 8〜12時間
- **クリティカルパス**: Phase 0 → Phase 1 → Phase 2 → Phase 4 (Task 4-1) → Phase 4 (Task 4-2/4-3/4-4) → Phase 5 → Phase 6

---

## 1. 概要

### 1.1 背景

現在、AI Workflow Agent v0.3.0では、以下のGitコミットメッセージが不適切な状態になっています：

1. **メタデータ初期化時のコミットメッセージ**: 実際はワークフロー初期化であるにも関わらず、「Phase 1 (planning) - completed」と表示される
2. **ログクリーンアップ時のコミットメッセージ**: Phase番号が間違っている（Report PhaseはPhase 8のはずが9と表示される）
3. **Planning Phase（Phase 0）のログが削除されない**: Report Phase完了後のクリーンアップ対象から除外されている
4. **Evaluation Phase完了後のログクリーンアップが未実装**: ログだけを削除するオプションがない

### 1.2 目的

**ビジネス価値**:
- **明確なコミット履歴**: 各操作の目的が一目でわかり、レビュー効率が向上
- **リポジトリサイズの削減**: Planning Phaseのログも削除することで、PRサイズが約5-10%削減
- **柔軟なクリーンアップオプション**: Evaluation Phase完了後に、ログのみ削除か全体削除かを選択可能

**技術的価値**:
- **コードの一貫性向上**: 既存パターン（commitStepOutput）を踏襲した新メソッドの追加
- **保守性の向上**: コミットメッセージ生成ロジックの分離により、将来の拡張が容易
- **後方互換性の維持**: 既存のコミット処理に影響を与えない設計

### 1.3 スコープ

**対象範囲**:
- GitManagerクラスへの新メソッド追加（commitWorkflowInit, commitCleanupLogs）
- main.ts、report.ts、evaluation.tsの既存コミット呼び出しの修正
- Report Phaseのクリーンアップ対象へのPlanning Phase追加
- Evaluation Phaseへのログクリーンアップ機能実装

**対象外**:
- 既存のコミットメッセージフォーマット変更（commitPhaseOutput, commitStepOutput）
- Git操作の根本的な変更（simple-gitライブラリの置き換えなど）
- メタデータ構造の変更

---

## 2. 機能要件

### 2.1 メタデータ初期化時のコミットメッセージ改善 (優先度: 高)

**要件ID**: REQ-001

**説明**: ワークフロー初期化時（metadata.json作成時）のコミットメッセージを、Phase 1完了ではなく初期化であることを明示する。

**具体的な動作**:

**変更前**:
```
[ai-workflow] Phase 1 (planning) - completed

Issue: #123
Phase: 1 (planning)
Status: completed
Review: N/A

Auto-generated by AI Workflow
```

**変更後**:
```
[ai-workflow] Initialize workflow for issue #123

Issue: #123
Action: Create workflow metadata and directory structure
Branch: ai-workflow/issue-123

Auto-generated by AI Workflow
```

**受け入れ基準**:
- Given: `node dist/index.js init --issue-url https://github.com/owner/repo/issues/123`を実行
- When: メタデータ初期化が完了し、Gitコミットが作成される
- Then: コミットメッセージが「Initialize workflow for issue #123」形式になっている
- And: コミットメッセージにIssue番号、Action、Branch情報が含まれている
- And: Phase番号が含まれていない

---

### 2.2 ログクリーンアップ時のコミットメッセージ改善 (優先度: 高)

**要件ID**: REQ-002

**説明**: Report Phase（Phase 8）およびEvaluation Phase（Phase 9）完了後のログクリーンアップ時のコミットメッセージを、正確なPhase番号と削除内容を明示する。

**具体的な動作**:

**変更前（Report Phase）**:
```
[ai-workflow] Phase 9 (report) - completed

Issue: #123
Phase: 9 (report)
Status: completed
Review: N/A

Auto-generated by AI Workflow
```

**変更後（Report Phase）**:
```
[ai-workflow] Clean up workflow execution logs

Issue: #123
Phase: 8 (report)
Action: Remove agent execution logs (execute/review/revise directories)
Preserved: metadata.json, output/*.md

Auto-generated by AI Workflow
```

**変更後（Evaluation Phase）**:
```
[ai-workflow] Clean up workflow execution logs

Issue: #123
Phase: 9 (evaluation)
Action: Remove agent execution logs (execute/review/revise directories)
Preserved: metadata.json, output/*.md

Auto-generated by AI Workflow
```

**受け入れ基準**:
- Given: Report Phase（Phase 8）が完了
- When: ログクリーンアップが実行され、Gitコミットが作成される
- Then: コミットメッセージが「Clean up workflow execution logs」形式になっている
- And: Phase番号が正確（Report PhaseはPhase 8、Evaluation PhaseはPhase 9）
- And: 削除対象と保護対象が明記されている

---

### 2.3 Planning Phase（Phase 0）のログ削除 (優先度: 高)

**要件ID**: REQ-003

**説明**: Report Phase完了後のクリーンアップで、Planning Phase（00_planning）の実行ログ（execute/review/reviseディレクトリ）を削除対象に追加する。ただし、output/planning.mdは保持する。

**具体的な動作**:

**削除対象**:
- `.ai-workflow/issue-{NUM}/00_planning/execute/`
- `.ai-workflow/issue-{NUM}/00_planning/review/`
- `.ai-workflow/issue-{NUM}/00_planning/revise/`

**保持対象**:
- `.ai-workflow/issue-{NUM}/00_planning/output/planning.md`
- `.ai-workflow/issue-{NUM}/00_planning/metadata.json`（存在する場合）

**受け入れ基準**:
- Given: Report Phase（Phase 8）が完了
- When: ログクリーンアップが実行される
- Then: `00_planning/execute/`、`00_planning/review/`、`00_planning/revise/`ディレクトリが削除される
- And: `00_planning/output/planning.md`が保持される
- And: リポジトリサイズが約5-10%削減される（Planning Phaseログ削除による効果）

---

### 2.4 Evaluation Phaseでのログクリーンアップ実装 (優先度: 中)

**要件ID**: REQ-004

**説明**: Evaluation Phase完了後、`--cleanup-on-complete`オプション未指定時にログクリーンアップを実行する。オプション指定時は既存のワークフロー全体削除が優先される。

**具体的な動作**:

**ケース1: --cleanup-on-complete未指定（デフォルト）**
- 動作: ログのみ削除（Report Phaseと同じクリーンアップ処理）
- 削除対象: `00_planning` 〜 `09_evaluation`の`execute/`、`review/`、`revise/`ディレクトリ
- 保持対象: `metadata.json`、`output/*.md`

**ケース2: --cleanup-on-complete指定**
- 動作: ワークフロー全体削除（既存動作を維持）
- 削除対象: `.ai-workflow/issue-{NUM}/`ディレクトリ全体

**受け入れ基準**:

**ケース1の受け入れ基準**:
- Given: `node dist/index.js execute --issue 123 --phase evaluation`を実行（--cleanup-on-complete未指定）
- When: Evaluation Phaseが正常に完了
- Then: ログクリーンアップが実行される
- And: `00_planning` 〜 `09_evaluation`の`execute/`、`review/`、`revise/`ディレクトリが削除される
- And: `metadata.json`と`output/*.md`が保持される
- And: クリーンアップ結果がGitコミット＆プッシュされる

**ケース2の受け入れ基準**:
- Given: `node dist/index.js execute --issue 123 --phase evaluation --cleanup-on-complete`を実行
- When: Evaluation Phaseが正常に完了
- Then: ワークフロー全体削除が実行される
- And: `.ai-workflow/issue-123/`ディレクトリが完全に削除される
- And: ログクリーンアップは実行されない（全体削除が優先）

---

### 2.5 GitManagerの新メソッド追加 (優先度: 高)

**要件ID**: REQ-005

**説明**: GitManagerクラスに、ワークフロー初期化用とログクリーンアップ用の新メソッドを追加する。

**追加メソッド**:

**メソッド1: commitWorkflowInit**
```typescript
public async commitWorkflowInit(
  issueNumber: number,
  branchName: string
): Promise<CommitResult>
```

- 機能: ワークフロー初期化用のコミットを作成
- 引数:
  - issueNumber: Issue番号
  - branchName: ブランチ名
- 戻り値: CommitResult（success, commit_hash, files_committed, error?）
- コミットメッセージ: `[ai-workflow] Initialize workflow for issue #<NUM>`

**メソッド2: commitCleanupLogs**
```typescript
public async commitCleanupLogs(
  issueNumber: number,
  phase: 'report' | 'evaluation'
): Promise<CommitResult>
```

- 機能: ログクリーンアップ用のコミットを作成
- 引数:
  - issueNumber: Issue番号
  - phase: クリーンアップを実行したフェーズ（'report' or 'evaluation'）
- 戻り値: CommitResult（success, commit_hash, files_committed, error?）
- コミットメッセージ: `[ai-workflow] Clean up workflow execution logs`

**受け入れ基準**:
- Given: GitManagerクラスのインスタンスが作成されている
- When: `commitWorkflowInit(123, 'ai-workflow/issue-123')`を呼び出す
- Then: 成功時に`{ success: true, commit_hash: '...', files_committed: [...] }`が返される
- And: コミットメッセージが正しいフォーマットになっている
- And: ファイルがない場合は警告ログを出力し、`{ success: true, commit_hash: null, files_committed: [] }`を返す

---

## 3. 非機能要件

### 3.1 パフォーマンス要件

**NFR-001: コミット処理の応答時間**
- コミット処理は既存の`commitPhaseOutput`と同等の時間で完了すること
- 目標: 5秒以内（通常のファイル数：10-50ファイル）

**NFR-002: ログクリーンアップの処理時間**
- ログクリーンアップは既存のReport Phaseクリーンアップと同等の時間で完了すること
- 目標: 10秒以内（Phase数：10フェーズ × 3ステップ = 30ディレクトリ）

### 3.2 信頼性要件

**NFR-003: エラーハンドリング**
- Gitコミット失敗時に適切なエラーメッセージを返すこと
- ファイルなし時に警告ログを出力し、エラーとして扱わないこと
- ログクリーンアップ失敗時もワークフロー全体は成功として扱うこと

**NFR-004: トランザクション性**
- コミット処理は既存の`commitStepOutput`と同じエラーハンドリングパターンを踏襲すること
- `--no-verify`フラグを使用し、pre-commit hookをスキップすること

### 3.3 保守性要件

**NFR-005: コードの一貫性**
- 新メソッドは既存の`commitStepOutput`と同じインターフェース（CommitResultを返す）を使用すること
- コミットメッセージ生成ロジックは既存の`createCommitMessage`と同じパターンを踏襲すること

**NFR-006: 拡張性**
- 将来的に他のクリーンアップフェーズが追加されても、`commitCleanupLogs`の`phase`引数を拡張するだけで対応可能なこと

### 3.4 セキュリティ要件

**NFR-007: シークレットマスキング**
- 既存のシークレットマスキング機能（Issue #12）を継承すること
- コミット前に`SecretMasker.maskSecretsInWorkflowDir`を実行すること

---

## 4. 制約事項

### 4.1 技術的制約

**CON-001: 使用ライブラリ**
- Git操作には既存の`simple-git`ライブラリを使用すること
- ファイル操作には既存の`fs-extra`ライブラリを使用すること

**CON-002: 既存システムとの整合性**
- 既存のコミット処理（`commitPhaseOutput`, `commitStepOutput`）に影響を与えないこと
- CommitResult型のインターフェースを維持すること

**CON-003: ファイルパス構造**
- `.ai-workflow/issue-{NUM}/{phase_dir}/{execute|review|revise}/`の構造を変更しないこと
- `output/*.md`の保護パターンを維持すること

### 4.2 リソース制約

**CON-004: 工数**
- 総工数: 8〜12時間（Planning Documentで見積もり済み）
- 実装フェーズ: 2.5〜3.5時間

### 4.3 ポリシー制約

**CON-005: Git設定**
- Git user.name、user.emailは既存の`ensureGitConfig`メソッドで設定すること
- 環境変数`GIT_COMMIT_USER_NAME`、`GIT_COMMIT_USER_EMAIL`を優先すること

**CON-006: コミットメッセージ規約**
- コミットメッセージは必ず`[ai-workflow]`プレフィックスで始まること
- 最終行は`Auto-generated by AI Workflow`で終わること

---

## 5. 前提条件

### 5.1 システム環境

**ENV-001: Node.js環境**
- Node.js 20以上
- npm 10以上

**ENV-002: Git環境**
- Git 2.30以上
- リモートリポジトリ（GitHub）へのアクセス権限

### 5.2 依存コンポーネント

**DEP-001: 既存モジュール**
- `simple-git` v3.x
- `fs-extra` v11.x
- `MetadataManager`クラス
- `SecretMasker`クラス（Issue #12で追加）

**DEP-002: 環境変数**
- `GITHUB_TOKEN`: GitHub パーソナルアクセストークン
- `GITHUB_REPOSITORY`: owner/repo形式のリポジトリ名
- `GIT_COMMIT_USER_NAME`（任意）: Gitコミット作成者名
- `GIT_COMMIT_USER_EMAIL`（任意）: Gitコミット作成者メール

### 5.3 前提動作

**PRE-001: ワークフロー初期化**
- `init`コマンドでメタデータが作成されていること
- `.ai-workflow/issue-{NUM}/metadata.json`が存在すること

**PRE-002: ブランチ状態**
- 対象ブランチ（ai-workflow/issue-{NUM}）が存在すること
- ブランチが正しくチェックアウトされていること

---

## 6. 受け入れ基準

### 6.1 メタデータ初期化時のコミットメッセージ（REQ-001）

**AC-001-1: コミットメッセージフォーマット**
- Given: `node dist/index.js init --issue-url https://github.com/tielec/ai-workflow-agent/issues/16`を実行
- When: メタデータ初期化が完了
- Then: Gitコミットメッセージの1行目が`[ai-workflow] Initialize workflow for issue #16`である
- And: Issue番号、Action、Branch情報が含まれている
- And: Phase番号が含まれていない

**AC-001-2: ファイル範囲**
- Given: 上記と同じ
- When: コミットが作成される
- Then: `.ai-workflow/issue-16/metadata.json`が含まれている
- And: その他の`.ai-workflow/`配下のファイルも含まれている（必要に応じて）

**AC-001-3: エラーハンドリング**
- Given: コミット対象ファイルが存在しない状態
- When: `commitWorkflowInit`を呼び出す
- Then: 警告ログが出力される
- And: `{ success: true, commit_hash: null, files_committed: [] }`が返される

### 6.2 ログクリーンアップ時のコミットメッセージ（REQ-002）

**AC-002-1: Report Phaseのコミットメッセージ**
- Given: Report Phase（Phase 8）が完了
- When: ログクリーンアップが実行され、コミットが作成される
- Then: Gitコミットメッセージの1行目が`[ai-workflow] Clean up workflow execution logs`である
- And: `Phase: 8 (report)`が含まれている
- And: 削除対象と保護対象が明記されている

**AC-002-2: Evaluation Phaseのコミットメッセージ**
- Given: Evaluation Phase（Phase 9）が完了（--cleanup-on-complete未指定）
- When: ログクリーンアップが実行され、コミットが作成される
- Then: Gitコミットメッセージの1行目が`[ai-workflow] Clean up workflow execution logs`である
- And: `Phase: 9 (evaluation)`が含まれている

### 6.3 Planning Phaseのログ削除（REQ-003）

**AC-003-1: 削除対象ディレクトリ**
- Given: Report Phase（Phase 8）が完了
- When: ログクリーンアップが実行される
- Then: `00_planning/execute/`ディレクトリが削除される
- And: `00_planning/review/`ディレクトリが削除される
- And: `00_planning/revise/`ディレクトリが削除される

**AC-003-2: 保護対象ファイル**
- Given: 上記と同じ
- When: ログクリーンアップが実行される
- Then: `00_planning/output/planning.md`が保持される
- And: `00_planning/metadata.json`が保持される（存在する場合）

**AC-003-3: リポジトリサイズ削減**
- Given: 上記と同じ
- When: ログクリーンアップが完了
- Then: リポジトリサイズが約5-10%削減される

### 6.4 Evaluation Phaseのログクリーンアップ（REQ-004）

**AC-004-1: デフォルト動作（ログのみ削除）**
- Given: `node dist/index.js execute --issue 16 --phase evaluation`を実行
- When: Evaluation Phaseが正常に完了
- Then: ログクリーンアップが実行される
- And: `00_planning` 〜 `09_evaluation`の`execute/`、`review/`、`revise/`が削除される
- And: `metadata.json`と`output/*.md`が保持される
- And: クリーンアップ結果がGitコミット＆プッシュされる

**AC-004-2: --cleanup-on-complete指定時（全体削除）**
- Given: `node dist/index.js execute --issue 16 --phase evaluation --cleanup-on-complete`を実行
- When: Evaluation Phaseが正常に完了
- Then: ワークフロー全体削除が実行される
- And: `.ai-workflow/issue-16/`ディレクトリが完全に削除される
- And: ログクリーンアップは実行されない

**AC-004-3: エラー時の動作**
- Given: ログクリーンアップ中にエラーが発生
- When: クリーンアップ処理が失敗
- Then: 警告ログが出力される
- And: ワークフロー全体は成功として扱われる（Evaluation Phaseの結果はPASS）

### 6.5 GitManagerの新メソッド（REQ-005）

**AC-005-1: commitWorkflowInitの正常系**
- Given: GitManagerクラスのインスタンスが作成されている
- When: `commitWorkflowInit(16, 'ai-workflow/issue-16')`を呼び出す
- Then: `{ success: true, commit_hash: '...', files_committed: [...] }`が返される
- And: コミットメッセージが`[ai-workflow] Initialize workflow for issue #16`で始まる

**AC-005-2: commitWorkflowInitの異常系**
- Given: コミット対象ファイルが存在しない
- When: `commitWorkflowInit`を呼び出す
- Then: `{ success: true, commit_hash: null, files_committed: [] }`が返される
- And: 警告ログが出力される

**AC-005-3: commitCleanupLogsの正常系**
- Given: GitManagerクラスのインスタンスが作成されている
- When: `commitCleanupLogs(16, 'report')`を呼び出す
- Then: `{ success: true, commit_hash: '...', files_committed: [...] }`が返される
- And: コミットメッセージが`[ai-workflow] Clean up workflow execution logs`で始まる
- And: `Phase: 8 (report)`が含まれる

**AC-005-4: commitCleanupLogsのPhase番号検証**
- Given: GitManagerクラスのインスタンスが作成されている
- When: `commitCleanupLogs(16, 'report')`を呼び出す
- Then: コミットメッセージに`Phase: 8 (report)`が含まれる（Phase 9ではない）
- When: `commitCleanupLogs(16, 'evaluation')`を呼び出す
- Then: コミットメッセージに`Phase: 9 (evaluation)`が含まれる

### 6.6 後方互換性

**AC-006-1: 既存コミット処理への影響**
- Given: 既存の`commitPhaseOutput`、`commitStepOutput`を使用しているコード
- When: 新しいコミット処理を追加
- Then: 既存のコミット処理が正常に動作する
- And: 既存のワークフローが影響を受けない

**AC-006-2: CommitResult型の互換性**
- Given: 新メソッド（commitWorkflowInit、commitCleanupLogs）
- When: 戻り値を取得
- Then: CommitResult型（success, commit_hash, files_committed, error?）と互換性がある

### 6.7 テストカバレッジ

**AC-007-1: ユニットテストカバレッジ**
- Given: 新メソッド（commitWorkflowInit、commitCleanupLogs）
- When: ユニットテストを実行
- Then: すべての新メソッドが100%カバーされる
- And: コミットメッセージフォーマット検証テストが含まれる
- And: エラーケース（ファイルなし、Git操作失敗）がカバーされる

**AC-007-2: 統合テストカバレッジ**
- Given: ワークフロー実行（init → execute）
- When: 統合テストを実行
- Then: 実際のGitコミット動作が検証される
- And: コミットメッセージが正しいフォーマットになっている

### 6.8 ドキュメント

**AC-008-1: CLAUDE.md更新**
- Given: 新機能が実装される
- When: CLAUDE.mdを確認
- Then: GitManagerの新機能説明が追加されている
- And: コミットメッセージ形式の説明が更新されている

**AC-008-2: ARCHITECTURE.md更新**
- Given: 新機能が実装される
- When: ARCHITECTURE.mdを確認
- Then: Gitコミット処理フローの図が更新されている
- And: 新メソッドの説明が追加されている

---

## 7. スコープ外

### 7.1 明確にスコープ外とする事項

**OUT-001: 既存コミットメッセージフォーマットの変更**
- `commitPhaseOutput`、`commitStepOutput`のコミットメッセージフォーマットは変更しない
- 既存のワークフローに影響を与えないため

**OUT-002: Git操作ライブラリの置き換え**
- `simple-git`ライブラリの置き換えは行わない
- 既存の動作実績を維持するため

**OUT-003: メタデータ構造の変更**
- `metadata.json`のスキーマ変更は行わない
- コミットメッセージ関連のメタデータ追加も不要

**OUT-004: CI/CD環境の変更**
- Jenkinsfileやワークフロー定義の変更は行わない
- 既存のCI/CD環境で動作すること

### 7.2 将来的な拡張候補

**FUT-001: コミットメッセージのカスタマイズ**
- ユーザー定義のコミットメッセージテンプレート機能
- メタデータで設定可能なコミットメッセージフォーマット

**FUT-002: クリーンアップ戦略の柔軟化**
- フェーズごとにクリーンアップ対象を設定可能にする
- クリーンアップタイミングのカスタマイズ（Phase完了時、PR作成時など）

**FUT-003: コミット履歴の分析機能**
- ワークフロー全体のコミット履歴を可視化
- フェーズごとのコミット数、ファイル変更量の統計

**FUT-004: ログアーカイブ機能**
- 削除前にログをアーカイブ（zip圧縮）して保存
- アーカイブファイルの自動アップロード（S3、GCSなど）

---

## 8. 実装の優先順位

Planning Documentで策定された優先順位を踏まえ、以下の順序で実装します：

### 最優先（Phase 4で最初に実装）
1. **REQ-001: メタデータ初期化時のコミットメッセージ改善**
   - 影響度: HIGH（全てのワークフロー初期化で使用される）
   - ユーザー可視性: HIGH（`git log`で最初に表示される）
   - 実装難易度: LOW（新メソッド追加のみ）

### 高優先
2. **REQ-002: ログクリーンアップ時のコミットメッセージ改善**
   - 影響度: MEDIUM（Report Phase完了時のみ）
   - ユーザー可視性: HIGH（コミット履歴が改善される）
   - 実装難易度: LOW（新メソッド追加のみ）

3. **REQ-003: Planning（Phase 0）のログ削除**
   - 影響度: MEDIUM（リポジトリサイズ削減）
   - ユーザー可視性: MEDIUM（PRサイズが小さくなる）
   - 実装難易度: VERY LOW（配列に1行追加のみ）

### 中優先
4. **REQ-004: Evaluation Phaseでのログクリーンアップ**
   - 影響度: LOW（オプション機能の拡張）
   - ユーザー可視性: MEDIUM（柔軟性が向上）
   - 実装難易度: MEDIUM（新メソッド実装 + run()拡張）

---

## 9. 補足情報

### 9.1 関連Issue

- **Issue #12**: シークレットマスキング機能（依存）
- **Issue #405**: ワークフローログクリーンアップ（関連）
- **Issue #411**: Report Phaseクリーンアップの改善（関連）

### 9.2 参考資料

- CLAUDE.md: プロジェクト全体方針とコーディングガイドライン
- ARCHITECTURE.md: アーキテクチャ設計思想とGitコミット処理フロー
- Planning Document: .ai-workflow/issue-16/00_planning/output/planning.md
- Git命名規則: https://git-scm.com/docs/git-check-ref-format

### 9.3 想定される影響範囲

**直接影響**:
- src/core/git-manager.ts（新メソッド追加）
- src/main.ts:390（commitWorkflowInit呼び出し）
- src/phases/report.ts:324（phaseDirectories配列に'00_planning'追加）、32-33（commitCleanupLogs呼び出し）
- src/phases/evaluation.ts（cleanupWorkflowLogs実装、run()拡張）

**間接影響**:
- tests/unit/core/git-manager.test.ts（ユニットテスト追加）
- tests/integration/（統合テスト追加）
- CLAUDE.md、ARCHITECTURE.md（ドキュメント更新）

**影響なし**:
- 既存のコミット処理（commitPhaseOutput、commitStepOutput）
- メタデータ構造（metadata.json）
- CI/CD環境（Jenkinsfile）

---

## 10. 品質ゲート確認

本要件定義書は、以下の品質ゲートを満たしています：

- ✅ **機能要件が明確に記載されている**: REQ-001〜REQ-005の5つの機能要件が具体的に定義されている
- ✅ **受け入れ基準が定義されている**: AC-001〜AC-008の受け入れ基準が明確にGiven-When-Then形式で記載されている
- ✅ **スコープが明確である**: 対象範囲（4ファイルの変更）と対象外（既存コミット処理、メタデータ構造など）が明記されている
- ✅ **論理的な矛盾がない**: 機能要件と受け入れ基準が対応し、非機能要件と制約事項が矛盾していない

---

## 11. まとめ

本要件定義書は、Issue #16「Gitコミットメッセージの改善」の詳細な実装仕様を定義しています。

**主要な改善点**:
1. メタデータ初期化時のコミットメッセージを明確化（REQ-001）
2. ログクリーンアップ時のコミットメッセージを正確化（REQ-002）
3. Planning Phaseのログも削除対象に含める（REQ-003）
4. Evaluation Phaseにログクリーンアップオプションを追加（REQ-004）
5. GitManagerに新メソッド（commitWorkflowInit、commitCleanupLogs）を追加（REQ-005）

**品質保証**:
- 5つの機能要件、8つの受け入れ基準カテゴリ、7つの非機能要件を定義
- Planning Documentで策定された実装戦略（EXTEND）、テスト戦略（UNIT_INTEGRATION）に準拠
- 後方互換性を維持し、既存ワークフローに影響を与えない設計

**次のステップ**:
- Phase 2（設計）: 詳細設計とインターフェース設計
- Phase 3（テストシナリオ）: ユニットテスト・統合テストシナリオの策定
- Phase 4（実装）: GitManager新メソッド実装 → 呼び出し側修正
