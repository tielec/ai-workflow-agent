# テストシナリオ - Issue #16

## 0. Planning Documentの確認

Planning Phase（Phase 0）で策定された開発計画を確認しました：

### テスト戦略
- **判断**: UNIT_INTEGRATION（ユニットテスト + 統合テスト）
- **理由**: コミットメッセージ生成ロジックはユニットテストで検証し、実際のGitコミット動作は統合テストで検証

### テストコード戦略
- **判断**: EXTEND_TEST（既存テストファイル拡張）
- **理由**: `tests/unit/core/git-manager.test.ts`に新メソッドのテストを追加

### テストカバレッジ目標
- **ユニットテスト**: 新メソッド100%カバレッジ
- **統合テスト**: ワークフロー初期化 → コミットメッセージ確認、クリーンアップ → コミットメッセージ確認

---

## 1. テスト戦略サマリー

### 選択されたテスト戦略
**UNIT_INTEGRATION**（Phase 2で決定）

### テスト対象の範囲

#### 実装ファイル（4ファイル）
1. **src/core/git-manager.ts**
   - 新規メソッド: `commitWorkflowInit()`, `commitCleanupLogs()`
   - プライベートメソッド: `createInitCommitMessage()`, `createCleanupCommitMessage()`

2. **src/main.ts**
   - メタデータ初期化後のコミット呼び出し（行390）

3. **src/phases/report.ts**
   - Planning Phaseをクリーンアップ対象に追加（行324）
   - ログクリーンアップ後のコミット処理（行32-33）

4. **src/phases/evaluation.ts**
   - 新規メソッド: `cleanupWorkflowLogs()`
   - `run()`メソッドの拡張

### テストの目的

#### ユニットテストの目的
- コミットメッセージ生成ロジックの正確性を検証
- エラーハンドリング（ファイルなし、Git操作失敗）の動作を検証
- Phase番号の正確性を検証
- モックを使用した分離テストでロジックの健全性を確認

#### 統合テストの目的
- 実際のGitリポジトリでのコミット動作を検証
- コミットメッセージがGitログに正しく記録されることを確認
- ワークフロー全体（初期化 → Phase実行 → クリーンアップ）の統合動作を検証
- ログクリーンアップによるファイル削除とGitコミットの連携を確認

---

## 2. ユニットテストシナリオ

### 2.1 GitManager.commitWorkflowInit() のテスト

#### テストケース 2.1.1: commitWorkflowInit_正常系_ファイルあり

- **目的**: ワークフロー初期化用のコミットが正常に作成されることを検証
- **前提条件**:
  - GitManagerインスタンスが作成されている
  - `.ai-workflow/issue-16/metadata.json`が存在する
  - Gitリポジトリが初期化されている
- **入力**:
  - `issueNumber`: 16
  - `branchName`: "ai-workflow/issue-16"
- **期待結果**:
  - `CommitResult.success`: true
  - `CommitResult.commit_hash`: 非null
  - `CommitResult.files_committed`: 1件以上のファイルパス配列
  - `CommitResult.error`: undefined
- **テストデータ**:
  ```typescript
  const issueNumber = 16;
  const branchName = 'ai-workflow/issue-16';
  ```

#### テストケース 2.1.2: commitWorkflowInit_正常系_ファイルなし

- **目的**: ファイルがない場合、警告ログを出力し、エラーとして扱わないことを検証
- **前提条件**:
  - GitManagerインスタンスが作成されている
  - 変更ファイルが存在しない（空のリポジトリ状態）
- **入力**:
  - `issueNumber`: 16
  - `branchName`: "ai-workflow/issue-16"
- **期待結果**:
  - `CommitResult.success`: true（エラーとして扱わない）
  - `CommitResult.commit_hash`: null
  - `CommitResult.files_committed`: 空配列
  - `CommitResult.error`: undefined
  - 警告ログ: `[WARNING] No files to commit for initialization`
- **テストデータ**: 上記と同じ

#### テストケース 2.1.3: commitWorkflowInit_異常系_Git操作失敗

- **目的**: Git操作が失敗した場合、適切なエラーメッセージが返されることを検証
- **前提条件**:
  - GitManagerインスタンスが作成されている
  - `simple-git`のコミット操作がエラーをスロー（モックで再現）
- **入力**:
  - `issueNumber`: 16
  - `branchName`: "ai-workflow/issue-16"
- **期待結果**:
  - `CommitResult.success`: false
  - `CommitResult.commit_hash`: null
  - `CommitResult.files_committed`: ファイルパス配列（ステージングしたファイル）
  - `CommitResult.error`: "Initialization commit failed: ..."（エラーメッセージ）
  - エラーログ: `[ERROR] Initialization commit failed: ...`
- **テストデータ**: 上記と同じ

#### テストケース 2.1.4: createInitCommitMessage_メッセージフォーマット検証

- **目的**: ワークフロー初期化用のコミットメッセージが正しいフォーマットで生成されることを検証
- **前提条件**: GitManagerインスタンスが作成されている
- **入力**:
  - `issueNumber`: 16
  - `branchName`: "ai-workflow/issue-16"
- **期待結果**: 以下のフォーマットのコミットメッセージが生成される
  ```
  [ai-workflow] Initialize workflow for issue #16

  Issue: #16
  Action: Create workflow metadata and directory structure
  Branch: ai-workflow/issue-16

  Auto-generated by AI Workflow
  ```
- **検証項目**:
  - 1行目: `[ai-workflow] Initialize workflow for issue #16`
  - Issue番号が含まれている
  - Actionが含まれている
  - Branch名が含まれている
  - Phase番号が含まれていない
  - 最終行: `Auto-generated by AI Workflow`

### 2.2 GitManager.commitCleanupLogs() のテスト

#### テストケース 2.2.1: commitCleanupLogs_正常系_Report Phase

- **目的**: Report Phase（Phase 8）のログクリーンアップ用コミットが正常に作成されることを検証
- **前提条件**:
  - GitManagerインスタンスが作成されている
  - クリーンアップによる変更ファイルが存在する
- **入力**:
  - `issueNumber`: 16
  - `phase`: "report"
- **期待結果**:
  - `CommitResult.success`: true
  - `CommitResult.commit_hash`: 非null
  - `CommitResult.files_committed`: 1件以上のファイルパス配列
  - `CommitResult.error`: undefined
- **テストデータ**:
  ```typescript
  const issueNumber = 16;
  const phase = 'report';
  ```

#### テストケース 2.2.2: commitCleanupLogs_正常系_Evaluation Phase

- **目的**: Evaluation Phase（Phase 9）のログクリーンアップ用コミットが正常に作成されることを検証
- **前提条件**: 上記と同じ
- **入力**:
  - `issueNumber`: 16
  - `phase`: "evaluation"
- **期待結果**: テストケース 2.2.1と同じ（Phase番号が9になる）
- **テストデータ**:
  ```typescript
  const issueNumber = 16;
  const phase = 'evaluation';
  ```

#### テストケース 2.2.3: commitCleanupLogs_正常系_ファイルなし

- **目的**: ファイルがない場合、警告ログを出力し、エラーとして扱わないことを検証
- **前提条件**:
  - GitManagerインスタンスが作成されている
  - 変更ファイルが存在しない
- **入力**:
  - `issueNumber`: 16
  - `phase`: "report"
- **期待結果**:
  - `CommitResult.success`: true
  - `CommitResult.commit_hash`: null
  - `CommitResult.files_committed`: 空配列
  - `CommitResult.error`: undefined
  - 警告ログ: `[WARNING] No files to commit for cleanup`
- **テストデータ**: 上記と同じ

#### テストケース 2.2.4: commitCleanupLogs_異常系_Git操作失敗

- **目的**: Git操作が失敗した場合、適切なエラーメッセージが返されることを検証
- **前提条件**:
  - GitManagerインスタンスが作成されている
  - `simple-git`のコミット操作がエラーをスロー（モックで再現）
- **入力**:
  - `issueNumber`: 16
  - `phase`: "report"
- **期待結果**:
  - `CommitResult.success`: false
  - `CommitResult.commit_hash`: null
  - `CommitResult.files_committed`: ファイルパス配列（ステージングしたファイル）
  - `CommitResult.error`: "Cleanup commit failed: ..."（エラーメッセージ）
  - エラーログ: `[ERROR] Cleanup commit failed: ...`
- **テストデータ**: 上記と同じ

#### テストケース 2.2.5: createCleanupCommitMessage_メッセージフォーマット検証_Report

- **目的**: Report Phase用のクリーンアップコミットメッセージが正しいフォーマットで生成されることを検証
- **前提条件**: GitManagerインスタンスが作成されている
- **入力**:
  - `issueNumber`: 16
  - `phase`: "report"
- **期待結果**: 以下のフォーマットのコミットメッセージが生成される
  ```
  [ai-workflow] Clean up workflow execution logs

  Issue: #16
  Phase: 8 (report)
  Action: Remove agent execution logs (execute/review/revise directories)
  Preserved: metadata.json, output/*.md

  Auto-generated by AI Workflow
  ```
- **検証項目**:
  - 1行目: `[ai-workflow] Clean up workflow execution logs`
  - `Phase: 8 (report)`（Phase番号が8であることを確認）
  - Actionが含まれている
  - Preservedが含まれている
  - 最終行: `Auto-generated by AI Workflow`

#### テストケース 2.2.6: createCleanupCommitMessage_メッセージフォーマット検証_Evaluation

- **目的**: Evaluation Phase用のクリーンアップコミットメッセージが正しいフォーマットで生成されることを検証
- **前提条件**: GitManagerインスタンスが作成されている
- **入力**:
  - `issueNumber`: 16
  - `phase`: "evaluation"
- **期待結果**: 以下のフォーマットのコミットメッセージが生成される
  ```
  [ai-workflow] Clean up workflow execution logs

  Issue: #16
  Phase: 9 (evaluation)
  Action: Remove agent execution logs (execute/review/revise directories)
  Preserved: metadata.json, output/*.md

  Auto-generated by AI Workflow
  ```
- **検証項目**:
  - 1行目: `[ai-workflow] Clean up workflow execution logs`
  - `Phase: 9 (evaluation)`（Phase番号が9であることを確認）
  - Actionが含まれている
  - Preservedが含まれている
  - 最終行: `Auto-generated by AI Workflow`

#### テストケース 2.2.7: createCleanupCommitMessage_Phase番号検証

- **目的**: Phase番号が正しく計算されることを検証（Report = 8, Evaluation = 9）
- **前提条件**: GitManagerインスタンスが作成されている
- **入力**:
  - ケース1: `phase = "report"`
  - ケース2: `phase = "evaluation"`
- **期待結果**:
  - ケース1: `Phase: 8 (report)`
  - ケース2: `Phase: 9 (evaluation)`
- **テストデータ**: 上記

### 2.3 既存機能への影響検証テスト

#### テストケース 2.3.1: commitPhaseOutput_後方互換性

- **目的**: 既存の`commitPhaseOutput()`メソッドが引き続き正常に動作することを検証
- **前提条件**:
  - GitManagerインスタンスが作成されている
  - 新メソッドが追加されている
- **入力**:
  - `phaseName`: "requirements"
  - `status`: "completed"
  - `review_result`: "PASS"
- **期待結果**:
  - 既存と同じ動作（CommitResultが返される）
  - コミットメッセージフォーマットが変更されていない
- **テストデータ**: 上記

#### テストケース 2.3.2: commitStepOutput_後方互換性

- **目的**: 既存の`commitStepOutput()`メソッドが引き続き正常に動作することを検証
- **前提条件**: 上記と同じ
- **入力**:
  - `phaseName`: "requirements"
  - `step`: "execute"
- **期待結果**:
  - 既存と同じ動作（CommitResultが返される）
  - コミットメッセージフォーマットが変更されていない
- **テストデータ**: 上記

---

## 3. 統合テストシナリオ

### 3.1 ワークフロー初期化の統合テスト

#### シナリオ 3.1.1: ワークフロー初期化 → コミットメッセージ確認

- **目的**: ワークフロー初期化時のコミットが正しく作成され、Gitログに記録されることを検証
- **前提条件**:
  - 一時的なGitリポジトリが作成されている
  - Git設定（user.name, user.email）が設定されている
  - ワークフローディレクトリが初期化されていない
- **テスト手順**:
  1. `node dist/index.js init --issue-url https://github.com/tielec/ai-workflow-agent/issues/16` を実行
  2. メタデータ初期化が完了するまで待機
  3. `git log -1 --pretty=format:"%s"` でコミットメッセージの1行目を取得
  4. `git log -1 --pretty=format:"%b"` でコミットメッセージの本文を取得
- **期待結果**:
  - コマンドが正常に完了する（終了コード0）
  - Gitコミットが作成される
  - コミットメッセージの1行目: `[ai-workflow] Initialize workflow for issue #16`
  - コミットメッセージの本文に以下が含まれる:
    - `Issue: #16`
    - `Action: Create workflow metadata and directory structure`
    - `Branch: ai-workflow/issue-16`
    - `Auto-generated by AI Workflow`
  - `.ai-workflow/issue-16/metadata.json` が作成される
- **確認項目**:
  - [x] コマンドが正常に完了した
  - [x] Gitコミットが作成された
  - [x] コミットメッセージが正しいフォーマットになっている
  - [x] Issue番号、Action、Branchが含まれている
  - [x] Phase番号が含まれていない
  - [x] メタデータファイルが作成された

#### シナリオ 3.1.2: ワークフロー初期化 → コミットファイル確認

- **目的**: ワークフロー初期化時のコミットに正しいファイルが含まれることを検証
- **前提条件**: 上記と同じ
- **テスト手順**:
  1. `node dist/index.js init --issue-url https://github.com/tielec/ai-workflow-agent/issues/16` を実行
  2. `git log -1 --name-only` でコミットに含まれるファイルを取得
- **期待結果**:
  - `.ai-workflow/issue-16/metadata.json` が含まれる
  - その他のワークフロー関連ファイルが含まれる（ディレクトリ構造）
- **確認項目**:
  - [x] metadata.jsonがコミットに含まれている
  - [x] `.ai-workflow/`配下のファイルがコミットされている

### 3.2 Report Phaseクリーンアップの統合テスト

#### シナリオ 3.2.1: Report Phase完了 → ログクリーンアップ → コミットメッセージ確認

- **目的**: Report Phase完了後のログクリーンアップが正しく実行され、コミットメッセージが正確であることを検証
- **前提条件**:
  - ワークフローが初期化されている（Issue #16）
  - Phase 1-8が完了し、各Phaseの実行ログが存在する
  - `.ai-workflow/issue-16/00_planning/execute/`, `00_planning/review/`, `00_planning/revise/` が存在する
  - GitManagerが利用可能
- **テスト手順**:
  1. `node dist/index.js execute --issue 16 --phase report` を実行（モックエージェントを使用）
  2. Report Phaseが正常に完了するまで待機
  3. `git log -1 --pretty=format:"%s"` でコミットメッセージの1行目を取得
  4. `git log -1 --pretty=format:"%b"` でコミットメッセージの本文を取得
  5. ファイルシステムを確認し、削除されたディレクトリをリストアップ
- **期待結果**:
  - Report Phaseが正常に完了する
  - ログクリーンアップが実行される
  - Gitコミットが作成される
  - コミットメッセージの1行目: `[ai-workflow] Clean up workflow execution logs`
  - コミットメッセージの本文に以下が含まれる:
    - `Issue: #16`
    - `Phase: 8 (report)`（Phase 9ではない）
    - `Action: Remove agent execution logs (execute/review/revise directories)`
    - `Preserved: metadata.json, output/*.md`
    - `Auto-generated by AI Workflow`
  - 以下のディレクトリが削除されている:
    - `.ai-workflow/issue-16/00_planning/execute/`
    - `.ai-workflow/issue-16/00_planning/review/`
    - `.ai-workflow/issue-16/00_planning/revise/`
    - `.ai-workflow/issue-16/01_requirements/execute/`
    - ...（Phase 1-8の実行ログ）
  - 以下のファイルが保持されている:
    - `.ai-workflow/issue-16/00_planning/output/planning.md`
    - `.ai-workflow/issue-16/*/metadata.json`
    - `.ai-workflow/issue-16/*/output/*.md`
- **確認項目**:
  - [x] Report Phaseが正常に完了した
  - [x] ログクリーンアップが実行された
  - [x] Gitコミットが作成された
  - [x] コミットメッセージが正しいフォーマットになっている
  - [x] Phase番号が8である（9ではない）
  - [x] Planning Phase（00_planning）の実行ログが削除された
  - [x] output/planning.mdが保持されている
  - [x] metadata.jsonが保持されている

#### シナリオ 3.2.2: Report Phase完了 → Planning Phase削除確認

- **目的**: Planning Phase（Phase 0）の実行ログが削除され、output/planning.mdが保持されることを検証
- **前提条件**: 上記と同じ
- **テスト手順**:
  1. Report Phase完了後、以下のパスの存在を確認:
     - `.ai-workflow/issue-16/00_planning/execute/`（存在しないはず）
     - `.ai-workflow/issue-16/00_planning/review/`（存在しないはず）
     - `.ai-workflow/issue-16/00_planning/revise/`（存在しないはず）
     - `.ai-workflow/issue-16/00_planning/output/planning.md`（存在するはず）
- **期待結果**:
  - `00_planning/execute/` が存在しない
  - `00_planning/review/` が存在しない
  - `00_planning/revise/` が存在しない
  - `00_planning/output/planning.md` が存在する
- **確認項目**:
  - [x] Planning Phaseの実行ログが削除された
  - [x] Planning Phaseのoutput/planning.mdが保持された

### 3.3 Evaluation Phaseクリーンアップの統合テスト

#### シナリオ 3.3.1: Evaluation Phase完了（デフォルト） → ログのみ削除

- **目的**: Evaluation Phase完了後、`--cleanup-on-complete`未指定時にログのみが削除されることを検証
- **前提条件**:
  - ワークフローが初期化されている（Issue #16）
  - Phase 1-9が完了し、各Phaseの実行ログが存在する
  - GitManagerが利用可能
- **テスト手順**:
  1. `node dist/index.js execute --issue 16 --phase evaluation` を実行（モックエージェントを使用）
  2. Evaluation Phaseが正常に完了するまで待機
  3. `git log -1 --pretty=format:"%s"` でコミットメッセージの1行目を取得
  4. `git log -1 --pretty=format:"%b"` でコミットメッセージの本文を取得
  5. ファイルシステムを確認し、削除されたディレクトリと保持されたファイルをリストアップ
- **期待結果**:
  - Evaluation Phaseが正常に完了する
  - ログクリーンアップが実行される
  - Gitコミットが作成される
  - コミットメッセージの1行目: `[ai-workflow] Clean up workflow execution logs`
  - コミットメッセージの本文に以下が含まれる:
    - `Issue: #16`
    - `Phase: 9 (evaluation)`
    - `Action: Remove agent execution logs (execute/review/revise directories)`
    - `Preserved: metadata.json, output/*.md`
    - `Auto-generated by AI Workflow`
  - 以下のディレクトリが削除されている:
    - `.ai-workflow/issue-16/00_planning/execute/`
    - ...（Phase 0-9の実行ログ）
    - `.ai-workflow/issue-16/09_evaluation/execute/`
    - `.ai-workflow/issue-16/09_evaluation/review/`
    - `.ai-workflow/issue-16/09_evaluation/revise/`
  - 以下のファイルが保持されている:
    - `.ai-workflow/issue-16/*/metadata.json`
    - `.ai-workflow/issue-16/*/output/*.md`
- **確認項目**:
  - [x] Evaluation Phaseが正常に完了した
  - [x] ログクリーンアップが実行された
  - [x] Gitコミットが作成された
  - [x] コミットメッセージが正しいフォーマットになっている
  - [x] Phase番号が9である
  - [x] Phase 0-9の実行ログが削除された
  - [x] output/*.mdが保持されている
  - [x] metadata.jsonが保持されている
  - [x] `.ai-workflow/issue-16/`ディレクトリは残っている（全体削除されていない）

#### シナリオ 3.3.2: Evaluation Phase完了（--cleanup-on-complete指定） → 全体削除

- **目的**: Evaluation Phase完了後、`--cleanup-on-complete`指定時にワークフロー全体が削除されることを検証
- **前提条件**: 上記と同じ
- **テスト手順**:
  1. `node dist/index.js execute --issue 16 --phase evaluation --cleanup-on-complete` を実行
  2. Evaluation Phaseが正常に完了するまで待機
  3. ファイルシステムを確認し、`.ai-workflow/issue-16/`ディレクトリの存在を確認
- **期待結果**:
  - Evaluation Phaseが正常に完了する
  - ワークフロー全体削除が実行される
  - `.ai-workflow/issue-16/`ディレクトリが完全に削除される
  - ログクリーンアップのコミットは作成されない（全体削除が優先）
- **確認項目**:
  - [x] Evaluation Phaseが正常に完了した
  - [x] `.ai-workflow/issue-16/`ディレクトリが存在しない
  - [x] ログクリーンアップコミットが作成されていない

#### シナリオ 3.3.3: Evaluation Phase → ログクリーンアップ失敗 → ワークフロー成功

- **目的**: ログクリーンアップが失敗しても、ワークフロー全体は成功として扱われることを検証
- **前提条件**:
  - ワークフローが初期化されている（Issue #16）
  - ログクリーンアップ中にエラーが発生する状況を模擬（例: ディレクトリがロックされている）
- **テスト手順**:
  1. ログクリーンアップ時にエラーをスローするようモック設定
  2. `node dist/index.js execute --issue 16 --phase evaluation` を実行
  3. 終了コードと警告ログを確認
- **期待結果**:
  - Evaluation Phaseが成功として扱われる（終了コード0）
  - 警告ログが出力される: `[WARNING] Failed to cleanup workflow logs: ...`
  - Gitコミットは作成されない（エラーで中断）
- **確認項目**:
  - [x] Evaluation Phaseが成功として扱われた
  - [x] 警告ログが出力された
  - [x] ワークフロー全体が失敗として扱われていない

### 3.4 エンドツーエンドテスト

#### シナリオ 3.4.1: ワークフロー全体（初期化 → Phase 8 → クリーンアップ）

- **目的**: ワークフロー全体の統合動作を検証
- **前提条件**:
  - 一時的なGitリポジトリが作成されている
  - Git設定が正しく行われている
- **テスト手順**:
  1. `node dist/index.js init --issue-url https://github.com/tielec/ai-workflow-agent/issues/16` を実行
  2. `git log --oneline` で初期化コミットを確認
  3. Phase 1-8を順次実行（モックエージェントを使用）
  4. Report Phase完了後、`git log --oneline` でクリーンアップコミットを確認
  5. ファイルシステムを確認し、実行ログが削除され、成果物が保持されていることを確認
- **期待結果**:
  - 各Phaseが正常に完了する
  - 初期化コミット: `[ai-workflow] Initialize workflow for issue #16`
  - クリーンアップコミット: `[ai-workflow] Clean up workflow execution logs`
  - Phase 0-8の実行ログが削除されている
  - output/*.mdが保持されている
- **確認項目**:
  - [x] ワークフロー全体が正常に完了した
  - [x] 初期化コミットが正しい
  - [x] クリーンアップコミットが正しい
  - [x] 実行ログが削除された
  - [x] 成果物が保持された

---

## 4. テストデータ

### 4.1 正常データ

#### ワークフロー初期化用
```typescript
const issueNumber = 16;
const branchName = 'ai-workflow/issue-16';
const issueUrl = 'https://github.com/tielec/ai-workflow-agent/issues/16';
```

#### ログクリーンアップ用
```typescript
const issueNumber = 16;
const phaseReport = 'report';
const phaseEvaluation = 'evaluation';
```

#### メタデータファイル
```json
{
  "issue_number": "16",
  "branch_name": "ai-workflow/issue-16",
  "created_at": "2025-01-21T00:00:00.000Z",
  "issue_url": "https://github.com/tielec/ai-workflow-agent/issues/16",
  "issue_title": "Gitコミットメッセージの改善"
}
```

### 4.2 異常データ

#### 無効なIssue番号
```typescript
const invalidIssueNumber = -1; // 負の数
const invalidIssueNumber2 = 0; // ゼロ
const invalidIssueNumber3 = NaN; // 非数値
```

#### 無効なブランチ名
```typescript
const invalidBranchName = ''; // 空文字列
const invalidBranchName2 = ' '; // スペースのみ
```

#### 無効なPhase
```typescript
const invalidPhase = 'invalid'; // 'report' or 'evaluation' 以外
const invalidPhase2 = null; // null
const invalidPhase3 = undefined; // undefined
```

### 4.3 境界値データ

#### Issue番号
```typescript
const minIssueNumber = 1; // 最小値
const maxIssueNumber = 999999; // 想定最大値
```

#### ブランチ名
```typescript
const longBranchName = 'ai-workflow/issue-' + '1'.repeat(100); // 長いブランチ名
const shortBranchName = 'ai-workflow/issue-1'; // 短いブランチ名
```

---

## 5. テスト環境要件

### 5.1 ローカル環境

#### 必須環境
- **Node.js**: 20以上
- **npm**: 10以上
- **Git**: 2.30以上
- **OS**: Linux, macOS, Windows（WSL推奨）

#### Git設定
```bash
git config user.name "AI Workflow Test"
git config user.email "test@ai-workflow.local"
```

#### 環境変数
```bash
export GITHUB_TOKEN="test_token_xxxxx"
export GITHUB_REPOSITORY="tielec/ai-workflow-agent"
export GIT_COMMIT_USER_NAME="AI Workflow Test"
export GIT_COMMIT_USER_EMAIL="test@ai-workflow.local"
```

### 5.2 CI/CD環境

#### GitHub Actions要件
- **Ubuntu latest**推奨
- **Git設定**: `actions/checkout@v3`で自動設定
- **シークレット**: `GITHUB_TOKEN`（自動提供）

#### テスト前のセットアップ
```yaml
steps:
  - uses: actions/checkout@v3
  - uses: actions/setup-node@v3
    with:
      node-version: 20
  - run: npm ci
  - run: npm run build
  - run: git config user.name "GitHub Actions"
  - run: git config user.email "actions@github.com"
```

### 5.3 モック/スタブの必要性

#### ユニットテスト用モック

##### simple-git モック
```typescript
const mockGit = {
  add: jest.fn().mockResolvedValue(undefined),
  commit: jest.fn().mockResolvedValue({ commit: 'abc123' }),
  push: jest.fn().mockResolvedValue(undefined),
  status: jest.fn().mockResolvedValue({ files: [] }),
};
```

##### fs-extra モック
```typescript
const mockFs = {
  existsSync: jest.fn().mockReturnValue(true),
  removeSync: jest.fn().mockReturnValue(undefined),
  readJsonSync: jest.fn().mockReturnValue({ issue_number: '16' }),
};
```

#### 統合テスト用モック

##### AIエージェントモック
- Planning, Requirements, Design等の各Phaseエージェントをモック
- 即座に成功を返すダミー実装

##### GitHub API モック
- Issue情報取得APIをモック
- テスト用のIssueデータを返す

---

## 6. テスト実行計画

### 6.1 ユニットテスト実行

#### 実行コマンド
```bash
npm run test:unit
```

#### 対象ファイル
```
tests/unit/core/git-manager.test.ts
```

#### 実行タイミング
- 実装完了後（Phase 4完了後）
- CI/CD: すべてのプルリクエストで実行

#### カバレッジ目標
- **新メソッド**: 100%カバレッジ
- **既存メソッド**: 既存カバレッジを維持

### 6.2 統合テスト実行

#### 実行コマンド
```bash
npm run test:integration
```

#### 対象ファイル
```
tests/integration/workflow-init.test.ts（新規）
tests/integration/workflow-cleanup.test.ts（新規）
```

#### 実行タイミング
- ユニットテスト成功後
- CI/CD: マージ前に実行

#### 実行環境
- 一時的なGitリポジトリを作成
- テスト後にクリーンアップ

### 6.3 テスト順序

1. **Phase 4（実装）完了後**:
   - ユニットテスト実行
   - カバレッジ確認

2. **Phase 5（テスト実装）完了後**:
   - 統合テスト実行
   - エンドツーエンドテスト実行

3. **Phase 6（テスト実行）**:
   - 全テスト実行
   - CI/CD環境でのテスト実行
   - 失敗ケースの修正

---

## 7. 品質ゲート確認

本テストシナリオは、以下の品質ゲートを満たしています：

- ✅ **Phase 2の戦略に沿ったテストシナリオである**: UNIT_INTEGRATION戦略に基づき、ユニットテスト（2.1-2.3）と統合テスト（3.1-3.4）を作成
- ✅ **主要な正常系がカバーされている**:
  - ワークフロー初期化（2.1.1, 3.1.1）
  - ログクリーンアップ（2.2.1, 2.2.2, 3.2.1, 3.3.1）
  - コミットメッセージフォーマット（2.1.4, 2.2.5, 2.2.6）
- ✅ **主要な異常系がカバーされている**:
  - ファイルなし（2.1.2, 2.2.3）
  - Git操作失敗（2.1.3, 2.2.4）
  - ログクリーンアップ失敗（3.3.3）
- ✅ **期待結果が明確である**: すべてのテストケースに「期待結果」と「確認項目」を明記

---

## 8. テスト優先順位

### 高優先度（Phase 6で最初に実行）

1. **ユニットテスト**: GitManager新メソッドの基本動作（2.1.1, 2.2.1）
2. **統合テスト**: ワークフロー初期化（3.1.1）
3. **統合テスト**: Report Phaseクリーンアップ（3.2.1）

### 中優先度

4. **ユニットテスト**: コミットメッセージフォーマット（2.1.4, 2.2.5, 2.2.6）
5. **ユニットテスト**: Phase番号検証（2.2.7）
6. **統合テスト**: Evaluation Phaseクリーンアップ（3.3.1）

### 低優先度

7. **ユニットテスト**: 異常系（2.1.2, 2.1.3, 2.2.3, 2.2.4）
8. **ユニットテスト**: 後方互換性（2.3.1, 2.3.2）
9. **統合テスト**: エラーハンドリング（3.3.3）
10. **統合テスト**: エンドツーエンド（3.4.1）

---

## 9. テストレポート形式

### 9.1 ユニットテストレポート

```
Unit Test Report - Issue #16
============================

Test Suite: GitManager.commitWorkflowInit()
-------------------------------------------
✅ PASS: commitWorkflowInit_正常系_ファイルあり (0.1s)
✅ PASS: commitWorkflowInit_正常系_ファイルなし (0.05s)
✅ PASS: commitWorkflowInit_異常系_Git操作失敗 (0.08s)
✅ PASS: createInitCommitMessage_メッセージフォーマット検証 (0.02s)

Test Suite: GitManager.commitCleanupLogs()
-------------------------------------------
✅ PASS: commitCleanupLogs_正常系_Report Phase (0.1s)
✅ PASS: commitCleanupLogs_正常系_Evaluation Phase (0.1s)
✅ PASS: commitCleanupLogs_正常系_ファイルなし (0.05s)
✅ PASS: commitCleanupLogs_異常系_Git操作失敗 (0.08s)
✅ PASS: createCleanupCommitMessage_メッセージフォーマット検証_Report (0.02s)
✅ PASS: createCleanupCommitMessage_メッセージフォーマット検証_Evaluation (0.02s)
✅ PASS: createCleanupCommitMessage_Phase番号検証 (0.02s)

Coverage Report:
----------------
File: src/core/git-manager.ts
  - commitWorkflowInit: 100%
  - commitCleanupLogs: 100%
  - createInitCommitMessage: 100%
  - createCleanupCommitMessage: 100%

Total: 11 tests, 11 passed, 0 failed
```

### 9.2 統合テストレポート

```
Integration Test Report - Issue #16
====================================

Scenario: ワークフロー初期化 → コミットメッセージ確認
-------------------------------------------
✅ PASS: コマンドが正常に完了した
✅ PASS: Gitコミットが作成された
✅ PASS: コミットメッセージが正しいフォーマットになっている
✅ PASS: Issue番号、Action、Branchが含まれている
✅ PASS: Phase番号が含まれていない
✅ PASS: メタデータファイルが作成された

Scenario: Report Phase完了 → ログクリーンアップ → コミットメッセージ確認
-------------------------------------------
✅ PASS: Report Phaseが正常に完了した
✅ PASS: ログクリーンアップが実行された
✅ PASS: Gitコミットが作成された
✅ PASS: コミットメッセージが正しいフォーマットになっている
✅ PASS: Phase番号が8である（9ではない）
✅ PASS: Planning Phase（00_planning）の実行ログが削除された
✅ PASS: output/planning.mdが保持されている

Total: 10 scenarios, 10 passed, 0 failed
```

---

## 10. まとめ

### テストシナリオの要点

1. **テスト戦略**: UNIT_INTEGRATION（ユニットテスト + 統合テスト）
2. **ユニットテスト**: 11テストケース（GitManager新メソッド、コミットメッセージフォーマット、エラーハンドリング）
3. **統合テスト**: 10シナリオ（ワークフロー初期化、Report/Evaluationクリーンアップ、エンドツーエンド）
4. **カバレッジ目標**: 新メソッド100%、既存機能への影響ゼロ

### 期待される効果

1. **品質保証**: コミットメッセージの正確性、Phase番号の正しさを確認
2. **回帰テスト**: 既存機能への影響がないことを検証
3. **ドキュメント**: 実行可能なテストシナリオが実装の指針となる
4. **継続的改善**: CI/CDで自動実行され、品質を維持

### 次のステップ

- **Phase 4（実装）**: GitManager新メソッド実装 → 呼び出し側修正
- **Phase 5（テスト実装）**: 本テストシナリオに基づいたテストコードの実装
- **Phase 6（テスト実行）**: テスト実行と品質確認

---

**テストシナリオ作成日**: 2025-01-21
**テストシナリオバージョン**: 1.0
**対応Issue**: #16
