# 実装ログ - Issue #16

## 実装サマリー

- **実装戦略**: EXTEND（既存クラスの機能拡張）
- **変更ファイル数**: 4個
- **新規作成ファイル数**: 0個
- **実装日**: 2025-01-21

## 変更ファイル一覧

### 修正

1. **`src/core/git-manager.ts`**: GitManagerクラスに新メソッドを追加
2. **`src/main.ts`**: ワークフロー初期化時のコミット呼び出しを修正
3. **`src/phases/report.ts`**: Planning Phaseをクリーンアップ対象に追加、コミット処理を修正
4. **`src/phases/evaluation.ts`**: ログクリーンアップ機能を追加

## 実装詳細

### ファイル1: src/core/git-manager.ts

**変更内容**: GitManagerクラスに4つの新メソッドを追加

#### 追加メソッド

##### 1. `commitWorkflowInit(issueNumber: number, branchName: string): Promise<CommitResult>`

ワークフロー初期化用のコミットを作成するパブリックメソッド。

**処理フロー**:
1. 変更ファイルを取得（`getChangedFiles()`）
2. Issue番号でフィルタリング（`filterPhaseFiles()`）
3. ファイルがない場合は警告ログを出力して成功を返す
4. ファイルをステージング（`git.add()`）
5. Git設定を確保（`ensureGitConfig()`）
6. コミットメッセージを生成（`createInitCommitMessage()`）
7. コミット実行（`git.commit()`）
8. 成功時は`CommitResult`を返す、失敗時はエラーメッセージ付きで返す

**理由**: 既存の`commitStepOutput()`と同じパターンを踏襲し、エラーハンドリングを統一。

##### 2. `createInitCommitMessage(issueNumber: number, branchName: string): string`

ワークフロー初期化用のコミットメッセージを生成するプライベートメソッド。

**コミットメッセージフォーマット**:
```
[ai-workflow] Initialize workflow for issue #<NUM>

Issue: #<NUM>
Action: Create workflow metadata and directory structure
Branch: <BRANCH_NAME>

Auto-generated by AI Workflow
```

**理由**: 要件定義書（REQ-001）に従い、Phase番号を含まない明確な初期化メッセージを生成。

##### 3. `commitCleanupLogs(issueNumber: number, phase: 'report' | 'evaluation'): Promise<CommitResult>`

ログクリーンアップ用のコミットを作成するパブリックメソッド。

**処理フロー**: `commitWorkflowInit()`と同じパターン、コミットメッセージ生成のみ異なる。

**理由**: コード重複を許容し、既存パターンとの一貫性を優先。

##### 4. `createCleanupCommitMessage(issueNumber: number, phase: 'report' | 'evaluation'): string`

ログクリーンアップ用のコミットメッセージを生成するプライベートメソッド。

**Phase番号計算**:
- `phase === 'report'` → `8`
- `phase === 'evaluation'` → `9`

**コミットメッセージフォーマット**:
```
[ai-workflow] Clean up workflow execution logs

Issue: #<NUM>
Phase: <PHASE_NUM> (<PHASE_NAME>)
Action: Remove agent execution logs (execute/review/revise directories)
Preserved: metadata.json, output/*.md

Auto-generated by AI Workflow
```

**理由**: 要件定義書（REQ-002）に従い、正確なPhase番号と削除内容を明示。

**注意点**:
- 既存の`commitPhaseOutput()`、`commitStepOutput()`には影響を与えない
- `CommitResult`型の戻り値で一貫性を維持
- エラーハンドリングは既存パターンを踏襲

---

### ファイル2: src/main.ts

**変更内容**: ワークフロー初期化時のコミット呼び出しを修正（行387-390）

**変更前**:
```typescript
const commitResult = await gitManager.commitPhaseOutput('planning', 'completed', 'N/A');
```

**変更後**:
```typescript
// コミット & プッシュ (Issue #16: commitWorkflowInit を使用)
const gitManager = new GitManager(repoRoot, metadataManager);
console.info('[INFO] Committing metadata.json...');
const commitResult = await gitManager.commitWorkflowInit(issueNumber, branchName);
```

**理由**:
- メタデータ初期化時のコミットメッセージを「Phase 1 (planning) - completed」から「Initialize workflow for issue #16」に変更
- Issue番号とブランチ名を明示的に渡すことで、コミットメッセージの正確性を向上

**注意点**:
- エラーハンドリングは既存と同じ（`commitResult.success`でチェック）
- コミット失敗時もワークフロー初期化は継続（既存動作を維持）

---

### ファイル3: src/phases/report.ts

**変更内容1**: Planning Phase（00_planning）をクリーンアップ対象に追加（行335）

**変更前**:
```typescript
// Planning フェーズ（00_planning）は削除対象外（Issue参照ソースとして保持）
const phaseDirectories = [
  '01_requirements',
  '02_design',
  ...
];
```

**変更後**:
```typescript
// すべてのフェーズ（00-08）の実行ログを削除（Issue #16）
// ※ output/planning.md は保持される（targetSubdirsに'output'が含まれないため）
const phaseDirectories = [
  '00_planning',
  '01_requirements',
  '02_design',
  ...
];
```

**理由**:
- 要件定義書（REQ-003）に従い、Planning Phaseの実行ログも削除対象に
- `output/planning.md`は保持される（`targetSubdirs = ['execute', 'review', 'revise']`に'output'が含まれないため）

**変更内容2**: コミット処理を`commitCleanupLogs()`に置き換え（行30-44）

**変更前**:
```typescript
if (gitManager) {
  await this.autoCommitAndPush(gitManager, null);
  console.info('[INFO] Cleanup changes committed and pushed.');
}
```

**変更後**:
```typescript
// ログクリーンナップによる削除をコミット・プッシュ（Issue #16: commitCleanupLogs を使用）
if (gitManager) {
  const commitResult = await gitManager.commitCleanupLogs(issueNumber, 'report');

  if (!commitResult.success) {
    throw new Error(`Git commit failed: ${commitResult.error ?? 'unknown error'}`);
  }

  const pushResult = await gitManager.pushToRemote();
  if (!pushResult.success) {
    throw new Error(`Git push failed: ${pushResult.error ?? 'unknown error'}`);
  }

  console.info('[INFO] Cleanup changes committed and pushed.');
}
```

**理由**:
- コミットメッセージを「Phase 9 (report) - completed」から「Clean up workflow execution logs (Phase 8: report)」に変更
- Phase番号を正確に（Report PhaseはPhase 8）

**注意点**:
- エラーハンドリングは厳格に（コミット失敗時は`Error`をスロー）
- try-catchブロックで全体をラップし、クリーンアップ失敗時は警告ログのみ出力

---

### ファイル4: src/phases/evaluation.ts

**変更内容1**: `run()`メソッドの拡張（行18-75）

**変更前**:
```typescript
public async run(options: PhaseRunOptions = {}): Promise<boolean> {
  const success = await super.run(options);

  // 全ての処理が成功した場合のみ、クリーンアップを実行（Issue #2）
  if (success && options.cleanupOnComplete) {
    // ワークフロー全体削除
    ...
  }

  return success;
}
```

**変更後**:
```typescript
public async run(options: PhaseRunOptions = {}): Promise<boolean> {
  const success = await super.run(options);

  // すべての処理が成功し、かつ --cleanup-on-complete 未指定の場合、ログをクリーンアップ（Issue #16）
  if (success && !options.cleanupOnComplete) {
    // ログのみ削除（新規追加）
    await this.cleanupWorkflowLogs(issueNumber);
    // Git commit + push
    const commitResult = await gitManager.commitCleanupLogs(issueNumber, 'evaluation');
    ...
  }

  // オプションが指定されている場合は、ワークフロー全体を削除（Issue #2）
  if (success && options.cleanupOnComplete) {
    // ワークフロー全体削除（既存動作）
    ...
  }

  return success;
}
```

**動作仕様**:
1. **デフォルト（`--cleanup-on-complete`未指定）**:
   - `cleanupWorkflowLogs()`を実行してログのみ削除
   - Gitコミット＆プッシュ（`commitCleanupLogs(issueNumber, 'evaluation')`）
2. **`--cleanup-on-complete`指定時**:
   - `cleanupWorkflowArtifacts()`を実行してワークフロー全体を削除（既存動作）
   - ログクリーンアップは実行されない（全体削除が優先）

**理由**:
- 要件定義書（REQ-004）に従い、柔軟なクリーンアップオプションを実装
- Report Phaseと同じクリーンアップパターンを適用

**変更内容2**: `cleanupWorkflowLogs()`メソッドの追加（行424-477）

Report Phaseの`cleanupWorkflowLogs()`と同じパターンで実装。

**削除対象**:
- `.ai-workflow/issue-{NUM}/00_planning/execute/`
- `.ai-workflow/issue-{NUM}/00_planning/review/`
- `.ai-workflow/issue-{NUM}/00_planning/revise/`
- ...（同様に09_evaluationまで）

**保持対象**:
- `.ai-workflow/issue-{NUM}/*/metadata.json`
- `.ai-workflow/issue-{NUM}/*/output/*.md`

**理由**:
- Report Phaseと同じパターンで一貫性を維持
- Phase 0-9のすべての実行ログを削除（Evaluation Phaseも含む）

**注意点**:
- ログクリーンアップ失敗時もワークフロー全体は成功として扱う（Report Phaseと同じパターン）
- try-catchブロックで全体をラップし、警告ログのみ出力

---

## 品質ゲート確認

### Phase 4（実装）の品質ゲート

- ✅ **Phase 2の設計に沿った実装である**: 設計書（design.md）のセクション7（詳細設計）に従って実装
- ✅ **既存コードの規約に準拠している**:
  - インデント: 2スペース
  - 命名規則: camelCase（メソッド）、PascalCase（クラス）
  - コメント: JSDoc形式
  - エラーハンドリング: try-catchブロック、`console.error()`/`console.warn()`
- ✅ **基本的なエラーハンドリングがある**:
  - ファイルなし時: 警告ログを出力し、`success: true`を返す
  - Git操作失敗時: エラーログを出力し、`success: false`、`error`フィールドにメッセージ
  - ログクリーンアップ失敗時: 警告ログのみ出力、ワークフロー全体は成功として扱う
- ✅ **明らかなバグがない**:
  - Phase番号の計算が正確（Report = 8, Evaluation = 9）
  - ログクリーンアップ対象が正確（00_planning 〜 09_evaluation）
  - 既存機能への影響がない（新メソッドのみ追加、既存メソッドは変更なし）

---

## 実装の意図

### 設計判断

1. **既存パターンの踏襲**:
   - `commitStepOutput()`と同じインターフェース（`CommitResult`を返す）
   - 同じエラーハンドリングパターン
   - 同じログ出力パターン

2. **コード重複の許容**:
   - `commitWorkflowInit()`と`commitCleanupLogs()`は処理フローが似ているが、共通化せず
   - 理由: メソッドの責任を明確にし、将来的な拡張性を確保

3. **Phase番号の計算**:
   - `phase === 'report' ? 8 : 9`という単純な条件分岐
   - 理由: Phase番号は固定（Report = 8, Evaluation = 9）、複雑なロジック不要

4. **Evaluation Phaseの動作優先順位**:
   - `!options.cleanupOnComplete`を先にチェック（ログクリーンアップ）
   - `options.cleanupOnComplete`を後にチェック（全体削除）
   - 理由: デフォルト動作（ログクリーンアップ）を優先、オプション指定時のみ全体削除

### 既存コードとの整合性

1. **GitManager**:
   - 既存メソッド（`commitPhaseOutput`, `commitStepOutput`）に影響なし
   - `CommitResult`型で一貫性を維持

2. **main.ts**:
   - エラーハンドリングは既存と同じ
   - コミット失敗時もワークフロー初期化は継続

3. **report.ts**:
   - `cleanupWorkflowLogs()`の実装は変更なし（対象配列のみ追加）
   - エラーハンドリングパターンは変更なし

4. **evaluation.ts**:
   - `cleanupWorkflowArtifacts()`の既存動作は変更なし
   - 新規追加の`cleanupWorkflowLogs()`はReport Phaseと同じパターン

---

## テストに関する注意事項

**Phase 4では実コードのみを実装し、テストコードは Phase 5（test_implementation）で実装します。**

Phase 5で実装するテストコード（参考）:
- ユニットテスト: `tests/unit/core/git-manager.test.ts`に追加
  - `commitWorkflowInit()`のテスト（正常系、ファイルなし、Git操作失敗）
  - `commitCleanupLogs()`のテスト（正常系、ファイルなし、Git操作失敗、Phase番号検証）
- 統合テスト: `tests/integration/`に追加
  - ワークフロー初期化 → コミットメッセージ確認
  - Report Phaseクリーンアップ → コミットメッセージ確認、Planning Phase削除確認
  - Evaluation Phaseクリーンアップ → コミットメッセージ確認、ログのみ削除確認

---

## 次のステップ

- **Phase 5（test_implementation）**: テストコードを実装
  - ユニットテスト（`commitWorkflowInit`, `commitCleanupLogs`）
  - 統合テスト（ワークフロー初期化、クリーンアップ）
  - コミットメッセージフォーマット検証
- **Phase 6（testing）**: テストを実行
  - `npm run test:unit`
  - `npm run test:integration`
  - カバレッジ確認
- **Phase 7（documentation）**: ドキュメントを更新
  - CLAUDE.md: 新機能説明追加
  - ARCHITECTURE.md: Gitコミット処理フロー更新

---

## まとめ

Issue #16の実装は、既存パターンを踏襲し、後方互換性を維持しながら、Gitコミットメッセージの改善を実現しました。

**主要な改善点**:
1. ワークフロー初期化時のコミットメッセージを明確化
2. ログクリーンアップ時のコミットメッセージを正確化（Phase番号を正しく）
3. Planning Phaseのログも削除対象に含める
4. Evaluation Phaseにログクリーンアップオプションを追加

**実装の特徴**:
- 既存コードへの影響を最小限に
- エラーハンドリングは既存パターンを踏襲
- コード重複を許容し、責任を明確に
- Report PhaseとEvaluation Phaseで一貫性を維持

**品質ゲート**: すべての必須要件を満たしています。
