# 要件定義書

## Issue概要

- **Issue番号**: #545
- **タイトル**: feat: Add GitHub Actions CI workflows for automated testing and build verification
- **状態**: open
- **URL**: https://github.com/tielec/ai-workflow-agent/issues/545

---

## 0. Planning Documentの確認

### 開発計画の全体像

Planning Document（`.ai-workflow/issue-545/00_planning/output/planning.md`）を確認し、以下の戦略を踏まえて要件定義を実施。

| 項目 | 判定 | 根拠 |
|------|------|------|
| **複雑度** | 簡単 | 新規ファイル2つのみ、既存コードへの変更なし |
| **見積もり工数** | 2時間 | ワークフローファイル作成、YAML検証、ドキュメント作成 |
| **リスク評価** | 低 | 実装内容がIssueで完全定義済み、既存コードへの影響ゼロ |
| **実装戦略** | CREATE | 新規ファイル作成のみ |
| **テスト戦略** | UNIT_ONLY | YAML構文検証 + GitHub Actions上での動作確認 |

### Planning Documentで特定されたリスク

1. GitHub Actions実行時の権限不足（低確率・中影響）
2. Codecov連携の失敗（中確率・低影響）
3. Windows環境での予期しないテスト失敗（低確率・中影響）
4. Node.js 18.xでの互換性問題（低確率・中影響）
5. ワークフロープッシュ時の権限エラー（中確率・高影響）

---

## 1. 概要

### 1.1 背景

現在、本プロジェクトのテストは手動実行のみで行われており、PR（Pull Request）マージ前の自動検証が実施されていない。CI/CDパイプラインとしてJenkinsが使用されているが、GitHub Actionsを導入することで、より軽量かつGitHubネイティブなCIワークフローを構築する。

### 1.2 目的

- **リグレッション防止**: すべてのPRで自動テストを実行し、コード品質を維持
- **クロスプラットフォーム検証**: Ubuntu/Windowsでの動作を自動確認
- **Node.jsバージョン互換性検証**: Node.js 18.x/20.xでの互換性を自動検証
- **ビルドプロセス検証**: TypeScriptビルドの正常性を自動確認
- **カバレッジ収集**: コードカバレッジの自動収集（Codecov連携）

### 1.3 ビジネス価値・技術的価値

| カテゴリ | 価値 |
|----------|------|
| **品質保証** | PRマージ前の自動テストにより、バグの早期発見とリグレッション防止 |
| **開発効率** | 手動テスト実行の工数削減、開発者は機能開発に集中可能 |
| **信頼性** | クロスプラットフォーム・マルチバージョン検証による動作保証 |
| **可視性** | カバレッジレポートによるテスト品質の可視化 |
| **標準化** | GitHub Actionsという業界標準のCI/CDツールの採用 |

---

## 2. 機能要件

### 2.1 テストワークフロー（test.yml）

| ID | 要件 | 詳細 | 優先度 |
|----|------|------|--------|
| **FR-001** | ワークフローファイル作成 | `.github/workflows/test.yml`を作成する | 高 |
| **FR-002** | トリガー設定（push） | main/developブランチへのpush時にワークフローを実行する | 高 |
| **FR-003** | トリガー設定（pull_request） | main/developブランチへのPR作成・更新時にワークフローを実行する | 高 |
| **FR-004** | マトリックスビルド（OS） | ubuntu-latest、windows-latestの両環境でテストを実行する | 高 |
| **FR-005** | マトリックスビルド（Node.js） | Node.js 18.x、20.xの両バージョンでテストを実行する | 高 |
| **FR-006** | 依存関係インストール | `npm ci`コマンドで依存関係をクリーンインストールする | 高 |
| **FR-007** | テスト実行 | `npm test`コマンドでテストスイートを実行する | 高 |
| **FR-008** | カバレッジアップロード | Ubuntu + Node.js 20.x環境でのみCodecovにカバレッジをアップロードする | 中 |
| **FR-009** | Codecov連携（graceful） | Codecovアップロード失敗時もCI全体は失敗としない | 中 |
| **FR-010** | npmキャッシュ | `actions/setup-node`のcache機能でnpmキャッシュを有効化する | 中 |

### 2.2 ビルドワークフロー（build.yml）

| ID | 要件 | 詳細 | 優先度 |
|----|------|------|--------|
| **FR-011** | ワークフローファイル作成 | `.github/workflows/build.yml`を作成する | 高 |
| **FR-012** | トリガー設定（push） | main/developブランチへのpush時にワークフローを実行する | 高 |
| **FR-013** | トリガー設定（pull_request） | main/developブランチへのPR作成・更新時にワークフローを実行する | 高 |
| **FR-014** | 実行環境 | ubuntu-latest + Node.js 20.x環境でビルドを実行する | 高 |
| **FR-015** | 依存関係インストール | `npm ci`コマンドで依存関係をクリーンインストールする | 高 |
| **FR-016** | TypeScriptビルド | `npm run build`コマンドでTypeScriptをコンパイルする | 高 |
| **FR-017** | ビルド成果物検証 | `dist`ディレクトリが作成されたことを確認する | 高 |
| **FR-018** | ビルド失敗時エラー | `dist`ディレクトリが存在しない場合、エラー終了する | 高 |

---

## 3. 非機能要件

### 3.1 パフォーマンス要件

| ID | 要件 | 詳細 |
|----|------|------|
| **NFR-001** | テスト実行時間 | マトリックスビルド全体（4パターン）が30分以内に完了すること |
| **NFR-002** | ビルド実行時間 | ビルドワークフローが15分以内に完了すること |
| **NFR-003** | npmキャッシュ活用 | キャッシュヒット時、依存関係インストール時間を50%以上短縮すること |

### 3.2 セキュリティ要件

| ID | 要件 | 詳細 |
|----|------|------|
| **NFR-004** | 公式アクション使用 | GitHub公式/信頼されたアクションのみを使用する（`actions/*`、`codecov/*`） |
| **NFR-005** | バージョン固定 | アクションはメジャーバージョン（`@v4`、`@v3`）で固定する |
| **NFR-006** | シークレット管理 | Codecovトークン等のシークレットはGitHub Secretsで管理する |

### 3.3 可用性・信頼性要件

| ID | 要件 | 詳細 |
|----|------|------|
| **NFR-007** | Codecov障害耐性 | Codecovサービス障害時もCIワークフロー全体は成功とする |
| **NFR-008** | マトリックス独立性 | 1つのマトリックス環境が失敗しても、他の環境のテストは継続実行する |

### 3.4 保守性・拡張性要件

| ID | 要件 | 詳細 |
|----|------|------|
| **NFR-009** | YAML可読性 | ワークフローファイルは適切なコメントと構造化で可読性を確保する |
| **NFR-010** | ジョブ名明確化 | ジョブ名・ステップ名は目的が明確に分かる名称とする |
| **NFR-011** | 拡張容易性 | 将来的なワークフロー追加（lint、deploy等）が容易な構造とする |

---

## 4. 制約事項

### 4.1 技術的制約

| ID | 制約 | 詳細 |
|----|------|------|
| **C-001** | GitHub Actions使用 | CI/CDツールとしてGitHub Actionsを使用する |
| **C-002** | 使用アクションバージョン | `actions/checkout@v4`、`actions/setup-node@v4`、`codecov/codecov-action@v3`を使用する |
| **C-003** | Node.jsバージョン | テストはNode.js 18.x/20.xで実行する（プロジェクトの`engines`は`20+`だが互換性検証のため） |
| **C-004** | テストコマンド | 既存の`npm test`コマンドを使用する（テストスクリプトの変更は行わない） |
| **C-005** | ビルドコマンド | 既存の`npm run build`コマンドを使用する（ビルドスクリプトの変更は行わない） |

### 4.2 リソース制約

| ID | 制約 | 詳細 |
|----|------|------|
| **C-006** | GitHub Actions無料枠 | パブリックリポジトリの無料枠内での実行を想定 |
| **C-007** | 同時実行数 | GitHub Actionsのデフォルト同時実行制限内での動作を想定 |

### 4.3 ポリシー制約

| ID | 制約 | 詳細 |
|----|------|------|
| **C-008** | 既存コード変更禁止 | 本Issueでは`src/`、`tests/`配下のコード変更は行わない |
| **C-009** | 既存設定変更禁止 | `package.json`、`tsconfig.json`等の設定ファイル変更は行わない |

---

## 5. 前提条件

### 5.1 システム環境

| ID | 前提条件 | 詳細 |
|----|----------|------|
| **P-001** | GitHub Actionsの有効化 | リポジトリでGitHub Actionsが有効になっていること |
| **P-002** | ワークフロー書き込み権限 | PRを作成するユーザーにワークフロー書き込み権限があること |

### 5.2 依存コンポーネント

| ID | 前提条件 | 詳細 |
|----|----------|------|
| **P-003** | npm ci対応 | `package-lock.json`が存在し、`npm ci`が正常動作すること |
| **P-004** | テスト正常動作 | `npm test`が正常に実行・完了すること（現在: 143 test suites, 2180 tests） |
| **P-005** | ビルド正常動作 | `npm run build`が正常に実行・完了し、`dist/`ディレクトリを生成すること |
| **P-006** | カバレッジ出力 | テスト実行時に`coverage/lcov.info`が出力されること |

### 5.3 外部システム連携

| ID | 前提条件 | 詳細 |
|----|----------|------|
| **P-007** | Codecov連携（オプション） | Codecov連携は任意。未設定でもCI全体は成功とする |

---

## 6. 受け入れ基準

### 6.1 テストワークフロー（test.yml）

#### AC-001: ワークフローファイルの存在

```gherkin
Given リポジトリに.github/workflows/test.ymlが存在する
When ファイルを確認する
Then 有効なYAML形式であること
And 構文エラーがないこと
```

#### AC-002: pushトリガーの動作

```gherkin
Given main/developブランチにコードがpushされる
When GitHub Actionsがトリガーされる
Then test.ymlワークフローが自動的に開始される
```

#### AC-003: pull_requestトリガーの動作

```gherkin
Given main/developブランチへのPRが作成される
When GitHub Actionsがトリガーされる
Then test.ymlワークフローが自動的に開始される
```

#### AC-004: マトリックスビルドの実行

```gherkin
Given test.ymlワークフローが実行される
When マトリックスビルドが展開される
Then 4つのジョブが作成される（Ubuntu×18.x、Ubuntu×20.x、Windows×18.x、Windows×20.x）
And 各ジョブが並列で実行される
```

#### AC-005: テストの成功

```gherkin
Given すべてのテストがパスする状態のコードがある
When test.ymlワークフローが実行される
Then 4つのマトリックスジョブすべてが成功ステータスで完了する
```

#### AC-006: カバレッジアップロード

```gherkin
Given Ubuntu + Node.js 20.x環境でテストが実行される
When テストが成功する
Then coverage/lcov.infoがCodecovにアップロードされる
And アップロード失敗時もジョブは成功ステータスで完了する
```

### 6.2 ビルドワークフロー（build.yml）

#### AC-007: ワークフローファイルの存在

```gherkin
Given リポジトリに.github/workflows/build.ymlが存在する
When ファイルを確認する
Then 有効なYAML形式であること
And 構文エラーがないこと
```

#### AC-008: ビルドの成功

```gherkin
Given ビルドが成功する状態のコードがある
When build.ymlワークフローが実行される
Then npm run buildが成功する
And distディレクトリが作成される
And ジョブが成功ステータスで完了する
```

#### AC-009: ビルド失敗時の検出

```gherkin
Given ビルドが失敗する状態のコードがある
When build.ymlワークフローが実行される
Then ジョブが失敗ステータスで完了する
And エラーメッセージが出力される
```

#### AC-010: distディレクトリの検証

```gherkin
Given npm run buildが完了する
When distディレクトリ存在チェックが実行される
Then distディレクトリが存在する場合は成功メッセージが出力される
And distディレクトリが存在しない場合はエラーで終了する
```

---

## 7. スコープ外

### 7.1 明確にスコープ外とする事項

| ID | 事項 | 理由 |
|----|------|------|
| **OUT-001** | Jenkins設定の変更 | 既存のJenkins CI/CDは本Issueの対象外 |
| **OUT-002** | デプロイワークフロー | 本Issueはテスト・ビルド検証のみ |
| **OUT-003** | リントワークフロー | 本Issueはテスト・ビルド検証のみ |
| **OUT-004** | READMEへのバッジ追加 | 本Issueの必須要件ではない（将来的な改善として推奨） |
| **OUT-005** | テストコードの変更 | 既存テストへの変更は行わない |
| **OUT-006** | package.jsonの変更 | 既存設定への変更は行わない |
| **OUT-007** | Codecovトークン設定 | リポジトリ管理者タスク（本Issueの実装範囲外） |

### 7.2 将来的な拡張候補

| ID | 候補 | 説明 |
|----|------|------|
| **FUT-001** | ESLint/Prettierワークフロー | コード品質チェックの自動化 |
| **FUT-002** | 依存関係脆弱性スキャン | `npm audit`の自動実行 |
| **FUT-003** | リリースワークフロー | タグ作成時の自動リリース |
| **FUT-004** | PRラベル自動付与 | 変更内容に応じたラベル自動付与 |
| **FUT-005** | ドキュメント生成 | TypeDocによる自動ドキュメント生成 |

---

## 8. 用語定義

| 用語 | 定義 |
|------|------|
| **マトリックスビルド** | 複数の環境・バージョンの組み合わせで並列にジョブを実行するGitHub Actionsの機能 |
| **npm ci** | package-lock.jsonに基づいてクリーンインストールを行うnpmコマンド |
| **Codecov** | コードカバレッジを収集・可視化するサービス |
| **lcov** | カバレッジレポートの標準フォーマット |

---

## 9. 参考資料

- [GitHub Issue #545](https://github.com/tielec/ai-workflow-agent/issues/545)
- [Planning Document](.ai-workflow/issue-545/00_planning/output/planning.md)
- [GitHub Actions Documentation](https://docs.github.com/en/actions)
- [actions/checkout](https://github.com/actions/checkout)
- [actions/setup-node](https://github.com/actions/setup-node)
- [codecov/codecov-action](https://github.com/codecov/codecov-action)

---

## 10. 改訂履歴

| バージョン | 日付 | 変更内容 | 作成者 |
|------------|------|----------|--------|
| 1.0 | - | 初版作成 | AI Workflow Agent |

---

## 11. 品質ゲート確認

| 品質ゲート | 状態 | 備考 |
|------------|------|------|
| 機能要件が明確に記載されている | ✅ | FR-001〜FR-018で18件の機能要件を定義 |
| 受け入れ基準が定義されている | ✅ | AC-001〜AC-010で10件の受け入れ基準をGiven-When-Then形式で定義 |
| スコープが明確である | ✅ | スコープ外事項（OUT-001〜OUT-007）を明記 |
| 論理的な矛盾がない | ✅ | 機能要件と受け入れ基準が対応、制約事項と前提条件が整合 |
