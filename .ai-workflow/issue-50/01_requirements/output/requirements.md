# 要件定義書: Logger抽象化の導入

**Issue番号**: #50
**プロジェクト**: AI Workflow Agent
**作成日**: 2025-01-20
**複雑度**: 中程度
**見積もり工数**: 16~20時間

---

## 0. Planning Documentの確認

Planning Phase（Phase 0）で策定された開発計画を確認しました：

### 実装戦略: CREATE
- 新規ファイル `src/core/logger.ts` を作成（ILogger、ConsoleLogger、LogLevel）
- 既存コードへの影響は置き換えのみ（EXTENDではなくCREATE）
- アーキテクチャ変更ではなく、新規抽象化層の追加

### テスト戦略: UNIT_ONLY
- Loggerクラスは外部依存がなく、ユニットテストのみで十分
- 統合テストは不要（既存のログ出力を置き換えるだけ）
- BDDテストも不要（インフラストラクチャ層の機能）

### テストコード戦略: CREATE_TEST
- 新規テストファイル `tests/unit/core/logger.test.ts` を作成
- 既存テストは修正不要（console.logのモックを置き換える程度）

### リスク評価: 中
- 影響範囲が大きい（40ファイル、329箇所）が、各変更は機械的で単純
- 既存機能への影響は最小限（ロギング出力のみ）
- テストコードへの影響は許容範囲（本番コードを優先）

### スケジュール: 16~20時間
- Logger抽象化の設計・実装: 2~3時間
- 329箇所のconsole呼び出しを段階的に置き換え: 10~12時間
- ユニットテスト作成: 2時間
- ドキュメント更新: 1時間
- レビュー・修正: 1~2時間

---

## 1. 概要

### 1.1 背景

AI Workflow Agent プロジェクトでは、現在コードベース全体に `console.log`、`console.error`、`console.warn`、`console.info` の直接呼び出しが **280箇所**（実測値、Issue記載は278箇所）存在します。この分散したロギング実装により、以下の問題が発生しています：

1. **一元管理の欠如**: ログフォーマットをグローバルに変更できない
2. **責務の混在**: ビジネスロジックとロギングが混在している
3. **制御性の欠如**: ログレベルのフィルタリングができない
4. **テスト困難性**: ロギング動作のテストが困難
5. **構造化データの欠如**: 構造化ログのサポートがない

### 1.2 目的

Logger抽象化を導入し、以下を実現します：

1. **一元化されたロギング設定**: 環境変数でログレベルを制御可能
2. **構造化ログのサポート**: コンテキスト情報を構造化して記録
3. **テスト容易性**: Loggerインターフェースをモック化可能
4. **バックエンドの切り替え**: 将来的にファイル出力や外部サービス連携が容易
5. **本番環境での柔軟性**: ログレベルで詳細度を制御可能

### 1.3 ビジネス価値

- **開発効率向上**: ログ出力の標準化により、デバッグ時間を短縮
- **運用コスト削減**: 本番環境でのログレベル制御により、ログストレージコストを削減
- **品質向上**: テスト可能なロギングにより、エラーハンドリングの品質向上
- **保守性向上**: ロギングバックエンドの切り替えが容易になり、将来的な拡張性向上

### 1.4 技術的価値

- **疎結合化**: ビジネスロジックとロギング実装の分離
- **単一責任原則**: 各クラスがロギング責務を持たず、Loggerに委譲
- **依存性注入**: Loggerインターフェースにより、モック注入が容易
- **拡張性**: ILoggerインターフェースにより、将来的な実装追加が容易（FileLogger、CloudLogger等）

---

## 2. 機能要件

### FR-01: Logger抽象化の実装（優先度: 高）

**説明**: `src/core/logger.ts` にLogger抽象化を実装する。

**詳細要件**:
- **FR-01-1**: `LogLevel` 列挙型を定義する（DEBUG=0, INFO=1, WARN=2, ERROR=3）
- **FR-01-2**: `ILogger` インターフェースを定義する（debug, info, warn, error メソッド）
- **FR-01-3**: `ConsoleLogger` クラスを実装する（ILogger インターフェースを実装）
- **FR-01-4**: シングルトンインスタンス `logger` をエクスポートする

**優先度**: 高（全置き換えの前提条件）

---

### FR-02: ログレベルフィルタリング（優先度: 高）

**説明**: 環境変数 `LOG_LEVEL` に基づいてログレベルをフィルタリングする。

**詳細要件**:
- **FR-02-1**: 環境変数 `LOG_LEVEL` を読み込む（未設定時はデフォルト: INFO）
- **FR-02-2**: `LOG_LEVEL` 以下のレベルのログのみを出力する
  - 例: `LOG_LEVEL=WARN` の場合、WARN と ERROR のみ出力
  - 例: `LOG_LEVEL=DEBUG` の場合、すべてのログを出力
- **FR-02-3**: 無効な `LOG_LEVEL` 値の場合、WARNING を出力してデフォルト（INFO）にフォールバック

**優先度**: 高（本番環境での柔軟性に必須）

---

### FR-03: 構造化ログのサポート（優先度: 高）

**説明**: ログメッセージに加えて、コンテキスト情報を構造化データとして記録する。

**詳細要件**:
- **FR-03-1**: `debug`, `info`, `warn` メソッドは、オプショナルな `context?: Record<string, unknown>` パラメータを受け取る
- **FR-03-2**: `error` メソッドは、`error?: Error` と `context?: Record<string, unknown>` パラメータを受け取る
- **FR-03-3**: コンテキスト情報は JSON 形式で出力する（存在する場合のみ）
- **FR-03-4**: Error オブジェクトはスタックトレースを含めて出力する

**優先度**: 高（ログ集約・分析に必須）

---

### FR-04: console呼び出しの段階的置き換え（優先度: 高）

**説明**: コードベース全体の console 呼び出しを Logger に置き換える。

**詳細要件**:
- **FR-04-1**: `src/commands/` モジュールの console 呼び出しを置き換える（39箇所）
- **FR-04-2**: `src/core/` モジュールの console 呼び出しを置き換える（120箇所）
  - `src/core/git/` サブディレクトリを含む（48箇所）
  - `src/core/github/` サブディレクトリを含む（13箇所）
  - `src/core/helpers/` サブディレクトリを含む（4箇所）
- **FR-04-3**: `src/phases/` モジュールの console 呼び出しを置き換える（98箇所）
  - `src/phases/core/` サブディレクトリを含む（20箇所）
- **FR-04-4**: `tests/` モジュールの console 呼び出しを置き換える（低優先度、必要に応じて、92箇所）

**優先度**: 高（本機能の主要成果物）

**注**: 実測値は280箇所（src配下）、テストコード含めて374箇所。本番コード（src/）を優先し、テストコードは低優先度とする。

---

### FR-05: ログフォーマットの統一（優先度: 中）

**説明**: 既存のログフォーマット `[INFO]`, `[ERROR]`, `[WARNING]` を維持する。

**詳細要件**:
- **FR-05-1**: `debug` メソッドは `[DEBUG]` プレフィックスを付与
- **FR-05-2**: `info` メソッドは `[INFO]` プレフィックスを付与
- **FR-05-3**: `warn` メソッドは `[WARNING]` プレフィックスを付与
- **FR-05-4**: `error` メソッドは `[ERROR]` プレフィックスを付与

**優先度**: 中（既存ログフォーマットとの互換性維持）

---

### FR-06: ユニットテストの実装（優先度: 高）

**説明**: `tests/unit/core/logger.test.ts` にユニットテストを実装する。

**詳細要件**:
- **FR-06-1**: LogLevel フィルタリングのテスト（各レベルでの出力検証）
- **FR-06-2**: 構造化ログのテスト（context パラメータの出力検証）
- **FR-06-3**: エラーロギングのテスト（Error オブジェクトのスタックトレース出力検証）
- **FR-06-4**: 環境変数読み込みのテスト（LOG_LEVEL のパース検証）
- **FR-06-5**: カバレッジ 80% 以上を達成

**優先度**: 高（品質保証に必須）

---

### FR-07: ドキュメント更新（優先度: 中）

**説明**: プロジェクトドキュメントを更新する。

**詳細要件**:
- **FR-07-1**: `README.md` に環境変数 `LOG_LEVEL` の説明を追加
- **FR-07-2**: `ARCHITECTURE.md` に Logger モジュールの説明を追加
- **FR-07-3**: `CLAUDE.md` にロギングガイドライン（使用例、ベストプラクティス）を追加

**優先度**: 中（開発者体験向上）

---

### FR-08: ESLintルール追加（優先度: 低）

**説明**: 今後の console 呼び出しを防止する ESLint ルールを追加する。

**詳細要件**:
- **FR-08-1**: `.eslintrc.cjs` に `no-console` ルールを追加（allow: []）
- **FR-08-2**: 既存の console 呼び出しをすべて置き換えた後に有効化

**優先度**: 低（将来的な品質向上）

**注**: Phase 4 完了後に実施を推奨（Planning Document 参照）

---

## 3. 非機能要件

### NFR-01: パフォーマンス要件

- **NFR-01-1**: Logger のオーバーヘッドは 1 ログ呼び出しあたり 1ms 未満であること
- **NFR-01-2**: LogLevel フィルタリングにより、不要なログ生成を抑制すること
- **NFR-01-3**: 構造化ログの JSON シリアライズは、循環参照を適切に処理すること

**根拠**: AI Workflow Agent は長時間実行されるワークフローを扱うため、ロギングのオーバーヘッドを最小限に抑える必要がある。

---

### NFR-02: セキュリティ要件

- **NFR-02-1**: ログに機密情報（API キー、パスワード、トークン）を出力しないこと
- **NFR-02-2**: エラーメッセージにスタックトレースを含める場合、本番環境では機密情報をマスクすること
- **NFR-02-3**: 構造化ログの context パラメータには、機密情報を含めないこと（開発者責任）

**根拠**: 既存の SecretMasker 機能（`src/core/secret-masker.ts`）と連携し、ログにシークレットが漏洩しないよう保護する。

**注**: 現時点では Logger と SecretMasker の統合は **スコープ外** とする（将来的な拡張候補）。

---

### NFR-03: 可用性・信頼性要件

- **NFR-03-1**: Logger の初期化失敗時も、アプリケーション全体は起動すること（フォールバック: console.log）
- **NFR-03-2**: 無効な LOG_LEVEL 値でもアプリケーションは正常動作すること（デフォルト: INFO）
- **NFR-03-3**: ログ出力の失敗（console.log の例外）がアプリケーション全体の例外を引き起こさないこと

**根拠**: ロギング機能の障害がビジネスロジックに影響を与えないようにする。

---

### NFR-04: 保守性・拡張性要件

- **NFR-04-1**: ILogger インターフェースにより、将来的な実装追加が容易であること（FileLogger、CloudLogger 等）
- **NFR-04-2**: ConsoleLogger の実装は、依存関係を持たないこと（外部ライブラリ不要）
- **NFR-04-3**: ログフォーマットの変更は、ConsoleLogger クラスのみで完結すること（全置き換え箇所への影響なし）

**根拠**: 将来的なロギングバックエンドの拡張や、ログフォーマット変更に対応できるようにする。

---

### NFR-05: テスト容易性要件

- **NFR-05-1**: ILogger インターフェースにより、テスト時にモック注入が可能であること
- **NFR-05-2**: ConsoleLogger の出力は、テスト時に検証可能であること（console.log のモック化）
- **NFR-05-3**: ユニットテストのカバレッジは 80% 以上であること

**根拠**: ロギング機能のテスト容易性を確保し、品質を保証する。

---

## 4. 制約事項

### 4.1 技術的制約

- **C-01**: Node.js 20 以上の環境で動作すること
- **C-02**: 外部ライブラリへの依存を追加しないこと（`winston`, `pino` 等のロギングライブラリは使用しない）
- **C-03**: 既存のログフォーマット `[INFO]`, `[ERROR]`, `[WARNING]` を維持すること（後方互換性）
- **C-04**: TypeScript の型安全性を維持すること（ILogger インターフェースの厳格な型定義）

### 4.2 リソース制約

- **C-05**: 見積もり工数は 16~20 時間以内であること
- **C-06**: 実装は段階的に行い、モジュール単位で置き換えること（一括置き換えは禁止）
- **C-07**: テストコード（tests/）の置き換えは低優先度とし、本番コード（src/）を優先すること

### 4.3 ポリシー制約

- **C-08**: ESLint、TypeScript の既存ルールに準拠すること
- **C-09**: Git コミットメッセージは `[ai-workflow]` プレフィックスを付与すること
- **C-10**: PR レビュー時に、品質ゲート（後述）を満たすこと

---

## 5. 前提条件

### 5.1 システム環境

- **A-01**: Node.js 20 以上がインストールされていること
- **A-02**: npm 10 以上がインストールされていること
- **A-03**: Git がインストールされていること

### 5.2 依存コンポーネント

- **A-04**: 既存のコードベースが正常にビルドできること（`npm run build` が成功）
- **A-05**: 既存のテストが正常にパスすること（`npm test` が成功）

### 5.3 外部システム連携

- **A-06**: 本機能は外部システム連携を必要としない（スタンドアロンで動作）
- **A-07**: 環境変数 `LOG_LEVEL` は任意設定（未設定時はデフォルト: INFO）

---

## 6. 受け入れ基準

### AC-01: Logger抽象化の実装

**Given**: `src/core/logger.ts` ファイルが存在しない
**When**: Logger抽象化を実装する
**Then**:
- `LogLevel` 列挙型が定義されている（DEBUG=0, INFO=1, WARN=2, ERROR=3）
- `ILogger` インターフェースが定義されている（debug, info, warn, error メソッド）
- `ConsoleLogger` クラスが ILogger を実装している
- シングルトンインスタンス `logger` がエクスポートされている

---

### AC-02: ログレベルフィルタリング

**Given**: 環境変数 `LOG_LEVEL=WARN` が設定されている
**When**: `logger.debug("test")`, `logger.info("test")`, `logger.warn("test")`, `logger.error("test")` を実行する
**Then**:
- `debug` と `info` は出力されない
- `warn` と `error` は出力される

**Given**: 環境変数 `LOG_LEVEL` が未設定
**When**: `logger.debug("test")`, `logger.info("test")` を実行する
**Then**:
- `debug` は出力されない
- `info` は出力される（デフォルト: INFO）

**Given**: 環境変数 `LOG_LEVEL=INVALID` が設定されている
**When**: Logger を初期化する
**Then**:
- WARNING ログが出力される（無効な LOG_LEVEL 値）
- デフォルト（INFO）にフォールバックする

---

### AC-03: 構造化ログのサポート

**Given**: Logger が初期化されている
**When**: `logger.info("Phase completed", { phase: "requirements", duration: 1234 })` を実行する
**Then**:
- `[INFO] Phase completed` が出力される
- JSON 形式のコンテキスト `{"phase":"requirements","duration":1234}` が出力される

**Given**: Logger が初期化されている
**When**: `logger.error("Failed", new Error("test error"), { phase: "implementation" })` を実行する
**Then**:
- `[ERROR] Failed` が出力される
- Error オブジェクトのスタックトレースが出力される
- JSON 形式のコンテキスト `{"phase":"implementation"}` が出力される

---

### AC-04: console呼び出しの置き換え

**Given**: `src/commands/`, `src/core/`, `src/phases/` モジュールに console 呼び出しが存在する
**When**: すべての console 呼び出しを Logger に置き換える
**Then**:
- `grep -r "console\.(log|error|warn|info)" src/` の結果が 0 件である（本番コード）
- すべてのログ出力が Logger を経由している
- 既存のログフォーマット `[INFO]`, `[ERROR]`, `[WARNING]` が維持されている

---

### AC-05: ユニットテストの実装

**Given**: `tests/unit/core/logger.test.ts` が実装されている
**When**: `npm run test:unit` を実行する
**Then**:
- すべてのテストがパスする
- カバレッジが 80% 以上である（logger.ts）
- LogLevel フィルタリング、構造化ログ、エラーロギング、環境変数読み込みがテストされている

---

### AC-06: ドキュメント更新

**Given**: ドキュメントが更新されていない
**When**: `README.md`, `ARCHITECTURE.md`, `CLAUDE.md` を更新する
**Then**:
- `README.md` に環境変数 `LOG_LEVEL` の説明が追加されている
- `ARCHITECTURE.md` に Logger モジュールの説明が追加されている
- `CLAUDE.md` にロギングガイドライン（使用例、ベストプラクティス）が追加されている

---

### AC-07: 既存機能への影響がないこと

**Given**: Logger 置き換え前の既存テストがすべてパスしている
**When**: Logger 置き換え後に `npm test` を実行する
**Then**:
- すべての既存テストがパスする（回帰なし）
- ビルドが成功する（`npm run build`）
- ESLint エラーがない

---

## 7. スコープ外

以下の事項は本要件のスコープ外とし、将来的な拡張候補とします：

### 7.1 将来的な拡張候補

- **OUT-01**: ファイルへのログ出力（FileLogger 実装）
- **OUT-02**: 外部ロギングサービスへの送信（CloudLogger 実装、例: AWS CloudWatch、Google Cloud Logging）
- **OUT-03**: Logger と SecretMasker の統合（ログに機密情報を含めない自動マスキング）
- **OUT-04**: ログローテーション機能
- **OUT-05**: ログの圧縮・アーカイブ機能
- **OUT-06**: ログの検索・フィルタリング UI
- **OUT-07**: ログのリアルタイム監視・アラート機能

### 7.2 明確にスコープ外とする事項

- **OUT-08**: 既存の console 呼び出しの完全な削除（console.log は残る可能性がある、テストコード等）
- **OUT-09**: ログフォーマットの大幅な変更（既存フォーマット `[INFO]`, `[ERROR]` を維持）
- **OUT-10**: 外部ライブラリの使用（`winston`, `pino`, `bunyan` 等）
- **OUT-11**: ログの国際化（i18n）対応

---

## 8. 品質ゲート（Phase 1: Requirements）

本要件定義書は、以下の品質ゲートを満たしています：

- [x] **機能要件が明確に記載されている**
  - FR-01 ~ FR-08 で 8 つの機能要件を定義
  - 各要件は優先度（高/中/低）を付与
  - 詳細要件（FR-XX-Y）で具体的な実装内容を記述

- [x] **受け入れ基準が定義されている**
  - AC-01 ~ AC-07 で 7 つの受け入れ基準を定義
  - Given-When-Then 形式で検証可能な形で記述
  - 各機能要件に対応する受け入れ基準を定義

- [x] **スコープが明確である**
  - 機能要件（FR-01 ~ FR-08）で実施範囲を定義
  - スコープ外（OUT-01 ~ OUT-11）で将来的な拡張候補を明示
  - 制約事項（C-01 ~ C-10）で技術的・リソース的制約を明示

- [x] **論理的な矛盾がない**
  - Planning Document の戦略（CREATE、UNIT_ONLY、CREATE_TEST）と整合
  - 見積もり工数（16~20時間）と機能要件の範囲が整合
  - 非機能要件（NFR-01 ~ NFR-05）と機能要件が矛盾していない

---

## 9. トレーサビリティマトリクス

| Issue TODO | 機能要件 | 受け入れ基準 |
|-----------|---------|------------|
| Logger抽象化の作成 | FR-01, FR-02, FR-03, FR-05 | AC-01, AC-02, AC-03 |
| console呼び出しの段階的置き換え | FR-04 | AC-04, AC-07 |
| 環境変数からログレベルを設定 | FR-02 | AC-02 |
| ユニットテスト作成 | FR-06 | AC-05 |
| ドキュメント更新 | FR-07 | AC-06 |
| ESLintルール追加（任意） | FR-08 | （スコープ外、Phase 4完了後） |

---

## 10. リスクと軽減策

Planning Document で策定されたリスクと軽減策を確認します：

| リスク | 影響度 | 確率 | 軽減策 |
|-------|-------|------|-------|
| console呼び出しの置き換え漏れ | 中 | 中 | Grepツールで全ファイル検索、ESLintルール追加、CI/CD静的解析 |
| 既存機能への影響（ログ出力変更） | 低 | 低 | 既存ログフォーマット維持、テストで出力形式検証、段階的ロールアウト |
| パフォーマンス低下 | 低 | 低 | シンプルな実装、LogLevelフィルタリング、ベンチマーク実施 |
| テストコードへの影響 | 中 | 中 | テストコードは低優先度、必要に応じてLoggerモック作成、後方互換性維持 |

---

## 11. 参照ドキュメント

- **Planning Document**: `.ai-workflow/issue-50/00_planning/output/planning.md`
- **GitHub Issue**: https://github.com/tielec/ai-workflow-agent/issues/50
- **CLAUDE.md**: プロジェクトの全体方針とコーディングガイドライン
- **ARCHITECTURE.md**: アーキテクチャ設計思想
- **README.md**: プロジェクト概要と使用方法

---

**作成者**: AI Workflow Agent (Phase 1: Requirements)
**レビュー状態**: Pending
**次フェーズ**: Phase 2 (Design)
