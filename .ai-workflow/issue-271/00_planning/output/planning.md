# プロジェクト計画書

**Issue番号**: #271
**タイトル**: feat(rollback): Add auto mode with agent-based rollback target detection
**作成日**: 2025-12-06

---

## 1. プロジェクト概要

### 1.1 背景と目的

現在の `rollback` コマンドは、差し戻し先フェーズ、ステップ、理由を手動で指定する必要があります。しかし、Review 実行後であれば、エージェントが metadata.json と最新の生成ドキュメント（レビュー結果、テスト結果）を分析することで、差し戻しの必要性と適切な差し戻し先を自動判断できます。

本機能では、`rollback auto` サブコマンドを追加し、Codex/Claude エージェントによる自動判断を実現します。

### 1.2 スコープ

**対象範囲（In Scope）**:
- `rollback auto` サブコマンドの CLI 追加
- エージェント判断ロジックの実装（metadata.json、レビュー結果、テスト結果の分析）
- JSON 出力パースとバリデーション
- confidence レベルに応じた確認プロンプト
- 既存 rollback コマンドとの統合

**対象外範囲（Out of Scope）**:
- 既存 rollback コマンドの仕様変更
- 手動 rollback 時の自動判断機能の追加
- エージェント以外の判断ロジック（ルールベース）

### 1.3 複雑度と工数見積もり

- **複雑度**: 中程度
- **見積もり工数**: 12~16時間
- **リスク評価**: 中
  - エージェント出力の不安定性（高影響、中確率）
  - エージェント判断精度の問題（中影響、中確率）

---

## 2. 戦略定義

### 2.1 実装戦略

**選択された戦略**: **EXTEND**

**理由**:
- 既存の `rollback.ts` に `auto` サブコマンドを追加する形で実装
- `executeRollback()` などの既存関数を再利用することでコード重複を回避
- CLI パーサーの拡張とエージェント統合ロジックの追加のみで実現可能

### 2.2 テスト戦略

**選択された戦略**: **UNIT_INTEGRATION**

**理由**:
- ユニットテストでは、JSON パース処理、バリデーション、confidence 制御ロジックを個別にテスト
- 統合テストでは、エージェント呼び出しからロールバック実行までのエンドツーエンドの動作を確認
- エージェント出力のモック化により、決定論的なテストが可能

### 2.3 テストコード戦略

**選択された戦略**: **BOTH_TEST**

**理由**:
- 既存 rollback コマンドのリグレッションテストを拡張（既存テストに auto モードのケースを追加）
- 新規に auto モード専用のテストファイル（`rollback-auto.test.ts`）を作成
- ユニットテストと統合テストの両方で網羅的にカバー

---

## 3. 影響範囲分析

### 3.1 変更対象ファイル

| ファイルパス | 変更内容 | 影響度 |
|------------|---------|-------|
| `src/commands/rollback.ts` | `handleRollbackAutoCommand()` 追加、CLI パーサー拡張 | 高 |
| `src/prompts/rollback/auto-analyze.txt` | エージェント判断プロンプトテンプレート（新規作成） | 高 |
| `src/main.ts` | `rollback auto` サブコマンドの登録 | 中 |
| `src/types/commands.ts` | `RollbackDecision` 型定義追加 | 中 |
| `tests/commands/rollback.test.ts` | 既存テストの拡張（リグレッションテスト） | 中 |
| `tests/commands/rollback-auto.test.ts` | 新規テストファイル（auto モード専用） | 高 |
| `README.md` | CLI ヘルプ、使用例の追加 | 低 |

### 3.2 影響を受けるモジュール

- **CLI Parser**: `rollback auto` サブコマンドの認識とオプション解析
- **Agent Executor**: `AgentExecutor` クラスを使用してエージェント呼び出し
- **Metadata Reader**: `MetadataManager` を使用して metadata.json を読み込み
- **File Finder**: 最新のレビュー結果・テスト結果ファイルの特定ロジック
- **Git Manager**: `executeRollback()` 内で Git コミット・プッシュを実行

### 3.3 データフロー

```
1. CLI 入力（rollback auto --issue 271）
   ↓
2. metadata.json 読み込み（MetadataManager）
   ↓
3. 最新レビュー結果・テスト結果ファイルの特定
   ↓
4. プロンプト生成（テンプレート + ファイル参照）
   ↓
5. エージェント呼び出し（AgentExecutor）
   ↓
6. JSON 出力パース（RollbackDecision 型）
   ↓
7. confidence 制御（確認プロンプト表示）
   ↓
8. 既存 executeRollback() 呼び出し
   ↓
9. Git コミット・プッシュ
```

---

## 4. リスク分析

### 4.1 技術的リスク

| リスク | 影響度 | 確率 | 軽減策 |
|-------|-------|-----|-------|
| エージェント出力の不安定性 | 高 | 中 | JSON形式明示、複数抽出パターン、フォールバック処理 |
| エージェント判断精度の問題 | 中 | 中 | confidence制御、dry-runモード、analysisフィールド表示 |
| ファイル参照の複雑性 | 中 | 中 | 命名規則明確化、エラーハンドリング、統合テスト |
| 既存rollbackコマンドとの統合問題 | 中 | 低 | 既存関数再利用、リグレッションテスト |
| CI環境での動作問題 | 低 | 低 | `--force`自動付与、環境変数制御 |

### 4.2 スコープリスク

| リスク | 影響度 | 確率 | 軽減策 |
|-------|-------|-----|-------|
| 要件の曖昧性（エージェント判断基準） | 中 | 中 | プロンプト設計時に判断基準を明文化、テストケースで検証 |
| 仕様変更（判断ロジック追加） | 低 | 低 | プロンプトテンプレート分離により柔軟性を確保 |

### 4.3 リソースリスク

| リスク | 影響度 | 確率 | 軽減策 |
|-------|-------|-----|-------|
| 工数超過（エージェント出力パース複雑化） | 中 | 中 | Phase 4 実装を細分化、複数パターン対応を段階的に実装 |
| スキル不足（エージェントプロンプト設計） | 低 | 低 | 既存プロンプト（Planning、Design等）を参考にテンプレート作成 |

### 4.4 ユーザー体験リスク

| リスク | 影響度 | 確率 | 軽減策 |
|-------|-------|-----|-------|
| 自動ロールバックの誤判断 | 高 | 低 | confidence制御で低確度時は必ず確認、analysisフィールドで理由表示 |
| 出力が理解しにくい | 低 | 中 | 出力フォーマットを統一、dry-runモードで事前確認可能に |

---

## 5. タスク分割

各タスクは 1~4 時間の粒度で分割し、明確な完了条件（Done criteria）を設定します。

### Phase 1: 要件定義 (1~2h)

**目的**: Issue 要件を精査し、機能要件、受け入れ基準を明確化

#### Task 1.1: 機能要件の明確化 (0.5~1h)
**内容**:
- Issue #271 の CLI 設計、エージェント判断ロジック、出力形式を詳細に分析
- 必要な入力情報（metadata.json、レビュー結果、テスト結果）を洗い出し
- オプション仕様（`--dry-run`, `--force`, `--agent`）の定義

**完了条件**:
- [x] CLI サブコマンド仕様が明確になっている
- [x] エージェント入力情報リストが作成されている
- [x] オプション仕様表が作成されている

#### Task 1.2: 受け入れ基準の定義 (0.5~1h)
**内容**:
- ユースケースの洗い出し（成功ケース、失敗ケース）
- エージェント判断結果のバリデーション要件を定義
- エラーハンドリング方針を決定

**完了条件**:
- [x] 受け入れ基準が 5 件以上定義されている
- [x] 異常系ケース（JSON パース失敗、ファイル未発見等）がリストアップされている

**依存関係**: なし

---

### Phase 2: 設計 (2~3h)

**目的**: プロンプト設計、コンポーネント設計を完了

#### Task 2.1: プロンプトテンプレート設計 (1~1.5h)
**内容**:
- `auto-analyze.txt` のプロンプト文面を設計
- 判断基準（差し戻し必要/不要、差し戻し先の決定ロジック）を明記
- 出力 JSON フォーマットを定義（`RollbackDecision` 型）

**完了条件**:
- [x] プロンプトテンプレートのドラフトが作成されている
- [x] JSON スキーマ定義が完成している
- [x] 判断基準が具体的に記述されている

#### Task 2.2: コンポーネント設計 (1~1.5h)
**内容**:
- `handleRollbackAutoCommand()` の関数シグネチャ設計
- ファイル検索ロジック（最新レビュー結果、テスト結果）の設計
- JSON パース処理の設計

**完了条件**:
- [x] 関数インターフェースが定義されている
- [x] データフロー図が作成されている
- [x] エラーハンドリングフローが明確になっている

**依存関係**: Task 1.1, 1.2 完了後

---

### Phase 3: テストシナリオ作成 (1.5~2h)

**目的**: ユニットテスト、統合テストのシナリオを作成

#### Task 3.1: ユニットテストシナリオ作成 (0.5~1h)
**内容**:
- JSON パース処理のテストケース（正常系、異常系）
- confidence 制御ロジックのテストケース
- バリデーション処理のテストケース

**完了条件**:
- [x] ユニットテストシナリオが 10 件以上作成されている
- [x] エッジケース（空文字列、null、不正なフォーマット）が含まれている

#### Task 3.2: 統合テストシナリオ作成 (1~1h)
**内容**:
- エージェント呼び出しから rollback 実行までのエンドツーエンドテスト
- dry-run モードのテスト
- 既存 rollback コマンドとのリグレッションテスト

**完了条件**:
- [x] 統合テストシナリオが 5 件以上作成されている
- [x] モック設計（エージェント出力のモック）が完成している

**依存関係**: Task 2.1, 2.2 完了後

---

### Phase 4: 実装 (5~7h)

**目的**: CLI 拡張、プロンプトテンプレート、エージェント統合を実装

#### Task 4.1: CLI 引数パーサーの拡張 (1~1.5h)
**内容**:
- `main.ts` に `rollback auto` サブコマンドを登録
- `--dry-run`, `--force`, `--agent` オプションのパース処理
- `handleRollbackAutoCommand()` の基本骨格を実装

**完了条件**:
- [x] `rollback auto --issue 271` が認識される
- [x] オプション解析が正しく動作する
- [x] バリデーションエラーが適切に表示される

#### Task 4.2: プロンプトテンプレート作成 (1.5~2h)
**内容**:
- `src/prompts/rollback/auto-analyze.txt` を作成
- ファイル参照形式（`@path`）を使用してプロンプトを構築
- 変数置換ロジック（`{issue_number}`, `{latest_review_result_reference}` 等）を実装

**完了条件**:
- [x] プロンプトテンプレートファイルが作成されている
- [x] 変数置換が正しく動作する
- [x] ファイル参照が適切に展開される

#### Task 4.3: エージェント呼び出しロジック実装 (1.5~2h)
**内容**:
- `AgentExecutor` を使用してエージェントを呼び出し
- プロンプト生成（metadata.json、レビュー結果、テスト結果を含む）
- ファイル検索ロジック（最新のレビュー結果・テスト結果を特定）

**完了条件**:
- [x] エージェントが呼び出され、出力が取得できる
- [x] ファイル検索が正しく動作する（存在しない場合のエラーハンドリング含む）
- [x] エージェントログが保存される

#### Task 4.4: JSON 出力パース処理実装 (1~1.5h)
**内容**:
- エージェント出力から JSON ブロックを抽出
- `RollbackDecision` 型へのパースとバリデーション
- パース失敗時のフォールバック処理（複数パターンの抽出ロジック）

**完了条件**:
- [x] JSON パースが正常系で動作する
- [x] バリデーションエラーが適切に検出される
- [x] フォールバック処理が実装されている

**依存関係**: Task 4.3 完了後

#### Task 4.5: confidence 制御と確認プロンプト実装 (0.5~1h)
**内容**:
- confidence レベル（high/medium/low）に応じた確認プロンプト表示
- `--force` オプション時のスキップロジック
- 既存 `executeRollback()` への委譲処理

**完了条件**:
- [x] confidence が high の場合、`--force` なしで確認プロンプトが表示される
- [x] confidence が medium/low の場合、`--force` でもスキップされない
- [x] `executeRollback()` が正しく呼び出される

**依存関係**: Task 4.4 完了後

---

### Phase 5: テストコード実装 (2~3h)

**目的**: ユニットテスト、統合テストを実装

#### Task 5.1: ユニットテスト実装 (1~1.5h)
**内容**:
- JSON パース処理のテスト
- confidence 制御ロジックのテスト
- バリデーション処理のテスト

**完了条件**:
- [x] ユニットテストが 10 件以上実装されている
- [x] カバレッジが 80% 以上（パース処理、バリデーション）

#### Task 5.2: 統合テスト実装 (1~1.5h)
**内容**:
- エージェント呼び出しのモックテスト
- dry-run モードのテスト
- 既存 rollback コマンドのリグレッションテスト

**完了条件**:
- [x] 統合テストが 5 件以上実装されている
- [x] モックが適切に動作する
- [x] リグレッションテストが全てパスする

**依存関係**: Phase 4 完了後

---

### Phase 6: テスト実行 (0.5~1h)

**目的**: テストを実行し、バグを修正

#### Task 6.1: テスト実行とバグ修正 (0.5~1h)
**内容**:
- ユニットテスト、統合テストの実行
- 失敗したテストケースの原因調査と修正
- リグレッションテストの確認

**完了条件**:
- [x] 全てのテストがパスする
- [x] カバレッジが 80% 以上
- [x] リグレッションテストが全てパスする

**依存関係**: Phase 5 完了後

---

### Phase 7: ドキュメント作成 (0.5~1h)

**目的**: CLI ヘルプ、README を更新

#### Task 7.1: CLI ヘルプ更新 (0.25~0.5h)
**内容**:
- `rollback auto` サブコマンドのヘルプメッセージを追加
- 使用例を記載

**完了条件**:
- [x] `--help` でサブコマンドが表示される
- [x] 使用例が 3 件以上記載されている

#### Task 7.2: README 更新 (0.25~0.5h)
**内容**:
- README に `rollback auto` の使い方を追加
- エージェント判断ロジックの説明を追加

**完了条件**:
- [x] README に新しいセクションが追加されている
- [x] 使用例が記載されている

**依存関係**: Phase 6 完了後

---

### Phase 8: レポート作成 (0.5~1h)

**目的**: 実装完了レポートを作成

#### Task 8.1: 実装完了レポート作成 (0.5~1h)
**内容**:
- 実装内容のサマリ
- テスト結果のサマリ
- 既知の問題点、今後の改善点

**完了条件**:
- [ ] レポートが作成されている
- [ ] 実装完了の証跡（テスト結果、コミットハッシュ）が記載されている

**依存関係**: Phase 7 完了後

---

## 6. Issue TODO との対応関係

| Issue TODO | Phase | Task | 備考 |
|-----------|-------|------|-----|
| サブコマンド構造の追加 | 4 | 4.1 | CLI 引数パーサー拡張 |
| コンテキスト収集 | 4 | 4.3 | ファイル検索、metadata.json 読み込み |
| エージェント統合 | 4 | 4.2, 4.3, 4.4 | プロンプト作成、呼び出し、JSON パース |
| 確認と実行 | 4 | 4.5 | confidence 制御、executeRollback() 委譲 |

---

## 7. タスク間の依存関係

```
Phase 1 (要件定義)
  ├─ Task 1.1
  └─ Task 1.2
        ↓
Phase 2 (設計)
  ├─ Task 2.1 ← depends on Task 1.1, 1.2
  └─ Task 2.2 ← depends on Task 1.1, 1.2
        ↓
Phase 3 (テストシナリオ)
  ├─ Task 3.1 ← depends on Task 2.1, 2.2
  └─ Task 3.2 ← depends on Task 2.1, 2.2
        ↓
Phase 4 (実装)
  ├─ Task 4.1
  ├─ Task 4.2
  ├─ Task 4.3
  ├─ Task 4.4 ← depends on Task 4.3
  └─ Task 4.5 ← depends on Task 4.4
        ↓
Phase 5 (テストコード実装)
  ├─ Task 5.1 ← depends on Phase 4
  └─ Task 5.2 ← depends on Phase 4
        ↓
Phase 6 (テスト実行)
  └─ Task 6.1 ← depends on Phase 5
        ↓
Phase 7 (ドキュメント)
  ├─ Task 7.1 ← depends on Phase 6
  └─ Task 7.2 ← depends on Phase 6
        ↓
Phase 8 (レポート)
  └─ Task 8.1 ← depends on Phase 7
```

---

## 8. 品質ゲート

### 8.1 Planning Phase 完了条件

- [x] **実装戦略が明確に決定されている**: EXTEND 戦略が選択され、理由が明記されている
- [x] **テスト戦略が明確に決定されている**: UNIT_INTEGRATION 戦略が選択され、理由が明記されている
- [x] **テストコード戦略が明確に決定されている**: BOTH_TEST 戦略が選択され、理由が明記されている
- [x] **影響範囲が分析されている**: 変更対象ファイル、影響を受けるモジュール、データフローが明確
- [x] **タスク分割が適切な粒度である**: 全てのタスクが 1~4 時間単位で分割され、完了条件が明記されている
- [x] **リスクが洗い出されている**: 5 つ以上のリスクが洗い出され、軽減策が記載されている

### 8.2 各フェーズの品質ゲート

各フェーズの完了条件は、各タスクの完了条件（Done criteria）を全て満たすことです。

---

## 9. 注記

### 9.1 エージェント判断ロジックの詳細

エージェントは以下の情報を分析して判断を行います：

1. **metadata.json**: 各フェーズのステータス、completed_steps、rollback_history
2. **レビュー結果**: `{phase}/review/result.md` または `{phase}/review/review_result.md`
3. **テスト結果**: `06_testing/output/test-result.md`（Testing Phase の場合）

判断基準：
- 差し戻し不要: すべてのフェーズが正常完了、現在のフェーズで対処可能
- 差し戻し必要: BLOCKER 存在、テスト失敗が実装問題に起因、設計・要件の根本的問題

### 9.2 JSON 出力フォーマット

```json
{
  "needs_rollback": true,
  "to_phase": "implementation",
  "to_step": "revise",
  "reason": "テスト失敗の原因が実装にあるため...",
  "confidence": "high",
  "analysis": "Testing Phase で 3 件のテストが失敗..."
}
```

### 9.3 confidence 制御

- **high**: `--force` がなければ確認プロンプト表示
- **medium/low**: `--force` でもスキップしない（必ず確認）

---

**計画書作成者**: Claude Agent
**レビュー対象**: Design Phase
**次のアクション**: Planning Phase Review
