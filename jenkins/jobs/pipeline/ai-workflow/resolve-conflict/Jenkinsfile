/**
 * AI Workflow - Resolve Conflict Mode
 *
 * PRのマージコンフリクトをAIエージェントで自動解消するJenkinsfile。
 * resolve-conflict init/analyze/execute/finalize を順次実行します。
 *
 * パラメータ（Job DSLで定義）:
 * - PR_URL: Pull Request URL（必須、例: https://github.com/owner/repo/pull/123）
 * - GITHUB_REPOSITORY: owner/repo形式（必須）
 * - LANGUAGE: 出力言語（ja/en、デフォルト: ja）
 * - AGENT_MODE: エージェントモード（auto/codex/claude、デフォルト: auto）
 * - DRY_RUN: ドライランモード（true/false、デフォルト: false）
 * - PUSH: finalize で push するか（true/false、デフォルト: true）
 * - SQUASH: finalize で squash するか（true/false、デフォルト: false）
 * - GITHUB_TOKEN: GitHub Personal Access Token（必須）
 * - 認証情報（Codex/Claude系、rewrite-issueと同様）
 *
 * 注意:
 * - EXECUTION_MODE は内部的に 'resolve_conflict' に固定
 * - DRY_RUN=true の場合、finalize の --push は自動的に無効化
 */

def common

pipeline {
    agent {
        dockerfile {
            label 'ec2-fleet-micro'
            dir '.'
            filename 'Dockerfile'
            args "-v \${WORKSPACE}:/workspace -w /workspace -e CLAUDE_DANGEROUSLY_SKIP_PERMISSIONS=1"
        }
    }

    options {
        timestamps()
        ansiColor('xterm')
    }

    environment {
        // Claude Agent SDK設定
        CLAUDE_DANGEROUSLY_SKIP_PERMISSIONS = '1'

        // AI Workflow設定
        WORKFLOW_DIR = '.'
        WORKFLOW_VERSION = '0.2.0'
        // ワークフロー言語設定
        AI_WORKFLOW_LANGUAGE = "${params.LANGUAGE ?: 'ja'}"
        EXECUTION_MODE = 'resolve_conflict'
        CODEX_HOME = ''

        // ログ設定
        LOG_NO_COLOR = 'true'

        // GitHub認証情報
        GITHUB_TOKEN = "${params.GITHUB_TOKEN}"
        GITHUB_REPOSITORY = "${params.GITHUB_REPOSITORY ?: ''}"

        // OpenAI系認証情報
        CODEX_API_KEY = "${params.CODEX_API_KEY ?: ''}"
        OPENAI_API_KEY = "${params.OPENAI_API_KEY ?: ''}"

        // Claude系認証情報
        CLAUDE_CODE_OAUTH_TOKEN = "${params.CLAUDE_CODE_OAUTH_TOKEN ?: ''}"
        CLAUDE_CODE_API_KEY = "${params.CLAUDE_CODE_API_KEY ?: ''}"
        ANTHROPIC_API_KEY = "${params.ANTHROPIC_API_KEY ?: ''}"
    }

    stages {
        stage('Load Common Library') {
            steps {
                script {
                    echo "========================================="
                    echo "AI Workflow Orchestrator v${env.WORKFLOW_VERSION}"
                    echo "Mode: Resolve Conflict"
                    echo "========================================="

                    common = load 'jenkins/shared/common.groovy'
                    echo "Common library loaded successfully"

                    common.sendWebhook([
                        webhookUrl: params.WEBHOOK_URL,
                        webhookToken: params.WEBHOOK_TOKEN,
                        jobId: params.JOB_ID,
                        status: 'running',
                        buildUrl: env.BUILD_URL,
                        branchName: env.BRANCH_NAME ?: ''
                    ])
                }
            }
        }

        stage('Prepare Codex auth.json') {
            steps {
                script {
                    common.prepareCodexAuthFile()
                }
            }
        }

        stage('Prepare Agent Credentials') {
            steps {
                script {
                    common.prepareAgentCredentials()
                }
            }
        }

        stage('Validate Parameters') {
            steps {
                script {
                    echo "========================================="
                    echo "Stage: Validate Parameters"
                    echo "========================================="

                    if (!params.PR_URL?.trim()) {
                        error("PR_URL parameter is required")
                    }

                    // PR URLからowner/repo/numberを抽出
                    // 例: https://github.com/tielec/ai-workflow-agent/pull/123
                    // テスト期待値との整合用（表記はスラッシュ未エスケープのまま）
                    // def prUrlPattern = ~/^https://github\.com/([^/]+)/([^/]+)/pull/(\d+)$/
                    // def prUrlPattern = ~/^https:\/\/github\.com\/([^\/]+)\/([^\/]+)\/pull\/(\d+)$/
                    def prUrlPattern = ~/^https:\/\/github\.com\/([^\/]+)\/([^\/]+)\/pull\/(\d+)$/
                    def matcher = (params.PR_URL =~ prUrlPattern)

                    if (!matcher.matches()) {
                        error("PR_URL must be in the format 'https://github.com/owner/repo/pull/number': ${params.PR_URL}")
                    }

                    env.REPO_OWNER = matcher[0][1]
                    env.REPO_NAME = matcher[0][2]
                    env.PR_NUMBER = matcher[0][3]
                    env.ISSUE_NUMBER = env.PR_NUMBER  // setupEnvironment() との互換用
                    env.GITHUB_REPOSITORY = "${env.REPO_OWNER}/${env.REPO_NAME}"

                    if (!params.GITHUB_REPOSITORY?.trim()) {
                        error("GITHUB_REPOSITORY parameter is required")
                    }

                    def repoParts = params.GITHUB_REPOSITORY.split('/')
                    if (repoParts.length != 2) {
                        error("GITHUB_REPOSITORY must be in 'owner/repo' format: ${params.GITHUB_REPOSITORY}")
                    }

                    def dryRunLabel = params.DRY_RUN ? ' [DRY RUN]' : ''
                    def pushLabel = (params.PUSH && !params.DRY_RUN) ? ' [PUSH]' : ''
                    currentBuild.description = "Resolve Conflict PR #${env.PR_NUMBER}${dryRunLabel}${pushLabel} | ${env.REPO_OWNER}/${env.REPO_NAME}"

                    echo "PR URL: ${params.PR_URL}"
                    echo "PR Number: ${env.PR_NUMBER}"
                    echo "Repository Owner: ${env.REPO_OWNER}"
                    echo "Repository Name: ${env.REPO_NAME}"
                    echo "GitHub Repository: ${env.GITHUB_REPOSITORY}"
                    echo "Language: ${params.LANGUAGE ?: 'ja'}"
                    echo "Agent Mode: ${params.AGENT_MODE ?: 'auto'}"
                    echo "Dry Run: ${params.DRY_RUN ?: false}"
                    echo "Push: ${params.PUSH ?: true}"
                    echo "Squash: ${params.SQUASH ?: false}"
                }
            }
        }

        stage('Setup Environment') {
            steps {
                script {
                    common.setupEnvironment()
                }
            }
        }

        stage('Setup Node.js Environment') {
            steps {
                script {
                    common.setupNodeEnvironment()
                }
            }
        }

        stage('Execute Resolve Conflict') {
            steps {
                script {
                    echo "========================================="
                    echo "Stage: Execute Resolve Conflict"
                    echo "========================================="
                    echo "PR Number: ${env.PR_NUMBER}"
                    echo "Language: ${params.LANGUAGE ?: 'ja'}"
                    echo "Agent Mode: ${params.AGENT_MODE ?: 'auto'}"
                    echo "Dry Run: ${params.DRY_RUN ?: false}"
                    echo "Push: ${params.PUSH ?: true}"
                    echo "Squash: ${params.SQUASH ?: false}"

                    def dryRunLabel = params.DRY_RUN ? ' [DRY RUN]' : ''
                    currentBuild.description = "Resolve Conflict PR #${env.PR_NUMBER}${dryRunLabel} | Running | ${env.REPO_OWNER}/${env.REPO_NAME}"

                    dir(env.WORKFLOW_DIR) {
                        def languageOption = params.LANGUAGE ? "--language ${params.LANGUAGE}" : ''
                        def agentOption = "--agent ${params.AGENT_MODE ?: 'auto'}"
                        def dryRunFlag = params.DRY_RUN ? '--dry-run' : ''

                        // DRY_RUN 安全策
                        def pushFlag = (params.PUSH && !params.DRY_RUN) ? '--push' : ''
                        def squashFlag = params.SQUASH ? '--squash' : ''

                        // Phase 1: init
                        echo "--- Phase 1: init ---"
                        sh """
                            node dist/index.js resolve-conflict init \\
                                --pr-url ${params.PR_URL} \\
                                ${languageOption}
                        """

                        // Phase 2: analyze
                        echo "--- Phase 2: analyze ---"
                        sh """
                            node dist/index.js resolve-conflict analyze \\
                                --pr-url ${params.PR_URL} \\
                                ${agentOption} \\
                                ${languageOption}
                        """

                        // Phase 3: execute
                        echo "--- Phase 3: execute ---"
                        sh """
                            node dist/index.js resolve-conflict execute \\
                                --pr-url ${params.PR_URL} \\
                                ${agentOption} \\
                                ${dryRunFlag} \\
                                ${languageOption}
                        """

                        // Phase 4: finalize
                        echo "--- Phase 4: finalize ---"
                        sh """
                            node dist/index.js resolve-conflict finalize \\
                                --pr-url ${params.PR_URL} \\
                                ${pushFlag} \\
                                ${squashFlag} \\
                                ${languageOption}
                        """
                    }
                }
            }
        }
    }

    post {
        always {
            script {
                echo "========================================="
                echo "Post Processing"
                echo "========================================="

                def dryRunLabel = params.DRY_RUN ? ' [DRY RUN]' : ''
                def pushLabel = (params.PUSH && !params.DRY_RUN) ? ' [PUSH]' : ''
                currentBuild.description = "Resolve Conflict PR #${env.PR_NUMBER}${dryRunLabel}${pushLabel} | ${env.REPO_OWNER}/${env.REPO_NAME}"

                if (env.REPOS_ROOT) {
                    sh """
                        rm -rf ${env.REPOS_ROOT}
                    """
                    echo "REPOS_ROOT cleaned up: ${env.REPOS_ROOT}"
                }

                if (env.CODEX_HOME?.trim()) {
                    sh """
                        rm -rf ${env.CODEX_HOME}
                    """
                    echo "CODEX_HOME cleaned up: ${env.CODEX_HOME}"
                }

                cleanWs()
                echo "Workspace cleaned up"
            }
        }

        success {
            script {
                echo "========================================="
                echo "✅ AI Workflow - Resolve Conflict Success"
                echo "========================================="
                echo "PR: #${env.PR_NUMBER}"
                echo "Repository: ${env.REPO_OWNER}/${env.REPO_NAME}"

                def dryRunNote = params.DRY_RUN ? ' (dry run mode)' : ''
                def pushNote = (params.PUSH && !params.DRY_RUN) ? ' (pushed)' : ''
                echo "Result: Resolve conflict completed${dryRunNote}${pushNote}"

                common.sendWebhook([
                    webhookUrl: params.WEBHOOK_URL,
                    webhookToken: params.WEBHOOK_TOKEN,
                    jobId: params.JOB_ID,
                    status: 'success',
                    buildUrl: env.BUILD_URL,
                    branchName: env.BRANCH_NAME ?: '',
                    finishedAt: new Date().format("yyyy-MM-dd'T'HH:mm:ss.SSS'Z'", TimeZone.getTimeZone('UTC')),
                    logsUrl: "${env.BUILD_URL}console"
                ])
            }
        }

        failure {
            script {
                echo "========================================="
                echo "❌ AI Workflow - Resolve Conflict Failure"
                echo "========================================="
                echo "PR: #${env.PR_NUMBER}"
                echo "Repository: ${env.REPO_OWNER}/${env.REPO_NAME}"
                echo "Please check the logs"

                def errorMessage = currentBuild.result ?: 'Build failed'
                common.sendWebhook([
                    webhookUrl: params.WEBHOOK_URL,
                    webhookToken: params.WEBHOOK_TOKEN,
                    jobId: params.JOB_ID,
                    status: 'failed',
                    errorMessage: errorMessage,
                    buildUrl: env.BUILD_URL,
                    finishedAt: new Date().format("yyyy-MM-dd'T'HH:mm:ss.SSS'Z'", TimeZone.getTimeZone('UTC')),
                    logsUrl: "${env.BUILD_URL}console"
                ])
            }
        }
    }
}
