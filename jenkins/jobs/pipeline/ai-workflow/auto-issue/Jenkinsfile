/**
 * AI Workflow - Auto Issue Mode
 *
 * AIエージェントがリポジトリを探索し、バグ・改善点を自動検出してGitHub Issueを生成するJenkinsfile（v0.5.0、Issue #121で追加）。
 * Initialize Workflowステージは不要（Issue URLベースではないため）。
 *
 * パラメータ（Job DSLで定義）:
 * - GITHUB_REPOSITORY: owner/repo形式（必須、デフォルト: tielec/ai-workflow-agent）
 * - AUTO_ISSUE_CATEGORY: Issue検出カテゴリ（デフォルト: bug、選択肢: bug, refactor, enhancement, all）
 * - AUTO_ISSUE_LIMIT: 作成するIssue上限（デフォルト: 5）
 * - AUTO_ISSUE_SIMILARITY_THRESHOLD: 重複判定の類似度閾値（デフォルト: 0.8）
 * - AGENT_MODE: エージェントモード（デフォルト: auto）
 * - GITHUB_TOKEN: GitHub Personal Access Token（必須）
 * - CODEX_AUTH_JSON: Codex ~/.codex/auth.json の内容（オプション）
 * - その他の認証情報（Jenkinsfile.all-phasesと同じ）
 * - DRY_RUN: ドライランモード（デフォルト: false、Issue生成せず検出結果のみ表示）
 *
 * 注意:
 * - ISSUE_URL パラメータは不要（auto_issueモードでは使用しない）
 * - REPOS_ROOT 環境変数を設定し、対象リポジトリをクローン
 */

def common

pipeline {
    agent {
        dockerfile {
            label 'ec2-fleet'
            dir '.'
            filename 'Dockerfile'
            args "-v \${WORKSPACE}:/workspace -w /workspace -e CLAUDE_DANGEROUSLY_SKIP_PERMISSIONS=1"
        }
    }

    options {
        timestamps()
        ansiColor('xterm')
    }

    environment {
        CLAUDE_DANGEROUSLY_SKIP_PERMISSIONS = '1'
        WORKFLOW_DIR = '.'
        WORKFLOW_VERSION = '0.2.0'
        EXECUTION_MODE = 'auto_issue'
        CODEX_HOME = ''
        LOG_NO_COLOR = 'true'

        GIT_COMMIT_USER_NAME = "${params.GIT_COMMIT_USER_NAME ?: 'AI Workflow Bot'}"
        GIT_COMMIT_USER_EMAIL = "${params.GIT_COMMIT_USER_EMAIL ?: 'ai-workflow@example.com'}"

        AWS_ACCESS_KEY_ID = "${params.AWS_ACCESS_KEY_ID ?: ''}"
        AWS_SECRET_ACCESS_KEY = "${params.AWS_SECRET_ACCESS_KEY ?: ''}"
        AWS_SESSION_TOKEN = "${params.AWS_SESSION_TOKEN ?: ''}"

        GITHUB_TOKEN = "${params.GITHUB_TOKEN}"
        GITHUB_REPOSITORY = "${params.GITHUB_REPOSITORY ?: 'tielec/ai-workflow-agent'}"

        CODEX_API_KEY = "${params.CODEX_API_KEY ?: ''}"
        OPENAI_API_KEY = "${params.OPENAI_API_KEY ?: ''}"

        CLAUDE_CODE_OAUTH_TOKEN = "${params.CLAUDE_CODE_OAUTH_TOKEN ?: ''}"
        CLAUDE_CODE_API_KEY = "${params.CLAUDE_CODE_API_KEY ?: ''}"
        ANTHROPIC_API_KEY = "${params.ANTHROPIC_API_KEY ?: ''}"
    }

    stages {
        stage('Load Common Library') {
            steps {
                script {
                    echo "========================================="
                    echo "AI Workflow Orchestrator v${env.WORKFLOW_VERSION}"
                    echo "Mode: Auto Issue (${params.AUTO_ISSUE_CATEGORY ?: 'bug'})"
                    echo "========================================="

                    common = load 'jenkins/shared/common.groovy'
                    echo "Common library loaded successfully"
                }
            }
        }

        stage('Prepare Codex auth.json') {
            steps {
                script {
                    common.prepareCodexAuthFile()
                }
            }
        }

        stage('Prepare Agent Credentials') {
            steps {
                script {
                    common.prepareAgentCredentials()
                }
            }
        }


        stage('Validate Parameters') {
            steps {
                script {
                    echo "========================================="
                    echo "Stage: Validate Parameters"
                    echo "========================================="

                    if (!params.GITHUB_REPOSITORY) {
                        error("GITHUB_REPOSITORY parameter is required for auto_issue mode")
                    }

                    def repoParts = params.GITHUB_REPOSITORY.split('/')
                    if (repoParts.length != 2) {
                        error("GITHUB_REPOSITORY must be in 'owner/repo' format: ${params.GITHUB_REPOSITORY}")
                    }

                    env.REPO_OWNER = repoParts[0]
                    env.REPO_NAME = repoParts[1]
                    env.ISSUE_NUMBER = 'auto'  // auto_issue モードでは Issue 番号なし

                    // ビルドディスクリプションを設定
                    def dryRunLabel = params.DRY_RUN ? ' [DRY RUN]' : ''
                    currentBuild.description = "Auto Issue | ${params.AUTO_ISSUE_CATEGORY ?: 'bug'}${dryRunLabel} | ${env.REPO_OWNER}/${env.REPO_NAME}"

                    echo "GitHub Repository: ${params.GITHUB_REPOSITORY}"
                    echo "Repository Owner: ${env.REPO_OWNER}"
                    echo "Repository Name: ${env.REPO_NAME}"
                    echo "Auto Issue Category: ${params.AUTO_ISSUE_CATEGORY ?: 'bug'}"
                    echo "Auto Issue Limit: ${params.AUTO_ISSUE_LIMIT ?: 5}"
                    echo "Auto Issue Similarity Threshold: ${params.AUTO_ISSUE_SIMILARITY_THRESHOLD ?: 0.8}"
                    echo "Agent Mode: ${params.AGENT_MODE ?: 'auto'}"
                    echo "Dry Run: ${params.DRY_RUN ?: false}"
                }
            }
        }

        stage('Setup Environment') {
            steps {
                script {
                    common.setupEnvironment()
                }
            }
        }

        stage('Setup Node.js Environment') {
            steps {
                script {
                    common.setupNodeEnvironment()
                }
            }
        }

        // Note: Initialize Workflow ステージは auto_issue モードでは不要
        // （Issue URLベースではなく、リポジトリ全体を探索するため）

        stage('Execute Auto Issue') {
            steps {
                script {
                    echo "========================================="
                    echo "Stage: Execute Auto Issue"
                    echo "========================================="
                    echo "Category: ${params.AUTO_ISSUE_CATEGORY ?: 'bug'}"
                    echo "Limit: ${params.AUTO_ISSUE_LIMIT ?: 5}"
                    echo "Similarity Threshold: ${params.AUTO_ISSUE_SIMILARITY_THRESHOLD ?: 0.8}"
                    echo "Dry Run: ${params.DRY_RUN ?: false}"

                    // ビルドディスクリプションを更新
                    def dryRunLabel = params.DRY_RUN ? ' [DRY RUN]' : ''
                    currentBuild.description = "Auto Issue | Executing: ${params.AUTO_ISSUE_CATEGORY ?: 'bug'}${dryRunLabel} | ${env.REPO_OWNER}/${env.REPO_NAME}"

                    dir(env.WORKFLOW_DIR) {
                        // auto-issue コマンドを実行
                        def category = params.AUTO_ISSUE_CATEGORY ?: 'bug'
                        def limit = params.AUTO_ISSUE_LIMIT ?: 5
                        def similarityThreshold = params.AUTO_ISSUE_SIMILARITY_THRESHOLD ?: 0.8
                        def dryRunFlag = params.DRY_RUN ? '--dry-run' : ''

                        sh """
                            node dist/index.js auto-issue \
                                --category ${category} \
                                --limit ${limit} \
                                --similarity-threshold ${similarityThreshold} \
                                --agent ${params.AGENT_MODE ?: 'auto'} \
                                ${dryRunFlag}
                        """
                    }
                }
            }
        }
    }

    post {
        always {
            script {
                echo "========================================="
                echo "Post Processing"
                echo "========================================="

                def dryRunLabel = params.DRY_RUN ? ' [DRY RUN]' : ''
                currentBuild.description = "Auto Issue | ${params.AUTO_ISSUE_CATEGORY ?: 'bug'}${dryRunLabel} | ${env.REPO_OWNER}/${env.REPO_NAME}"

                // Note: auto_issue モードでは .ai-workflow ディレクトリは使用しないため、
                // アーティファクトのアーカイブはスキップ

                // REPOS_ROOTクリーンアップ
                if (env.REPOS_ROOT) {
                    sh """
                        rm -rf ${env.REPOS_ROOT}
                    """
                    echo "REPOS_ROOT cleaned up: ${env.REPOS_ROOT}"
                }

                if (env.CODEX_HOME?.trim()) {
                    sh """
                        rm -rf ${env.CODEX_HOME}
                    """
                    echo "CODEX_HOME cleaned up: ${env.CODEX_HOME}"
                }
            }
        }

        success {
            script {
                echo "========================================="
                echo "✅ AI Workflow - Auto Issue Success"
                echo "========================================="
                echo "Repository: ${params.GITHUB_REPOSITORY}"
                echo "Category: ${params.AUTO_ISSUE_CATEGORY ?: 'bug'}"
                def dryRunNote = params.DRY_RUN ? ' (dry run mode, no issues created)' : ''
                echo "Result: Auto issue detection completed${dryRunNote}"
            }
        }

        failure {
            script {
                echo "========================================="
                echo "❌ AI Workflow - Auto Issue Failure"
                echo "========================================="
                echo "Repository: ${params.GITHUB_REPOSITORY}"
                echo "Category: ${params.AUTO_ISSUE_CATEGORY ?: 'bug'}"
                echo "Please check the logs"
            }
        }
    }
}
