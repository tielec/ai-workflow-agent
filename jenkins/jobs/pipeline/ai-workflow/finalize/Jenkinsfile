/**
 * AI Workflow - Finalize Mode
 *
 * ワークフロー完了後の最終処理を行うJenkinsfile（v0.4.0、Issue #259で追加）。
 * Phase 1ではCleanup Workflowのみ実装。Phase 2で他のステージを拡張予定。
 *
 * パラメータ（Job DSLで定義）:
 * - ISSUE_URL: GitHub Issue URL（必須）
 * - CLEANUP_PHASES: クリーンアップ対象フェーズ範囲（デフォルト: 0-8）
 * - CLEANUP_ALL: 完全クリーンアップ（Phase 0-9すべて、Evaluation完了後のみ）
 * - CLEANUP_DRY_RUN: クリーンアッププレビューモード
 * - DRY_RUN: ドライランモード（デフォルト: false）
 * - AGENT_MODE: エージェントモード（デフォルト: auto）
 * - GITHUB_TOKEN: GitHub Personal Access Token（必須）
 * - その他: APIキー、AWS認証情報、Git設定
 */

def common

pipeline {
    agent {
        dockerfile {
            label 'ec2-fleet'
            dir '.'
            filename 'Dockerfile'
            args "-v \${WORKSPACE}:/workspace -w /workspace -e CLAUDE_DANGEROUSLY_SKIP_PERMISSIONS=1"
        }
    }

    options {
        timestamps()
        ansiColor('xterm')
    }

    environment {
        // Claude Agent SDK設定
        CLAUDE_DANGEROUSLY_SKIP_PERMISSIONS = '1'

        // AI Workflow設定
        WORKFLOW_DIR = '.'
        WORKFLOW_VERSION = '0.2.0'
        EXECUTION_MODE = 'finalize'

        // ログ設定（CI環境ではカラーリング無効化）
        LOG_NO_COLOR = 'true'

        // Git設定
        GIT_COMMIT_USER_NAME = "${params.GIT_COMMIT_USER_NAME ?: 'AI Workflow Bot'}"
        GIT_COMMIT_USER_EMAIL = "${params.GIT_COMMIT_USER_EMAIL ?: 'ai-workflow@example.com'}"

        // AWS認証情報
        AWS_ACCESS_KEY_ID = "${params.AWS_ACCESS_KEY_ID ?: ''}"
        AWS_SECRET_ACCESS_KEY = "${params.AWS_SECRET_ACCESS_KEY ?: ''}"
        AWS_SESSION_TOKEN = "${params.AWS_SESSION_TOKEN ?: ''}"

        // GitHub認証情報
        GITHUB_TOKEN = "${params.GITHUB_TOKEN}"
        GITHUB_REPOSITORY = "${params.GITHUB_REPOSITORY ?: 'tielec/ai-workflow-agent'}"

        // OpenAI系認証情報
        CODEX_API_KEY = "${params.CODEX_API_KEY ?: ''}"
        OPENAI_API_KEY = "${params.OPENAI_API_KEY ?: ''}"

        // Claude系認証情報
        CLAUDE_CODE_OAUTH_TOKEN = "${params.CLAUDE_CODE_OAUTH_TOKEN ?: ''}"
        CLAUDE_CODE_API_KEY = "${params.CLAUDE_CODE_API_KEY ?: ''}"
        ANTHROPIC_API_KEY = "${params.ANTHROPIC_API_KEY ?: ''}"
    }

    stages {
        stage('Load Common Library') {
            steps {
                script {
                    echo "========================================="
                    echo "AI Workflow Orchestrator v${env.WORKFLOW_VERSION}"
                    echo "Mode: Finalize"
                    echo "========================================="

                    common = load 'jenkins/shared/common.groovy'
                    echo "Common library loaded successfully"
                }
            }
        }

        stage('Prepare Agent Credentials') {
            steps {
                script {
                    common.prepareAgentCredentials()
                }
            }
        }

        stage('Validate Parameters') {
            steps {
                script {
                    echo "========================================="
                    echo "Stage: Validate Parameters"
                    echo "========================================="

                    if (!params.ISSUE_URL) {
                        error("ISSUE_URL parameter is required")
                    }

                    if (!params.ISSUE_URL.startsWith('https://github.com/')) {
                        error("ISSUE_URL must be a GitHub Issue URL: ${params.ISSUE_URL}")
                    }

                    if (!params.ISSUE_URL.contains('/issues/')) {
                        error("ISSUE_URL must be a GitHub Issue URL (/issues/): ${params.ISSUE_URL}")
                    }

                    // CLEANUP_PHASES と CLEANUP_ALL の排他チェック
                    if (params.CLEANUP_PHASES && params.CLEANUP_ALL) {
                        error("Cannot specify both CLEANUP_PHASES and CLEANUP_ALL parameters")
                    }

                    // CLEANUP_PHASES 形式チェック（数値範囲またはフェーズ名リスト）
                    if (params.CLEANUP_PHASES && params.CLEANUP_PHASES != '0-8') {
                        def phasesPattern = /^(\d+-\d+|[a-z-]+(,[a-z-]+)*)$/
                        if (!params.CLEANUP_PHASES.matches(phasesPattern)) {
                            error("CLEANUP_PHASES must be numeric range (0-4) or phase name list (planning,requirements)")
                        }
                    }

                    // Issue番号とリポジトリ情報抽出
                    def urlParts = params.ISSUE_URL.split('/')
                    env.ISSUE_NUMBER = urlParts[-1]
                    env.REPO_OWNER = urlParts[-4]
                    env.REPO_NAME = urlParts[-3]

                    // ビルドディスクリプションを設定
                    currentBuild.description = "Issue #${env.ISSUE_NUMBER} | Finalize | ${env.REPO_OWNER}/${env.REPO_NAME}"

                    echo "Issue URL: ${params.ISSUE_URL}"
                    echo "Issue Number: ${env.ISSUE_NUMBER}"
                    echo "Repository Owner: ${env.REPO_OWNER}"
                    echo "Repository Name: ${env.REPO_NAME}"
                    echo "Cleanup Phases: ${params.CLEANUP_PHASES ?: '0-8 (default)'}"
                    echo "Cleanup All: ${params.CLEANUP_ALL ?: false}"
                    echo "Cleanup Dry Run: ${params.CLEANUP_DRY_RUN ?: false}"
                    echo "Dry Run: ${params.DRY_RUN ?: false}"
                }
            }
        }

        stage('Setup Environment') {
            steps {
                script {
                    common.setupEnvironment()
                }
            }
        }

        stage('Setup Node.js Environment') {
            steps {
                script {
                    common.setupNodeEnvironment()
                }
            }
        }

        stage('Initialize Workflow') {
            steps {
                script {
                    echo "========================================="
                    echo "Stage: Initialize Workflow"
                    echo "========================================="

                    dir(env.WORKFLOW_DIR) {
                        if (params.DRY_RUN) {
                            echo "[DRY RUN] Workflow initialization skipped"
                        } else {
                            def branchOption = params.BRANCH_NAME ? "--branch ${params.BRANCH_NAME}" : ""

                            sh """
                                node dist/index.js init \
                                    --issue-url ${params.ISSUE_URL} \
                                    ${branchOption}
                            """
                        }
                    }
                }
            }
        }

        stage('Cleanup Workflow') {
            steps {
                script {
                    echo "========================================="
                    echo "Stage: Cleanup Workflow"
                    echo "========================================="

                    currentBuild.description = "Issue #${env.ISSUE_NUMBER} | Cleanup Workflow | ${env.REPO_OWNER}/${env.REPO_NAME}"

                    dir(env.WORKFLOW_DIR) {
                        if (params.DRY_RUN) {
                            echo "[DRY RUN] Cleanup workflow skipped"
                        } else {
                            // Cleanup 実行
                            // --phases オプション: デフォルト 0-8（パラメータから取得）
                            // --dry-run オプション: CLEANUP_DRY_RUNパラメータに応じて設定
                            // --all オプション: CLEANUP_ALL パラメータに応じて設定
                            def phasesFlag = params.CLEANUP_PHASES ? "--phases ${params.CLEANUP_PHASES}" : ''
                            def allFlag = params.CLEANUP_ALL ? '--all' : ''
                            def dryRunFlag = params.CLEANUP_DRY_RUN ? '--dry-run' : ''

                            sh """
                                node dist/index.js cleanup \
                                    --issue ${env.ISSUE_NUMBER} \
                                    ${phasesFlag} \
                                    ${allFlag} \
                                    ${dryRunFlag}
                            """
                        }
                    }
                }
            }
        }

        stage('Squash Commits') {
            steps {
                script {
                    echo "========================================="
                    echo "Stage: Squash Commits (Phase 2 - TODO)"
                    echo "========================================="

                    // TODO: Issue #194 の squash 機能を呼び出し
                    // node dist/index.js execute --issue ${env.ISSUE_NUMBER} --phase evaluation --squash-on-complete
                    // または専用コマンド追加の可能性
                    echo "Squash Commits: Not implemented yet (Phase 2 - future expansion)"
                    echo "Planned: Squash commits from base_commit to HEAD with AI-generated message"
                }
            }
        }

        stage('Update PR') {
            steps {
                script {
                    echo "========================================="
                    echo "Stage: Update PR (Phase 2 - TODO)"
                    echo "========================================="

                    // TODO: PR本文の最終更新
                    // gh pr edit コマンドでPR本文を更新
                    // - 完了ステータスの記載
                    // - 変更サマリーの更新
                    echo "Update PR: Not implemented yet (Phase 2 - future expansion)"
                    echo "Planned: Update PR body with completion status and summary"
                }
            }
        }

        stage('Promote PR') {
            steps {
                script {
                    echo "========================================="
                    echo "Stage: Promote PR (Phase 2 - TODO)"
                    echo "========================================="

                    // TODO: ドラフト状態を解除
                    // gh pr ready コマンドでドラフト状態を解除
                    // 必要に応じてレビュアーをアサイン
                    echo "Promote PR: Not implemented yet (Phase 2 - future expansion)"
                    echo "Planned: Mark PR as ready for review and assign reviewers"
                }
            }
        }
    }

    post {
        always {
            script {
                echo "========================================="
                echo "Post Processing"
                echo "========================================="

                currentBuild.description = "Issue #${env.ISSUE_NUMBER} | Finalize | ${env.REPO_OWNER}/${env.REPO_NAME}"

                if (env.ISSUE_NUMBER && env.ISSUE_NUMBER != 'auto') {
                    common.archiveArtifacts(env.ISSUE_NUMBER)
                }

                // REPOS_ROOTクリーンアップ
                if (env.REPOS_ROOT) {
                    sh """
                        rm -rf ${env.REPOS_ROOT}
                    """
                    echo "REPOS_ROOT cleaned up: ${env.REPOS_ROOT}"
                }
            }
        }

        success {
            script {
                echo "========================================="
                echo "✅ AI Workflow - Finalize Success"
                echo "========================================="
                echo "Issue: ${params.ISSUE_URL}"
                echo "Workflow Directory: .ai-workflow/issue-${env.ISSUE_NUMBER}"
            }
        }

        failure {
            script {
                echo "========================================="
                echo "❌ AI Workflow - Finalize Failure"
                echo "========================================="
                echo "Issue: ${params.ISSUE_URL}"
                echo "Please check the logs"
            }
        }
    }
}
