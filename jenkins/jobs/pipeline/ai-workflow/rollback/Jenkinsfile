/**
 * AI Workflow - Rollback Mode
 *
 * ワークフローを前のフェーズに差し戻すJenkinsfile（v0.4.0、Issue #90で追加）。
 * 差し戻し理由を記録し、メタデータを更新、reviseプロンプトに自動注入。
 *
 * パラメータ（Job DSLで定義）:
 * - ISSUE_URL: GitHub Issue URL（必須）
 * - ROLLBACK_TO_PHASE: 差し戻し先フェーズ名（必須、選択肢: planning, requirements, design, test-scenario, implementation, test-implementation, testing, documentation, report, evaluation）
 * - ROLLBACK_TO_STEP: 差し戻し先ステップ（オプション、デフォルト: revise、選択肢: execute, review, revise）
 * - ROLLBACK_REASON: 差し戻し理由（オプション、テキスト形式）
 * - ROLLBACK_REASON_FILE: 差し戻し理由ファイルパス（オプション）
 * - ROLLBACK_MODE: 差し戻しモード（auto: エージェント自動判定 / manual: 従来の手動指定）
 * - AGENT_MODE: エージェントモード（デフォルト: auto）
 * - GITHUB_TOKEN: GitHub Personal Access Token（必須）
 * - CODEX_AUTH_JSON: Codex ~/.codex/auth.json の内容（オプション）
 * - その他の認証情報（Jenkinsfile.all-phasesと同じ）
 *
 * 注意:
 * - ROLLBACK_REASON、ROLLBACK_REASON_FILE、インタラクティブモードのいずれかで差し戻し理由を提供する必要がある
 * - CI環境では --force フラグを自動付与し、確認プロンプトをスキップ
 */

def common

pipeline {
    agent {
        dockerfile {
            label 'ec2-fleet-micro'
            dir '.'
            filename 'Dockerfile'
            args "-v \${WORKSPACE}:/workspace -w /workspace -e CLAUDE_DANGEROUSLY_SKIP_PERMISSIONS=1"
        }
    }

    options {
        timestamps()
        ansiColor('xterm')
    }

    environment {
        CLAUDE_DANGEROUSLY_SKIP_PERMISSIONS = '1'
        WORKFLOW_DIR = '.'
        WORKFLOW_VERSION = '0.2.0'
        EXECUTION_MODE = 'rollback'
        CODEX_HOME = ''
        ROLLBACK_MODE = "${params.ROLLBACK_MODE ?: 'auto'}"
        LOG_NO_COLOR = 'true'

        GIT_COMMIT_USER_NAME = "${params.GIT_COMMIT_USER_NAME ?: 'AI Workflow Bot'}"
        GIT_COMMIT_USER_EMAIL = "${params.GIT_COMMIT_USER_EMAIL ?: 'ai-workflow@example.com'}"

        AWS_ACCESS_KEY_ID = "${params.AWS_ACCESS_KEY_ID ?: ''}"
        AWS_SECRET_ACCESS_KEY = "${params.AWS_SECRET_ACCESS_KEY ?: ''}"
        AWS_SESSION_TOKEN = "${params.AWS_SESSION_TOKEN ?: ''}"

        GITHUB_TOKEN = "${params.GITHUB_TOKEN}"
        GITHUB_REPOSITORY = "${params.GITHUB_REPOSITORY ?: 'tielec/ai-workflow-agent'}"

        CODEX_API_KEY = "${params.CODEX_API_KEY ?: ''}"
        OPENAI_API_KEY = "${params.OPENAI_API_KEY ?: ''}"

        CLAUDE_CODE_OAUTH_TOKEN = "${params.CLAUDE_CODE_OAUTH_TOKEN ?: ''}"
        CLAUDE_CODE_API_KEY = "${params.CLAUDE_CODE_API_KEY ?: ''}"
        ANTHROPIC_API_KEY = "${params.ANTHROPIC_API_KEY ?: ''}"
    }

    stages {
        stage('Load Common Library') {
            steps {
                script {
                    echo "========================================="
                    echo "AI Workflow Orchestrator v${env.WORKFLOW_VERSION}"
                    def initialTarget = env.ROLLBACK_MODE == 'manual' ? (params.ROLLBACK_TO_PHASE ?: 'implementation') : 'auto-detect (agent)'
                    echo "Mode: Rollback (${env.ROLLBACK_MODE ?: 'auto'} -> ${initialTarget})"
                    echo "========================================="

                    common = load 'jenkins/shared/common.groovy'
                    echo "Common library loaded successfully"

                    common.sendWebhook(
                        params.JOB_ID,
                        params.WEBHOOK_URL,
                        params.WEBHOOK_TOKEN,
                        'running'
                    )
                }
            }
        }

        stage('Prepare Codex auth.json') {
            steps {
                script {
                    common.prepareCodexAuthFile()
                }
            }
        }

        stage('Prepare Agent Credentials') {
            steps {
                script {
                    common.prepareAgentCredentials()
                }
            }
        }

        stage('Validate Parameters') {
            steps {
                script {
                    echo "========================================="
                    echo "Stage: Validate Parameters"
                    echo "========================================="

                    if (!params.ISSUE_URL) {
                        error("ISSUE_URL parameter is required")
                    }

                    if (!params.ISSUE_URL.startsWith('https://github.com/')) {
                        error("ISSUE_URL must be a GitHub Issue URL: ${params.ISSUE_URL}")
                    }

                    if (!params.ISSUE_URL.contains('/issues/')) {
                        error("ISSUE_URL must be a GitHub Issue URL (/issues/): ${params.ISSUE_URL}")
                    }

                    // Issue番号とリポジトリ情報抽出
                    def urlParts = params.ISSUE_URL.split('/')
                    env.ISSUE_NUMBER = urlParts[-1]
                    env.REPO_OWNER = urlParts[-4]
                    env.REPO_NAME = urlParts[-3]

                    def rollbackMode = (params.ROLLBACK_MODE ?: 'auto').toLowerCase()
                    if (!['auto', 'manual'].contains(rollbackMode)) {
                        error("ROLLBACK_MODE must be 'auto' or 'manual': ${params.ROLLBACK_MODE}")
                    }

                    def targetPhaseLabel = rollbackMode == 'manual' ? (params.ROLLBACK_TO_PHASE ?: 'implementation') : 'auto-detect (agent)'
                    env.ROLLBACK_MODE = rollbackMode
                    env.ROLLBACK_TARGET_LABEL = targetPhaseLabel

                    if (rollbackMode == 'manual' && !params.ROLLBACK_TO_PHASE) {
                        error("ROLLBACK_TO_PHASE is required when ROLLBACK_MODE=manual")
                    }

                    if (rollbackMode == 'manual' && !params.ROLLBACK_REASON && !params.ROLLBACK_REASON_FILE) {
                        error("Provide ROLLBACK_REASON or ROLLBACK_REASON_FILE when ROLLBACK_MODE=manual")
                    }

                    // ビルドディスクリプションを設定
                    currentBuild.description = "Issue #${env.ISSUE_NUMBER} | Rollback (${rollbackMode}) -> ${targetPhaseLabel} | ${env.REPO_OWNER}/${env.REPO_NAME}"

                    echo "Issue URL: ${params.ISSUE_URL}"
                    echo "Issue Number: ${env.ISSUE_NUMBER}"
                    echo "Repository Owner: ${env.REPO_OWNER}"
                    echo "Repository Name: ${env.REPO_NAME}"
                    echo "Rollback Mode: ${rollbackMode}"
                    if (rollbackMode == 'manual') {
                        echo "Rollback To Phase: ${params.ROLLBACK_TO_PHASE ?: 'implementation'}"
                        echo "Rollback To Step: ${params.ROLLBACK_TO_STEP ?: 'revise (default)'}"
                        echo "Rollback Reason: ${params.ROLLBACK_REASON ?: '(not provided)'}"
                        echo "Rollback Reason File: ${params.ROLLBACK_REASON_FILE ?: '(not provided)'}"
                    } else {
                        echo "Rollback To Phase: auto-detect (agent)"
                        echo "Rollback To Step: auto-detect (agent)"
                        echo "Rollback Reason: auto-generated by agent"
                        echo "Rollback Reason File: (not used in auto mode)"
                    }
                    echo "Dry Run: ${params.DRY_RUN ?: false}"
                }
            }
        }

        stage('Setup Environment') {
            steps {
                script {
                    common.setupEnvironment()
                }
            }
        }

        stage('Setup Node.js Environment') {
            steps {
                script {
                    common.setupNodeEnvironment()
                }
            }
        }

        stage('Initialize Workflow') {
            steps {
                script {
                    echo "========================================="
                    echo "Stage: Initialize Workflow"
                    echo "========================================="

                    dir(env.WORKFLOW_DIR) {
                        if (params.DRY_RUN) {
                            echo "[DRY RUN] Workflow initialization skipped"
                        } else {
                            def branchOption = params.BRANCH_NAME ? "--branch ${params.BRANCH_NAME}" : ""

                            sh """
                                node dist/index.js init \
                                    --issue-url ${params.ISSUE_URL} \
                                    ${branchOption}
                            """
                        }
                    }
                }
            }
        }



        stage('Execute Rollback') {
            steps {
                script {
                    echo "========================================="
                    def rollbackMode = env.ROLLBACK_MODE ?: 'auto'
                    def targetLabel = env.ROLLBACK_TARGET_LABEL ?: (rollbackMode == 'manual' ? (params.ROLLBACK_TO_PHASE ?: 'implementation') : 'auto-detect (agent)')
                    echo "Stage: Execute Rollback (${rollbackMode}) - ${targetLabel}"
                    echo "========================================="

                    currentBuild.description = "Issue #${env.ISSUE_NUMBER} | Executing Rollback (${rollbackMode}) -> ${targetLabel} | ${env.REPO_OWNER}/${env.REPO_NAME}"

                    dir(env.WORKFLOW_DIR) {
                        if (params.DRY_RUN) {
                            if (rollbackMode == 'manual') {
                                echo "[DRY RUN] Rollback to ${targetLabel} skipped"
                            } else {
                                echo "[DRY RUN] Rollback auto analysis skipped"
                            }
                        } else {
                            // 差し戻しを実行
                            // CI環境では --force フラグを付与（確認プロンプトをスキップ）
                            if (rollbackMode == 'manual') {
                                def toStepFlag = params.ROLLBACK_TO_STEP ? "--to-step ${params.ROLLBACK_TO_STEP}" : ''
                                def reasonFlag = params.ROLLBACK_REASON ? "--reason \"${params.ROLLBACK_REASON}\"" : ''
                                def reasonFileFlag = params.ROLLBACK_REASON_FILE ? "--reason-file ${params.ROLLBACK_REASON_FILE}" : ''

                                sh """
                                    node dist/index.js rollback \
                                        --issue ${env.ISSUE_NUMBER} \
                                        --to-phase ${params.ROLLBACK_TO_PHASE ?: 'implementation'} \
                                        ${toStepFlag} \
                                        ${reasonFlag} \
                                        ${reasonFileFlag} \
                                        --force
                                """
                            } else {
                                sh """
                                    node dist/index.js rollback-auto \
                                        --issue ${env.ISSUE_NUMBER} \
                                        --agent ${params.AGENT_MODE ?: 'auto'} \
                                        --force
                                """
                            }
                        }
                    }
                }
            }
        }
    }

    post {
        always {
            script {
                echo "========================================="
                echo "Post Processing"
                echo "========================================="

                def rollbackMode = env.ROLLBACK_MODE ?: 'auto'
                def targetLabel = env.ROLLBACK_TARGET_LABEL ?: (rollbackMode == 'manual' ? (params.ROLLBACK_TO_PHASE ?: 'implementation') : 'auto-detect (agent)')
                currentBuild.description = "Issue #${env.ISSUE_NUMBER} | Rollback (${rollbackMode}) -> ${targetLabel} | ${env.REPO_OWNER}/${env.REPO_NAME}"

                if (env.ISSUE_NUMBER && env.ISSUE_NUMBER != 'auto') {
                    common.archiveArtifacts(env.ISSUE_NUMBER)
                }

                // REPOS_ROOTクリーンアップ
                if (env.REPOS_ROOT) {
                    sh """
                        rm -rf ${env.REPOS_ROOT}
                    """
                    echo "REPOS_ROOT cleaned up: ${env.REPOS_ROOT}"
                }

                if (env.CODEX_HOME?.trim()) {
                    sh """
                        rm -rf ${env.CODEX_HOME}
                    """
                    echo "CODEX_HOME cleaned up: ${env.CODEX_HOME}"
                }

                // ワークスペースのクリーンアップ
                cleanWs()
                echo "Workspace cleaned up"
            }
        }

        success {
            script {
                echo "========================================="
                echo "✅ AI Workflow - Rollback Success"
                echo "========================================="
                def rollbackMode = env.ROLLBACK_MODE ?: 'auto'
                def targetLabel = env.ROLLBACK_TARGET_LABEL ?: (rollbackMode == 'manual' ? (params.ROLLBACK_TO_PHASE ?: 'implementation') : 'auto-detect (agent)')
                echo "Issue: ${params.ISSUE_URL}"
                echo "Rollback Mode: ${rollbackMode}"
                echo "Rollback Target: ${targetLabel}"
                echo "Workflow Directory: .ai-workflow/issue-${env.ISSUE_NUMBER}"

                common.sendWebhook(
                    params.JOB_ID,
                    params.WEBHOOK_URL,
                    params.WEBHOOK_TOKEN,
                    'success'
                )
            }
        }

        failure {
            script {
                echo "========================================="
                echo "❌ AI Workflow - Rollback Failure"
                echo "========================================="
                def rollbackMode = env.ROLLBACK_MODE ?: 'auto'
                def targetLabel = env.ROLLBACK_TARGET_LABEL ?: (rollbackMode == 'manual' ? (params.ROLLBACK_TO_PHASE ?: 'implementation') : 'auto-detect (agent)')
                echo "Issue: ${params.ISSUE_URL}"
                echo "Rollback Mode: ${rollbackMode}"
                echo "Rollback Target: ${targetLabel}"
                echo "Please check the logs"

                def errorMessage = currentBuild.result ?: 'Build failed'
                common.sendWebhook(
                    params.JOB_ID,
                    params.WEBHOOK_URL,
                    params.WEBHOOK_TOKEN,
                    'failed',
                    errorMessage
                )
            }
        }
    }
}
