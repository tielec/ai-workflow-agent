/**
 * AI Workflow - All Phases Mode
 *
 * 全フェーズ（Phase 0-9）を順次実行するJenkinsfile。
 * resume機能により、失敗したフェーズから自動再開。
 *
 * パラメータ（Job DSLで定義）:
 * - ISSUE_URL: GitHub Issue URL（必須）
 * - AGENT_MODE: エージェントモード（デフォルト: auto）
 * - AUTO_MODEL_SELECTION: 自動モデル選択を有効化（デフォルト: true）
 * - GITHUB_TOKEN: GitHub Personal Access Token（必須）
 * - CODEX_API_KEY: Codexエージェント用APIキー（オプション）
 * - CODEX_AUTH_JSON: Codex ~/.codex/auth.json の内容（オプション）
 * - OPENAI_API_KEY: OpenAI API用キー（オプション）
 * - CLAUDE_CODE_OAUTH_TOKEN: Claude Codeエージェント用OAuthトークン（オプション）
 * - CLAUDE_CODE_API_KEY: Claude Codeエージェント用APIキー（オプション）
 * - ANTHROPIC_API_KEY: Anthropic API用キー（オプション）
 * - AWS_ACCESS_KEY_ID: AWS Access Key ID（オプション）
 * - AWS_SECRET_ACCESS_KEY: AWS Secret Access Key（オプション）
 * - AWS_SESSION_TOKEN: AWS Session Token（オプション）
 * - GITHUB_REPOSITORY: owner/repo形式（デフォルト: tielec/ai-workflow-agent）
 * - BRANCH_NAME: ブランチ名（オプション）
 * - BASE_BRANCH: 分岐元ブランチ（デフォルト: main）
 * - FORCE_RESET: 強制リセット（デフォルト: false）
 * - CLEANUP_ON_COMPLETE_FORCE: Evaluation Phase完了後にワークフローディレクトリを強制削除（デフォルト: false）
 * - SQUASH_ON_COMPLETE: ワークフロー完了時にコミットをスカッシュ（デフォルト: false）
 * - DRY_RUN: ドライランモード（デフォルト: false）
 * - GIT_COMMIT_USER_NAME: Gitコミット時のユーザー名（デフォルト: AI Workflow Bot）
 * - GIT_COMMIT_USER_EMAIL: Gitコミット時のメールアドレス（デフォルト: ai-workflow@example.com）
 */

def common

pipeline {
    agent {
        dockerfile {
            label 'ec2-fleet-small'
            dir '.'
            filename 'Dockerfile'
            args "-v \${WORKSPACE}:/workspace -w /workspace -e CLAUDE_DANGEROUSLY_SKIP_PERMISSIONS=1"
        }
    }

    options {
        timestamps()
        ansiColor('xterm')
    }

    environment {
        // Claude Agent SDK設定
        CLAUDE_DANGEROUSLY_SKIP_PERMISSIONS = '1'

        // AI Workflow設定
        WORKFLOW_DIR = '.'
        WORKFLOW_VERSION = '0.2.0'
        // ワークフロー言語設定
        AI_WORKFLOW_LANGUAGE = "${params.LANGUAGE ?: 'ja'}"
        EXECUTION_MODE = 'all_phases'
        CODEX_HOME = ''

        // ログ設定（CI環境ではカラーリング無効化）
        LOG_NO_COLOR = 'true'

        // Git設定
        GIT_COMMIT_USER_NAME = "${params.GIT_COMMIT_USER_NAME ?: 'AI Workflow Bot'}"
        GIT_COMMIT_USER_EMAIL = "${params.GIT_COMMIT_USER_EMAIL ?: 'ai-workflow@example.com'}"

        // AWS認証情報
        AWS_ACCESS_KEY_ID = "${params.AWS_ACCESS_KEY_ID ?: ''}"
        AWS_SECRET_ACCESS_KEY = "${params.AWS_SECRET_ACCESS_KEY ?: ''}"
        AWS_SESSION_TOKEN = "${params.AWS_SESSION_TOKEN ?: ''}"

        // GitHub認証情報
        GITHUB_TOKEN = "${params.GITHUB_TOKEN}"
        GITHUB_REPOSITORY = "${params.GITHUB_REPOSITORY ?: 'tielec/ai-workflow-agent'}"

        // OpenAI系認証情報
        CODEX_API_KEY = "${params.CODEX_API_KEY ?: ''}"
        OPENAI_API_KEY = "${params.OPENAI_API_KEY ?: ''}"

        // Claude系認証情報
        CLAUDE_CODE_OAUTH_TOKEN = "${params.CLAUDE_CODE_OAUTH_TOKEN ?: ''}"
        CLAUDE_CODE_API_KEY = "${params.CLAUDE_CODE_API_KEY ?: ''}"
        ANTHROPIC_API_KEY = "${params.ANTHROPIC_API_KEY ?: ''}"

        // 自動モデル選択設定
        AUTO_MODEL_SELECTION = "${params.AUTO_MODEL_SELECTION ?: 'true'}"
    }

    stages {
        stage('Load Common Library') {
            steps {
                script {
                    echo "========================================="
                    echo "AI Workflow Orchestrator v${env.WORKFLOW_VERSION}"
                    echo "Mode: All Phases (Phase 0-9)"
                    echo "========================================="

                    common = load 'jenkins/shared/common.groovy'
                    echo "Common library loaded successfully"

                    common.sendWebhook([
                        webhookUrl: params.WEBHOOK_URL,
                        webhookToken: params.WEBHOOK_TOKEN,
                        jobId: params.JOB_ID,
                        status: 'running',
                        buildUrl: env.BUILD_URL,
                        branchName: env.BRANCH_NAME ?: ''
                    ])
                }
            }
        }

        stage('Prepare Codex auth.json') {
            steps {
                script {
                    common.prepareCodexAuthFile()
                }
            }
        }

        stage('Prepare Agent Credentials') {
            steps {
                script {
                    common.prepareAgentCredentials()
                }
            }
        }


        stage('Validate Parameters') {
            steps {
                script {
                    echo "========================================="
                    echo "Stage: Validate Parameters"
                    echo "========================================="

                    if (!params.ISSUE_URL) {
                        error("ISSUE_URL parameter is required")
                    }

                    if (!params.ISSUE_URL.startsWith('https://github.com/')) {
                        error("ISSUE_URL must be a GitHub Issue URL: ${params.ISSUE_URL}")
                    }

                    if (!params.ISSUE_URL.contains('/issues/')) {
                        error("ISSUE_URL must be a GitHub Issue URL (/issues/): ${params.ISSUE_URL}")
                    }

                    // Issue番号とリポジトリ情報抽出
                    def urlParts = params.ISSUE_URL.split('/')
                    env.ISSUE_NUMBER = urlParts[-1]
                    env.REPO_OWNER = urlParts[-4]
                    env.REPO_NAME = urlParts[-3]

                    // ビルドディスクリプションを設定
                    currentBuild.description = "Issue #${env.ISSUE_NUMBER} | All Phases | ${env.REPO_OWNER}/${env.REPO_NAME}"

                    echo "Issue URL: ${params.ISSUE_URL}"
                    echo "Issue Number: ${env.ISSUE_NUMBER}"
                    echo "Repository Owner: ${env.REPO_OWNER}"
                    echo "Repository Name: ${env.REPO_NAME}"
                    echo "Base Branch: ${params.BASE_BRANCH ?: '(current branch)'}"
                    echo "Agent Mode: ${params.AGENT_MODE ?: 'auto'}"
                    echo "Auto Model Selection: ${params.AUTO_MODEL_SELECTION ?: true}"
                    echo "Force Reset: ${params.FORCE_RESET ?: false}"
                    echo "Cleanup On Complete Force: ${params.CLEANUP_ON_COMPLETE_FORCE ?: false}"
                    echo "Squash On Complete: ${params.SQUASH_ON_COMPLETE ?: false}"
                    echo "Dry Run: ${params.DRY_RUN ?: false}"
                    echo "Skip Phases: ${params.SKIP_PHASES ?: '(none)'}"
                }
            }
        }

        stage('Setup Environment') {
            steps {
                script {
                    common.setupEnvironment()
                }
            }
        }

        stage('Setup Node.js Environment') {
            steps {
                script {
                    common.setupNodeEnvironment()
                }
            }
        }

        stage('Initialize Workflow') {
            steps {
                script {
                    echo "========================================="
                    echo "Stage: Initialize Workflow"
                    echo "========================================="

                    dir(env.WORKFLOW_DIR) {
                        if (params.DRY_RUN) {
                            echo "[DRY RUN] Workflow initialization skipped"
                        } else {
                            def branchOption = params.BRANCH_NAME ? "--branch ${params.BRANCH_NAME}" : ""
                            def baseBranchOption = params.BASE_BRANCH ? "--base-branch ${params.BASE_BRANCH}" : ""
                            def autoModelSelectionFlag = env.AUTO_MODEL_SELECTION == 'true' ? '--auto-model-selection' : ''
                            def languageOption = params.LANGUAGE ? "--language ${params.LANGUAGE}" : ''

                            sh """
                                node dist/index.js init \
                                    --issue-url ${params.ISSUE_URL} \
                                    ${branchOption} \
                                    ${baseBranchOption} \
                                    ${autoModelSelectionFlag} \
                                    ${languageOption}
                            """
                        }
                    }
                }
            }
        }

        stage('Execute All Phases') {
            steps {
                script {
                    echo "========================================="
                    echo "Stage: Execute All Phases"
                    echo "========================================="
                    echo "Force Reset: ${params.FORCE_RESET ?: false}"

                    currentBuild.description = "Issue #${env.ISSUE_NUMBER} | Executing All Phases (Phase 0-9) | ${env.REPO_OWNER}/${env.REPO_NAME}"

                    dir(env.WORKFLOW_DIR) {
                        if (params.DRY_RUN) {
                            echo "[DRY RUN] All phases execution skipped"
                        } else {
                            def forceResetFlag = params.FORCE_RESET ? '--force-reset' : ''
                            def cleanupFlags = params.CLEANUP_ON_COMPLETE_FORCE ? '--cleanup-on-complete --cleanup-on-complete-force' : ''
                            def squashFlag = params.SQUASH_ON_COMPLETE ? '--squash-on-complete' : ''
                            def languageOption = params.LANGUAGE ? "--language ${params.LANGUAGE}" : ''
                            def skipPhasesOption = params.SKIP_PHASES?.trim() ? "--skip-phases ${params.SKIP_PHASES.trim()}" : ''

                            sh """
                                node dist/index.js execute \
                                    --phase all \
                                    --issue ${env.ISSUE_NUMBER} \
                                    --agent ${params.AGENT_MODE ?: 'auto'} \
                                    --followup-llm-mode agent \
                                    ${forceResetFlag} \
                                    ${cleanupFlags} \
                                    ${squashFlag} \
                                    ${languageOption} \
                                    ${skipPhasesOption}
                            """

                            // metadata.json から PR URL を直接読み込み（readJSON を使用して SecretMasker を回避）
                            try {
                                def metadataFile = ".ai-workflow/issue-${env.ISSUE_NUMBER}/metadata.json"
                                if (fileExists(metadataFile)) {
                                    def metadata = readJSON file: metadataFile
                                    env.PR_URL = metadata.pr_url ?: ''
                                    echo "Retrieved PR URL from metadata: ${env.PR_URL}"
                                } else {
                                    env.PR_URL = ''
                                    echo "Metadata file not found"
                                }
                            } catch (Exception e) {
                                echo "Could not retrieve PR URL: ${e.message}"
                                env.PR_URL = ''
                            }
                        }
                    }
                }
            }
        }
    }

    post {
        always {
            script {
                echo "========================================="
                echo "Post Processing"
                echo "========================================="

                currentBuild.description = "Issue #${env.ISSUE_NUMBER} | All Phases | ${env.REPO_OWNER}/${env.REPO_NAME}"

                if (env.ISSUE_NUMBER && env.ISSUE_NUMBER != 'auto') {
                    common.archiveArtifacts(env.ISSUE_NUMBER)
                }

                // REPOS_ROOTクリーンアップ
                if (env.REPOS_ROOT) {
                    sh """
                        rm -rf ${env.REPOS_ROOT}
                    """
                    echo "REPOS_ROOT cleaned up: ${env.REPOS_ROOT}"
                }

                if (env.CODEX_HOME?.trim()) {
                    sh """
                        rm -rf ${env.CODEX_HOME}
                    """
                    echo "CODEX_HOME cleaned up: ${env.CODEX_HOME}"
                }

                // ワークスペースのクリーンアップ
                cleanWs()
                echo "Workspace cleaned up"
            }
        }

        success {
            script {
                echo "========================================="
                echo "✅ AI Workflow - All Phases Success"
                echo "========================================="
                echo "Issue: ${params.ISSUE_URL}"
                echo "Workflow Directory: .ai-workflow/issue-${env.ISSUE_NUMBER}"

                // PR URL は Execute All Phases ステージで取得済み（環境変数に保存）
                def prUrl = env.PR_URL ?: ''
                if (prUrl) {
                    echo "PR URL: ${prUrl}"
                }

                common.sendWebhook([
                    webhookUrl: params.WEBHOOK_URL,
                    webhookToken: params.WEBHOOK_TOKEN,
                    jobId: params.JOB_ID,
                    status: 'success',
                    buildUrl: env.BUILD_URL,
                    branchName: env.BRANCH_NAME ?: '',
                    prUrl: prUrl,
                    finishedAt: new Date().format("yyyy-MM-dd'T'HH:mm:ss.SSS'Z'", TimeZone.getTimeZone('UTC')),
                    logsUrl: "${env.BUILD_URL}console"
                ])
            }
        }

        failure {
            script {
                echo "========================================="
                echo "❌ AI Workflow - All Phases Failure"
                echo "========================================="
                echo "Issue: ${params.ISSUE_URL}"
                echo "Please check the logs"

                def errorMessage = currentBuild.result ?: 'Build failed'
                common.sendWebhook([
                    webhookUrl: params.WEBHOOK_URL,
                    webhookToken: params.WEBHOOK_TOKEN,
                    jobId: params.JOB_ID,
                    status: 'failed',
                    errorMessage: errorMessage,
                    buildUrl: env.BUILD_URL,
                    finishedAt: new Date().format("yyyy-MM-dd'T'HH:mm:ss.SSS'Z'", TimeZone.getTimeZone('UTC')),
                    logsUrl: "${env.BUILD_URL}console"
                ])
            }
        }
    }
}
