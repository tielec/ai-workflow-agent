# PRレビューコメント — 分析フェーズ

**重要: すべてのドキュメント内容を日本語で記述してください。すべてのセクション、説明、解説は日本語で書いてください。**

PRレビューコメントのトリアージを支援します。提供された**すべて**のコメントを一括で分析し、単一の対応計画を提案してください。

## 目標
- 各コメントを以下のいずれかに分類: `code_change`, `reply`, `discussion`, `skip`
- 信頼度を提供: `high` | `medium` | `low`
- `code_change` の場合、最小限で安全な変更を提案（機密ファイルは避ける）
- 各コメントへの返信メッセージを作成

## 入力コンテキスト
- PR番号: {pr_number}
- PRタイトル: {pr_title}
- 対象リポジトリ: {repo_path}
- コメント（一括）:
{all_comments}

## セキュリティ・安全ガードレール
- 以下のファイルは絶対に変更・提案しない: `.env`, `.env.*`, `credentials.*`, `secrets.*`, `*.pem`, `*.key`
- リポジトリ相対パスのみ使用（絶対パスやパストラバーサル `..` は禁止）
- `code_change` の信頼度が `low` になる場合は、`discussion` にダウングレード
- 返信は簡潔で、プロフェッショナルで、実行可能な内容にする

## 出力
**出力先**: `{output_file_path}`

**重要**: 必ず指定されたファイルパス（`{output_file_path}`）にJSONを書き出してください。  
ファイル書き込みツールを使用して、以下の構造のJSONファイルを作成してください。

```json
{
  "pr_number": 123,
  "analyzer_agent": "codex|claude|auto",
  "comments": [
    {
      "comment_id": "c001",
      "file": "src/app.ts",
      "line": 42,
      "author": "reviewer",
      "body": "...コメントテキスト...",
      "type": "code_change|reply|discussion|skip",
      "confidence": "high|medium|low",
      "rationale": "この選択の理由",
      "proposed_changes": [
        {
          "action": "modify|create|delete",
          "file": "src/app.ts",
          "line_range": "40-55",
          "changes": "modify/createの場合、新しいファイルの完全な内容をここに記載。deleteの場合は空文字列。"
        }
      ],
      "reply_message": "GitHubに投稿する返信メッセージ"
    }
  ]
}
```

禁止事項:
- イベントストリーム（JSON Lines）形式での出力
- Markdownコードブロック以外の場所への説明テキスト追加
- 複数のJSONオブジェクトや前後のコメントを出力すること

注意事項:
- JSON形式は上記の構造に厳密に従ってください
- ファイルが正常に書き込まれたことを確認してください
- 入力された全てのコメントを1回ずつ含める
- `proposed_changes` は `code_change` 以外のタイプでは空配列でよい
- ファイルが見つからない場合は、`proposed_changes` を空配列にし、`discussion` または `reply` を選択

## スレッドコンテキストの理解

コメントはスレッド単位でグループ化されています。各スレッドには次の情報が含まれます:

- `[User Comment]`: ユーザー（レビュアー）が投稿したコメント
- `[AI Reply]`: AIがこれまでに投稿した返信

**重要**: 判定時はスレッド全体の流れを考慮してください。

## 承認パターンの検出

スレッド内で以下のパターンが成立する場合、**最新のコメント**を `code_change` として扱ってください。

### パターン1: AI提案 → ユーザー承認

1. 直前のコメントがAI提案である（例: 「〜してよいでしょうか」「〜する案で進めます」「〜の方針で進めてよいですか」）。
2. 現在のコメントが承認である（例: 「はい」「OK」「いいです」「承認」「その方針で進めて」「それでお願いします」）。

判定:
- `type: "code_change"`
- `confidence: "high"`
- `proposed_changes` にAI提案の内容を具体的な実装として含める

### パターン2: 質問 → 回答

1. 直前のコメントがAIの質問。
2. 現在のコメントが具体的な指示を含むユーザー回答。

判定:
- `type: "code_change"`
- `confidence: "medium"`
- `proposed_changes` にユーザー指示に基づく実装を含める

### パターン3: 単純な返信（承認なし）

AI提案がない、または承認キーワードがない場合:

- `type: "reply"` または `type: "discussion"`
- `proposed_changes: []`

## 注意事項

- **常にスレッド全体の文脈を参照**し、最新コメントだけでなく直前のAI提案/質問を確認すること
- ユーザーが明示的に承認・指示した場合は必ずコード変更として実装すること
- 承認検出に迷う場合は `confidence: "medium"` を設定すること
