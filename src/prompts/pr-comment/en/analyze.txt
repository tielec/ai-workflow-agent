# PR Review Comments — Analyze Phase

**IMPORTANT: Write all document content in English. All sections, descriptions, and explanations must be in English.**

Triage **all** provided review comments in one pass and propose a single response plan.

## Goals
- Classify each comment as: `code_change`, `reply`, `discussion`, or `skip`
- Provide confidence: `high` | `medium` | `low`
- For `code_change`, suggest minimal, safe edits (avoid sensitive files)
- Draft a reply message for every comment

## Input Context
- PR number: {pr_number}
- PR title: {pr_title}
- Repository path: {repo_path}
- Comments (batched):
{all_comments}

## Security & Safety Guardrails
- Never change or propose touching: `.env`, `.env.*`, `credentials.*`, `secrets.*`, `*.pem`, `*.key`
- Use repository-relative paths only (no absolute paths or `..` traversal)
- If confidence for `code_change` would be `low`, downgrade to `discussion`
- Replies must be concise, professional, and actionable

## Output
**Path**: `{output_file_path}`

**Important**: Write JSON to `{output_file_path}` using the file-write tool.

```json
{
  "pr_number": 123,
  "analyzer_agent": "codex|claude|auto",
  "comments": [
    {
      "comment_id": "c001",
      "file": "src/app.ts",
      "line": 42,
      "author": "reviewer",
      "body": "...",
      "type": "code_change|reply|discussion|skip",
      "confidence": "high|medium|low",
      "rationale": "reason for this choice",
      "proposed_changes": [
        {
          "action": "modify|create|delete",
          "file": "src/app.ts",
          "line_range": "40-55",
          "changes": "For modify/create, include full new file content; for delete use an empty string."
        }
      ],
      "reply_message": "Reply text to post on GitHub"
    }
  ]
}
```

Do not:
- Output JSON Lines/event streams
- Add extra narrative outside the JSON block
- Output multiple JSON objects or comments around the JSON

Notes:
- Follow the structure above exactly
- Ensure the file is written successfully
- Include every input comment exactly once
- `proposed_changes` can be an empty array for non-`code_change` types
- If a file is missing, keep `proposed_changes` empty and use `discussion` or `reply`

## Understanding Thread Context

Comments are grouped by thread. Each thread contains:

- `[User Comment]`: Comments posted by the reviewer
- `[AI Reply]`: Replies previously posted by AI

**Important**: Always consider the full thread when deciding.

## Approval Pattern Detection

When the following patterns appear within a thread, classify the **latest comment** as `code_change`.

### Pattern 1: AI proposal → User approval

1. The previous comment is an AI proposal (e.g., "shall I", "would you like me to", "I suggest we", "let me know if you'd like").
2. The current comment is user approval (e.g., "yes", "OK", "approved", "LGTM", "go ahead", "please proceed", "sounds good").

Decision:
- `type: "code_change"`
- `confidence: "high"`
- `proposed_changes` should include concrete implementation of the AI proposal

### Pattern 2: Question → Answer

1. The previous comment is an AI question.
2. The current comment is a user answer with specific instructions.

Decision:
- `type: "code_change"`
- `confidence: "medium"`
- `proposed_changes` should implement the user’s instruction

### Pattern 3: Simple reply (no approval)

If there is no AI proposal or no approval keywords:

- Use `type: "reply"` or `type: "discussion"`
- `proposed_changes: []`

## Notes

- **Always reference the full thread context**, not only the latest comment
- When a user explicitly approves or instructs, treat it as a code change
- If approval detection is uncertain, set `confidence: "medium"`
