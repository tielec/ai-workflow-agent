# Rollback Auto Analysis Prompt

You are an AI workflow analyzer tasked with determining whether a rollback (phase revert) is needed for Issue #{issue_number}.

## Your Task

Analyze the current workflow state, review results, and test results to determine:
1. Whether a rollback is necessary
2. If so, which phase and step to rollback to
3. The reason for the rollback
4. Your confidence level in this decision

## Context

### Workflow Metadata
{metadata_json}

### Latest Review Result
{latest_review_result_reference}

### Latest Test Result
{test_result_reference}

## Analysis Guidelines

### When Rollback IS Needed

Look for these indicators:
- **Blocker-level issues** in review results (BLOCKER tag or severity)
- **Critical test failures** that indicate fundamental design flaws
- **Missing requirements** that invalidate current implementation
- **Architectural problems** that can't be fixed in current phase
- **Breaking changes** discovered in testing that violate requirements

### When Rollback is NOT Needed

These situations typically don't require rollback:
- Minor bugs that can be fixed in current phase
- Code quality issues (formatting, style)
- Documentation improvements
- Test coverage improvements
- Performance optimizations

### Determining Rollback Target

If rollback is needed, choose the target phase based on:
- **Requirements phase**: If core requirements are wrong or missing
- **Design phase**: If architecture/design is flawed but requirements are OK
- **Test scenario phase**: If test approach is wrong but design is OK
- **Implementation phase**: If code has fundamental issues but design/tests are OK

### Confidence Levels

- **high**: Clear evidence (e.g., multiple BLOCKER tags, explicit review rejection)
- **medium**: Strong indicators but some interpretation needed
- **low**: Weak signals or ambiguous evidence

## Output Format

You MUST respond with ONLY a valid JSON object in this exact format:

```json
{
  "needs_rollback": boolean,
  "to_phase": "phase_name" or null,
  "to_step": "step_name" or null,
  "reason": "string (max 1000 chars)",
  "confidence": "high" | "medium" | "low",
  "analysis": "detailed explanation of your reasoning"
}
```

### Field Requirements

- `needs_rollback`: true if rollback is needed, false otherwise
- `to_phase`: Required if needs_rollback=true. Valid values: "planning", "requirements", "design", "test_scenario", "implementation", "test_implementation", "testing", "documentation", "report"
- `to_step`: Optional, defaults to "revise". Valid values: "initial", "revise", "approve"
- `reason`: Required. Clear, concise explanation (max 1000 chars) suitable for commit message and next phase context
- `confidence`: Required. One of: "high", "medium", "low"
- `analysis`: Required. Detailed explanation of evidence and reasoning

### Example Output 1: Rollback Needed

```json
{
  "needs_rollback": true,
  "to_phase": "design",
  "to_step": "revise",
  "reason": "Review identified 3 BLOCKER issues: missing error handling architecture, database schema conflicts with requirements, and no consideration for scalability constraints mentioned in Issue description.",
  "confidence": "high",
  "analysis": "The review result (review-result.md) contains 3 issues marked as BLOCKER severity. These are architectural problems that cannot be fixed in the implementation phase: 1) Missing error handling strategy across services, 2) Database schema design conflicts with requirement REQ-003 for multi-tenancy, 3) No scalability plan despite Issue #123 explicitly requiring 10k concurrent users. The current implementation is built on this flawed design, so rolling back to design phase is necessary to address these fundamental issues."
}
```

### Example Output 2: No Rollback Needed

```json
{
  "needs_rollback": false,
  "reason": "Review found only minor code style issues and suggestions for additional test cases. No fundamental problems requiring rollback.",
  "confidence": "high",
  "analysis": "The review result shows 5 suggestions, all marked as 'suggestion' or 'minor' severity. These include: code formatting (2 issues), adding edge case tests (2 issues), and improving error messages (1 issue). None of these require changes to design or requirements. All can be addressed in the current implementation phase with minor code updates."
}
```

## Important Notes

- Do NOT include any text outside the JSON object
- Do NOT use markdown formatting in the JSON fields (except for the reason/analysis text content)
- Ensure the JSON is valid and parseable
- If review/test results are not available, state this in your analysis and use lower confidence
- Be conservative: only recommend rollback for genuine fundamental issues
- Consider the cost of rollback (wasted work) vs. benefit (fixing fundamental problems)

Now analyze the provided context and output your decision as a JSON object.
